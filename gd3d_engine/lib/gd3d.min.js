var __decorate=this&&this.__decorate||function(t,e,a,r){var i,o=arguments.length,n=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,a):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(t,e,a,r);else for(var s=t.length-1;s>=0;s--)(i=t[s])&&(n=(o<3?i(n):o>3?i(e,a,n):i(e,a))||n);return o>3&&n&&Object.defineProperty(e,a,n),n},__metadata=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},__extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a])};return function(e,a){function __(){this.constructor=e}t(e,a),e.prototype=null===a?Object.create(a):(__.prototype=a.prototype,new __)}}(),gd3d;!function(t){!function(e){!function(t){t[t.AddChild=0]="AddChild",t[t.RemoveChild=1]="RemoveChild",t[t.ChangeVisible=2]="ChangeVisible",t[t.AddCamera=3]="AddCamera",t[t.AddCanvasRender=4]="AddCanvasRender"}(e.NotifyType||(e.NotifyType={}));var a=function(){function application(){this.limitFrame=!0,this.version="v0.0.1",this.build="b000010",this._tar=-1,this._standDeltaTime=-1,this.beStepNumber=0,this.pretimer=0,this.isFrustumCulling=!0,this._userCode=[],this._userCodeNew=[],this._editorCode=[],this._editorCodeNew=[],this._bePlay=!1,this.be2dstate=!1,this.curcameraindex=-1,this._bePause=!1,this._beStepForward=!1}return Object.defineProperty(application.prototype,"timeScale",{get:function(){return this._timeScale},set:function(t){this._timeScale=t},enumerable:!0,configurable:!0}),Object.defineProperty(application.prototype,"targetFrame",{get:function(){return this._tar},set:function(t){0==t&&(t=-1),this._tar=t,this._standDeltaTime=1/this._tar},enumerable:!0,configurable:!0}),application.prototype.start=function(a){console.log("version: "+this.version+"  build: "+this.build);var r,i=document.getElementsByName("viewport");!i||i.length<1?((r=document.createElement("meta")).name="viewport",document.head.appendChild(r)):r=i[0],r.content="width=device-width, height=device-height, user-scalable=no, initial-scale=0.5, minimum-scale=0.5, maximum-scale=0.5",e.sceneMgr.app=this,this._timeScale=1,this.container=a;var o=document.createElement("canvas");o.className="full",o.style.position="absolute",o.style.width="100%",o.style.height="100%",o.style.backgroundColor="#1e1e1e",o.setAttribute("tabindex","1"),a.appendChild(o),this.webgl=o.getContext("webgl")||o.getContext("experimental-webgl"),t.render.webglkit.initConst(this.webgl),this.initAssetMgr(),this.initInputMgr(),this.initScene(),this.beginTimer=this.lastTimer=this.pretimer=Date.now()/1e3,this.loop(),t.io.referenceInfo.regDefaultType();var n=window.initovercallback;null!=n&&n(this)},application.prototype.markNotify=function(t,e){this.doNotify(t,e)},application.prototype.doNotify=function(t,e){if(null!=t&&this.checkFilter(t)&&(this.notify&&this.notify.notify(t,e),null!=t.children))for(var a in t.children)this.doNotify(t.children[a],e)},application.prototype.checkFilter=function(e){return!(e instanceof t.framework.transform&&e.gameObject.hideFlags&t.framework.HideFlags.HideInHierarchy)&&!(e instanceof t.framework.transform2D&&e.hideFlags&t.framework.HideFlags.HideInHierarchy)},application.prototype.showFps=function(){null==this.stats?(this.stats=new Stats.Stats(this),this.stats.container.style.position="absolute",this.stats.container.style.left="0px",this.stats.container.style.top="0px",this.container.appendChild(this.stats.container)):this.container.appendChild(this.stats.container)},application.prototype.closeFps=function(){null!=this.stats&&this.container.removeChild(this.stats.container)},application.prototype.update=function(t){this.webgl.canvas.clientWidth==this.webgl.canvas.width&&this.webgl.canvas.clientHeight==this.webgl.canvas.height||(this.webgl.canvas.width=this.webgl.canvas.clientWidth,this.webgl.canvas.height=this.webgl.canvas.clientHeight,console.log("canvas resize.   width:"+this.webgl.canvas.clientWidth+"   height:"+this.webgl.canvas.clientHeight)),this.width=this.webgl.canvas.width,this.height=this.webgl.canvas.height,this.bePlay&&(this.bePause?this.beStepForward&&this.beStepNumber>0&&(this.beStepNumber--,this.updateUserCode(t)):this.updateUserCode(t)),this.updateEditorCode(t),null!=this._scene&&this._scene.update(t)},application.prototype.getUserUpdateTimer=function(){return this.usercodetime},application.prototype.getTotalTime=function(){return this.totalTime},Object.defineProperty(application.prototype,"deltaTime",{get:function(){return this._deltaTime*this._timeScale},enumerable:!0,configurable:!0}),application.prototype.getUpdateTimer=function(){return this.updateTimer},application.prototype.loop=function(){var t=Date.now()/1e3;if(this._deltaTime=t-this.lastTimer,this.totalTime=t-this.beginTimer,this.updateTimer=t-this.pretimer,this._deltaTime<this._standDeltaTime){var e=this,a=this._standDeltaTime-this._deltaTime;setTimeout(function(){var t=Date.now()/1e3;e.lastTimer=t,e.pretimer=t,e.update(e._standDeltaTime),null!=e.stats&&e.stats.update(),e.loop()},1e3*a)}else this.update(this.deltaTime),null!=this.stats&&this.stats.update(),this.lastTimer=t,this.pretimer=t,this.limitFrame?requestAnimationFrame(this.loop.bind(this)):setTimeout(this.loop.bind(this),1)},application.prototype.initScene=function(){null==this._scene&&(this._scene=new e.scene(this),e.sceneMgr.scene=this._scene)},application.prototype.getScene=function(){return this._scene},application.prototype.initAssetMgr=function(){null==this._assetmgr&&(this._assetmgr=new e.assetMgr(this),this._assetmgr.initDefAsset())},application.prototype.getAssetMgr=function(){return this._assetmgr},application.prototype.initInputMgr=function(){null==this._inputmgr&&(this._inputmgr=new e.inputMgr(this))},application.prototype.getInputMgr=function(){return this._inputmgr},Object.defineProperty(application.prototype,"bePlay",{get:function(){return this._bePlay},set:function(t){this._bePlay=t},enumerable:!0,configurable:!0}),Object.defineProperty(application.prototype,"bePause",{get:function(){return this._bePause},set:function(t){this._bePause=t},enumerable:!0,configurable:!0}),Object.defineProperty(application.prototype,"beStepForward",{get:function(){return this._beStepForward},set:function(t){this._beStepForward=t},enumerable:!0,configurable:!0}),application.prototype.updateUserCode=function(t){for(a=this._userCodeNew.length-1;a>=0;a--)0==(r=this._userCodeNew[a]).isClosed()&&(r.onStart(this),this._userCode.push(r),this._userCodeNew.splice(a,1));for(var e=-1,a=0;a<this._userCode.length;a++){var r=this._userCode[a];0==r.isClosed()?r.onUpdate(t):e<0&&(e=a)}e>=0&&this._userCode.splice(e,1)},application.prototype.updateEditorCode=function(t){for(e=this._editorCodeNew.length-1;e>=0;e--)0==(a=this._editorCodeNew[e]).isClosed()&&(a.onStart(this),this._editorCode.push(a),this._editorCodeNew.splice(e,1));for(var e=this._editorCode.length-1;e>=0;e--){var a=this._editorCode[e];a.isClosed()?this._editorCode.splice(e,1):a.onUpdate(t)}},application.prototype.addUserCodeDirect=function(t){this._userCodeNew.push(t)},application.prototype.addUserCode=function(e){var a=t.reflect.getPrototype(e);if(null!=a){var r=t.reflect.createInstance(a,{usercode:"1"});this.addUserCodeDirect(r)}},application.prototype.addEditorCode=function(e){var a=t.reflect.getPrototype(e);if(null!=a){var r=t.reflect.createInstance(a,{editorcode:"1"});this.addEditorCodeDirect(r)}},application.prototype.addEditorCodeDirect=function(t){this._editorCodeNew.push(t)},application}();e.application=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(t){var e=function(){function sceneMgr(){}return Object.defineProperty(sceneMgr,"ins",{get:function(){return null==sceneMgr._ins&&(sceneMgr._ins=new sceneMgr),sceneMgr._ins},enumerable:!0,configurable:!0}),sceneMgr}();t.sceneMgr=e}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var Stats;!function(t){var e=function(){function Stats(t){var e=this;this.mode=0,this.app=t,this.container=document.createElement("div"),this.container.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.7;z-index:1",this.container.addEventListener("click",function(t){t.preventDefault(),e.showPanel(++e.mode%e.container.children.length)},!1),this.beginTime=(performance||Date).now(),this.prevTime=this.beginTime,this.frames=0,this.fpsPanel=this.addPanel(new a("FPS","#0ff","#002")),this.msPanel=this.addPanel(new a("MS","#0f0","#020")),this.ratePanel=this.addPanel(new a("%","#0f0","#020")),this.userratePanel=this.addPanel(new a("%","#0f0","#020")),self.performance&&self.performance.memory&&(this.memPanel=this.addPanel(new a("MB","#f08","#201"))),this.showPanel(0)}return Stats.prototype.update=function(){this.beginTime=this.end()},Stats.prototype.showPanel=function(t){for(var e=0;e<this.container.children.length;e++)this.container.children[e].style.display=e===t?"block":"none";this.mode=t},Stats.prototype.addPanel=function(t){return this.container.appendChild(t.canvas),t},Stats.prototype.begin=function(){this.beginTime=(performance||Date).now()},Stats.prototype.end=function(){this.frames++;var t=(performance||Date).now();if(this.msPanel.update(t-this.beginTime,200),t>this.prevTime+1e3){var e=1e3*this.frames/(t-this.prevTime);if(this.fpsPanel.update(e,100),this.ratePanel.update(this.app.getUpdateTimer()*this.frames/10,100),this.userratePanel.update(this.app.getUserUpdateTimer()*this.frames/10,100),this.prevTime=t,this.frames=0,this.memPanel){var a=performance.memory;this.memPanel.update(a.usedJSHeapSize/1048576,a.jsHeapSizeLimit/1048576)}}return t},Stats}();t.Stats=e;var a=function(){function Panel(t,e,a){this.name=t,this.fg=e,this.bg=a,this.min=1/0,this.max=0,this.PR=Math.round(window.devicePixelRatio||1),this.WIDTH=80*this.PR,this.HEIGHT=48*this.PR,this.TEXT_X=3*this.PR,this.TEXT_Y=2*this.PR,this.GRAPH_X=3*this.PR,this.GRAPH_Y=15*this.PR,this.GRAPH_WIDTH=74*this.PR,this.GRAPH_HEIGHT=30*this.PR,this.canvas=document.createElement("canvas"),this.canvas.width=this.WIDTH,this.canvas.height=this.HEIGHT,this.canvas.style.cssText="width:80px;height:48px",this.context=this.canvas.getContext("2d"),this.context.font="bold "+9*this.PR+"px Helvetica,Arial,sans-serif",this.context.textBaseline="top",this.context.fillStyle=a,this.context.fillRect(0,0,this.WIDTH,this.HEIGHT),this.context.fillStyle=e,this.context.fillText(t,this.TEXT_X,this.TEXT_Y),this.context.fillRect(this.GRAPH_X,this.GRAPH_Y,this.GRAPH_WIDTH,this.GRAPH_HEIGHT),this.context.fillStyle=a,this.context.globalAlpha=.9,this.context.fillRect(this.GRAPH_X,this.GRAPH_Y,this.GRAPH_WIDTH,this.GRAPH_HEIGHT)}return Panel.prototype.update=function(t,e){this.min=Math.min(this.min,t),this.max=Math.max(this.max,t),this.context.fillStyle=this.bg,this.context.globalAlpha=1,this.context.fillRect(0,0,this.WIDTH,this.GRAPH_Y),this.context.fillStyle=this.fg,this.context.fillText(Math.round(t)+" "+this.name+" ("+Math.round(this.min)+"-"+Math.round(this.max)+")",this.TEXT_X,this.TEXT_Y),this.context.drawImage(this.canvas,this.GRAPH_X+this.PR,this.GRAPH_Y,this.GRAPH_WIDTH-this.PR,this.GRAPH_HEIGHT,this.GRAPH_X,this.GRAPH_Y,this.GRAPH_WIDTH-this.PR,this.GRAPH_HEIGHT),this.context.fillRect(this.GRAPH_X+this.GRAPH_WIDTH-this.PR,this.GRAPH_Y,this.PR,this.GRAPH_HEIGHT),this.context.fillStyle=this.bg,this.context.globalAlpha=.9,this.context.fillRect(this.GRAPH_X+this.GRAPH_WIDTH-this.PR,this.GRAPH_Y,this.PR,Math.round((1-t/e)*this.GRAPH_HEIGHT))},Panel}()}(Stats||(Stats={}));var gd3d;!function(t){!function(t){function regType(t,e){void 0==t.__gdmeta__&&(t.__gdmeta__={}),void 0==t.__gdmeta__.class&&(t.__gdmeta__.class={});var a=t.constructor.name;if(null==a){var r=t.constructor.toString(),i=r.indexOf("(");a=r.substring(9,i)}if(t.__gdmeta__.class.typename=a,null==document.__gdmeta__&&(document.__gdmeta__={}),document.__gdmeta__[a]=t,null==t.__gdmeta__.class.custom&&(t.__gdmeta__.class.custom={}),null!=e)for(var o in e)t.__gdmeta__.class.custom[o]=e[o]}function regFunc(t,e,a){void 0==t.__gdmeta__&&(t.__gdmeta__={}),null==t.__gdmeta__[e]&&(t.__gdmeta__[e]={}),t.__gdmeta__[e].type="function";var r=Reflect.getMetadata("design:paramtypes",t,e),i=Reflect.getMetadata("design:returntype",t,e);t.__gdmeta__[e].paramtypes=[];for(var o in r)t.__gdmeta__[e].paramtypes[o]=r[o].name;if(t.__gdmeta__[e].returntype=null==i?null:i.name,null==t.__gdmeta__[e].custom&&(t.__gdmeta__[e].custom={}),null!=a)for(var n in a)t.__gdmeta__[e].custom[n]=a[n]}function regField(t,e,a){if(void 0==t.__gdmeta__&&(t.__gdmeta__={}),null==t.__gdmeta__[e]&&(t.__gdmeta__[e]={}),t.__gdmeta__[e].type="field",null==t.__gdmeta__[e].custom&&(t.__gdmeta__[e].custom={}),null!=a)for(var r in a)t.__gdmeta__[e].custom[r]=a[r]}t.getPrototypes=function getPrototypes(){return document.__gdmeta__},t.getPrototype=function getPrototype(t){return document.__gdmeta__[t]},t.createInstance=function createInstance(t,e){if(null==e)return new(i=t.constructor);var a=t.__gdmeta__.class.custom;for(var r in e)if(a[r]!=e[r])return console.warn("createInstance:"+name+". tag do not match."),null;var i=t.constructor;return new i},t.getClassName=function getClassName(t){return t.__gdmeta__.class.typename},t.getClassTag=function getClassTag(t,e){return t.__gdmeta__.class.custom[e]},t.getMeta=function getMeta(t){return t.__gdmeta__},t.attr_Class=function attr_Class(t){regType(t.prototype,null)},t.attr_Func=function attr_Func(t){return void 0===t&&(t=null),function(e,a,r){regFunc(e,a,t)}},t.attr_Field=function attr_Field(t){return void 0===t&&(t=null),function(e,a){regField(e,a,t)}},t.userCode=function userCode(t){regType(t.prototype,{usercode:"1"})},t.editorCode=function editorCode(t){regType(t.prototype,{editorcode:"1"})},t.selfClone=function selfClone(t){regType(t.prototype,{selfclone:"1"})},t.nodeComponent=function nodeComponent(t){regType(t.prototype,{nodecomp:"1"})},t.nodeComponentInspector=function nodeComponentInspector(t){regType(t.prototype,{nodecomp_inspector:"1"})},t.nodeRender=function nodeRender(t){regType(t.prototype,{renderer:"1"})},t.nodeCamera=function nodeCamera(t){regType(t.prototype,{camera:"1"})},t.nodeLight=function nodeLight(t){regType(t.prototype,{light:"1"})},t.nodeBoxCollider=function nodeBoxCollider(t){regType(t.prototype,{boxcollider:"1"})},t.nodeSphereCollider=function nodeSphereCollider(t){regType(t.prototype,{spherecollider:"1"})},t.nodeEffectBatcher=function nodeEffectBatcher(t){regType(t.prototype,{effectbatcher:"1"})},t.nodeMeshCollider=function nodeMeshCollider(t){regType(t.prototype,{meshcollider:"1"})},t.nodeCanvasRendererCollider=function nodeCanvasRendererCollider(t){regType(t.prototype,{canvasRenderer:"1"})},t.node2DComponent=function node2DComponent(t){regType(t.prototype,{"2dcomp":"1"})},t.pluginMenuItem=function pluginMenuItem(t){regType(t.prototype,{plugin_menuitem:"1"})},t.pluginWindow=function pluginWindow(t){regType(t.prototype,{plugin_window:"1"})},t.pluginExt=function pluginExt(t){regType(t.prototype,{plugin_ext:"1"})},t.compValue=function compValue(t,e,a,r){return void 0===t&&(t=!1),void 0===e&&(e=0),void 0===a&&(a=Number.MIN_VALUE),void 0===r&&(r=Number.MAX_VALUE),function(i,o){regField(i,o,{compValue:"1",integer:t?"1":"0",defvalue:e.toString(),min:a.toString(),max:r.toString()})}},t.compCall=function compCall(t){return void 0===t&&(t=null),function(e,a,r){regFunc(e,a,{compcall:"1"}),regFunc(e,a,t)}},t.SerializeType=function SerializeType(t){regType(t.prototype,{SerializeType:"1"})},t.Field=function Field(t,e,a){return void 0===e&&(e=void 0),void 0===a&&(a=void 0),function(a,r){regField(a,r,{SerializeField:!0,valueType:t}),void 0==e||regField(a,r,{defaultValue:e})}},t.UIComment=function UIComment(t){return function(e,a){regField(e,a,{UIComment:t})}};!function(t){t[t.None=0]="None",t[t.RangeFloat=1]="RangeFloat",t[t.MultiLineString=2]="MultiLineString",t[t.Enum=3]="Enum"}(t.FieldUIStyle||(t.FieldUIStyle={})),t.UIStyle=function UIStyle(t,e,a,r){return function(i,o){regField(i,o,{FieldUIStyle:t,min:e||null,max:a||null,defvalue:r||null})}}}(t.reflect||(t.reflect={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function canvas(){this.is2dUI=!0,this.pointDown=!1,this.pointSelect=null,this.pointEvent=new e.PointEvent,this.pointX=0,this.pointY=0,this.pixelWidth=640,this.pixelHeight=480,this.rootNode=new e.transform2D,this.rootNode.canvas=this}return canvas.prototype.addChild=function(t){this.rootNode.addChild(t)},canvas.prototype.removeChild=function(t){this.rootNode.removeChild(t)},canvas.prototype.getChildren=function(){return this.rootNode.children},canvas.prototype.getChildCount=function(){return null==this.rootNode.children?0:this.rootNode.children.length},canvas.prototype.getChild=function(t){return this.rootNode.children[t]},canvas.prototype.update=function(t,a,r,i){this.pixelWidth,this.pixelHeight;this.rootNode.localScale.x=2/this.pixelWidth,this.rootNode.localScale.y=-2/this.pixelHeight,this.rootNode.localTranslate.y=1,this.rootNode.localTranslate.x=-1,this.rootNode.width=this.pixelWidth,this.rootNode.height=this.pixelHeight,this.rootNode.pivot.x=0,this.rootNode.pivot.y=0,this.rootNode.updateTran(!1),this.pointEvent.eated=!1,this.pointEvent.x=r,this.pointEvent.y=i,this.pointEvent.selected=this.pointSelect;var o=!1;0==this.pointDown&&0==a?o=!0:0==this.pointDown&&1==a?this.pointEvent.type=e.PointEventEnum.PointDown:1==this.pointDown&&1==a?(this.pointEvent.type=e.PointEventEnum.PointHold,this.pointX==this.pointEvent.x&&this.pointY==this.pointEvent.y&&(o=!0)):1==this.pointDown&&0==a&&(this.pointEvent.type=e.PointEventEnum.PointUp),o||(this.rootNode.onCapturePointEvent(this,this.pointEvent),this.rootNode.onPointEvent(this,this.pointEvent),this.pointSelect=this.pointEvent.selected,this.pointDown=a,this.pointX=this.pointEvent.x,this.pointY=this.pointEvent.y),this.rootNode.update(t)},canvas.prototype.render=function(a,r){if(this.context=a,this.assetmgr=r,this.lastMat=null,null==this.batcher){this.webgl=a.webgl,this.batcher=new e.batcher2D;var i=t.render.VertexFormatMask.Position|t.render.VertexFormatMask.Color|t.render.VertexFormatMask.UV0|t.render.VertexFormatMask.ColorEX;this.batcher.initBuffer(a.webgl,i,t.render.DrawModeEnum.VboTri)}this.drawScene(this.rootNode,a,r),this.batcher.end(a.webgl),null!=this.afterRender&&this.afterRender()},canvas.prototype.pushRawData=function(t,e){if(t!=this.lastMat){this.lastMat=t,this.batcher.end(this.webgl);var a=this.lastMat.getShader().passes.base[0];t.setMatrix("glstate_matrix_mvp",this.context.matrixModelViewProject),t.uploadUniform(a),a.use(this.webgl),this.batcher.begin(this.webgl,a)}this.batcher.push(this.webgl,e,null)},canvas.prototype.drawScene=function(t,e,a){if(null!=t.renderer&&t.renderer.render(this),null!=t.children)for(var r=0;r<t.children.length;r++)this.drawScene(t.children[r],e,a)},canvas.prototype.getRoot=function(){return null==this.rootNode&&(this.rootNode=new e.transform2D,this.rootNode.canvas=this,this.scene.app.markNotify(this.rootNode,e.NotifyType.AddChild)),this.rootNode},canvas}();__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],a.prototype,"pixelWidth",void 0),__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],a.prototype,"pixelHeight",void 0),__decorate([t.reflect.Field("transform2D"),__metadata("design:type",e.transform2D)],a.prototype,"rootNode",void 0),a=__decorate([t.reflect.SerializeType,__metadata("design:paramtypes",[])],a),e.canvas=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function batcher2D(){this.vboCount=0,this.eboCount=0}return batcher2D.prototype.initBuffer=function(e,a,r){this.mesh=new t.render.glMesh,this.mesh.initBuffer(e,a,128,t.render.MeshTypeEnum.Dynamic),this.dataForVbo=new Float32Array(128),this.drawMode=r,r!=t.render.DrawModeEnum.EboLine&&r!=t.render.DrawModeEnum.EboTri||(this.mesh.addIndex(e,128),this.dataForEbo=new Uint16Array(128))},batcher2D.prototype.begin=function(t,e){this.vboCount>0&&this.end(t),this.curPass=e},batcher2D.prototype.push=function(e,a,r){if((this.vboCount+a.length>2048||null!=r&&this.eboCount+r.length>2048)&&this.end(e),this.vboCount+a.length>this.dataForVbo.length){for(var i=new Float32Array(2*this.dataForVbo.length),o=0;o<this.dataForVbo.length;o++)i[o]=this.dataForVbo[o];this.dataForVbo=i,this.mesh.resetVboSize(e,this.dataForVbo.length)}for(o=0;o<a.length;o++)this.dataForVbo[this.vboCount+o]=a[o];if(this.vboCount+=a.length,this.drawMode!=t.render.DrawModeEnum.VboLine&&this.drawMode!=t.render.DrawModeEnum.VboTri&&null!=r){if(this.eboCount+r.length>this.dataForEbo.length){for(var i=new Uint16Array(2*this.dataForEbo.length),o=0;o<this.dataForEbo.length;o++)i[o]=this.dataForEbo[o];this.dataForEbo=i,this.mesh.resetEboSize(e,0,this.dataForEbo.length)}for(o=0;o<r.length;o++)this.dataForEbo[this.eboCount+o]=r[o];this.eboCount+=r.length}},batcher2D.prototype.end=function(e){if(0!=this.vboCount){this.mesh.uploadVertexSubData(e,this.dataForVbo.slice(0,this.vboCount),0),this.eboCount>0&&this.mesh.uploadIndexSubData(e,0,this.dataForEbo.slice(0,this.eboCount),0);var a=this.vboCount/(this.mesh.vertexByteSize/4)|0;this.curPass.use(e),this.mesh.bind(e,this.curPass.program,this.drawMode==t.render.DrawModeEnum.EboLine||this.drawMode==t.render.DrawModeEnum.EboTri?0:-1),this.drawMode==t.render.DrawModeEnum.EboLine?this.mesh.drawElementLines(e,0,this.eboCount):this.drawMode==t.render.DrawModeEnum.EboTri?this.mesh.drawElementTris(e,0,this.eboCount):this.drawMode==t.render.DrawModeEnum.VboLine?this.mesh.drawArrayLines(e,0,a):this.drawMode==t.render.DrawModeEnum.VboTri&&this.mesh.drawArrayTris(e,0,a),this.vboCount=0,this.eboCount=0}},batcher2D}();e.batcher2D=a;var r=function(){function canvasRenderer(){this.layer=e.RenderLayerEnum.Common,this.queue=0,this.renderLayer=e.CullingMask.default,this.canvas=new e.canvas,this.canvas.is2dUI=!1}return canvasRenderer.prototype.getBound=function(){return null},canvasRenderer.prototype.intersectsTransform=function(t){return!1},canvasRenderer.prototype.start=function(){this.canvas.scene=this.gameObject.getScene(),this.canvas.parentTrans=this.gameObject.transform,this.inputmgr=this.gameObject.getScene().app.getInputMgr()},canvasRenderer.prototype.addChild=function(t){this.canvas.addChild(t)},canvasRenderer.prototype.removeChild=function(t){this.canvas.removeChild(t)},canvasRenderer.prototype.getChildren=function(){return this.canvas.getChildren()},canvasRenderer.prototype.getChildCount=function(){return this.canvas.getChildCount()},canvasRenderer.prototype.getChild=function(t){return this.canvas.getChild(t)},canvasRenderer.prototype.update=function(e){var a=this.canvas.pixelWidth/this.canvas.pixelHeight;if(this.gameObject.transform.localScale.x=this.gameObject.transform.localScale.y*a,null!=this.cameraTouch){var r=this.gameObject.getScene(),i=this.cameraTouch.creatRayByScreen(new t.math.vector2(this.inputmgr.point.x,this.inputmgr.point.y),r.app),o=r.pick(i);if(null!=o&&o.pickedtran==this.gameObject.transform){var n=this.gameObject.transform.getWorldMatrix(),s=new t.math.matrix;t.math.matrixInverse(n,s);var l=new t.math.vector3;t.math.matrixTransformVector3(o.hitposition,s,l),this.canvas.update(e,this.inputmgr.point.touch,l.x,l.y)}else this.canvas.update(e,!1,0,0)}else this.canvas.update(e,!1,0,0)},canvasRenderer.prototype.pick2d=function(e){var a=e.intersectPlaneTransform(this.gameObject.transform);if(null!=a){var r=this.gameObject.transform.getWorldMatrix(),i=t.math.pool.new_matrix();t.math.matrixInverse(r,i);var o=t.math.pool.new_vector3();t.math.matrixTransformVector3(a.hitposition,i,o);var n=t.math.pool.new_vector2();n.x=o.x,n.y=o.y;var s=this.canvas.getRoot();return this.dopick2d(n,s)}return null},canvasRenderer.prototype.dopick2d=function(t,e){if(null!=e.components)for(r=e.components.length-1;r>=0;r--){var a=e.components[r];if(null!=a&&a.init&&a.comp.transform.ContainsCanvasPoint(t))return a.comp.transform}if(null!=e.children)for(var r=e.children.length-1;r>=0;r--){var i=this.dopick2d(t,e.children[r]);if(null!=i)return i}return null},canvasRenderer.prototype.render=function(t,e,a){t.updateModel(this.gameObject.transform),this.canvas.render(t,e)},canvasRenderer.prototype.jsonToAttribute=function(t,e){},canvasRenderer.prototype.remove=function(){},canvasRenderer.prototype.clone=function(){},canvasRenderer}();__decorate([t.reflect.Field("canvas"),__metadata("design:type",e.canvas)],r.prototype,"canvas",void 0),r=__decorate([t.reflect.nodeRender,t.reflect.nodeComponent,t.reflect.nodeCanvasRendererCollider,__metadata("design:paramtypes",[])],r),e.canvasRenderer=r}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(t){!function(t){t[t.PointNothing=0]="PointNothing",t[t.PointDown=1]="PointDown",t[t.PointHold=2]="PointHold",t[t.PointUp=3]="PointUp"}(t.PointEventEnum||(t.PointEventEnum={}));var e=function(){return function PointEvent(){}}();t.PointEvent=e;var a=function(){function UIEvent(){this.funcs=[]}return UIEvent.prototype.addListener=function(t){this.funcs.push(t)},UIEvent.prototype.excute=function(){for(var t in this.funcs)this.funcs[t]()},UIEvent.prototype.clear=function(){this.funcs.length=0},UIEvent}();t.UIEvent=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function overlay2D(){this.init=!1,this.autoAsp=!0,this.renderLayer=e.CullingMask.ui,this.canvas=new e.canvas,e.sceneMgr.app.markNotify(this.canvas.getRoot(),e.NotifyType.AddChild)}return overlay2D.prototype.start=function(t){this.camera=t,this.app=t.gameObject.getScene().app,this.canvas.scene=t.gameObject.getScene(),this.inputmgr=t.gameObject.getScene().app.getInputMgr()},overlay2D.prototype.addChild=function(t){this.canvas.addChild(t)},overlay2D.prototype.removeChild=function(t){this.canvas.removeChild(t)},overlay2D.prototype.getChildren=function(){return this.canvas.getChildren()},overlay2D.prototype.getChildCount=function(){return this.canvas.getChildCount()},overlay2D.prototype.getChild=function(t){return this.canvas.getChild(t)},overlay2D.prototype.render=function(e,a,r){if(this.canvas.getRoot().visible&&null!=this.camera&&void 0!=this.camera){if(this.autoAsp){var i=new t.math.rect;this.camera.calcViewPortPixel(a.app,i);var o=i.w/i.h;this.canvas.pixelWidth/this.canvas.pixelHeight!=o&&(this.canvas.pixelWidth=this.canvas.pixelHeight*o,this.canvas.getRoot().markDirty())}e.updateOverlay(),this.canvas.render(e,a)}},overlay2D.prototype.update=function(e){var a=new t.math.rect,r=(this.camera.calcViewPortPixel(this.app,a),this.inputmgr.point.x/a.w*2-1),i=this.inputmgr.point.y/a.h*-2+1;this.canvas.update(e,this.inputmgr.point.touch,r,i)},overlay2D.prototype.pick2d=function(e,a){if(null==this.camera)return null;var r=new t.math.rect,i=(this.camera.calcViewPortPixel(this.app,r),e/r.w*2-1),o=a/r.h*-2+1,n=t.math.pool.new_vector2();n.x=i,n.y=o;var s=this.canvas.getRoot();return this.dopick2d(n,s)},overlay2D.prototype.dopick2d=function(t,e){if(null!=e.components)for(r=e.components.length-1;r>=0;r--){var a=e.components[r];if(null!=a&&a.init&&a.comp.transform.ContainsCanvasPoint(t))return a.comp.transform}if(null!=e.children)for(var r=e.children.length-1;r>=0;r--){var i=this.dopick2d(t,e.children[r]);if(null!=i)return i}return null},overlay2D.prototype.calScreenPosToCanvasPos=function(e,a){var r=new t.math.rect;this.camera.calcViewPortPixel(this.app,r);var i=t.math.pool.new_vector2();i.x=e.x/r.w*2-1,i.y=e.y/r.h*-2+1;var o=t.math.pool.new_matrix3x2();t.math.matrix3x2Clone(this.canvas.getRoot().getWorldMatrix(),o),t.math.matrix3x2Inverse(o,o),t.math.matrix3x2TransformVector2(o,i,a),t.math.pool.delete_vector2(i)},overlay2D}();__decorate([t.reflect.Field("canvas"),__metadata("design:type",e.canvas)],a.prototype,"canvas",void 0),__decorate([t.reflect.Field("boolean"),__metadata("design:type",Boolean)],a.prototype,"autoAsp",void 0),a=__decorate([t.reflect.SerializeType,__metadata("design:paramtypes",[])],a),e.overlay2D=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function vector2(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return vector2.prototype.toString=function(){return this.x+","+this.y},vector2}();__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],a.prototype,"x",void 0),__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],a.prototype,"y",void 0),a=__decorate([t.reflect.SerializeType,__metadata("design:paramtypes",[Number,Number])],a),e.vector2=a;var r=function(){function rect(t,e,a,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===a&&(a=0),void 0===r&&(r=0),this.x=t,this.y=e,this.w=a,this.h=r}return rect.prototype.toString=function(){return this.x+","+this.y+","+this.w+","+this.h},rect}();__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],r.prototype,"x",void 0),__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],r.prototype,"y",void 0),__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],r.prototype,"w",void 0),__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],r.prototype,"h",void 0),r=__decorate([t.reflect.SerializeType,__metadata("design:paramtypes",[Number,Number,Number,Number])],r),e.rect=r;var i=function(){return function border(t,e,a,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===a&&(a=0),void 0===r&&(r=0),this.l=t,this.t=e,this.r=a,this.b=r}}();__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],i.prototype,"l",void 0),__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],i.prototype,"t",void 0),__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],i.prototype,"r",void 0),__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],i.prototype,"b",void 0),i=__decorate([t.reflect.SerializeType,__metadata("design:paramtypes",[Number,Number,Number,Number])],i),e.border=i;var o=function(){function color(t,e,a,r){void 0===t&&(t=1),void 0===e&&(e=1),void 0===a&&(a=1),void 0===r&&(r=1),this.r=t,this.g=e,this.b=a,this.a=r}return color.prototype.toString=function(){return this.r+","+this.g+","+this.b+","+this.a},color}();__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],o.prototype,"r",void 0),__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],o.prototype,"g",void 0),__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],o.prototype,"b",void 0),__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],o.prototype,"a",void 0),o=__decorate([t.reflect.SerializeType,__metadata("design:paramtypes",[Number,Number,Number,Number])],o),e.color=o;var n=function(){function vector3(t,e,a){void 0===t&&(t=0),void 0===e&&(e=0),void 0===a&&(a=0),this.x=t,this.y=e,this.z=a}return vector3.prototype.toString=function(){return this.x+","+this.y+","+this.z},vector3}();__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],n.prototype,"x",void 0),__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],n.prototype,"y",void 0),__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],n.prototype,"z",void 0),n=__decorate([t.reflect.SerializeType,__metadata("design:paramtypes",[Number,Number,Number])],n),e.vector3=n;var s=function(){function vector4(t,e,a,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===a&&(a=0),void 0===r&&(r=0),this.x=t,this.y=e,this.z=a,this.w=r}return vector4.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},vector4}();__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],s.prototype,"x",void 0),__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],s.prototype,"y",void 0),__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],s.prototype,"z",void 0),__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],s.prototype,"w",void 0),s=__decorate([t.reflect.SerializeType,__metadata("design:paramtypes",[Number,Number,Number,Number])],s),e.vector4=s;var l=function(){function quaternion(t,e,a,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===a&&(a=0),void 0===r&&(r=1),this.x=t,this.y=e,this.z=a,this.w=r}return quaternion.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},quaternion}();__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],l.prototype,"x",void 0),__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],l.prototype,"y",void 0),__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],l.prototype,"z",void 0),__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],l.prototype,"w",void 0),l=__decorate([t.reflect.SerializeType,__metadata("design:paramtypes",[Number,Number,Number,Number])],l),e.quaternion=l;var h=function(){function matrix(t){void 0===t&&(t=null),this.rawData=t||new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}return matrix.prototype.toString=function(){return"["+this.rawData[0]+","+this.rawData[1]+","+this.rawData[2]+","+this.rawData[3]+"],["+this.rawData[4]+","+this.rawData[5]+","+this.rawData[6]+","+this.rawData[7]+"],["+this.rawData[8]+","+this.rawData[9]+","+this.rawData[10]+","+this.rawData[11]+"],["+this.rawData[12]+","+this.rawData[13]+","+this.rawData[14]+","+this.rawData[15]+"]"},matrix}();e.matrix=h;var c=function(){function matrix3x2(t){void 0===t&&(t=null),this.rawData=t||new Float32Array([1,0,0,0,1,0])}return matrix3x2.prototype.toString=function(){return"["+this.rawData[0]+","+this.rawData[1]+","+this.rawData[2]+"],["+this.rawData[3]+","+this.rawData[4]+","+this.rawData[5]+"]"},matrix3x2}();e.matrix3x2=c}(t.math||(t.math={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){return function C2DComponent(t,e){void 0===e&&(e=!1),this.comp=t,this.init=e}}();__decorate([t.reflect.Field("I2DComponent"),__metadata("design:type",Object)],a.prototype,"comp",void 0),a=__decorate([t.reflect.SerializeType,__metadata("design:paramtypes",[Object,Boolean])],a),e.C2DComponent=a;var r=function(){function transform2D(){this.name="noname",this.pivot=new t.math.vector2(0,0),this.hideFlags=e.HideFlags.None,this._visible=!0,this.insId=new e.insID,this.dirty=!0,this.dirtyChild=!0,this.dirtyWorldDecompose=!1,this.localTranslate=new t.math.vector2(0,0),this.localScale=new t.math.vector2(1,1),this.localRotate=0,this.localMatrix=new t.math.matrix3x2,this.worldMatrix=new t.math.matrix3x2,this.worldRotate=new t.math.angelref,this.worldTranslate=new t.math.vector2(0,0),this.worldScale=new t.math.vector2(1,1),this.components=[]}return Object.defineProperty(transform2D.prototype,"canvas",{get:function(){return null==this._canvas?null==this.parent?null:this.parent.canvas:this._canvas},set:function(t){this._canvas=t},enumerable:!0,configurable:!0}),Object.defineProperty(transform2D.prototype,"visibleInScene",{get:function(){for(var t=this;t.visible;)t=t.parent;return t.visible},enumerable:!0,configurable:!0}),Object.defineProperty(transform2D.prototype,"visible",{get:function(){return this._visible},set:function(t){t!=this._visible&&(this._visible=t,e.sceneMgr.app.markNotify(this,e.NotifyType.ChangeVisible))},enumerable:!0,configurable:!0}),Object.defineProperty(transform2D.prototype,"transform",{get:function(){return this},enumerable:!0,configurable:!0}),transform2D.prototype.addChild=function(t){null!=t.parent&&t.parent.removeChild(t),null==this.children&&(this.children=[]),this.children.push(t),t.parent=this,t.canvas=this.canvas,e.sceneMgr.app.markNotify(t,e.NotifyType.AddChild)},transform2D.prototype.addChildAt=function(t,a){a<0||(null!=t.parent&&t.parent.removeChild(t),null==this.children&&(this.children=[]),this.children.splice(a,0,t),t.canvas=this.canvas,t.parent=this,e.sceneMgr.app.markNotify(t,e.NotifyType.AddChild))},transform2D.prototype.removeChild=function(t){if(t.parent!=this||null==this.children)throw new Error("not my child.");var a=this.children.indexOf(t);a>=0&&this.children.splice(a,1),e.sceneMgr.app.markNotify(t,e.NotifyType.RemoveChild)},transform2D.prototype.removeAllChild=function(){for(;this.children.length>0;)this.removeChild(this.children[0])},transform2D.prototype.markDirty=function(){this.dirty=!0;for(var t=this.parent;null!=t;)t.dirtyChild=!0,t=t.parent},transform2D.prototype.updateTran=function(e){if(0!=this.dirtyChild||0!=this.dirty||0!=e){if(this.dirty&&t.math.matrix3x2MakeTransformRTS(this.localTranslate,this.localScale,this.localRotate,this.localMatrix),(this.dirty||e)&&(null==this.parent?t.math.matrix3x2Clone(this.localMatrix,this.worldMatrix):t.math.matrix3x2Multiply(this.parent.worldMatrix,this.localMatrix,this.worldMatrix),null!=this.renderer&&this.renderer.updateTran(),this.dirtyWorldDecompose=!0),null!=this.children)for(var a=0;a<this.children.length;a++)this.children[a].updateTran(e||this.dirty);this.dirty=!1,this.dirtyChild=!1}},transform2D.prototype.updateWorldTran=function(){var t=this.parent,e=[];for(e.push(this);null!=t;)t.dirty&&e.push(t),t=t.parent;e.pop().updateTran(!1)},transform2D.prototype.getWorldTranslate=function(){return this.dirtyWorldDecompose&&(t.math.matrix3x2Decompose(this.worldMatrix,this.worldScale,this.worldRotate,this.worldTranslate),this.dirtyWorldDecompose=!1),this.worldTranslate},transform2D.prototype.getWorldScale=function(){return this.dirtyWorldDecompose&&(t.math.matrix3x2Decompose(this.worldMatrix,this.worldScale,this.worldRotate,this.worldTranslate),this.dirtyWorldDecompose=!1),this.worldScale},transform2D.prototype.getWorldRotate=function(){return this.dirtyWorldDecompose&&(t.math.matrix3x2Decompose(this.worldMatrix,this.worldScale,this.worldRotate,this.worldTranslate),this.dirtyWorldDecompose=!1),this.worldRotate},transform2D.prototype.getLocalMatrix=function(){return this.localMatrix},transform2D.prototype.getWorldMatrix=function(){return this.worldMatrix},transform2D.prototype.setWorldPosition=function(e){this.dirty=!0,this.updateWorldTran();var a=this.getWorldTranslate(),r=t.math.pool.new_vector2();r.x=e.x-a.x,r.y=e.y-a.y;var i=t.math.pool.new_matrix3x2();null!=this.parent?t.math.matrix3x2Clone(this.parent.worldMatrix,i):t.math.matrix3x2MakeIdentity(i);var o=t.math.pool.new_matrix3x2();t.math.matrix3x2Inverse(i,o);var n=t.math.pool.new_vector2();t.math.matrix3x2TransformNormal(o,r,n),this.localTranslate.x+=n.x,this.localTranslate.y+=n.y,t.math.pool.delete_matrix3x2(o),t.math.pool.delete_vector2(r),t.math.pool.delete_vector2(n)},transform2D.prototype.dispose=function(){if(this.children){for(var t in this.children)this.children[t].dispose();this.removeAllChild()}this.removeAllComponents()},transform2D.prototype.update=function(t){if(null!=this.components)for(a=0;a<this.components.length;a++)0==this.components[a].init&&(this.components[a].comp.start(),this.components[a].init=!0),e.sceneMgr.app.bePlay&&!e.sceneMgr.app.bePause&&this.components[a].comp.update(t);if(null!=this.children)for(var a=0;a<this.children.length;a++)this.children[a].update(t)},transform2D.prototype.addComponentDirect=function(e){if(null!=e.transform)throw new Error("this components has added to a  gameObject");e.transform=this,null==this.components&&(this.components=[]);var r=new a(e,!1);if(this.components.push(r),"1"==t.reflect.getClassTag(e.__proto__,"renderer")){if(null!=this.renderer)throw new Error("已经有一个渲染器的组件了，不能俩");this.renderer=e}return e},transform2D.prototype.getComponent=function(e){for(var a=0;a<this.components.length;a++)if(t.reflect.getClassName(this.components[a].comp.__proto__)==e)return this.components[a].comp;return null},transform2D.prototype.getComponents=function(){for(var t=[],e=0;e<this.components.length;e++)t.push(this.components[e].comp);return t},transform2D.prototype.getComponentsInChildren=function(t){var e=[];return this.getNodeCompoents(this,t,e),e},transform2D.prototype.getNodeCompoents=function(e,a,r){for(var i in e.components)t.reflect.getClassName(e.components[i].comp.__proto__)==a&&r.push(this.components[i].comp);if(null!=e.children)for(var i in e.children)this.getNodeCompoents(e.children[i],a,r)},transform2D.prototype.addComponent=function(e){null==this.components&&(this.components=[]);for(var a in this.components)if(this.components[a].comp.constructor.name==e)throw new Error("已经有一个"+e+"的组件了，不能俩");var r=t.reflect.getPrototype(e),i=t.reflect.createInstance(r,{"2dcomp":"1"});return this.addComponentDirect(i)},transform2D.prototype.removeComponent=function(t){for(var e=0;e<this.components.length;e++)this.components[e].comp==t&&(this.components[e].init,this.components.splice(e,1))},transform2D.prototype.removeComponentByTypeName=function(e){for(var a=0;a<this.components.length;a++)if(t.reflect.getClassName(this.components[a].comp)==e){var r=this.components.splice(a,1);return r[0].comp==this.renderer&&(this.renderer=null),r[0]}},transform2D.prototype.removeAllComponents=function(){for(var t=0;t<this.components.length;t++)this.components[t].comp.remove(),this.components[t].comp==this.renderer&&(this.renderer=null);this.components.length=0},transform2D.prototype.onCapturePointEvent=function(t,e){if(null!=this.components)for(r=0;r<=this.components.length;r++)if(0==e.eated){var a=this.components[r];null!=a&&a.init&&a.comp.onPointEvent(t,e,!0)}if(0==e.eated&&null!=this.children)for(var r=0;r<=this.children.length;r++){var i=this.children[r];null!=i&&i.onCapturePointEvent(t,e)}},transform2D.prototype.ContainsPoint=function(e){var a=new t.math.vector2;return a.x=e.x+this.pivot.x*this.width,a.y=e.y+this.pivot.y*this.height,a.x>=0&&a.y>=0&&a.x<this.width&&a.y<this.height},transform2D.prototype.ContainsCanvasPoint=function(e){var a=this.getWorldMatrix(),r=new t.math.matrix3x2;t.math.matrix3x2Inverse(a,r);var i=new t.math.vector2;return t.math.matrix3x2TransformVector2(r,e,i),i.x+=this.pivot.x*this.width,i.y+=this.pivot.y*this.height,i.x>=0&&i.y>=0&&i.x<this.width&&i.y<this.height},transform2D.prototype.onPointEvent=function(t,e){if(null!=this.children)for(r=this.children.length-1;r>=0;r--)if(0==e.eated){var a=this.children[r];null!=a&&a.onPointEvent(t,e)}if(0==e.eated&&null!=this.components)for(var r=this.components.length-1;r>=0;r--){var i=this.components[r];null!=i&&i.init&&i.comp.onPointEvent(t,e,!1)}},transform2D}();__decorate([t.reflect.Field("string"),__metadata("design:type",String)],r.prototype,"name",void 0),__decorate([t.reflect.Field("transform2D[]"),__metadata("design:type",Array)],r.prototype,"children",void 0),__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],r.prototype,"width",void 0),__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],r.prototype,"height",void 0),__decorate([t.reflect.Field("vector2"),__metadata("design:type",t.math.vector2)],r.prototype,"pivot",void 0),__decorate([t.reflect.Field("vector2"),__metadata("design:type",t.math.vector2)],r.prototype,"localTranslate",void 0),__decorate([t.reflect.Field("vector2"),__metadata("design:type",t.math.vector2)],r.prototype,"localScale",void 0),__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],r.prototype,"localRotate",void 0),__decorate([t.reflect.Field("C2DComponent[]"),__metadata("design:type",Array)],r.prototype,"components",void 0),r=__decorate([t.reflect.SerializeType],r),e.transform2D=r}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a;!function(t){t[t.None=0]="None",t[t.ColorTint=1]="ColorTint",t[t.SpriteSwap=2]="SpriteSwap"}(a=e.TransitionType||(e.TransitionType={}));var r=function(){function button(){this._transition=a.ColorTint,this._normalColor=new t.math.color(1,1,1,1),this._pressedColor=new t.math.color(.5,.5,.5,1),this._fadeDuration=.1,this.onClick=new e.UIEvent,this._downInThis=!1,this._dragOut=!1}return Object.defineProperty(button.prototype,"transition",{get:function(){return this._transition},set:function(t){this._transition=t,null!=this._targetImage&&(t==a.ColorTint?this._targetImage.color=this.normalColor:this._targetImage.color=this._originalColor)},enumerable:!0,configurable:!0}),Object.defineProperty(button.prototype,"targetImage",{get:function(){return this._targetImage},set:function(t){null!=this._targetImage&&(this._targetImage.color=this._originalColor),null!=t?(this._originalColor=t.color,this._originalSprite=t.sprite,(this._transition=a.ColorTint)&&(t.color=this.normalColor)):(this._originalColor=null,this._originalSprite=null),this._targetImage=t},enumerable:!0,configurable:!0}),Object.defineProperty(button.prototype,"pressedGraphic",{get:function(){return this._pressedSprite},set:function(t){this._pressedSprite=t},enumerable:!0,configurable:!0}),Object.defineProperty(button.prototype,"normalColor",{get:function(){return this._normalColor},set:function(t){this._normalColor=t,null!=this._targetImage&&this.transition==a.ColorTint&&(this._targetImage.color=t)},enumerable:!0,configurable:!0}),Object.defineProperty(button.prototype,"pressedColor",{get:function(){return this._pressedColor},set:function(t){this._pressedColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(button.prototype,"fadeDuration",{get:function(){return this._fadeDuration},set:function(t){this._fadeDuration=t},enumerable:!0,configurable:!0}),button.prototype.render=function(t){},button.prototype.updateTran=function(){},button.prototype.start=function(){},button.prototype.update=function(t){},button.prototype.remove=function(){},button.prototype.onPointEvent=function(a,r,i){0==i&&(this.transform.ContainsCanvasPoint(new t.math.vector2(r.x,r.y))?r.type==e.PointEventEnum.PointDown?(this._downInThis=!0,this.showPress()):r.type==e.PointEventEnum.PointHold&&this._downInThis?1==this._dragOut&&(this._dragOut=!1,this.showPress()):r.type==e.PointEventEnum.PointUp&&this._downInThis&&(this._downInThis=!1,this.showNormal(),this.onClick.excute()):r.type==e.PointEventEnum.PointUp?this._downInThis=!1:r.type==e.PointEventEnum.PointHold&&this._downInThis&&0==this._dragOut&&(this._dragOut=!0,this.showNormal()))},button.prototype.showNormal=function(){this.transition==a.ColorTint?this.changeColor(this._normalColor):this.transition==a.SpriteSwap&&this.changeSprite(this._originalSprite)},button.prototype.showPress=function(){this.transition==a.ColorTint?this.changeColor(this._pressedColor):this.transition==a.SpriteSwap&&(null!=this._targetImage&&null!=this._targetImage.sprite&&null==this._originalSprite&&(this._originalSprite=this._targetImage.sprite),this.changeSprite(this._pressedSprite))},button.prototype.changeColor=function(t){null!=this._targetImage&&(this._targetImage.color=t,this._targetImage.transform.markDirty())},button.prototype.changeSprite=function(t){null!=t&&null!=this._targetImage&&(this._targetImage.sprite=t,this._targetImage.transform.markDirty())},button}();__decorate([t.reflect.Field("number"),__metadata("design:type",Object),__metadata("design:paramtypes",[Number])],r.prototype,"transition",null),__decorate([t.reflect.Field("color"),__metadata("design:type",Object),__metadata("design:paramtypes",[t.math.color])],r.prototype,"normalColor",null),__decorate([t.reflect.Field("number"),__metadata("design:type",Object),__metadata("design:paramtypes",[Number])],r.prototype,"fadeDuration",null),r=__decorate([t.reflect.node2DComponent],r),e.button=r}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function image2D(){this.datar=[0,0,0,1,1,1,1,0,0,1,1,1,1,0,0,0,1,1,1,1,1,0,1,1,1,1,0,0,0,1,1,1,1,0,1,1,1,1,1,0,0,0,1,1,1,1,0,1,1,1,1,1,0,0,0,1,1,1,1,1,0,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1],this.color=new t.math.color(1,1,1,1),this._imageType=r.Simple,this._fillMethod=i.Horizontal,this._fillAmmount=1,t.io.enumMgr.enumMap.ImageType=r,t.io.enumMgr.enumMap.FillMethod=i}return Object.defineProperty(image2D.prototype,"imageType",{get:function(){return this._imageType},set:function(t){this._imageType=t,this.prepareData(),null!=this.transform&&this.transform.markDirty()},enumerable:!0,configurable:!0}),Object.defineProperty(image2D.prototype,"fillMethod",{get:function(){return this._fillMethod},set:function(t){this._fillMethod=t,this.prepareData(),null!=this.transform&&this.transform.markDirty()},enumerable:!0,configurable:!0}),Object.defineProperty(image2D.prototype,"fillAmmount",{get:function(){return this._fillAmmount},set:function(t){this._fillAmmount=t,null!=this.transform&&this.transform.markDirty()},enumerable:!0,configurable:!0}),image2D.prototype.setTexture=function(a,r,i){var o=new e.sprite;o.texture=a,o.border=null!=r?r:new t.math.border(0,0,0,0),o.rect=null!=i?i:new t.math.rect(0,0,a.glTexture.width,a.glTexture.height),this.sprite=o,this.prepareData(),null!=this.transform&&this.transform.markDirty()},Object.defineProperty(image2D.prototype,"sprite",{get:function(){return this._sprite},set:function(t){this._sprite&&this._sprite.unuse(),this._sprite=t,this._sprite.use(),this.prepareData(),this.transform.markDirty()},enumerable:!0,configurable:!0}),image2D.prototype.render=function(t){null==this.mat&&(this.mat=new e.material,this.mat.setShader(t.assetmgr.getShader("shader/defui")));var a=null;null!=this._sprite&&null!=this._sprite.texture&&(a=this._sprite.texture),this.mat.setTexture("_MainTex",a),t.pushRawData(this.mat,this.datar)},image2D.prototype.start=function(){},image2D.prototype.update=function(t){},image2D.prototype.remove=function(){this._sprite.unuse(!0),this.datar.length=0},image2D.prototype.onPointEvent=function(t,e,a){},image2D.prototype.prepareData=function(){if(null!=this._sprite){var t=this._sprite.urange,e=this._sprite.vrange,a=t.y-t.x,o=e.y-e.x;switch(this._imageType){case r.Simple:this.datar=[0,0,0,1,1,1,1,t.x,e.x,1,1,1,1,0,0,0,1,1,1,1,t.y,e.x,1,1,1,1,0,0,0,1,1,1,1,t.x,e.y,1,1,1,1,0,0,0,1,1,1,1,t.x,e.y,1,1,1,1,0,0,0,1,1,1,1,t.y,e.x,1,1,1,1,0,0,0,1,1,1,1,t.y,e.y,1,1,1,1];break;case r.Sliced:this.datar=[0,0,0,1,1,1,1,t.x,e.x,1,1,1,1,0,0,0,1,1,1,1,t.y,e.x,1,1,1,1,0,0,0,1,1,1,1,t.x,e.y,1,1,1,1,0,0,0,1,1,1,1,t.x,e.y,1,1,1,1,0,0,0,1,1,1,1,t.y,e.x,1,1,1,1,0,0,0,1,1,1,1,t.y,e.y,1,1,1,1,0,0,0,1,1,1,1,t.x,e.x,1,1,1,1,0,0,0,1,1,1,1,t.y,e.x,1,1,1,1,0,0,0,1,1,1,1,t.x,e.y,1,1,1,1,0,0,0,1,1,1,1,t.x,e.y,1,1,1,1,0,0,0,1,1,1,1,t.y,e.x,1,1,1,1,0,0,0,1,1,1,1,t.y,e.y,1,1,1,1,0,0,0,1,1,1,1,t.x,e.x,1,1,1,1,0,0,0,1,1,1,1,t.y,e.x,1,1,1,1,0,0,0,1,1,1,1,t.x,e.y,1,1,1,1,0,0,0,1,1,1,1,t.x,e.y,1,1,1,1,0,0,0,1,1,1,1,t.y,e.x,1,1,1,1,0,0,0,1,1,1,1,t.y,e.y,1,1,1,1,0,0,0,1,1,1,1,t.x,e.x,1,1,1,1,0,0,0,1,1,1,1,t.y,e.x,1,1,1,1,0,0,0,1,1,1,1,t.x,e.y,1,1,1,1,0,0,0,1,1,1,1,t.x,e.y,1,1,1,1,0,0,0,1,1,1,1,t.y,e.x,1,1,1,1,0,0,0,1,1,1,1,t.y,e.y,1,1,1,1,0,0,0,1,1,1,1,t.x,e.x,1,1,1,1,0,0,0,1,1,1,1,t.y,e.x,1,1,1,1,0,0,0,1,1,1,1,t.x,e.y,1,1,1,1,0,0,0,1,1,1,1,t.x,e.y,1,1,1,1,0,0,0,1,1,1,1,t.y,e.x,1,1,1,1,0,0,0,1,1,1,1,t.y,e.y,1,1,1,1,0,0,0,1,1,1,1,t.x,e.x,1,1,1,1,0,0,0,1,1,1,1,t.y,e.x,1,1,1,1,0,0,0,1,1,1,1,t.x,e.y,1,1,1,1,0,0,0,1,1,1,1,t.x,e.y,1,1,1,1,0,0,0,1,1,1,1,t.y,e.x,1,1,1,1,0,0,0,1,1,1,1,t.y,e.y,1,1,1,1,0,0,0,1,1,1,1,t.x,e.x,1,1,1,1,0,0,0,1,1,1,1,t.y,e.x,1,1,1,1,0,0,0,1,1,1,1,t.x,e.y,1,1,1,1,0,0,0,1,1,1,1,t.x,e.y,1,1,1,1,0,0,0,1,1,1,1,t.y,e.x,1,1,1,1,0,0,0,1,1,1,1,t.y,e.y,1,1,1,1,0,0,0,1,1,1,1,t.x,e.x,1,1,1,1,0,0,0,1,1,1,1,t.y,e.x,1,1,1,1,0,0,0,1,1,1,1,t.x,e.y,1,1,1,1,0,0,0,1,1,1,1,t.x,e.y,1,1,1,1,0,0,0,1,1,1,1,t.y,e.x,1,1,1,1,0,0,0,1,1,1,1,t.y,e.y,1,1,1,1,0,0,0,1,1,1,1,t.x,e.x,1,1,1,1,0,0,0,1,1,1,1,t.y,e.x,1,1,1,1,0,0,0,1,1,1,1,t.x,e.y,1,1,1,1,0,0,0,1,1,1,1,t.x,e.y,1,1,1,1,0,0,0,1,1,1,1,t.y,e.x,1,1,1,1,0,0,0,1,1,1,1,t.y,e.y,1,1,1,1];break;case r.Tiled:this.datar=[];break;case r.Filled:var n=t.x+.5*a,s=e.x+.5*o;switch(this._fillMethod){case i.Horizontal:case i.Vertical:case i.Radial_90:this.datar=[0,0,0,1,1,1,1,t.x,e.x,1,1,1,1,0,0,0,1,1,1,1,t.y,e.x,1,1,1,1,0,0,0,1,1,1,1,t.x,e.y,1,1,1,1,0,0,0,1,1,1,1,t.x,e.y,1,1,1,1,0,0,0,1,1,1,1,t.y,e.x,1,1,1,1,0,0,0,1,1,1,1,t.y,e.y,1,1,1,1];break;case i.Radial_180:this.datar=[0,0,0,1,1,1,1,t.x,e.x,1,1,1,1,0,0,0,1,1,1,1,n,e.x,1,1,1,1,0,0,0,1,1,1,1,n,e.y,1,1,1,1,0,0,0,1,1,1,1,t.x,e.x,1,1,1,1,0,0,0,1,1,1,1,n,e.y,1,1,1,1,0,0,0,1,1,1,1,t.x,e.y,1,1,1,1,0,0,0,1,1,1,1,n,e.x,1,1,1,1,0,0,0,1,1,1,1,t.y,e.x,1,1,1,1,0,0,0,1,1,1,1,n,e.y,1,1,1,1,0,0,0,1,1,1,1,n,e.y,1,1,1,1,0,0,0,1,1,1,1,t.y,e.x,1,1,1,1,0,0,0,1,1,1,1,t.y,e.y,1,1,1,1];break;case i.Radial_360:this.datar=[0,0,0,1,1,1,1,t.x,e.x,1,1,1,1,0,0,0,1,1,1,1,n,e.x,1,1,1,1,0,0,0,1,1,1,1,n,s,1,1,1,1,0,0,0,1,1,1,1,t.x,e.x,1,1,1,1,0,0,0,1,1,1,1,n,s,1,1,1,1,0,0,0,1,1,1,1,t.x,s,1,1,1,1,0,0,0,1,1,1,1,n,e.x,1,1,1,1,0,0,0,1,1,1,1,t.y,e.x,1,1,1,1,0,0,0,1,1,1,1,n,s,1,1,1,1,0,0,0,1,1,1,1,n,s,1,1,1,1,0,0,0,1,1,1,1,t.y,e.x,1,1,1,1,0,0,0,1,1,1,1,t.y,s,1,1,1,1,0,0,0,1,1,1,1,t.x,s,1,1,1,1,0,0,0,1,1,1,1,n,s,1,1,1,1,0,0,0,1,1,1,1,t.x,e.y,1,1,1,1,0,0,0,1,1,1,1,t.x,e.y,1,1,1,1,0,0,0,1,1,1,1,n,s,1,1,1,1,0,0,0,1,1,1,1,n,e.y,1,1,1,1,0,0,0,1,1,1,1,n,s,1,1,1,1,0,0,0,1,1,1,1,t.y,s,1,1,1,1,0,0,0,1,1,1,1,t.y,e.y,1,1,1,1,0,0,0,1,1,1,1,n,s,1,1,1,1,0,0,0,1,1,1,1,t.y,e.y,1,1,1,1,0,0,0,1,1,1,1,n,e.y,1,1,1,1]}}}},image2D.prototype.updateTran=function(){var t=this.transform.getWorldMatrix(),e=-this.transform.pivot.x*this.transform.width,a=this.transform.width+e,i=-this.transform.pivot.y*this.transform.height,o=this.transform.height+i,n=e*t.rawData[0]+i*t.rawData[2]+t.rawData[4],s=e*t.rawData[1]+i*t.rawData[3]+t.rawData[5],l=a*t.rawData[0]+i*t.rawData[2]+t.rawData[4],h=a*t.rawData[1]+i*t.rawData[3]+t.rawData[5],c=e*t.rawData[0]+o*t.rawData[2]+t.rawData[4],u=e*t.rawData[1]+o*t.rawData[3]+t.rawData[5],d=a*t.rawData[0]+o*t.rawData[2]+t.rawData[4],m=a*t.rawData[1]+o*t.rawData[3]+t.rawData[5];if(null!=this._sprite){switch(this._imageType){case r.Simple:this.updateSimpleData(n,s,l,h,c,u,d,m);break;case r.Sliced:this.updateSlicedData(n,s,l,h,c,u,d,m);break;case r.Tiled:this.updateTiledData(n,s,l,h,c,u,d,m);break;case r.Filled:this.updateFilledData(n,s,l,h,c,u,d,m)}for(var p=this.datar.length/13,f=0;f<p;f++)this.datar[13*f+3]=this.color.r,this.datar[13*f+4]=this.color.g,this.datar[13*f+5]=this.color.b,this.datar[13*f+6]=this.color.a}},image2D.prototype.updateQuadData=function(t,e,a,r,i,o,n,s,l,h){void 0===l&&(l=0),void 0===h&&(h=!1);var c=6*l;h?(this.datar[13*(c+0)]=t,this.datar[13*(c+0)+1]=e,this.datar[13*(c+1)]=a,this.datar[13*(c+1)+1]=r,this.datar[13*(c+2)]=n,this.datar[13*(c+2)+1]=s,this.datar[13*(c+3)]=t,this.datar[13*(c+3)+1]=e,this.datar[13*(c+4)]=n,this.datar[13*(c+4)+1]=s,this.datar[13*(c+5)]=i,this.datar[13*(c+5)+1]=o):(this.datar[13*(c+0)]=t,this.datar[13*(c+0)+1]=e,this.datar[13*(c+1)]=a,this.datar[13*(c+1)+1]=r,this.datar[13*(c+2)]=i,this.datar[13*(c+2)+1]=o,this.datar[13*(c+3)]=i,this.datar[13*(c+3)+1]=o,this.datar[13*(c+4)]=a,this.datar[13*(c+4)+1]=r,this.datar[13*(c+5)]=n,this.datar[13*(c+5)+1]=s)},image2D.prototype.updateSimpleData=function(t,e,a,r,i,o,n,s){this.updateQuadData(t,e,a,r,i,o,n,s)},image2D.prototype.updateSlicedData=function(e,a,r,i,o,n,s,l){var h=this._sprite.border,c=this._sprite.rect,u=t.math.pool.new_vector2(),d=t.math.pool.new_vector2(),m=t.math.pool.new_vector2(),p=t.math.pool.new_vector2(),f=t.math.pool.new_vector2(),v=t.math.pool.new_vector2(),g=t.math.pool.new_vector2(),y=t.math.pool.new_vector2(),_=t.math.pool.new_vector2(),w=t.math.pool.new_vector2(),b=t.math.pool.new_vector2(),x=t.math.pool.new_vector2(),D=t.math.pool.new_vector2(),T=t.math.pool.new_vector2(),E=t.math.pool.new_vector2(),S=t.math.pool.new_vector2(),A=t.math.pool.new_vector2(),M=t.math.pool.new_vector2(),R=t.math.pool.new_vector2(),C=t.math.pool.new_vector2(),P=t.math.pool.new_vector2(),F=t.math.pool.new_vector2(),I=t.math.pool.new_vector2(),V=t.math.pool.new_vector2(),U=t.math.pool.new_vector2(),k=t.math.pool.new_vector2(),N=t.math.pool.new_vector2(),B=t.math.pool.new_vector2(),O=t.math.pool.new_vector2(),L=t.math.pool.new_vector2(),z=t.math.pool.new_vector2(),j=t.math.pool.new_vector2(),W=t.math.pool.new_vector2(),G=t.math.pool.new_vector2(),q=t.math.pool.new_vector2();u.x=e,u.y=a,d.x=r,d.y=i,m.x=o,m.y=n,p.x=s,p.y=l;t.math.vec2Distance(u,d),t.math.vec2Distance(u,m);var X=this._sprite.urange,H=this._sprite.vrange,Q=h.l/this.transform.width,Y=h.r/this.transform.width,K=h.t/this.transform.height,J=h.b/this.transform.height,Z=h.l/c.w*(X.y-X.x),$=h.r/c.w*(X.y-X.x),tt=h.t/c.h*(H.y-H.x),et=h.b/c.h*(H.y-H.x);t.math.vec2Subtract(d,u,f),t.math.vec2ScaleByNum(f,Q,f),t.math.vec2Add(f,u,f),t.math.vec2Subtract(u,d,v),t.math.vec2ScaleByNum(v,Y,v),t.math.vec2Add(v,d,v),t.math.vec2Subtract(m,u,g),t.math.vec2ScaleByNum(g,K,g),t.math.vec2Add(g,u,g),t.math.vec2Subtract(u,m,y),t.math.vec2ScaleByNum(y,J,y),t.math.vec2Add(y,m,y),t.math.vec2Subtract(f,u,W),t.math.vec2Subtract(g,u,G),t.math.vec2Add(W,G,q),t.math.vec2Add(q,u,_),t.math.vec2Subtract(v,u,W),t.math.vec2Subtract(g,u,G),t.math.vec2Add(W,G,q),t.math.vec2Add(q,u,w),t.math.vec2Subtract(d,u,W),t.math.vec2Subtract(g,u,G),t.math.vec2Add(W,G,q),t.math.vec2Add(q,u,b),t.math.vec2Subtract(f,u,W),t.math.vec2Subtract(y,u,G),t.math.vec2Add(W,G,q),t.math.vec2Add(q,u,x),t.math.vec2Subtract(v,u,W),t.math.vec2Subtract(y,u,G),t.math.vec2Add(W,G,q),t.math.vec2Add(q,u,D),t.math.vec2Subtract(d,u,W),t.math.vec2Subtract(y,u,G),t.math.vec2Add(W,G,q),t.math.vec2Add(q,u,T),t.math.vec2Subtract(f,u,W),t.math.vec2Subtract(m,u,G),t.math.vec2Add(W,G,q),t.math.vec2Add(q,u,E),t.math.vec2Subtract(v,u,W),t.math.vec2Subtract(m,u,G),t.math.vec2Add(W,G,q),t.math.vec2Add(q,u,S),A.x=X.x,A.y=H.x,P.x=Z+X.x,P.y=H.x,F.x=X.y-$,F.y=H.x,M.x=X.y,M.y=H.x,I.x=X.x,I.y=tt+H.x,U.x=Z+X.x,U.y=tt+H.x,k.x=X.y-$,k.y=tt+H.x,N.x=X.y,N.y=tt+H.x,V.x=X.x,V.y=H.y-et,B.x=Z+X.x,B.y=H.y-et,O.x=X.y-$,O.y=H.y-et,L.x=X.y,L.y=H.y-et,R.x=X.x,R.y=H.y,z.x=Z+X.x,z.y=H.y,j.x=X.y-$,j.y=H.y,C.x=X.y,C.y=H.y;for(var at,rt,it=[u,f,v,d,g,_,w,b,y,x,D,T,m,E,S,p],ot=[A,P,F,M,I,U,k,N,V,B,O,L,R,z,j,C],nt=0;nt<9;nt++){var st=Math.floor(nt/3),lt=nt%3;at=[it[0+lt+4*st],it[1+lt+4*st],it[4+lt+4*st],it[5+lt+4*st]],rt=[ot[0+lt+4*st],ot[1+lt+4*st],ot[4+lt+4*st],ot[5+lt+4*st]],this.updateQuadData(at[0].x,at[0].y,at[1].x,at[1].y,at[2].x,at[2].y,at[3].x,at[3].y,nt),this.datar[13*(0+6*nt)+7]=rt[0].x,this.datar[13*(0+6*nt)+8]=rt[0].y,this.datar[13*(1+6*nt)+7]=rt[1].x,this.datar[13*(1+6*nt)+8]=rt[1].y,this.datar[13*(2+6*nt)+7]=rt[2].x,this.datar[13*(2+6*nt)+8]=rt[2].y,this.datar[13*(3+6*nt)+7]=rt[2].x,this.datar[13*(3+6*nt)+8]=rt[2].y,this.datar[13*(4+6*nt)+7]=rt[1].x,this.datar[13*(4+6*nt)+8]=rt[1].y,this.datar[13*(5+6*nt)+7]=rt[3].x,this.datar[13*(5+6*nt)+8]=rt[3].y,at.length=0,rt.length=0}t.math.pool.delete_vector2Array(it),t.math.pool.delete_vector2Array(ot),t.math.pool.delete_vector2Array([W,G,q])},image2D.prototype.updateFilledData=function(t,e,a,r,o,n,s,l){var h=this._sprite.urange,c=this._sprite.vrange,u=h.y-h.x,d=c.y-c.x,m=h.x+.5*u,p=c.x+.5*d;switch(this._fillMethod){case i.Horizontal:case i.Vertical:case i.Radial_90:this._fillMethod==i.Horizontal?(a-=(1-this.fillAmmount)*(a-t),r-=(1-this.fillAmmount)*(r-e),s-=(1-this.fillAmmount)*(s-o),l-=(1-this.fillAmmount)*(l-n),this.datar[20]=h.x+this.fillAmmount*u,this.datar[59]=h.x+this.fillAmmount*u,this.datar[72]=h.x+this.fillAmmount*u):this._fillMethod==i.Vertical?(t-=(1-this.fillAmmount)*(t-o),e-=(1-this.fillAmmount)*(e-n),a-=(1-this.fillAmmount)*(a-s),r-=(1-this.fillAmmount)*(r-l),this.datar[8]=c.y-this.fillAmmount*d,this.datar[21]=c.y-this.fillAmmount*d,this.datar[60]=c.y-this.fillAmmount*d):this._fillMethod==i.Radial_90&&(this.fillAmmount>=.5?(t-=(P=2*(1-this.fillAmmount))*(t-a),e-=P*(e-r),this.datar[7]=h.x+P*u,this.datar[21]=c.x,this.datar[60]=c.x):(t=a-=(P=2*(.5-this.fillAmmount))*(a-s),e=r-=P*(r-l),this.datar[8]=c.x+P*d,this.datar[21]=c.x+P*d,this.datar[60]=c.x+P*d)),this.updateQuadData(t,e,a,r,o,n,s,l);break;case i.Radial_180:var f=(t+a)/2,v=(e+r)/2,g=(o+s)/2,y=(n+l)/2;this.fillAmmount>=.75?(o-=(P=4*(1-this.fillAmmount))*(o-t),n-=P*(n-e),this.datar[73]=c.y-P*d,this.datar[7]=h.x,this.datar[46]=h.x,this.datar[85]=m,this.datar[99]=c.x,this.datar[138]=c.x):this.fillAmmount>=.5?(o=t-=(P=4*(.75-this.fillAmmount))*(t-f),n=e-=P*(e-v),this.datar[7]=h.x+.5*u*P,this.datar[46]=h.x+.5*u*P,this.datar[85]=m,this.datar[99]=c.x,this.datar[138]=c.x):this.fillAmmount>=.25?(o=t=f-=(P=4*(.5-this.fillAmmount))*(f-a),n=e=v-=P*(v-r),this.datar[85]=m+.5*u*P,this.datar[99]=c.x,this.datar[138]=c.x):(o=t=f=a-=(P=4*(.25-this.fillAmmount))*(a-s),n=e=v=r-=P*(r-l),this.datar[99]=c.x+P*d,this.datar[138]=c.x+P*d),this.updateQuadData(t,e,f,v,o,n,g,y,0,!0),this.updateQuadData(f,v,a,r,g,y,s,l,1);break;case i.Radial_360:var _=(t+a)/2,w=(e+r)/2,b=(t+o)/2,x=(e+n)/2,D=(o+s)/2,T=(n+l)/2,E=(a+s)/2,S=(r+l)/2,A=(b+E)/2,M=(x+S)/2,R=D,C=T;if(this.fillAmmount>=.875)D-=(P=8*(1-this.fillAmmount))*(D-o),T-=P*(T-n),this.datar[228]=m-.5*P*u,this.datar[190]=c.y,this.datar[203]=c.y,this.datar[73]=p,this.datar[7]=h.x,this.datar[46]=h.x,this.datar[85]=m,this.datar[99]=c.x,this.datar[138]=c.x,this.datar[255]=p,this.datar[267]=h.y,this.datar[293]=h.y;else if(this.fillAmmount>=.75)D=o-=(P=8*(.875-this.fillAmmount))*(o-b),T=n-=P*(n-x),this.datar[190]=c.y-.5*P*d,this.datar[203]=c.y-.5*P*d,this.datar[73]=p,this.datar[7]=h.x,this.datar[46]=h.x,this.datar[85]=m,this.datar[99]=c.x,this.datar[138]=c.x,this.datar[255]=p,this.datar[267]=h.y,this.datar[293]=h.y;else if(this.fillAmmount>=.625)D=o=b-=(P=8*(.75-this.fillAmmount))*(b-t),T=n=x-=P*(x-e),this.datar[73]=p-.5*P*d,this.datar[7]=h.x,this.datar[46]=h.x,this.datar[85]=m,this.datar[99]=c.x,this.datar[138]=c.x,this.datar[255]=p,this.datar[267]=h.y,this.datar[293]=h.y;else if(this.fillAmmount>=.5)D=o=b=t-=(P=8*(.625-this.fillAmmount))*(t-_),T=n=x=e-=P*(e-w),this.datar[7]=h.x+.5*P*u,this.datar[46]=h.x+.5*P*u,this.datar[85]=m,this.datar[99]=c.x,this.datar[138]=c.x,this.datar[255]=p,this.datar[267]=h.y,this.datar[293]=h.y;else if(this.fillAmmount>=.375)D=o=b=t=_-=(P=8*(.5-this.fillAmmount))*(_-a),T=n=x=e=w-=P*(w-r),this.datar[85]=m+.5*P*u,this.datar[99]=c.x,this.datar[138]=c.x,this.datar[255]=p,this.datar[267]=h.y,this.datar[293]=h.y;else if(this.fillAmmount>=.25)D=o=b=t=_=a-=(P=8*(.375-this.fillAmmount))*(a-E),T=n=x=e=w=r-=P*(r-S),this.datar[99]=c.x+.5*P*d,this.datar[138]=c.x+.5*P*d,this.datar[255]=p,this.datar[267]=h.y,this.datar[293]=h.y;else if(this.fillAmmount>=.125)D=o=b=t=_=a=E-=(P=8*(.25-this.fillAmmount))*(E-s),T=n=x=e=w=r=S-=P*(S-l),this.datar[255]=p+.5*P*d,this.datar[267]=h.y,this.datar[293]=h.y;else{var P=8*(.125-this.fillAmmount);D=o=b=t=_=a=E=s-=P*(s-D),T=n=x=e=w=r=S=l-=P*(l-T),this.datar[267]=h.y-.5*P*u,this.datar[293]=h.y-.5*P*u}this.updateQuadData(t,e,_,w,b,x,A,M,0,!0),this.updateQuadData(_,w,a,r,A,M,E,S,1),this.updateQuadData(b,x,A,M,o,n,D,T,2),this.updateQuadData(A,M,E,S,R,C,s,l,3,!0)}},image2D.prototype.updateTiledData=function(t,e,a,r,i,o,n,s){for(var l=this._sprite.rect,h=(this._sprite.border,this._sprite.urange),c=this._sprite.vrange,u=h.y-h.x,d=c.y-c.x,m=a-t,p=o-e,f=this.transform.width/l.w,v=this.transform.height/l.h,g=1/f,y=1/v,_=0,w=0;w<v-1;w++)for(P=0;P<f-1;P++){V=[0,0,0,1,1,1,1,h.x,c.x,1,1,1,1,0,0,0,1,1,1,1,h.y,c.x,1,1,1,1,0,0,0,1,1,1,1,h.x,c.y,1,1,1,1,0,0,0,1,1,1,1,h.x,c.y,1,1,1,1,0,0,0,1,1,1,1,h.y,c.x,1,1,1,1,0,0,0,1,1,1,1,h.y,c.y,1,1,1,1];this.datar=this.datar.concat(V);var b=t+g*m*P,x=e+y*p*w,D=t+g*m*(P+1),T=e+y*p*w,E=t+g*m*P,S=e+y*p*(w+1),A=t+g*m*(P+1),M=e+y*p*(w+1);this.updateQuadData(b,x,D,T,E,S,A,M,_),_++}for(var R=Math.ceil(v)-1,C=v-Math.ceil(v)+1,P=0;P<f-1;P++){V=[0,0,0,1,1,1,1,h.x,c.x,1,1,1,1,0,0,0,1,1,1,1,h.y,c.x,1,1,1,1,0,0,0,1,1,1,1,h.x,c.x+C*d,1,1,1,1,0,0,0,1,1,1,1,h.x,c.x+C*d,1,1,1,1,0,0,0,1,1,1,1,h.y,c.x,1,1,1,1,0,0,0,1,1,1,1,h.y,c.x+C*d,1,1,1,1];this.datar=this.datar.concat(V);var b=t+g*m*P,x=e+y*p*R,D=t+g*m*(P+1),T=e+y*p*R,E=t+g*m*P,S=e+y*p*(R+C),A=t+g*m*(P+1),M=e+y*p*(R+C);this.updateQuadData(b,x,D,T,E,S,A,M,_),_++}for(var F=Math.ceil(f)-1,I=f-Math.ceil(f)+1,w=0;w<v-1;w++){V=[0,0,0,1,1,1,1,h.x,c.x,1,1,1,1,0,0,0,1,1,1,1,h.x+I*u,c.x,1,1,1,1,0,0,0,1,1,1,1,h.x,c.y,1,1,1,1,0,0,0,1,1,1,1,h.x,c.y,1,1,1,1,0,0,0,1,1,1,1,h.x+I*u,c.x,1,1,1,1,0,0,0,1,1,1,1,h.x+I*u,c.y,1,1,1,1];this.datar=this.datar.concat(V);var b=t+g*m*F,x=e+y*p*w,D=t+g*m*(F+I),T=e+y*p*w,E=t+g*m*F,S=e+y*p*(w+1),A=t+g*m*(F+I),M=e+y*p*(w+1);this.updateQuadData(b,x,D,T,E,S,A,M,_),_++}var V=[0,0,0,1,1,1,1,h.x,c.x,1,1,1,1,0,0,0,1,1,1,1,h.x+I*u,c.x,1,1,1,1,0,0,0,1,1,1,1,h.x,c.x+C*d,1,1,1,1,0,0,0,1,1,1,1,h.x,c.x+C*d,1,1,1,1,0,0,0,1,1,1,1,h.x+I*u,c.x,1,1,1,1,0,0,0,1,1,1,1,h.x+I*u,c.x+C*d,1,1,1,1];this.datar=this.datar.concat(V);var b=t+g*m*F,x=e+y*p*R,D=t+g*m*(F+I),T=e+y*p*R,E=t+g*m*F,S=e+y*p*(R+C),A=t+g*m*(F+I),M=e+y*p*(R+C);this.updateQuadData(b,x,D,T,E,S,A,M,_),_++},image2D}();__decorate([t.reflect.Field("color"),t.reflect.UIStyle("vector4"),__metadata("design:type",t.math.color)],a.prototype,"color",void 0),__decorate([t.reflect.Field("number"),t.reflect.UIStyle("ImageType"),__metadata("design:type",Object),__metadata("design:paramtypes",[Number])],a.prototype,"imageType",null),__decorate([t.reflect.Field("number"),t.reflect.UIStyle("FillMethod"),__metadata("design:type",Object),__metadata("design:paramtypes",[Number])],a.prototype,"fillMethod",null),a=__decorate([t.reflect.node2DComponent,t.reflect.nodeRender,__metadata("design:paramtypes",[])],a),e.image2D=a;var r;!function(t){t[t.Simple=0]="Simple",t[t.Sliced=1]="Sliced",t[t.Tiled=2]="Tiled",t[t.Filled=3]="Filled"}(r=e.ImageType||(e.ImageType={}));var i;!function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical",t[t.Radial_90=2]="Radial_90",t[t.Radial_180=3]="Radial_180",t[t.Radial_360=4]="Radial_360"}(i=e.FillMethod||(e.FillMethod={}))}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function label(){this._fontsize=14,this.linespace=1,this.horizontalType=r.Center,this.verticalType=i.Center,this.indexarr=[],this.remainarrx=[],this.data_begin=new t.math.vector2(0,0),this.datar=[],this.color=new t.math.color(1,1,1,1),this.color2=new t.math.color(0,0,.5,.5),this.dirtyData=!0}return Object.defineProperty(label.prototype,"text",{get:function(){return this._text},set:function(t){this._text=t;var e=78*this._text.length;for(this.datar.splice(0,this.datar.length);this.datar.length<e;)this.datar.push(0,0,0,1,1,1,1,0,0,1,1,1,1,0,0,0,1,1,1,1,1,0,1,1,1,1,0,0,0,1,1,1,1,0,1,1,1,1,1,0,0,0,1,1,1,1,0,1,1,1,1,1,0,0,0,1,1,1,1,1,0,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1);for(;this.datar.length<e;)this.datar.pop();this.dirtyData=!0},enumerable:!0,configurable:!0}),Object.defineProperty(label.prototype,"font",{get:function(){return this._font},set:function(t){this._font&&this._font.unuse(),this._font=t,this._font.use()},enumerable:!0,configurable:!0}),Object.defineProperty(label.prototype,"fontsize",{get:function(){return this._fontsize},set:function(t){this._fontsize=t},enumerable:!0,configurable:!0}),label.prototype.updateData=function(t){this.dirtyData=!1;var e=this._fontsize/t.lineHeight,a=this.transform.getWorldMatrix(),o=a.rawData[0],n=a.rawData[2],s=a.rawData[1],l=a.rawData[3],h=this.data_begin.x,c=this.data_begin.y,u=0,d=0;this.indexarr=[],this.remainarrx=[];for(var m=0,p=0;p<this._text.length;p++){y=this._text.charAt(p);if(void 0!=(_=t.cmap[y])){if(u+_.xAddvance*e>this.transform.width){if(d+this._fontsize*this.linespace>this.transform.height)break;this.indexarr.push(p),this.remainarrx.push(this.transform.width-u),u=0,d+=this._fontsize*this.linespace}u+=_.xAddvance*e}}this.indexarr.push(p),this.remainarrx.push(this.transform.width-u),m=this.transform.height-d;var p=0,f=0,v=0;this.verticalType==i.Center?v+=m/2:this.verticalType==i.Boom&&(v+=m);for(var g=0;g<this.indexarr.length;g++){for(f=0,this.horizontalType==r.Center?f+=this.remainarrx[g]/2:(this.horizontalType=r.Right)&&(f+=this.remainarrx[g]);p<this.indexarr[g];p++){var y=this._text.charAt(p),_=t.cmap[y];if(void 0!=_){var w=f+_.xOffset*e,b=v-_.yOffset*e+t.baseline*e,x=e*_.ySize,D=e*_.xSize;f+=_.xAddvance*e;var T=w+D,E=b,S=w,A=b+x,M=w+D,R=b+x;this.datar[6*p*13+0]=h+w*o+b*n,this.datar[6*p*13+1]=c+w*s+b*l,this.datar[6*p*13+13+0]=h+T*o+E*n,this.datar[6*p*13+13+1]=c+T*s+E*l,this.datar[6*p*13+26+0]=h+S*o+A*n,this.datar[6*p*13+26+1]=c+S*s+A*l,this.datar[6*p*13+39+0]=h+S*o+A*n,this.datar[6*p*13+39+1]=c+S*s+A*l,this.datar[6*p*13+52+0]=h+T*o+E*n,this.datar[6*p*13+52+1]=c+T*s+E*l,this.datar[6*p*13+65+0]=h+M*o+R*n,this.datar[6*p*13+65+1]=c+M*s+R*l;var C=_.x,P=_.y,F=_.x+_.w,I=_.y,V=_.x,U=_.y+_.h,k=_.x+_.w,N=_.y+_.h;this.datar[6*p*13+7]=C,this.datar[6*p*13+8]=P,this.datar[6*p*13+13+7]=F,this.datar[6*p*13+13+8]=I,this.datar[6*p*13+26+7]=V,this.datar[6*p*13+26+8]=U,this.datar[6*p*13+39+7]=V,this.datar[6*p*13+39+8]=U,this.datar[6*p*13+52+7]=F,this.datar[6*p*13+52+8]=I,this.datar[6*p*13+65+7]=k,this.datar[6*p*13+65+8]=N;for(var B=0;B<6;B++)this.datar[6*p*13+13*B+3]=this.color.r,this.datar[6*p*13+13*B+4]=this.color.g,this.datar[6*p*13+13*B+5]=this.color.b,this.datar[6*p*13+13*B+6]=this.color.a,this.datar[6*p*13+13*B+9]=this.color2.r,this.datar[6*p*13+13*B+10]=this.color2.g,this.datar[6*p*13+13*B+11]=this.color2.b,this.datar[6*p*13+13*B+12]=this.color2.a}}v+=this._fontsize*this.linespace}},label.prototype.render=function(t){if(null!=this._font){(this.dirtyData=!0)&&(this.updateData(this._font),this.dirtyData=!1),null==this.mat&&(this.mat=new e.material,this.mat.setShader(t.assetmgr.getShader("shader/defuifont")));var a;null!=this._font&&(a=this._font.texture),null==a&&(a=this.transform.canvas.scene.app.getAssetMgr().getDefaultTexture("grid")),this.mat.setTexture("_MainTex",a),0!=this.datar.length&&t.pushRawData(this.mat,this.datar)}},label.prototype.updateTran=function(){var t=this.transform.getWorldMatrix(),e=-this.transform.pivot.x*this.transform.width,a=-this.transform.pivot.y*this.transform.height;this.data_begin.x=e*t.rawData[0]+a*t.rawData[2]+t.rawData[4],this.data_begin.y=e*t.rawData[1]+a*t.rawData[3]+t.rawData[5]},label.prototype.start=function(){},label.prototype.update=function(t){},label.prototype.remove=function(){this._font.unuse(!0),this.indexarr.length=0,this.remainarrx.length=0,this.datar.length=0},label.prototype.onPointEvent=function(t,e,a){},label}();__decorate([t.reflect.Field("string"),__metadata("design:type",String),__metadata("design:paramtypes",[String])],a.prototype,"text",null),__decorate([t.reflect.Field("font"),__metadata("design:type",Object),__metadata("design:paramtypes",[e.font])],a.prototype,"font",null),__decorate([t.reflect.Field("number"),__metadata("design:type",Object),__metadata("design:paramtypes",[Number])],a.prototype,"fontsize",null),a=__decorate([t.reflect.node2DComponent,t.reflect.nodeRender],a),e.label=a;var r;!function(t){t[t.Center=0]="Center",t[t.Left=1]="Left",t[t.Right=2]="Right"}(r=e.HorizontalType||(e.HorizontalType={}));var i;!function(t){t[t.Center=0]="Center",t[t.Top=1]="Top",t[t.Boom=2]="Boom"}(i=e.VerticalType||(e.VerticalType={}))}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function rawImage2D(){this.datar=[0,0,0,1,1,1,1,0,0,1,1,1,1,0,0,0,1,1,1,1,1,0,1,1,1,1,0,0,0,1,1,1,1,0,1,1,1,1,1,0,0,0,1,1,1,1,0,1,1,1,1,1,0,0,0,1,1,1,1,1,0,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1],this.color=new t.math.color(1,1,1,1)}return Object.defineProperty(rawImage2D.prototype,"image",{get:function(){return this._image},set:function(t){this._image&&this._image.unuse(),this._image=t,this._image.use()},enumerable:!0,configurable:!0}),rawImage2D.prototype.render=function(t){null==this.mat&&(this.mat=new e.material,this.mat.setShader(t.assetmgr.getShader("shader/defui")));var a=this.image;null!=a&&(this.mat.setTexture("_MainTex",a),t.pushRawData(this.mat,this.datar))},rawImage2D.prototype.updateTran=function(){var t=this.transform.getWorldMatrix(),e=-this.transform.pivot.x*this.transform.width,a=this.transform.width+e,r=-this.transform.pivot.y*this.transform.height,i=this.transform.height+r,o=e*t.rawData[0]+r*t.rawData[2]+t.rawData[4],n=e*t.rawData[1]+r*t.rawData[3]+t.rawData[5],s=a*t.rawData[0]+r*t.rawData[2]+t.rawData[4],l=a*t.rawData[1]+r*t.rawData[3]+t.rawData[5],h=e*t.rawData[0]+i*t.rawData[2]+t.rawData[4],c=e*t.rawData[1]+i*t.rawData[3]+t.rawData[5],u=a*t.rawData[0]+i*t.rawData[2]+t.rawData[4],d=a*t.rawData[1]+i*t.rawData[3]+t.rawData[5];this.datar[0]=o,this.datar[1]=n,this.datar[13]=s,this.datar[14]=l,this.datar[26]=h,this.datar[27]=c,this.datar[39]=h,this.datar[40]=c,this.datar[52]=s,this.datar[53]=l,this.datar[65]=u,this.datar[66]=d;for(var m=0;m<6;m++)this.datar[13*m+3]=this.color.r,this.datar[13*m+4]=this.color.g,this.datar[13*m+5]=this.color.b,this.datar[13*m+6]=this.color.a},rawImage2D.prototype.start=function(){},rawImage2D.prototype.update=function(t){},rawImage2D.prototype.remove=function(){this._image.unuse(!0)},rawImage2D.prototype.onPointEvent=function(t,e,a){},rawImage2D}();__decorate([t.reflect.Field("texture"),__metadata("design:type",e.texture)],a.prototype,"_image",void 0),__decorate([t.reflect.Field("color"),t.reflect.UIStyle("vector4"),__metadata("design:type",t.math.color)],a.prototype,"color",void 0),__decorate([t.reflect.Field("material"),t.reflect.UIStyle("material"),__metadata("design:type",e.material)],a.prototype,"mat",void 0),a=__decorate([t.reflect.node2DComponent,t.reflect.nodeRender],a),e.rawImage2D=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function resID(){this.id=resID.next()}return resID.next=function(){var t=resID.idAll;return resID.idAll++,t},resID.prototype.getID=function(){return this.id},resID}();a.idAll=1,e.resID=a;var r=function(){function constText(t){this.name=t}return constText.prototype.getText=function(){return this.name},constText}();r=__decorate([t.reflect.SerializeType,__metadata("design:paramtypes",[String])],r),e.constText=r}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a;!function(t){t[t.Unknown=0]="Unknown",t[t.Auto=1]="Auto",t[t.Bundle=2]="Bundle",t[t.CompressBundle=3]="CompressBundle",t[t.GLVertexShader=4]="GLVertexShader",t[t.GLFragmentShader=5]="GLFragmentShader",t[t.Shader=6]="Shader",t[t.Texture=7]="Texture",t[t.TextureDesc=8]="TextureDesc",t[t.Mesh=9]="Mesh",t[t.Prefab=10]="Prefab",t[t.Material=11]="Material",t[t.Aniclip=12]="Aniclip",t[t.Scene=13]="Scene",t[t.Atlas=14]="Atlas",t[t.Font=15]="Font",t[t.TextAsset=16]="TextAsset",t[t.PackBin=17]="PackBin",t[t.PackTxt=18]="PackTxt",t[t.pathAsset=19]="pathAsset",t[t.PVR=20]="PVR"}(a=e.AssetTypeEnum||(e.AssetTypeEnum={}));var r=function(){function stateLoad(){this.iserror=!1,this.isfinish=!1,this.resstate={},this.curtask=0,this.totaltask=0,this.logs=[],this.errs=[]}return Object.defineProperty(stateLoad.prototype,"progress",{get:function(){return this.curtask/this.totaltask},enumerable:!0,configurable:!0}),stateLoad}();e.stateLoad=r;var i=function(){function assetBundle(t){this.files=[],this.packages=[],this.mapNamed={},this.url=t;var e=t.lastIndexOf("/");this.path=t.substring(0,e)}return assetBundle.prototype.parse=function(t){for(var e=t.files,a=0;a<e.length;a++){var r=e[a],i=-1;void 0!=r.packes&&(i=r.packes),this.files.push({name:r.name,length:r.length,packes:i})}if(void 0!=t.packes)for(var i=t.packes,a=0;a<i.length;a++)this.packages.push(i[a])},assetBundle.prototype.unload=function(){for(var t in this.mapNamed){var e=this.assetmgr.getAssetByName(t,this.name);e&&this.assetmgr.unuse(e)}this.assetmgr.removeAssetBundle(this.name)},assetBundle.prototype.load=function(t,e){var r=this,i=e.state,o=e.onstate,n=this.files.length;this.assetmgr=t;for(var s=[],l=[],h=[],c=[],u=[],d=[],m=[],p=[],f=[],v=[],g=[],y=[],_={},w=0;w<this.files.length;w++){var b=this.files[w],x=t.calcType(b.name),D=this.path+"/"+b.name;-1!=b.packes&&(_[D]=b.packes),x==a.GLFragmentShader?l.push(D):x==a.GLVertexShader?s.push(D):x==a.Shader?h.push(D):x==a.Texture?u.push(D):x==a.TextureDesc?d.push(D):x==a.Mesh?c.push(D):x==a.Material?m.push(D):x==a.Aniclip?p.push(D):x==a.Prefab?f.push(D):x==a.Scene?v.push(D):x==a.TextAsset?g.push(D):x==a.PVR&&y.push(D)}for(var T=[],w=0;w<this.packages.length;w++){var E=this.packages[w],S=t.calcType(E),D=this.path+"/"+E;T.push({url:D,type:S})}for(w=0;w<s.length;w++)T.push({url:s[w],type:a.GLVertexShader});for(w=0;w<l.length;w++)T.push({url:l[w],type:a.GLFragmentShader});for(w=0;w<h.length;w++)T.push({url:h[w],type:a.Shader});for(w=0;w<u.length;w++)T.push({url:u[w],type:a.Texture});for(var A=0;A<y.length;A++)T.push({url:y[A],type:a.PVR});for(w=0;w<d.length;w++)T.push({url:d[w],type:a.TextureDesc});for(w=0;w<c.length;w++)T.push({url:c[w],type:a.Mesh});for(w=0;w<m.length;w++)T.push({url:m[w],type:a.Material});for(w=0;w<p.length;w++)T.push({url:p[w],type:a.Aniclip});for(w=0;w<f.length;w++)T.push({url:f[w],type:a.Prefab});for(w=0;w<v.length;w++)T.push({url:v[w],type:a.Scene});for(w=0;w<g.length;w++)T.push({url:g[w],type:a.TextAsset});var M=T.length;n>M&&console.log("assetBundle中某个file不是资源或后缀有问题"),i.totaltask=M+1,i.curtask=1,o(i),t.doWaitState(this.url,i);var R=function(){var e=T[i.curtask-1].url,n=T[i.curtask-1].type;void 0!=_[e]?t.loadResByPack(_[e],e,n,function(s){M--,i.curtask++;var l=t.getFileName(e);if(n!=a.GLVertexShader&&n!=a.GLFragmentShader&&n!=a.Shader&&n!=a.PackBin&&n!=a.PackTxt){var h=s.resstate[l].res;r.mapNamed[l]=h.getGUID()}0===M?(i.isfinish=!0,o(i),t.loadByQueue()):(o(i),R()),t.doWaitState(r.url,i)},i):t.loadSingleRes(e,n,function(s){M--,i.curtask++;var l=t.getFileName(e);if(n!=a.GLVertexShader&&n!=a.GLFragmentShader&&n!=a.Shader&&n!=a.PackBin&&n!=a.PackTxt){var h=s.resstate[l].res;null!=h?r.mapNamed[l]=h.getGUID():console.error(l)}0===M?(i.isfinish=!0,o(i),t.loadByQueue()):(o(i),R()),t.doWaitState(r.url,i)},i)};R()},assetBundle}();e.assetBundle=i;var o=function(){function assetMgr(e){this.mapShader={},this.mapDefaultMesh={},this.mapDefaultTexture={},this.mapBundle={},this.mapRes={},this.mapNamed={},this.mapInLoad={},this.assetUrlDic={},this.bundlePackBin={},this.waitStateDic={},this.queueState=[],this.app=e,this.webgl=e.webgl,this.shaderPool=new t.render.shaderPool}return assetMgr.prototype.initDefAsset=function(){e.defShader.initDefaultShader(this),e.defMesh.initDefaultMesh(this),e.defTexture.initDefaultTexture(this)},assetMgr.prototype.getShader=function(t){return this.mapShader[t]},assetMgr.prototype.getDefaultMesh=function(t){return this.mapDefaultMesh[t]},assetMgr.prototype.getDefaultTexture=function(t){return this.mapDefaultTexture[t]},assetMgr.prototype.getAsset=function(t){var e=this.mapRes[t];return null==e?null:e.asset},assetMgr.prototype.getAssetByName=function(t,e){if(void 0===e&&(e=null),null==this.mapNamed[t])return null;var a=this.mapNamed[t][0];if(null!=e){var r=this.mapBundle[e];null!=r&&(a=r.mapNamed[t])}if(null==a)return null;var i=this.mapRes[a];return null==i?null:i.asset},assetMgr.prototype.getAssetBundle=function(t){return this.mapBundle[t]?this.mapBundle[t]:null},assetMgr.prototype.unuse=function(t,e){void 0===e&&(e=!1);var a=t.getGUID(),r=t.getName();if(!t.defaultAsset&&(this.mapRes[a].refcount--,e&&this.mapRes[a].refcount<=0)){if(this.mapRes[a].asset.dispose(),null!=r)if(this.mapNamed[r].length<=1)delete this.mapNamed[r];else for(var i in this.mapNamed[r])a==this.mapNamed[r][i]&&this.mapNamed[r].splice(parseInt(i),1);delete this.mapRes[a]}},assetMgr.prototype.use=function(t){var e=t.getGUID(),a=t.getName();if(e<=0)throw new Error("不合法的res guid:"+a);t.defaultAsset||(null==this.mapRes[e]&&(this.mapRes[e]={asset:t,refcount:0},null!=a&&(null==this.mapNamed[a]&&(this.mapNamed[a]=[]),this.mapNamed[a].push(e))),this.mapRes[e].refcount++)},assetMgr.prototype.releaseUnuseAsset=function(){for(var t in this.mapRes)if(this.mapRes[t].refcount<=0){var e=this.mapRes[t].asset.getName();if(this.mapNamed[e].length<=1)delete this.mapNamed[e];else for(var a in this.mapNamed[e])this.mapRes[t].asset.getGUID()==this.mapNamed[e][a]&&this.mapNamed[e].splice(parseInt(a),1);this.mapRes[t].asset.dispose(),delete this.mapRes[t]}},assetMgr.prototype.getAssetsRefcount=function(){var t={};for(var e in this.mapNamed)if(1==this.mapNamed[e].length){r=this.mapRes[this.mapNamed[e][0]];t[e]=r.refcount}else for(var a in this.mapNamed[e]){var r=this.mapRes[this.mapNamed[e][a]];t[e+"("+a+")"]=r.refcount}return t},assetMgr.prototype.nameDuplicateCheck=function(t){return!0},assetMgr.prototype.removeAssetBundle=function(t){null!=this.mapBundle[t]&&delete this.mapBundle[t],null!=this.mapInLoad[t]&&delete this.mapInLoad[t]},assetMgr.prototype.getAssetUrl=function(t){return this.assetUrlDic[t.getGUID()]},assetMgr.prototype.loadResByPack=function(r,i,o,n,s){var l=this,h=this.getFileName(s.url),c=this.getFileName(i),u=c.substring(0,c.indexOf("."));if(0==r?this.bundlePackJson:this.bundlePackBin,o==a.GLVertexShader){s.resstate[c]={state:0,res:null};m=this.bundlePackJson[c];m=decodeURI(m),s.resstate[c].state=1,s.logs.push("load a glshader:"+c),this.shaderPool.compileVS(this.webgl,u,m),n(s)}else if(o==a.GLFragmentShader){s.resstate[c]={state:0,res:null};m=this.bundlePackJson[c];m=decodeURI(m),s.resstate[c].state=1,s.logs.push("load a glshader:"+c),this.shaderPool.compileFS(this.webgl,u,m),n(s)}else if(o==a.Shader){s.resstate[c]={state:0,res:null};m=this.bundlePackJson[c];s.resstate[c].state=1;var d=new e.shader(c);d.parse(this,JSON.parse(m)),this.assetUrlDic[d.getGUID()]=i,this.mapShader[c]=d,n(s)}else if(o==a.TextureDesc){var m=this.bundlePackJson[c],p=JSON.parse(m),f=p.name,v=p.filterMode,g=p.format,y=p.mipmap,_=p.wrap,w=t.render.TextureFormatEnum.RGBA;"RGB"==g?w=t.render.TextureFormatEnum.RGB:"Gray"==g&&(w=t.render.TextureFormatEnum.Gray);var b=!0;v.indexOf("linear")<0&&(b=!1);var x=!1;_.indexOf("Repeat")>=0&&(x=!0);var D=i.replace(c,f);s.resstate[c]={state:0,res:null};var T=new Image;T.src=D,T.crossOrigin="anonymous",T.onerror=function(t){null!=t&&(s.errs.push(new Error("img load failed:"+c+". message:"+t.message)),s.iserror=!0,n(s))},T.onload=function(){var a=new e.texture(c);a.realName=f,l.assetUrlDic[a.getGUID()]=i;var r=new t.render.glTexture2D(l.webgl,w);r.uploadImage(T,y,b,!0,x),a.glTexture=r,l.use(a),s.resstate[c].state=1,s.resstate[c].res=a,n(s)}}else if(o==a.Material){s.resstate[c]={state:0,res:null};m=this.bundlePackJson[c];s.resstate[c].state=1;var E=new e.material(c);E.Parse(this,JSON.parse(m)),this.assetUrlDic[E.getGUID()]=i,this.use(E),s.resstate[c].state=1,s.resstate[c].res=E,n(s)}else if(o==a.Mesh){s.resstate[c]={state:0,res:null};var S=this.bundlePackBin[c],A=new e.mesh(c);this.assetUrlDic[A.getGUID()]=i,A.Parse(S,this.webgl),this.use(A),s.resstate[c].state=1,s.resstate[c].res=A,n(s)}else if(o==a.Aniclip){s.resstate[c]={state:0,res:null};var S=this.bundlePackBin[c],M=new e.animationClip(c);this.assetUrlDic[M.getGUID()]=i,M.Parse(S),this.use(M),s.resstate[c].state=1,s.resstate[c].res=M,n(s)}else if(o==a.Atlas){s.resstate[c]={state:0,res:null};var m=this.bundlePackJson[c],R=new e.atlas(c);this.assetUrlDic[R.getGUID()]=i,R.Parse(m,this),this.use(R),s.resstate[c].state=1,s.resstate[c].res=R,n(s)}else if(o==a.Prefab){s.resstate[c]={state:0,res:null};var m=this.bundlePackJson[c],C=new e.prefab(c);C.assetbundle=h,this.assetUrlDic[C.getGUID()]=i,C.Parse(m,this),this.use(C),s.resstate[c].state=1,s.resstate[c].res=C,n(s)}else if(o==a.Scene){s.resstate[c]={state:0,res:null};var m=this.bundlePackJson[c],P=new e.rawscene(c);P.assetbundle=h,this.assetUrlDic[P.getGUID()]=i,P.Parse(m,this),this.use(P),s.resstate[c].state=1,s.resstate[c].res=P,n(s)}else if(o==a.Font){s.resstate[c]={state:0,res:null};var m=this.bundlePackJson[c],F=new e.font(c);this.assetUrlDic[F.getGUID()]=i,F.Parse(m,this),this.use(F),s.resstate[c].state=1,s.resstate[c].res=F,n(s)}else{if(o!=a.TextAsset)throw new Error("cant use the type:"+o);s.resstate[c]={state:0,res:null};var m=this.bundlePackJson[c],I=new e.textasset(c);this.assetUrlDic[I.getGUID()]=i,I.content=m,this.use(I),s.resstate[c].state=1,s.resstate[c].res=I,n(s)}},assetMgr.prototype.loadSingleRes=function(r,i,o,n){var s=this,l=this.getFileName(n.url),h=this.getFileName(r),c=h.substring(0,h.indexOf("."));if(i==a.PackBin)t.io.loadArrayBuffer(r,function(e,a){if(null!=a)return n.iserror=!0,n.errs.push(new Error(a.message)),void o(n);var r=new t.io.binReader(e),i=r.readInt32();for(r.position=i;r.canread();){var l=r.readInt32();if(0==i)break;var h=r.readStringUtf8FixLength(l).split("|"),c=parseInt(h[1]),u=parseInt(h[2]),d=e.slice(c,c+u);s.bundlePackBin[h[0]]=d}o(n)});else if(i==a.PackTxt)t.io.loadArrayBuffer(r,function(e,a){if(null!=a)return n.iserror=!0,n.errs.push(new Error(a.message)),void o(n);var r=new t.io.binReader(e),i=new Uint8Array(e.byteLength);r.readUint8Array(i);var l=t.io.binReader.utf8ArrayToString(i);s.bundlePackJson=JSON.parse(l),o(n)});else if(i==a.GLVertexShader)n.resstate[h]={state:0,res:null},t.io.loadText(r,function(t,e){if(null!=e)return n.iserror=!0,n.errs.push(new Error(e.message)),void o(n);n.resstate[h].state=1,n.logs.push("load a glshader:"+h),s.shaderPool.compileVS(s.webgl,c,t),o(n)});else if(i==a.GLFragmentShader)n.resstate[h]={state:0,res:null},t.io.loadText(r,function(t,e){if(null!=e)return n.iserror=!0,n.errs.push(new Error(e.message)),void o(n);n.resstate[h].state=1,n.logs.push("load a glshader:"+h),s.shaderPool.compileFS(s.webgl,c,t),o(n)});else if(i==a.Shader)n.resstate[h]={state:0,res:null},t.io.loadText(r,function(t,a){if(null!=a)return n.iserror=!0,n.errs.push(new Error(a.message)),void o(n);n.resstate[h].state=1;var i=new e.shader(h);i.parse(s,JSON.parse(t)),s.assetUrlDic[i.getGUID()]=r,s.mapShader[h]=i,o(n)});else if(i==a.PVR)n.resstate[h]={state:0,res:null},t.io.loadArrayBuffer(r,function(t,a){if(null!=a)return n.iserror=!0,n.errs.push(new Error(a.message)),void o(n);var i=new e.texture(h);s.assetUrlDic[i.getGUID()]=r;var l=new PVRHeader(s.webgl);i.glTexture=l.parse(t),s.use(i),n.resstate[h].state=1,n.resstate[h].res=i,o(n)});else if(i==a.Texture){n.resstate[h]={state:0,res:null};var u=new Image;u.src=r,u.crossOrigin="anonymous",u.onerror=function(t){null!=t&&(n.errs.push(new Error("img load failed:"+h+". message:"+t.message)),n.iserror=!0,o(n))},u.onload=function(){var a=new e.texture(h);s.assetUrlDic[a.getGUID()]=r;var i=t.render.TextureFormatEnum.RGBA,l=new t.render.glTexture2D(s.webgl,i);l.uploadImage(u,!0,!0,!0,!0),a.glTexture=l,s.use(a),n.resstate[h].state=1,n.resstate[h].res=a,o(n)}}else if(i==a.TextureDesc)t.io.loadText(r,function(a,i){if(null!=i)return n.iserror=!0,n.errs.push(new Error(i.message)),void o(n);var l=JSON.parse(a),c=l.name,u=l.filterMode,d=l.format,m=l.mipmap,p=l.wrap;c.indexOf("LightmapFar")>=0&&console.log("");var f=t.render.TextureFormatEnum.RGBA;"RGB"==d?f=t.render.TextureFormatEnum.RGB:"Gray"==d&&(f=t.render.TextureFormatEnum.Gray);var v=!0;u.indexOf("linear")<0&&(v=!1);var g=!1;p.indexOf("Repeat")>=0&&(g=!0);var y=r.replace(h,c);if(n.resstate[h]={state:0,res:null},y.indexOf(".pvr.bin")>=0)t.io.loadArrayBuffer(y,function(t,a){if(null!=a)return n.iserror=!0,n.errs.push(new Error(a.message)),void o(n);var i=new e.texture(h);s.assetUrlDic[i.getGUID()]=r;var l=new PVRHeader(s.webgl);console.log(y),i.glTexture=l.parse(t),s.use(i),n.resstate[h].state=1,n.resstate[h].res=i,o(n)});else{var _=new Image;_.src=y,_.crossOrigin="anonymous",_.onerror=function(t){null!=t&&(n.errs.push(new Error("img load failed:"+h+". message:"+t.message)),n.iserror=!0,o(n))},_.onload=function(){var a=new e.texture(h);a.realName=c,s.assetUrlDic[a.getGUID()]=r;var i=new t.render.glTexture2D(s.webgl,f);i.uploadImage(_,m,v,!0,g),a.glTexture=i,s.use(a),n.resstate[h].state=1,n.resstate[h].res=a,o(n)}}});else if(i==a.Material)n.resstate[h]={state:0,res:null},t.io.loadText(r,function(t,a){if(null!=a)return n.iserror=!0,n.errs.push(new Error(a.message)),void o(n);n.resstate[h].state=1;var i=new e.material(h);i.Parse(s,JSON.parse(t)),s.assetUrlDic[i.getGUID()]=r,s.use(i),n.resstate[h].state=1,n.resstate[h].res=i,o(n)});else if(i==a.Mesh)n.resstate[h]={state:0,res:null},t.io.loadArrayBuffer(r,function(t,a){if(null!=a)return n.iserror=!0,n.errs.push(new Error(a.message)),void o(n);var i=new e.mesh(h);s.assetUrlDic[i.getGUID()]=r,i.Parse(t,s.webgl),s.use(i),n.resstate[h].state=1,n.resstate[h].res=i,o(n)});else if(i==a.Aniclip)n.resstate[h]={state:0,res:null},t.io.loadArrayBuffer(r,function(t,a){if(null!=a)return n.iserror=!0,n.errs.push(new Error(a.message)),void o(n);var i=new e.animationClip(h);s.assetUrlDic[i.getGUID()]=r,i.Parse(t),s.use(i),n.resstate[h].state=1,n.resstate[h].res=i,o(n)});else if(i==a.Atlas)n.resstate[h]={state:0,res:null},t.io.loadText(r,function(t,a){if(null!=a)return n.iserror=!0,n.errs.push(new Error(a.message)),void o(n);var i=new e.atlas(h);s.assetUrlDic[i.getGUID()]=r,i.Parse(t,s),s.use(i),n.resstate[h].state=1,n.resstate[h].res=i,o(n)});else if(i==a.Prefab)n.resstate[h]={state:0,res:null},t.io.loadText(r,function(t,a){if(null!=a)return n.iserror=!0,n.errs.push(new Error(a.message)),void o(n);var i=new e.prefab(h);i.assetbundle=l,s.assetUrlDic[i.getGUID()]=r,i.Parse(t,s),s.use(i),n.resstate[h].state=1,n.resstate[h].res=i,o(n)});else if(i==a.Scene)n.resstate[h]={state:0,res:null},t.io.loadText(r,function(t,a){if(null!=a)return n.iserror=!0,n.errs.push(new Error(a.message)),void o(n);var i=new e.rawscene(h);i.assetbundle=l,s.assetUrlDic[i.getGUID()]=r,i.Parse(t,s),s.use(i),n.resstate[h].state=1,n.resstate[h].res=i,o(n)});else if(i==a.Font)n.resstate[h]={state:0,res:null},t.io.loadText(r,function(t,a){if(null!=a)return n.iserror=!0,n.errs.push(new Error(a.message)),void o(n);var i=new e.font(h);s.assetUrlDic[i.getGUID()]=r,i.Parse(t,s),s.use(i),n.resstate[h].state=1,n.resstate[h].res=i,o(n)});else if(i==a.TextAsset)n.resstate[h]={state:0,res:null},t.io.loadText(r,function(t,a){if(null!=a)return n.iserror=!0,n.errs.push(new Error(a.message)),void o(n);var i=new e.textasset(h);s.assetUrlDic[i.getGUID()]=r,i.content=t,s.use(i),n.resstate[h].state=1,n.resstate[h].res=i,o(n)});else{if(i!=a.pathAsset)throw new Error("cant use the type:"+i);n.resstate[h]={state:0,res:null},t.io.loadText(r,function(t,a){if(null!=a)return n.iserror=!0,n.errs.push(new Error(a.message)),void o(n);var i=new e.pathasset(h);s.assetUrlDic[i.getGUID()]=r,i.Parse(JSON.parse(t)),s.use(i),n.resstate[h].state=1,n.resstate[h].res=i,o(n)})}},assetMgr.prototype.doWaitState=function(t,e){if(null!=this.waitStateDic[t]){for(var a in this.waitStateDic[t])this.waitStateDic[t][a](e);e.isfinish&&(this.waitStateDic[t].length=0)}},assetMgr.prototype.loadByQueue=function(){var e=this;if(null!=this.curloadinfo){if(!this.curloadinfo.state.isfinish)return;this.curloadinfo=null,this.bundlePackBin={},this.bundlePackJson=null}if(0!=this.queueState.length){this.curloadinfo=this.queueState.shift();var r=this.curloadinfo.state,o=r.url,n=this.curloadinfo.type,s=this.curloadinfo.onstate;if(n==a.Bundle)t.io.loadText(o,function(t,a){if(null!=a)return e.curloadinfo.state.iserror=!0,e.curloadinfo.state.errs.push(new Error(a.message)),void s(r);var n=e.getFileName(o),l=new i(o);l.name=n,l.parse(JSON.parse(t)),l.load(e,e.curloadinfo),e.mapBundle[n]=l});else if(n==a.CompressBundle){var l=o.replace(".assetbundle.json",".packs.txt");t.io.loadText(l,function(t,a){if(null!=a)return r.iserror=!0,r.errs.push(new Error(a.message)),void s(r);var n=e.getFileName(o),l=new i(o);l.name=n;var h=JSON.parse(t);e.bundlePackJson=h,l.parse(h.bundleinfo),l.load(e,e.curloadinfo),e.mapBundle[n]=l})}else r.totaltask=1,this.loadSingleRes(o,n,function(t){r.curtask=1,t.isfinish=!0,s(t),e.doWaitState(o,t),e.loadByQueue()},r)}},assetMgr.prototype.loadCompressBundle=function(t,e){void 0===e&&(e=null);var i=this.getFileName(t),o=this.calcType(t),n=new r;if(this.mapInLoad[i]=n,n.url=t,o!=a.Bundle)return n.errs.push(new Error("is not bundle compress type:"+t)),n.iserror=!0,e(n),void this.doWaitState(t,n);o=a.CompressBundle,this.queueState.push({state:n,type:o,onstate:e}),this.loadByQueue()},assetMgr.prototype.load=function(t,e,i){void 0===e&&(e=a.Auto),void 0===i&&(i=null),null==i&&(i=function(){});var o=this.getFileName(t);if(null==this.mapInLoad[o]){var n=new r;if(this.mapInLoad[o]=n,n.url=t,e==a.Auto&&(e=this.calcType(t)),e==a.Unknown)return n.errs.push(new Error("can not sure about type:"+t)),n.iserror=!0,i(n),void this.doWaitState(t,n);this.queueState.push({state:n,type:e,onstate:i}),this.loadByQueue()}else this.mapInLoad[o].isfinish?i(this.mapInLoad[o]):(null==this.waitStateDic[o]&&(this.waitStateDic[o]=[]),this.waitStateDic[o].push(i))},assetMgr.prototype.unload=function(t,e){void 0===e&&(e=null);var a=this.getFileName(t);if(null!=this.mapInLoad[a]){var r=this.mapInLoad[a];for(var i in r.resstate)r.resstate[i].res.unuse();delete this.mapInLoad[a]}},assetMgr.prototype.loadScene=function(t,a){if(t.length>0){for(var r=this.getAssetByName(t),i=r.getSceneRoot();i.children.length>0;)this.app.getScene().addChild(i.children.shift());r.useLightMap(this.app.getScene()),r.useFog(this.app.getScene())}else{var o=new e.transform;o.gameObject.addComponent("camera"),o.name="camera",this.app.getScene().addChild(o)}this.app.getScene().name=t,this.app.getScene().getRoot().markDirty(),a()},assetMgr.prototype.saveScene=function(e){t.io.SerializeDependent.resoursePaths=[];var a=new s,r={},i=t.io.serializeObj(this.app.getScene().getRoot(),this),o=[],n=this.app.getScene().lightmaps;for(var l in n){var h={};h.name=n[l].getName(),o.push(h)}r.rootNode=i,r.lightmap=o;var c=JSON.stringify(r),u=this.getAssetByName(this.app.getScene().name);u.Parse(c,this);var d=this.getAssetUrl(u);a.files[d]=c,e(a,t.io.SerializeDependent.resoursePaths)},assetMgr.prototype.savePrefab=function(e,a,r){t.io.SerializeDependent.resoursePaths=[];var i=new s,o=this.getAssetByName(a);o.apply(e);var n=t.io.serializeObj(e,null,this),l=this.getAssetUrl(o);i.files[l]=JSON.stringify(n),r(i,t.io.SerializeDependent.resoursePaths)},assetMgr.prototype.saveMaterial=function(e,a){var r=new s,i={},o={},n=e.getShader(),l=n.defaultValue;i.shader=n.getName(),i.mapUniform=o;for(var h in l)if(void 0!=e.mapUniform[h]){var c={},u=e.mapUniform[h];switch(c.type=u.type,u.type){case t.render.UniformTypeEnum.Texture:c.value=null!=u.value?u.value.name.name:"";break;case t.render.UniformTypeEnum.Float4:case t.render.UniformTypeEnum.Float:c.value=u.value}o[h]=c}var d=this.getAssetUrl(e);r.files[d]=JSON.stringify(i),a(r)},assetMgr.prototype.loadSingleResImmediate=function(r,i){var o,n=this,s=this.getFileName(r),l=s.substring(0,s.indexOf("."));if(i==a.GLVertexShader)t.io.loadText(r,function(t,e){n.shaderPool.compileVS(n.webgl,l,t)});else if(i==a.GLFragmentShader)t.io.loadText(r,function(t,e){n.shaderPool.compileFS(n.webgl,l,t)});else if(i==a.Shader)o=new e.shader(s),t.io.loadText(r,function(t,e){o.parse(n,JSON.parse(t)),n.mapShader[s]=o});else if(i==a.Texture){o=new e.texture(s);var h=new Image;h.src=r,h.onload=function(){var e=t.render.TextureFormatEnum.RGBA;o.glTexture=new t.render.glTexture2D(n.webgl,e),o.glTexture.uploadImage(h,!1,!1),n.use(o)}}else{if(i!=a.Mesh)throw new Error("cant use the type:"+i);o=new e.mesh(s),t.io.loadArrayBuffer(r,function(t,e){o.Parse(t,n.webgl),n.use(o)})}return o},assetMgr.prototype.loadImmediate=function(e,r){void 0===r&&(r=a.Auto);var o;if(r==a.Auto&&(r=this.calcType(e)),r==a.Unknown)throw new Error("unknown format");return r==a.Bundle?(o=new i(e),t.io.loadText(e,function(t,e){o.parse(JSON.parse(t))})):o=this.loadSingleResImmediate(e,r),o},assetMgr.prototype.getFileName=function(t){var e=t.lastIndexOf("/");return t.substr(e+1)},assetMgr.prototype.calcType=function(t){for(var e=t.lastIndexOf("/"),r=t.substr(e+1),i=r.indexOf(".",0),o=null;i>=0;){if(".vs.glsl"==(o=r.substr(i)))return a.GLVertexShader;if(".assetbundle.json"==o)return a.Bundle;if(".fs.glsl"==o)return a.GLFragmentShader;if(".shader.json"==o)return a.Shader;if(".png"==o||".jpg"==o)return a.Texture;if(".pvr.bin"==o||".pvr"==o)return a.PVR;if(".imgdesc.json"==o)return a.TextureDesc;if(".mat.json"==o)return a.Material;if(".mesh.bin"==o)return a.Mesh;if(".aniclip.bin"==o)return a.Aniclip;if(".prefab.json"==o)return a.Prefab;if(".scene.json"==o)return a.Scene;if(".atlas.json"==o)return a.Atlas;if(".font.json"==o)return a.Font;if(".json"==o||".txt"==o||".effect.json"==o)return a.TextAsset;if(".packs.bin"==o)return a.PackBin;if(".packs.txt"==o)return a.PackTxt;if(".path.json"==o)return a.pathAsset;i=r.indexOf(".",i+1)}return a.Unknown},assetMgr}();e.assetMgr=o;var n=function(){return function assetRef(){}}();e.assetRef=n;var s=function(){return function SaveInfo(){this.files={}}}();e.SaveInfo=s}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var PVRHeader=function(){function PVRHeader(t){this.version=55727696,this.flags=0,this.pixelFormatH=0,this.pixelFormatL=0,this.colourSpace=0,this.channelType=0,this.height=1,this.width=1,this.depth=1,this.numSurfaces=1,this.numFaces=1,this.mipMapCount=1,this.metaDataSize=0,this.gl=t}return PVRHeader.prototype.parse=function(t){var e=new Uint8Array(t),a=new gd3d.io.binTool;return a.writeUint8Array(e),this.version=a.readUInt32(),55727696===this.version?(this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,1),this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,0),this.parseV3(a)):1347834371!==this.version?(console.error("pvr parse error!:"+this.version),null):void console.error("v2")},PVRHeader.prototype.parseV3=function(t){this.flags=t.readUInt32(),this.pixelFormatH=t.readUInt32(),this.pixelFormatL=t.readUInt32(),this.colourSpace=t.readUInt32(),this.channelType=t.readUInt32(),this.height=t.readUInt32(),this.width=t.readUInt32(),this.depth=t.readUInt32(),this.numSurfaces=t.readUInt32(),this.numFaces=t.readUInt32(),this.mipMapCount=t.readUInt32(),this.metaDataSize=t.readUInt32(),t.readBytes(this.metaDataSize);var e,a,r=new gd3d.render.glTexture2D(this.gl);switch(this.pixelFormatH){case 0:a=r.ext.COMPRESSED_RGB_PVRTC_2BPPV1_IMG,e=gd3d.render.TextureFormatEnum.PVRTC2_RGB;break;case 1:a=r.ext.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG,e=gd3d.render.TextureFormatEnum.PVRTC2_RGBA;break;case 2:a=r.ext.COMPRESSED_RGB_PVRTC_4BPPV1_IMG,e=gd3d.render.TextureFormatEnum.PVRTC4_RGB;break;case 3:a=r.ext.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG,e=gd3d.render.TextureFormatEnum.PVRTC4_RGBA;break;default:a=this.gl.RGB,e=gd3d.render.TextureFormatEnum.RGB,console.log("unknow pixel format::"+this.pixelFormatH)}switch(r.format=e,this.channelType){case ChannelTypes.UnsignedByteNorm:this.gl.UNSIGNED_BYTE;break;case ChannelTypes.UnsignedShortNorm:}var i=this.gl.TEXTURE_2D;this.numFaces>1&&(i=this.gl.TEXTURE_CUBE_MAP),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(i,r.texture),this.numFaces>1&&(i=this.gl.TEXTURE_CUBE_MAP_POSITIVE_X);for(var o=0,n=0;n<this.mipMapCount;++n){var s=function textureLevelSize(t,e,a){switch(t){case r.ext.COMPRESSED_RGB_S3TC_DXT1_EXT:case r.ext.COMPRESSED_RGB_ATC_WEBGL:case r.ext.COMPRESSED_RGB_ETC1_WEBGL:return(e+3>>2)*(a+3>>2)*8;case r.ext.COMPRESSED_RGBA_S3TC_DXT3_EXT:case r.ext.COMPRESSED_RGBA_S3TC_DXT5_EXT:case r.ext.COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL:case r.ext.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL:return(e+3>>2)*(a+3>>2)*16;case r.ext.COMPRESSED_RGB_PVRTC_4BPPV1_IMG:case r.ext.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG:return Math.floor((Math.max(e,8)*Math.max(a,8)*4+7)/8);case r.ext.COMPRESSED_RGB_PVRTC_2BPPV1_IMG:case r.ext.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG:return Math.floor((Math.max(e,16)*Math.max(a,8)*2+7)/8);default:return 0}}(a,this.width,this.height),l=t.readBytes(s);this.gl.compressedTexImage2D(this.gl.TEXTURE_2D,n,a,this.width,this.height,0,l),this.width=this.width>>1,this.width<1&&(this.width=1),this.height=this.height>>1,this.height<1&&(this.height=1),o+=s}return this.mipMapCount>1?(this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_NEAREST)):(this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR)),r},PVRHeader}(),ChannelTypes;!function(t){t[t.UnsignedByteNorm=0]="UnsignedByteNorm",t[t.SignedByteNorm=1]="SignedByteNorm",t[t.UnsignedByte=2]="UnsignedByte",t[t.SignedByte=3]="SignedByte",t[t.UnsignedShortNorm=4]="UnsignedShortNorm",t[t.SignedShortNorm=5]="SignedShortNorm",t[t.UnsignedShort=6]="UnsignedShort",t[t.SignedShort=7]="SignedShort",t[t.UnsignedIntegerNorm=8]="UnsignedIntegerNorm",t[t.SignedIntegerNorm=9]="SignedIntegerNorm",t[t.UnsignedInteger=10]="UnsignedInteger",t[t.SignedInteger=11]="SignedInteger",t[t.SignedFloat=12]="SignedFloat",t[t.Float=12]="Float",t[t.UnsignedFloat=13]="UnsignedFloat"}(ChannelTypes||(ChannelTypes={}));var gd3d;!function(t){!function(e){var a=function(){function defMesh(){}return defMesh.initDefaultMesh=function(e){e.mapDefaultMesh.cube=defMesh.createDefaultMesh("cube",t.render.meshData.genBoxCCW(1),e.webgl),e.mapDefaultMesh.quad=defMesh.createDefaultMesh("circleline",t.render.meshData.genQuad(1),e.webgl),e.mapDefaultMesh.quad_particle=defMesh.createDefaultMesh("quad_particle",t.render.meshData.genQuad_forparticle(1),e.webgl),e.mapDefaultMesh.plane=defMesh.createDefaultMesh("plane",t.render.meshData.genPlaneCCW(10),e.webgl),e.mapDefaultMesh.sphere=defMesh.createDefaultMesh("sphere",t.render.meshData.genSphereCCW(),e.webgl),e.mapDefaultMesh.pyramid=defMesh.createDefaultMesh("pyramid",t.render.meshData.genPyramid(2,.5),e.webgl),e.mapDefaultMesh.cylinder=defMesh.createDefaultMesh("cylinder",t.render.meshData.genCylinderCCW(2,.5),e.webgl),e.mapDefaultMesh.circleline=defMesh.createDefaultMesh("circleline",t.render.meshData.genCircleLineCCW(1),e.webgl)},defMesh.createDefaultMesh=function(a,r,i){var o=new e.mesh(a+".mesh.bin");o.defaultAsset=!0,o.data=r;var n=t.render.VertexFormatMask.Position|t.render.VertexFormatMask.Normal|t.render.VertexFormatMask.Tangent|t.render.VertexFormatMask.Color|t.render.VertexFormatMask.UV0,s=o.data.genVertexDataArray(n),l=o.data.genIndexDataArray();o.glMesh=new t.render.glMesh,o.glMesh.initBuffer(i,n,o.data.pos.length),o.glMesh.uploadVertexSubData(i,s),o.glMesh.addIndex(i,l.length),o.glMesh.uploadIndexSubData(i,0,l),o.submesh=[];var h=new e.subMeshInfo;return h.matIndex=0,h.useVertexIndex=0,h.start=0,h.size=l.length,h.line=!1,o.submesh.push(h),o},defMesh}();e.defMesh=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function defShader(){}return defShader.initDefaultShader=function(a){var r=a.shaderPool;r.compileVS(a.webgl,"def",defShader.vscode),r.compileFS(a.webgl,"def",defShader.fscode),r.compileFS(a.webgl,"def2",defShader.fscode2),r.compileFS(a.webgl,"defui",defShader.fscodeui),r.compileVS(a.webgl,"defuifont",defShader.vscodeuifont),r.compileFS(a.webgl,"defuifont",defShader.fscodeuifont),r.compileVS(a.webgl,"diffuse",defShader.vsdiffuse),r.compileFS(a.webgl,"diffuse",defShader.fsdiffuse),r.compileVS(a.webgl,"line",defShader.vsline),r.compileFS(a.webgl,"line",defShader.fsline),r.compileVS(a.webgl,"materialcolor",defShader.vsmaterialcolor);var i=r.linkProgram(a.webgl,"def","def"),o=r.linkProgram(a.webgl,"def","defui"),n=r.linkProgram(a.webgl,"defuifont","defuifont"),s=r.linkProgram(a.webgl,"diffuse","diffuse"),l=r.linkProgram(a.webgl,"line","line"),h=r.linkProgram(a.webgl,"materialcolor","line");(c=new e.shader("shader/def")).defaultAsset=!0,c.passes.base=[];u=new t.render.glDrawPass;c.passes.base.push(u),u.state_ztest=!0,u.state_ztest_method=t.render.webglkit.LEQUAL,u.state_zwrite=!0,u.state_showface=t.render.ShowFaceStateEnum.CCW,u.setProgram(i),u.setAlphaBlend(t.render.BlendModeEnum.Close),u.uniformTexture("_MainTex",null),a.mapShader[c.getName()]=c,(c=new e.shader("shader/def3dbeforeui")).defaultAsset=!0,c.passes.base=[];u=new t.render.glDrawPass;c.passes.base.push(u),u.state_ztest=!1,u.state_ztest_method=t.render.webglkit.LEQUAL,u.state_zwrite=!1,u.state_showface=t.render.ShowFaceStateEnum.CCW,u.setProgram(s),u.setAlphaBlend(t.render.BlendModeEnum.Close),u.uniformTexture("_MainTex",null),a.mapShader[c.getName()]=c,(c=new e.shader("shader/def2")).defaultAsset=!0,c.passes.base=[];u=new t.render.glDrawPass;c.passes.base.push(u),u.setProgram(o),u.state_showface=t.render.ShowFaceStateEnum.ALL,u.state_ztest=!1,u.state_ztest_method=t.render.webglkit.LEQUAL,u.setAlphaBlend(t.render.BlendModeEnum.Close),a.mapShader[c.getName()]=c,(c=new e.shader("shader/defui")).defaultAsset=!0,c.passes.base=[];u=new t.render.glDrawPass;c.passes.base.push(u),u.setProgram(o),u.state_showface=t.render.ShowFaceStateEnum.ALL,u.state_ztest=!1,u.state_zwrite=!1,u.state_ztest_method=t.render.webglkit.LEQUAL,u.setAlphaBlend(t.render.BlendModeEnum.Blend_PreMultiply),a.mapShader[c.getName()]=c,(c=new e.shader("shader/defuifont")).defaultAsset=!0,c.passes.base=[];u=new t.render.glDrawPass;c.passes.base.push(u),u.setProgram(n),u.state_showface=t.render.ShowFaceStateEnum.ALL,u.state_ztest=!1,u.state_zwrite=!1,u.state_ztest_method=t.render.webglkit.LEQUAL,u.setAlphaBlend(t.render.BlendModeEnum.Blend_PreMultiply),a.mapShader[c.getName()]=c,(c=new e.shader("shader/line")).defaultAsset=!0,c.passes.base=[];u=new t.render.glDrawPass;c.passes.base.push(u),u.setProgram(l),u.state_ztest=!0,u.state_ztest_method=t.render.webglkit.LEQUAL,u.state_zwrite=!0,u.state_showface=t.render.ShowFaceStateEnum.ALL,u.setAlphaBlend(t.render.BlendModeEnum.Close),a.mapShader[c.getName()]=c;var c=new e.shader("shader/materialcolor");c.defaultAsset=!0,c.passes.base=[];var u=new t.render.glDrawPass;c.passes.base.push(u),u.setProgram(h),u.state_ztest=!1,u.state_showface=t.render.ShowFaceStateEnum.ALL,u.setAlphaBlend(t.render.BlendModeEnum.Close),c.layer=e.RenderLayerEnum.Overlay,a.mapShader[c.getName()]=c},defShader}();a.vscode="    attribute vec4 _glesVertex;       attribute vec4 _glesColor;                      attribute vec4 _glesMultiTexCoord0;             uniform highp mat4 glstate_matrix_mvp;          varying lowp vec4 xlv_COLOR;                    varying highp vec2 xlv_TEXCOORD0;               void main()                                         {                                                       highp vec4 tmpvar_1;                                tmpvar_1.w = 1.0;                                   tmpvar_1.xyz = _glesVertex.xyz;                     xlv_COLOR = _glesColor;                             xlv_TEXCOORD0 = _glesMultiTexCoord0.xy;             gl_Position = (glstate_matrix_mvp * tmpvar_1);      }",a.fscode="             uniform sampler2D _MainTex;                                                     varying lowp vec4 xlv_COLOR;                                                     varying highp vec2 xlv_TEXCOORD0;       void main()     {        lowp vec4 col_1;            mediump vec4 prev_2;        lowp vec4 tmpvar_3;        tmpvar_3 = (xlv_COLOR * texture2D(_MainTex, xlv_TEXCOORD0));        prev_2 = tmpvar_3;        mediump vec4 tmpvar_4;        tmpvar_4 = mix(vec4(1.0, 1.0, 1.0, 1.0), prev_2, prev_2.wwww);        col_1 = tmpvar_4;        col_1.x =xlv_TEXCOORD0.x;        col_1.y =xlv_TEXCOORD0.y;        gl_FragData[0] = col_1;    }    ",a.fscode2="             void main()     {        gl_FragData[0] = vec4(1.0, 1.0, 1.0, 1.0);    }    ",a.fscodeui="             uniform sampler2D _MainTex;                                                     varying lowp vec4 xlv_COLOR;                                                     varying highp vec2 xlv_TEXCOORD0;       void main()     {        lowp vec4 tmpvar_3;        tmpvar_3 = (xlv_COLOR * texture2D(_MainTex, xlv_TEXCOORD0));        gl_FragData[0] = tmpvar_3;    }    ",a.vscodeuifont="    attribute vec4 _glesVertex;       attribute vec4 _glesColor;                      attribute vec4 _glesColorEx;                      attribute vec4 _glesMultiTexCoord0;             uniform highp mat4 glstate_matrix_mvp;          varying lowp vec4 xlv_COLOR;                    varying lowp vec4 xlv_COLOREx;                                                     varying highp vec2 xlv_TEXCOORD0;               void main()                                         {                                                       highp vec4 tmpvar_1;                                tmpvar_1.w = 1.0;                                   tmpvar_1.xyz = _glesVertex.xyz;                     xlv_COLOR = _glesColor;                             xlv_COLOREx = _glesColorEx;                             xlv_TEXCOORD0 = _glesMultiTexCoord0.xy;             gl_Position = (glstate_matrix_mvp * tmpvar_1);      }",a.fscodeuifont="precision mediump float;//鎸囧畾娴偣鍨嬬簿纭害 \nuniform sampler2D _MainTex; \nvarying lowp vec4 xlv_COLOR;\nvarying lowp vec4 xlv_COLOREx;\nvarying highp vec2 xlv_TEXCOORD0;   \nvoid main() \n{\nfloat scale = 10.0;//  \nfloat d = (texture2D(_MainTex, xlv_TEXCOORD0).r - 0.5)*scale;  //0.5\nfloat bd = (texture2D(_MainTex, xlv_TEXCOORD0).r - 0.34)*scale;  //0.34\n\nfloat c=xlv_COLOR.a * clamp ( d,0.0,1.0); \nfloat bc=xlv_COLOREx.a * clamp ( bd,0.0,1.0); \nbc =min(1.0-c,bc);\n\n\n\ngl_FragData[0] =xlv_COLOR*c + xlv_COLOREx*bc;\n}",a.vsdiffuse="    attribute vec4 _glesVertex;    attribute vec4 _glesMultiTexCoord0;    uniform highp mat4 glstate_matrix_mvp;    varying highp vec2 xlv_TEXCOORD0;    void main()    {        highp vec4 tmpvar_1;        tmpvar_1.w = 1.0;        tmpvar_1.xyz = _glesVertex.xyz;        xlv_TEXCOORD0 = _glesMultiTexCoord0.xy;        gl_Position = (glstate_matrix_mvp * tmpvar_1);    }",a.fsdiffuse="    uniform sampler2D _MainTex;    uniform lowp float _AlphaCut;    varying highp vec2 xlv_TEXCOORD0;    void main()     {        lowp vec4 tmpvar_3 = texture2D(_MainTex, xlv_TEXCOORD0);        if(tmpvar_3.a < _AlphaCut)            discard;        gl_FragData[0] = tmpvar_3;    }",a.vsline="    attribute vec4 _glesVertex;    attribute vec4 _glesColor;    uniform highp mat4 glstate_matrix_mvp;    varying lowp vec4 xlv_COLOR;    void main()    {        highp vec4 tmpvar_1;        tmpvar_1.w = 1.0;        tmpvar_1.xyz = _glesVertex.xyz;        xlv_COLOR = _glesColor;        gl_Position = (glstate_matrix_mvp * tmpvar_1);    }",a.fsline="    varying lowp vec4 xlv_COLOR;    void main()    {        gl_FragData[0] = xlv_COLOR;    }",a.vsmaterialcolor="    attribute vec4 _glesVertex;    uniform vec4 _Color;    uniform highp mat4 glstate_matrix_mvp;    varying lowp vec4 xlv_COLOR;    void main()    {        highp vec4 tmpvar_1;        tmpvar_1.w = 1.0;        tmpvar_1.xyz = _glesVertex.xyz;        xlv_COLOR = _Color;        gl_Position = (glstate_matrix_mvp * tmpvar_1);    }",e.defShader=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function defTexture(){}return defTexture.initDefaultTexture=function(a){var r=new e.texture("white");r.glTexture=t.render.glTexture2D.staticTexture(a.webgl,"white"),r.defaultAsset=!0,a.mapDefaultTexture.white=r,(r=new e.texture("gray")).glTexture=t.render.glTexture2D.staticTexture(a.webgl,"gray"),r.defaultAsset=!0,a.mapDefaultTexture.gray=r,(r=new e.texture("grid")).glTexture=t.render.glTexture2D.staticTexture(a.webgl,"grid"),r.defaultAsset=!0,a.mapDefaultTexture.grid=r},defTexture}();e.defTexture=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function animationClip(t){if(void 0===t&&(t=null),this.id=new e.resID,this.defaultAsset=!1,t||(t="animationClip_"+this.getGUID()),!e.sceneMgr.app.getAssetMgr().nameDuplicateCheck(t))throw new Error("already have name.");this.name=new e.constText(t)}return animationClip.prototype.getName=function(){return this.name.getText()},animationClip.prototype.getGUID=function(){return this.id.getID()},animationClip.prototype.use=function(){e.sceneMgr.app.getAssetMgr().use(this)},animationClip.prototype.unuse=function(t){void 0===t&&(t=!1),e.sceneMgr.app.getAssetMgr().unuse(this,t)},animationClip.prototype.dispose=function(){this.bones.length=0,this.subclips.length=0,delete this.frames},animationClip.prototype.caclByteLength=function(){var e=0;for(var a in this.bones)e+=t.math.caclStringByteLength(this.bones[a]);for(var a in this.frames)e+=this.frames[a].byteLength,e+=t.math.caclStringByteLength(a);return e+=i.caclByteLength()*this.subclips.length},animationClip.prototype.Parse=function(e){var a=new t.io.binReader(e);a.readStringAnsi();this.fps=a.readFloat(),this.loop=a.readBoolean(),this.boneCount=a.readInt(),this.bones=[];for(n=0;n<this.boneCount;n++)this.bones.push(a.readStringAnsi());this.subclipCount=a.readInt(),this.subclips=[];for(n=0;n<this.subclipCount;n++){var o=new i;o.name=a.readStringAnsi(),o.loop=a.readBoolean(),this.subclips.push(o)}this.frameCount=a.readInt(),this.frames={};for(var n=0;n<this.frameCount;n++){var s=a.readInt().toString(),l=a.readBoolean(),h=new Float32Array(7*this.boneCount+1);h[0]=l?1:0;for(var c=new r,u=0;u<this.boneCount;u++)c.load(a),h[7*u+1]=c.r.x,h[7*u+2]=c.r.y,h[7*u+3]=c.r.z,h[7*u+4]=c.r.w,h[7*u+5]=c.t.x,h[7*u+6]=c.t.y,h[7*u+7]=c.t.z;this.frames[s]=h}e=null},animationClip}();__decorate([t.reflect.Field("constText"),__metadata("design:type",e.constText)],a.prototype,"name",void 0),a=__decorate([t.reflect.SerializeType,__metadata("design:paramtypes",[String])],a),e.animationClip=a;var r=o=function(){function PoseBoneMatrix(){}return PoseBoneMatrix.caclByteLength=function(){return 28},PoseBoneMatrix.prototype.Clone=function(){var e=new o;return e.t=new t.math.vector3,e.r=new t.math.quaternion,t.math.vec3Clone(this.t,e.t),t.math.quatClone(this.r,e.r),e},PoseBoneMatrix.prototype.load=function(e){var a=e.readSingle(),r=e.readSingle(),i=e.readSingle(),o=e.readSingle();this.r=new t.math.quaternion(a,r,i,o);var a=e.readSingle(),r=e.readSingle(),i=e.readSingle();this.t=new t.math.vector3(a,r,i)},PoseBoneMatrix.createDefault=function(){var e=new o;return e.r=new t.math.quaternion(0,0,0,1),e.t=new t.math.vector3(0,0,0),e},PoseBoneMatrix.prototype.copyFrom=function(t){this.r.x=t.r.x,this.r.y=t.r.y,this.r.z=t.r.z,this.r.w=t.r.w,this.t.x=t.t.x,this.t.y=t.t.y,this.t.z=t.t.z},PoseBoneMatrix.prototype.copyFromData=function(t,e){this.r.x=t[e+0],this.r.y=t[e+1],this.r.z=t[e+2],this.r.w=t[e+3],this.t.x=t[e+4],this.t.y=t[e+5],this.t.z=t[e+6]},PoseBoneMatrix.prototype.invert=function(){t.math.quatInverse(this.r,this.r),t.math.quatTransformVector(this.r,this.t,this.t),this.t.x*=-1,this.t.y*=-1,this.t.z*=-1},PoseBoneMatrix.prototype.lerpInWorld=function(t,e,a,r){var i=o.sMultiply(e,t),n=o.sMultiply(a,t),s=o.sLerp(i,n,r),l=t.Clone();l.invert(),o.sMultiply(s,l,this)},PoseBoneMatrix.prototype.lerpInWorldWithData=function(t,e,a,r,i){var n=o.sMultiply(e,t),s=o.sMultiplyDataAndMatrix(a,r,t),l=o.sLerp(n,s,i),h=t.Clone();h.invert(),o.sMultiply(l,h,this)},PoseBoneMatrix.sMultiply=function(e,a,r){void 0===r&&(r=null),null==r&&(r=o.createDefault());var i=t.math.pool.new_vector3();t.math.vec3Clone(a.t,i);var n=t.math.pool.new_vector3();return t.math.quatTransformVector(e.r,i,n),r.t.x=n.x+e.t.x,r.t.y=n.y+e.t.y,r.t.z=n.z+e.t.z,t.math.quatMultiply(e.r,a.r,r.r),t.math.pool.delete_vector3(i),t.math.pool.delete_vector3(n),r},PoseBoneMatrix.sMultiplyDataAndMatrix=function(e,a,r,i){void 0===i&&(i=null),null==i&&(i=o.createDefault());var n=t.math.pool.new_vector3();t.math.vec3Clone(r.t,n);var s=t.math.pool.new_vector3();return t.math.quatTransformVectorDataAndQuat(e,a+0,n,s),i.t.x=s.x+e[a+4],i.t.y=s.y+e[a+5],i.t.z=s.z+e[a+6],t.math.quatMultiplyDataAndQuat(e,a+0,r.r,i.r),t.math.pool.delete_vector3(n),t.math.pool.delete_vector3(s),i},PoseBoneMatrix.sLerp=function(e,a,r,i){return void 0===i&&(i=null),null==i&&(i=o.createDefault()),i.t.x=e.t.x*(1-r)+a.t.x*r,i.t.y=e.t.y*(1-r)+a.t.y*r,i.t.z=e.t.z*(1-r)+a.t.z*r,t.math.quatLerp(e.r,a.r,i.r,r),i},PoseBoneMatrix}();__decorate([t.reflect.Field("vector3"),__metadata("design:type",t.math.vector3)],r.prototype,"t",void 0),__decorate([t.reflect.Field("quaternion"),__metadata("design:type",t.math.quaternion)],r.prototype,"r",void 0),r=o=__decorate([t.reflect.SerializeType],r),e.PoseBoneMatrix=r;var i=function(){function subClip(){}return subClip.caclByteLength=function(){var e=0;return e+=t.math.caclStringByteLength(name),e+=1,e+=8},subClip}();e.subClip=i;var o}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function atlas(t){if(void 0===t&&(t=null),this.id=new e.resID,this.sprites={},t||(t="atlas_"+this.getGUID()),!e.sceneMgr.app.getAssetMgr().nameDuplicateCheck(t))throw new Error("already have name.");this.name=new e.constText(t)}return atlas.prototype.getName=function(){return this.name.getText()},atlas.prototype.getGUID=function(){return this.id.getID()},atlas.prototype.use=function(){e.sceneMgr.app.getAssetMgr().use(this)},atlas.prototype.unuse=function(t){void 0===t&&(t=!1),e.sceneMgr.app.getAssetMgr().unuse(this,t)},atlas.prototype.dispose=function(){for(var t in this.sprites)this.sprites[t].unuse();this.texture.unuse(),delete this.sprites},atlas.prototype.caclByteLength=function(){var e=0;for(var a in this.sprites)e+=this.sprites[a].caclByteLength(),e+=t.math.caclStringByteLength(a);return e},Object.defineProperty(atlas.prototype,"texture",{get:function(){return this._texture},set:function(t){null!=this._texture&&this._texture.unuse(),this._texture=t,this._texture.use()},enumerable:!0,configurable:!0}),atlas.prototype.Parse=function(a,r){var i=JSON.parse(a),o=i.t;this.texturewidth=i.w,this.textureheight=i.h;var n=i.s;this.texture=r.getAssetByName(o),null==this.texture&&console.log("atlas的图片名字不对");for(var s in n){var l=n[s],h=l[0],c=new e.sprite(this.getName()+"_"+h);r.use(c),this.texture&&(c.texture=this.texture),c.rect=new t.math.rect(l[1],l[2],l[3],l[4]),c.border=new t.math.border(0,0,0,0),c.atlas=this.getName(),this.sprites[h]=c}},atlas}();a=__decorate([t.reflect.SerializeType,__metadata("design:paramtypes",[String])],a),e.atlas=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function font(t){if(void 0===t&&(t=null),this.id=new e.resID,t||(t="font_"+this.getGUID()),!e.sceneMgr.app.getAssetMgr().nameDuplicateCheck(t))throw new Error("already have name.");this.name=new e.constText(t)}return font.prototype.getName=function(){return this.name.getText()},font.prototype.getGUID=function(){return this.id.getID()},font.prototype.use=function(){e.sceneMgr.app.getAssetMgr().use(this)},font.prototype.unuse=function(t){void 0===t&&(t=!1),e.sceneMgr.app.getAssetMgr().unuse(this,t)},font.prototype.dispose=function(){this.texture&&this.texture.unuse(!0),delete this.cmap},font.prototype.caclByteLength=function(){var e=0;for(var a in this.cmap)e+=t.math.caclStringByteLength(a),e+=r.caclByteLength();return e},Object.defineProperty(font.prototype,"texture",{get:function(){return this._texture},set:function(t){null!=this._texture&&this._texture.unuse(),this._texture=t,this._texture.use()},enumerable:!0,configurable:!0}),font.prototype.Parse=function(t,e){var a=(new Date).valueOf(),i=JSON.parse(t),o=i.font;this.fontname=o[0];var n=o[1];this.texture=e.getAssetByName(n),this.pointSize=o[2],this.padding=o[3],this.lineHeight=o[4],this.baseline=o[5],this.atlasWidth=o[6],this.atlasHeight=o[7],this.cmap={};var s=i.map;for(var l in s){var h=new r;this.cmap[l]=h,h.x=(s[l][0]-.5)/this.atlasWidth,h.y=(s[l][1]-.5)/this.atlasHeight,h.w=(s[l][2]+1)/this.atlasWidth,h.h=(s[l][3]+1)/this.atlasHeight,h.xSize=s[l][2],h.ySize=s[l][3],h.xOffset=s[l][4],h.yOffset=s[l][5],h.xAddvance=s[l][6]}s=null,i=null;(new Date).valueOf()},font}();a=__decorate([t.reflect.SerializeType,__metadata("design:paramtypes",[String])],a),e.font=a;var r=function(){function charinfo(){}return charinfo.caclByteLength=function(){return 36},charinfo}();e.charinfo=r}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){return function UniformData(t,e,a){void 0===a&&(a=null),this.type=t,this.value=e,this.defaultValue=a}}();__decorate([t.reflect.Field("number"),t.reflect.UIStyle("UniformTypeEnum"),__metadata("design:type",Number)],a.prototype,"type",void 0),__decorate([t.reflect.Field("any"),__metadata("design:type",Object)],a.prototype,"value",void 0),a=__decorate([t.reflect.SerializeType,__metadata("design:paramtypes",[Number,Object,Object])],a),e.UniformData=a;var r=i=function(){function material(a){if(void 0===a&&(a=null),this.name=null,this.id=new e.resID,this.defaultAsset=!1,this._changeShaderMap={},this.mapUniform={},a||(a="material_"+this.getGUID()),!e.sceneMgr.app.getAssetMgr().nameDuplicateCheck(a))throw new Error("already have name.");this.name=new e.constText(a),t.io.enumMgr.enumMap.UniformTypeEnum=t.render.UniformTypeEnum,this.mapUniformTemp={}}return material.prototype.getName=function(){return void 0==this.name?null:this.name.getText()},material.prototype.getGUID=function(){return this.id.getID()},material.prototype.dispose=function(){for(var e in this.mapUniform)switch(this.mapUniform[e].type){case t.render.UniformTypeEnum.Texture:null!=this.mapUniform[e]&&null!=this.mapUniform[e].value&&this.mapUniform[e].value.unuse(!0)}delete this.mapUniform,delete this.mapUniformTemp},material.prototype.use=function(){e.sceneMgr.app.getAssetMgr().use(this)},material.prototype.unuse=function(t){void 0===t&&(t=!1),e.sceneMgr.app.getAssetMgr().unuse(this,t)},material.prototype.caclByteLength=function(){var e=0;this.shader&&(e+=this.shader.caclByteLength());for(var a in this.mapUniform){var r=this.mapUniform[a].type,i=this.mapUniform[a].value,o=this.mapUniform[a].defaultValue;switch(r){case t.render.UniformTypeEnum.Float:e+=4;break;case t.render.UniformTypeEnum.Floatv:e+=i.byteLength;break;case t.render.UniformTypeEnum.Float4:e+=16;break;case t.render.UniformTypeEnum.Float4v:e+=i.byteLength;break;case t.render.UniformTypeEnum.Float4x4:e+=64;break;case t.render.UniformTypeEnum.Float4x4v:e+=i.byteLength;break;case t.render.UniformTypeEnum.Texture:null!=i?e+=i.caclByteLength():null!=o&&(e+=o.caclByteLength())}}for(var a in this.mapUniformTemp){var r=this.mapUniformTemp[a].type,i=this.mapUniformTemp[a].value,o=this.mapUniformTemp[a].defaultValue;switch(r){case t.render.UniformTypeEnum.Float:e+=4;break;case t.render.UniformTypeEnum.Floatv:e+=i.byteLength;break;case t.render.UniformTypeEnum.Float4:e+=16;break;case t.render.UniformTypeEnum.Float4v:e+=i.byteLength;break;case t.render.UniformTypeEnum.Float4x4:e+=64;break;case t.render.UniformTypeEnum.Float4x4v:e+=i.byteLength;break;case t.render.UniformTypeEnum.Texture:null!=i?e+=i.caclByteLength():null!=o&&(e+=o.caclByteLength())}}return e},material.prototype.initUniformData=function(e){if(null!=e)for(var r=0;r<e.length;r++){var i=e[r];for(var o in i.uniforms){var n=i.uniforms[o],s=this.shader.defaultValue[o];if(null==s){if(null==this.mapUniform[o])if(n.type==t.render.UniformTypeEnum.Float)this.mapUniform[o]=new a(n.type,n.value);else if(n.type==t.render.UniformTypeEnum.Floatv)this.mapUniform[o]=new a(n.type,new Float32Array(0));else if(n.type==t.render.UniformTypeEnum.Float4){var l=new t.math.vector4;o.indexOf("_ST")>0&&(l.x=1,l.y=1),this.mapUniform[o]=new a(n.type,l)}else n.type==t.render.UniformTypeEnum.Float4v?this.mapUniform[o]=new a(n.type,new Float32Array(0)):n.type==t.render.UniformTypeEnum.Float4x4?this.mapUniform[o]=new a(n.type,new t.math.matrix):n.type==t.render.UniformTypeEnum.Float4x4v?this.mapUniform[o]=new a(n.type,new Float32Array(0)):n.type==t.render.UniformTypeEnum.Texture&&(this.mapUniform[o]=new a(n.type,null))}else this.mapUniform[o]=new a(n.type,s.value,s.defaultValue)}}},material.prototype.setShader=function(t){this.shader=t,this.mapUniform={},this.initUniformData(this.shader.passes.base)},material.prototype.changeShader=function(t){var e;if(void 0!=this._changeShaderMap[t.getName()])e=this._changeShaderMap[t.getName()].mapUniform;else{var a=this.clone();e=a.mapUniform,this._changeShaderMap[t.getName()]=a}this.setShader(t);for(var r in e)void 0!=this.mapUniform[r]&&(this.mapUniform[r]=e[r])},material.prototype.getLayer=function(){return this.shader.layer},material.prototype.getQueue=function(){return this.shader.queue},material.prototype.getShader=function(){return this.shader},material.prototype.setFloat=function(e,r){void 0!=this.mapUniform[e]?this.mapUniform[e].value=r:this.mapUniformTemp[e]=new a(t.render.UniformTypeEnum.Float,r)},material.prototype.setFloatv=function(e,r){void 0!=this.mapUniform[e]?this.mapUniform[e].value=r:this.mapUniformTemp[e]=new a(t.render.UniformTypeEnum.Floatv,r)},material.prototype.setVector4=function(e,r){void 0!=this.mapUniform[e]?this.mapUniform[e].value=r:this.mapUniformTemp[e]=new a(t.render.UniformTypeEnum.Float4,r)},material.prototype.setVector4v=function(e,r){void 0!=this.mapUniform[e]?this.mapUniform[e].value=r:this.mapUniformTemp[e]=new a(t.render.UniformTypeEnum.Float4v,r)},material.prototype.setMatrix=function(e,r){void 0!=this.mapUniform[e]?this.mapUniform[e].value=r:this.mapUniformTemp[e]=new a(t.render.UniformTypeEnum.Float4x4,r)},material.prototype.setMatrixv=function(e,r){void 0!=this.mapUniform[e]?this.mapUniform[e].value=r:this.mapUniformTemp[e]=new a(t.render.UniformTypeEnum.Float4x4v,r)},material.prototype.setTexture=function(e,r){void 0!=this.mapUniform[e]?(this.mapUniform[e].value&&this.mapUniform[e].value.unuse(),this.mapUniform[e].value=r,null!=r&&r.use()):this.mapUniformTemp[e]=new a(t.render.UniformTypeEnum.Texture,r)},material.prototype.uploadUniform=function(e){for(var a in this.mapUniform){var r=this.mapUniform[a].type,i=this.mapUniform[a].value,o=this.mapUniform[a].defaultValue;if(null!=(n=e.uniforms[a]))switch(r){case t.render.UniformTypeEnum.Float:e.uniformFloat(a,i);break;case t.render.UniformTypeEnum.Floatv:e.uniformFloatv(a,i);break;case t.render.UniformTypeEnum.Float4:e.uniformVec4(a,i);break;case t.render.UniformTypeEnum.Float4v:e.uniformVec4v(a,i);break;case t.render.UniformTypeEnum.Float4x4:e.uniformMatrix(a,i);break;case t.render.UniformTypeEnum.Float4x4v:e.uniformMatrixV(a,i);break;case t.render.UniformTypeEnum.Texture:null!=i?e.uniformTexture(a,i.glTexture):null!=o?e.uniformTexture(a,o.glTexture):e.uniformTexture(a,null)}}for(var a in this.mapUniformTemp){var r=this.mapUniformTemp[a].type,i=this.mapUniformTemp[a].value,n=e.uniforms[a];if(null!=n)switch(r){case t.render.UniformTypeEnum.Float:e.uniformFloat(a,i);break;case t.render.UniformTypeEnum.Floatv:e.uniformFloatv(a,i);break;case t.render.UniformTypeEnum.Float4:e.uniformVec4(a,i);break;case t.render.UniformTypeEnum.Float4v:e.uniformVec4v(a,i);break;case t.render.UniformTypeEnum.Float4x4:e.uniformMatrix(a,i);break;case t.render.UniformTypeEnum.Float4x4v:e.uniformMatrixV(a,i);break;case t.render.UniformTypeEnum.Texture:null!=i?e.uniformTexture(a,i.glTexture):e.uniformTexture(a,null)}}},material.prototype.draw=function(t,e,a,r){void 0===r&&(r="base");var i=this.shader.passes[r+t.drawtype];if(void 0==i&&(i=this.shader.passes["base"+t.drawtype]),void 0!=i){for(var o=0;o<i.length;o++){var n=i[o];for(var s in n.uniforms)switch(s){case"glstate_matrix_model":this.setMatrix(s,t.matrixModel);break;case"glstate_matrix_view":this.setMatrix(s,t.matrixView);break;case"glstate_matrix_project":this.setMatrix(s,t.matrixProject);break;case"glstate_matrix_modelview":this.setMatrix(s,t.matrixModelView);break;case"glstate_matrix_viewproject":this.setMatrix(s,t.matrixViewProject);break;case"glstate_matrix_mvp":this.setMatrix(s,t.matrixModelViewProject);break;case"glstate_timer":this.setFloat(s,t.floatTimer);break;case"glstate_lightcount":this.setFloat(s,t.intLightCount);break;case"glstate_vec4_lightposs":t.vec4LightPos.length>0&&this.setVector4v(s,t.vec4LightPos);break;case"glstate_vec4_lightdirs":t.vec4LightDir.length>0&&this.setVector4v(s,t.vec4LightDir);break;case"glstate_float_spotangelcoss":t.floatLightSpotAngleCos.length>0&&this.setFloatv(s,t.floatLightSpotAngleCos);break;case"glstate_eyepos":this.setVector4(s,t.eyePos);break;case"_LightmapTex":this.setTexture(s,t.lightmap);break;case"glstate_lightmapOffset":this.setVector4(s,t.lightmapOffset);break;case"glstate_lightmapUV":this.setFloat(s,t.lightmapUV);break;case"glstate_fog_start":this.setFloat(s,t.fog._Start);break;case"glstate_fog_end":this.setFloat(s,t.fog._End);break;case"glstate_fog_color":this.setVector4(s,t.fog._Color)}this.uploadUniform(n),n.use(t.webgl),e.glMesh.bind(t.webgl,n.program,a.useVertexIndex),a.useVertexIndex<0?a.line?e.glMesh.drawArrayLines(t.webgl,a.start,a.size):e.glMesh.drawArrayTris(t.webgl,a.start,a.size):a.line?e.glMesh.drawElementLines(t.webgl,a.start,a.size):e.glMesh.drawElementTris(t.webgl,a.start,a.size)}this.mapUniformTemp={}}},material.prototype.Parse=function(a,r){var i=r.shader;this.setShader(a.getShader(i));var o=r.mapUniform;for(var n in o){var s=o[n];switch(s.type){case t.render.UniformTypeEnum.Texture:var l=s.value,h=a.getAssetByName(l);void 0==h&&(h=a.getDefaultTexture("grid")),this.setTexture(n,h);break;case t.render.UniformTypeEnum.Float:l=s.value;this.setFloat(n,parseFloat(l));break;case t.render.UniformTypeEnum.Float4:var c=s.value;try{var u=c.match(e.RegexpUtil.vector4Regexp);if(null!=u){var d=new t.math.vector4(parseFloat(u[1]),parseFloat(u[2]),parseFloat(u[3]),parseFloat(u[4]));this.setVector4(n,d)}}catch(t){}break;default:console.log("materialJson的mapuniform中的某type："+s.type+"不符合范围（0-2）")}}},material.prototype.clone=function(){var e=new i(this.getName());e.setShader(this.shader);for(var a in this.mapUniform){var r=this.mapUniform[a];switch(r.type){case t.render.UniformTypeEnum.Texture:e.setTexture(a,r.value);break;case t.render.UniformTypeEnum.Float:e.setFloat(a,r.value);break;case t.render.UniformTypeEnum.Float4:e.setVector4(a,r.value)}}return e},material}();__decorate([t.reflect.Field("constText"),__metadata("design:type",e.constText)],r.prototype,"name",void 0),__decorate([t.reflect.Field("shader"),__metadata("design:type",e.shader)],r.prototype,"shader",void 0),__decorate([t.reflect.Field("UniformDataDic"),__metadata("design:type",Object)],r.prototype,"mapUniform",void 0),r=i=__decorate([t.reflect.SerializeType,__metadata("design:paramtypes",[String])],r),e.material=r;var i}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=i=function(){function mesh(t){if(void 0===t&&(t=null),this.id=new e.resID,this.defaultAsset=!1,this.submesh=[],t||(t="mesh_"+this.getGUID()),!e.sceneMgr.app.getAssetMgr().nameDuplicateCheck(t))throw new Error("already have name.");this.name=new e.constText(t)}return mesh.prototype.getName=function(){return this.name?this.name.getText():null},mesh.prototype.getGUID=function(){return this.id.getID()},mesh.prototype.use=function(){e.sceneMgr.app.getAssetMgr().use(this)},mesh.prototype.unuse=function(t){void 0===t&&(t=!1),e.sceneMgr.app.getAssetMgr().unuse(this,t)},mesh.prototype.dispose=function(){this.glMesh.dispose(e.sceneMgr.app.getAssetMgr().webgl),this.data=null,delete this.submesh},mesh.prototype.caclByteLength=function(){var t=0;return t+=this.glMesh.caclByteLength(),this.data&&(t+=this.data.caclByteLength()),t},mesh.prototype.Parse=function(e,a){var i=0,o=new t.render.meshData,n=new t.io.binReader(e);n.readStringAnsi();n.position=n.position+24;for(var s=n.readUInt32(),l=[];;){var h=n.readUInt8();if(255==h)break;if(1==h){void 0==o.pos&&(o.pos=[],i|=t.render.VertexFormatMask.Position);for(w=0;w<s;w++){var c=new t.math.vector3;c.x=n.readSingle(),c.y=n.readSingle(),c.z=n.readSingle(),o.pos.push(c)}}else if(2==h){void 0==o.color&&(o.color=[],i|=t.render.VertexFormatMask.Color);for(w=0;w<s;w++){var u=new t.math.color;u.a=n.readUInt8(),u.r=n.readUInt8(),u.g=n.readUInt8(),u.b=n.readUInt8(),o.color.push(u)}}else if(3==h){void 0==o.normal&&(o.normal=[],i|=t.render.VertexFormatMask.Normal);for(w=0;w<s;w++){var d=new t.math.vector3;d.x=n.readSingle(),d.y=n.readSingle(),d.z=n.readSingle(),o.normal.push(d)}}else if(4==h){void 0==o.uv&&(o.uv=[],i|=t.render.VertexFormatMask.UV0);for(w=0;w<s;w++)(m=new t.math.vector2).x=n.readSingle(),m.y=1-n.readSingle(),o.uv.push(m)}else if(5==h){void 0==o.uv2&&(o.uv2=[],i|=t.render.VertexFormatMask.UV1);for(w=0;w<s;w++){var m=new t.math.vector2;m.x=n.readSingle(),m.y=1-n.readSingle(),o.uv2.push(m)}}else if(6==h)for(w=0;w<s;w++)n.readSingle(),n.readSingle();else if(7==h){void 0==o.tangent&&(o.tangent=[],i|=t.render.VertexFormatMask.Tangent);for(w=0;w<s;w++){var p=new t.math.vector3,f=n.readSingle(),v=n.readSingle(),g=n.readSingle(),y=n.readSingle();p.x=f/y,p.y=v/y,p.z=g/y,o.tangent.push(p)}}else if(8==h)for(w=0;w<s;w++)n.readSingle(),n.readSingle();else if(16==h)for(var _=n.readUInt8(),w=0;w<_;w++)l[10*w+0]=n.readSingle(),l[10*w+1]=n.readSingle(),l[10*w+2]=n.readSingle(),l[10*w+3]=n.readSingle(),l[10*w+4]=n.readSingle(),l[10*w+5]=n.readSingle(),l[10*w+6]=n.readSingle(),l[10*w+7]=n.readSingle(),l[10*w+8]=n.readSingle(),l[10*w+9]=n.readSingle();else{if(17!=h)throw"notwrite"+h;void 0==o.blendIndex&&(o.blendIndex=[],i|=t.render.VertexFormatMask.BlendIndex4),void 0==o.blendWeight&&(o.blendWeight=[],i|=t.render.VertexFormatMask.BlendWeight4);for(w=0;w<s;w++){var b=new t.render.number4;b.v0=n.readUInt32(),b.v1=n.readUInt32(),b.v2=n.readUInt32(),b.v3=n.readUInt32();var x=new t.render.number4;x.v0=n.readSingle(),x.v1=n.readSingle(),x.v2=n.readSingle(),x.v3=n.readSingle(),o.blendIndex.push(b),o.blendWeight.push(x)}}}var D=n.readUInt8();o.trisindex=[],this.submesh=[];for(w=0;w<D;w++){var T=new r,E=(n.readUInt32(),n.readUInt32());T.start=o.trisindex.length,T.size=E,T.matIndex=w,this.submesh.push(T);for(var S=0;S<E;S++){var A=n.readUInt32();o.trisindex.push(A)}}e=null,this.data=o,this.glMesh=new t.render.glMesh;var M=this.data.genVertexDataArray(i),R=this.data.genIndexDataArray();this.glMesh.initBuffer(a,i,this.data.pos.length),this.glMesh.uploadVertexSubData(a,M),this.glMesh.addIndex(a,R.length),this.glMesh.uploadIndexSubData(a,0,R)},mesh.prototype.intersects=function(e,a){for(var r=null,i=0;i<this.submesh.length;i++){var o=this.submesh[i];if(o.line);else if(o.useVertexIndex<0);else{for(var n=t.math.pool.new_vector3(),s=t.math.pool.new_vector3(),l=t.math.pool.new_vector3(),h=o.start;h<o.size;h+=3){var c=this.data.pos[this.data.trisindex[h]],u=this.data.pos[this.data.trisindex[h+1]],d=this.data.pos[this.data.trisindex[h+2]];t.math.matrixTransformVector3(c,a,n),t.math.matrixTransformVector3(u,a,s),t.math.matrixTransformVector3(d,a,l);var m=e.intersectsTriangle(n,s,l);if(m){if(m.distance<0)continue;if(!r||r.distance>m.distance){(r=m).faceId=h/3,r.subMeshId=i;var p=t.math.pool.new_vector3();t.math.vec3ScaleByNum(e.direction,m.distance,p),t.math.vec3Add(e.origin,p,r.hitposition)}}}t.math.pool.delete_vector3(n),t.math.pool.delete_vector3(s),t.math.pool.delete_vector3(l)}}return r},mesh.prototype.clone=function(){var a=new i(this.getName()),o=this.glMesh.vertexFormat,n=new t.render.meshData;if(void 0!=this.data.pos){n.pos=[];for(p=0;p<this.data.pos.length;p++){var s=new t.math.vector3;s.x=this.data.pos[p].x,s.y=this.data.pos[p].y,s.z=this.data.pos[p].z,n.pos.push(s)}}if(void 0!=this.data.color){n.color=[];for(p=0;p<this.data.color.length;p++){var l=new t.math.color;l.a=this.data.color[p].a,l.r=this.data.color[p].r,l.g=this.data.color[p].g,l.b=this.data.color[p].b,n.color.push(l)}}if(void 0!=this.data.normal){n.normal=[];for(p=0;p<this.data.normal.length;p++){var h=new t.math.vector3;h.x=this.data.normal[p].x,h.y=this.data.normal[p].y,h.z=this.data.normal[p].z,n.normal.push(h)}}if(void 0!=this.data.uv){n.uv=[];for(p=0;p<this.data.uv.length;p++)(c=new t.math.vector2).x=this.data.uv[p].x,c.y=this.data.uv[p].y,n.uv.push(c)}if(void 0!=this.data.uv2){n.uv2=[];for(p=0;p<this.data.uv2.length;p++){var c=new t.math.vector2;c.x=this.data.uv2[p].x,c.y=this.data.uv2[p].y,n.uv2.push(c)}}if(void 0!=this.data.tangent){n.tangent=[];for(p=0;p<this.data.tangent.length;p++){var u=new t.math.vector3;u.x=this.data.tangent[p].x,u.y=this.data.tangent[p].y,u.z=this.data.tangent[p].z,n.tangent.push(u)}}if(void 0!=this.data.blendIndex){n.blendIndex=[];for(p=0;p<this.data.blendIndex.length;p++){var d=new t.render.number4;d.v0=this.data.blendIndex[p].v0,d.v1=this.data.blendIndex[p].v1,d.v2=this.data.blendIndex[p].v2,d.v3=this.data.blendIndex[p].v3,n.blendIndex.push(d)}}if(void 0!=this.data.blendWeight){n.blendWeight=[];for(p=0;p<this.data.blendWeight.length;p++){var m=new t.render.number4;m.v0=this.data.blendWeight[p].v0,m.v1=this.data.blendWeight[p].v1,m.v2=this.data.blendWeight[p].v2,m.v3=this.data.blendWeight[p].v3,n.blendWeight.push(m)}}a.submesh=[];for(var p=0;p<this.submesh.length;p++){var f=new r;f.start=this.submesh[p].start,f.size=this.submesh[p].size,f.matIndex=p,a.submesh.push(f)}n.trisindex=this.data.trisindex.slice(),a.data=n,a.glMesh=new t.render.glMesh;var v=a.data.genVertexDataArray(o),g=a.data.genIndexDataArray();return a.glMesh.initBuffer(e.sceneMgr.app.getAssetMgr().webgl,o,this.data.pos.length),a.glMesh.uploadVertexSubData(e.sceneMgr.app.getAssetMgr().webgl,v),a.glMesh.addIndex(e.sceneMgr.app.getAssetMgr().webgl,g.length),a.glMesh.uploadIndexSubData(e.sceneMgr.app.getAssetMgr().webgl,0,g),a},mesh}();a=i=__decorate([t.reflect.SerializeType,__metadata("design:paramtypes",[String])],a),e.mesh=a;var r=function(){return function subMeshInfo(){this.useVertexIndex=0,this.line=!1}}();e.subMeshInfo=r;var i}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function pathasset(t){if(void 0===t&&(t=null),this.id=new e.resID,this.defaultAsset=!1,this.paths=[],this.items=[],this.lines=[],t||(t="path_"+this.getGUID()),!e.sceneMgr.app.getAssetMgr().nameDuplicateCheck(t))throw new Error("already have name.");this.name=new e.constText(t)}return pathasset.prototype.getName=function(){return this.name.getText()},pathasset.prototype.getGUID=function(){return this.id.getID()},pathasset.prototype.use=function(){e.sceneMgr.app.getAssetMgr().use(this)},pathasset.prototype.unuse=function(){e.sceneMgr.app.getAssetMgr().unuse(this)},pathasset.prototype.dispose=function(){this.paths.length=0},pathasset.prototype.caclByteLength=function(){if(this.paths)return 12*this.paths.length},pathasset.prototype.Parse=function(e){switch(e.type){case"once":this.type=r.once;break;case"loop":this.type=r.loop;break;case"pingpong":this.type=r.pingpong}this.instertPointcount=e.insertPointcount;var a=e.path;for(var n in a){var s=new o,l=a[n];switch(l.type){case"VertexPoint":s.type=i.VertexPoint;break;case"ControlPoint":s.type=i.ControlPoint}var h=l.point.split(",");s.point=new t.math.vector3(parseFloat(h[0]),parseFloat(h[1]),parseFloat(h[2])),this.items.push(s)}this.getpaths(),this.items.length=0;for(var c=0;c<this.lines.length;c++)this.lines[c].length=0;this.lines.length=0},pathasset.prototype.getpaths=function(){for(var t=new Array,e=0;e<this.items.length;e++){var a=this.items[e];0==e?(t.push(a.point),this.lines.push(t)):e==this.items.length-1?this.type==r.loop?a.type==i.VertexPoint?(t.push(a.point),(t=new Array).push(a.point),t.push(this.items[0].point),this.lines.push(t)):(t.push(a.point),t.push(this.items[0].point)):t.push(a.point):a.type==i.VertexPoint?(t.push(a.point),(t=new Array).push(a.point),this.lines.push(t)):t.push(a.point)}for(var o=this.lines.length,n=0,e=0;e<o;e++)if(e==o-1)for(s=0;s<this.instertPointcount;s++){l=s/(this.instertPointcount-1);this.paths[n]=this.getBeisaierPointAlongCurve(this.lines[e],l),n++}else for(var s=0;s<this.instertPointcount;s++){var l=s/this.instertPointcount;this.paths[n]=this.getBeisaierPointAlongCurve(this.lines[e],l),n++}},pathasset.prototype.getBeisaierPointAlongCurve=function(e,a,r){void 0===r&&(r=!1);var i=e.length;{if(!(e.length<2)){if(2==i){var o=new t.math.vector3;return this.vec3Lerp(e[0],e[1],a,o),r&&(e.length=0),o}for(var n=[],s=0;s<i-1;s++){var l=t.math.pool.new_vector3();this.vec3Lerp(e[s],e[s+1],a,l),n[s]=l}return r&&(e.length=0),this.getBeisaierPointAlongCurve(n,a,!0)}console.log("計算貝塞爾需要超過2個點")}},pathasset.prototype.vec3Lerp=function(e,a,r,i){t.math.vec3Subtract(a,e,i),t.math.vec3ScaleByNum(i,r,i),t.math.vec3Add(e,i,i)},pathasset}();__decorate([t.reflect.Field("constText"),__metadata("design:type",e.constText)],a.prototype,"name",void 0),a=__decorate([t.reflect.SerializeType,__metadata("design:paramtypes",[String])],a),e.pathasset=a;var r;!function(t){t[t.once=0]="once",t[t.loop=1]="loop",t[t.pingpong=2]="pingpong"}(r=e.pathtype||(e.pathtype={}));var i;!function(t){t[t.VertexPoint=0]="VertexPoint",t[t.ControlPoint=1]="ControlPoint"}(i=e.epointtype||(e.epointtype={}));var o=function(){return function pointitem(){}}();e.pointitem=o}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function prefab(t){if(void 0===t&&(t=null),this.id=new e.resID,this.defaultAsset=!1,this.assetbundle=null,t||(t="prefab_"+this.getGUID()),!e.sceneMgr.app.getAssetMgr().nameDuplicateCheck(t))throw new Error("already have name.");this.name=new e.constText(t)}return prefab.prototype.getName=function(){return this.name.getText()},prefab.prototype.getGUID=function(){return this.id.getID()},prefab.prototype.use=function(){e.sceneMgr.app.getAssetMgr().use(this)},prefab.prototype.unuse=function(t){void 0===t&&(t=!1),e.sceneMgr.app.getAssetMgr().unuse(this,t)},prefab.prototype.dispose=function(){this.trans.dispose(),this.jsonstr=null},prefab.prototype.caclByteLength=function(){return 0},prefab.prototype.getCloneTrans=function(){return t.io.cloneObj(this.trans)},prefab.prototype.apply=function(t){this.trans=t},prefab.prototype.Parse=function(a,r){this.jsonstr=a,this.trans=new e.transform,t.io.deSerialize(JSON.parse(a),this.trans,r,this.assetbundle)},prefab}();a=__decorate([t.reflect.SerializeType,__metadata("design:paramtypes",[String])],a),e.prefab=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function rawscene(t){if(void 0===t&&(t=null),this.id=new e.resID,this.defaultAsset=!1,this.assetbundle=null,t||(t="rawscene_"+this.getGUID()),!e.sceneMgr.app.getAssetMgr().nameDuplicateCheck(t))throw new Error("already have name.");this.name=new e.constText(t)}return rawscene.prototype.getName=function(){return this.name.getText()},rawscene.prototype.getGUID=function(){return this.id.getID()},rawscene.prototype.use=function(){e.sceneMgr.app.getAssetMgr().use(this)},rawscene.prototype.unuse=function(t){void 0===t&&(t=!1),e.sceneMgr.app.getAssetMgr().unuse(this,t)},rawscene.prototype.caclByteLength=function(){return 0},rawscene.prototype.Parse=function(a,i){var o=JSON.parse(a);this.rootNode=new e.transform,this.rootNode.name=this.getName(),t.io.deSerialize(o.rootNode,this.rootNode,i,this.assetbundle),this.lightmaps=[];for(var n=o.lightmap,s=n.length,l=0;l<s;l++)if(null==n[l])this.lightmaps.push(null);else{var h=n[l].name,c=i.getAssetByName(h,this.assetbundle);c.use(),this.lightmaps.push(c)}var u=o.fog;if(void 0!=u){this.fog=new r,this.fog._Start=u._Start,this.fog._End=u._End;var d=u._Color.split(",");this.fog._Color=new t.math.vector4(parseFloat(d[0]),parseFloat(d[1]),parseFloat(d[2]),parseFloat(d[3])),this.fog._Density=u._Density}},rawscene.prototype.getSceneRoot=function(){return t.io.cloneObj(this.rootNode)},rawscene.prototype.useLightMap=function(t){t.lightmaps.length=0;for(var e=0;e<this.lightmaps.length;e++)t.lightmaps.push(this.lightmaps[e])},rawscene.prototype.useFog=function(t){t.fog=this.fog},rawscene.prototype.dispose=function(){this.rootNode&&this.rootNode.dispose();for(var t in this.lightmaps)this.lightmaps[t].unuse(!0)},rawscene}();a=__decorate([t.reflect.SerializeType,__metadata("design:paramtypes",[String])],a),e.rawscene=a;var r=function(){return function Fog(){}}();e.Fog=r}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function shader(t){if(void 0===t&&(t=null),this.name=null,this.id=new e.resID,this.defaultAsset=!1,this.passes={},this.defaultValue={},this.layer=e.RenderLayerEnum.Common,this.queue=0,t||(t="shader_"+this.getGUID()),!e.sceneMgr.app.getAssetMgr().nameDuplicateCheck(t))throw new Error("already have name.");this.name=new e.constText(t)}return shader.prototype.getName=function(){return this.name.getText()},shader.prototype.getGUID=function(){return this.id.getID()},shader.prototype.use=function(){e.sceneMgr.app.getAssetMgr().use(this)},shader.prototype.unuse=function(t){void 0===t&&(t=!1),e.sceneMgr.app.getAssetMgr().unuse(this,t)},shader.prototype.dispose=function(){},shader.prototype.caclByteLength=function(){return 0},shader.prototype.parse=function(t,a){if(this._parseProperties(t,a.properties),a.layer){var r=a.layer;"transparent"==r?this.layer=e.RenderLayerEnum.Transparent:"overlay"==r?this.layer=e.RenderLayerEnum.Overlay:"common"==r&&(this.layer=e.RenderLayerEnum.Common)}a.queue&&(this.queue=a.queue);var i=a.passes;this.passes={};for(var o in i){var n=i[o];if("base"==o||"lightmap"==o||"skin"==o||"quad"==o);else if(0!=o.indexOf("base_")&&0!=o.indexOf("lightmap_")&&0!=o.indexOf("skin_"))continue;this.passes[o]=[];for(var s=0;s<n.length;s++)this.passes[o].push(this._parsePass(t,n[s]))}if(void 0==this.passes.base)throw new Error("do not have base passgroup.")},shader.prototype._parseProperties=function(a,r){this.defaultValue={};for(var i in r){var o=r[i],n=o.match(e.RegexpUtil.floatRegexp);if(null==n&&(n=o.match(e.RegexpUtil.rangeRegexp)),null==n&&(n=o.match(e.RegexpUtil.vectorRegexp)),null==n&&(n=o.match(e.RegexpUtil.textureRegexp)),null==n)return void alert(this.getName()+" property error! info:\n"+o);if(null!=n&&n.length>=4){var s=n[1],l=(n[2],n[3].toLowerCase());switch(l){case"float":this.defaultValue[s]={type:l,value:parseFloat(n[4])};break;case"range":this.defaultValue[s]={type:l,min:parseFloat(n[4]),max:parseFloat(n[5]),value:parseFloat(n[6])};break;case"vector":case"color":var h=new t.math.vector4(parseFloat(n[4]),parseFloat(n[5]),parseFloat(n[6]),parseFloat(n[7]));this.defaultValue[s]={type:l,value:h};break;case"texture":this.defaultValue[s]={type:l,defaultValue:a.getDefaultTexture(n[4])};break;default:alert(this.getName()+" property error! unknown type : "+l)}}}},shader.prototype._parsePass=function(a,r){var i=new t.render.glDrawPass,o=r.vs,n=r.fs;switch(r.showface){case"cw":i.state_showface=t.render.ShowFaceStateEnum.CW;break;case"ccw":i.state_showface=t.render.ShowFaceStateEnum.CCW;break;default:i.state_showface=t.render.ShowFaceStateEnum.ALL}var s=t.render.BlendModeEnum.Close;switch(r.zwrite){case"off":i.state_zwrite=!1;break;case"on":default:i.state_zwrite=!0}switch(i.state_ztest=!0,r.ztest){case"greater":i.state_ztest_method=t.render.webglkit.GREATER;break;case"gequal":i.state_ztest_method=t.render.webglkit.GEQUAL;break;case"less":i.state_ztest_method=t.render.webglkit.LESS;break;case"equal":i.state_ztest_method=t.render.webglkit.EQUAL;break;case"notequal":i.state_ztest_method=t.render.webglkit.NOTEQUAL;break;case"always":case"off":i.state_ztest=!1;break;case"never":i.state_ztest_method=t.render.webglkit.NEVER;break;case"lequal":default:i.state_ztest_method=t.render.webglkit.LEQUAL}switch(r.blendmode){case"add":s=t.render.BlendModeEnum.Add;break;case"addpremult":s=t.render.BlendModeEnum.Add_PreMultiply;break;case"blend":s=t.render.BlendModeEnum.Blend;break;case"blendpremult":s=t.render.BlendModeEnum.Blend_PreMultiply}i.setAlphaBlend(s);var l=a.shaderPool.linkProgram(a.webgl,o,n);return i.setProgram(l),this.layer==e.RenderLayerEnum.Overlay&&(i.state_ztest=!0,i.state_zwrite=!0,i.state_ztest_method=t.render.webglkit.ALWAYS),i},shader}();__decorate([t.reflect.Field("constText"),__metadata("design:type",e.constText)],a.prototype,"name",void 0),a=__decorate([t.reflect.SerializeType,__metadata("design:paramtypes",[String])],a),e.shader=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function sprite(t){if(void 0===t&&(t=null),this.id=new e.resID,t||(t="sprite_"+this.getGUID()),!e.sceneMgr.app.getAssetMgr().nameDuplicateCheck(t))throw new Error("already have name.");this.name=new e.constText(t)}return sprite.prototype.getName=function(){return this.name.getText()},sprite.prototype.getGUID=function(){return this.id.getID()},sprite.prototype.use=function(){e.sceneMgr.app.getAssetMgr().use(this)},sprite.prototype.unuse=function(t){void 0===t&&(t=!1),e.sceneMgr.app.getAssetMgr().unuse(this,t)},sprite.prototype.dispose=function(){null!=this.texture&&this.texture.unuse(!0)},sprite.prototype.caclByteLength=function(){var t=0;return this._texture&&(t+=this._texture.caclByteLength()),t},Object.defineProperty(sprite.prototype,"texture",{get:function(){return this._texture},set:function(t){null!=this._texture&&this._texture.unuse(),this._texture=t,this._texture.use()},enumerable:!0,configurable:!0}),Object.defineProperty(sprite.prototype,"urange",{get:function(){return null==this._urange&&(this._urange=new t.math.vector2,this._urange.x=this.rect.x/this._texture.glTexture.width,this._urange.y=(this.rect.x+this.rect.w)/this._texture.glTexture.width),this._urange},enumerable:!0,configurable:!0}),Object.defineProperty(sprite.prototype,"vrange",{get:function(){return null==this._vrange&&(this._vrange=new t.math.vector2,this._vrange.x=this.rect.y/this._texture.glTexture.height,this._vrange.y=(this.rect.y+this.rect.h)/this._texture.glTexture.height),this._vrange},enumerable:!0,configurable:!0}),sprite}();a=__decorate([t.reflect.SerializeType,__metadata("design:paramtypes",[String])],a),e.sprite=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function textasset(t){if(void 0===t&&(t=null),this.id=new e.resID,this.defaultAsset=!1,t||(t="texture_"+this.getGUID()),!e.sceneMgr.app.getAssetMgr().nameDuplicateCheck(t))throw new Error("already have name.");this.name=new e.constText(t)}return textasset.prototype.getName=function(){return this.name.getText()},textasset.prototype.getGUID=function(){return this.id.getID()},textasset.prototype.use=function(){e.sceneMgr.app.getAssetMgr().use(this)},textasset.prototype.unuse=function(){e.sceneMgr.app.getAssetMgr().unuse(this)},textasset.prototype.dispose=function(){this.content},textasset.prototype.caclByteLength=function(){if(this.content)return t.math.caclStringByteLength(this.content)},textasset}();__decorate([t.reflect.Field("constText"),__metadata("design:type",e.constText)],a.prototype,"name",void 0),a=__decorate([t.reflect.SerializeType,__metadata("design:paramtypes",[String])],a),e.textasset=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function texture(t){if(void 0===t&&(t=null),this.id=new e.resID,this.defaultAsset=!1,t||(t="texture_"+this.getGUID()),!e.sceneMgr.app.getAssetMgr().nameDuplicateCheck(t))throw new Error("already have name.");this.name=new e.constText(t)}return texture.prototype.getName=function(){return this.name.getText()},texture.prototype.getGUID=function(){return this.id.getID()},texture.prototype.use=function(){e.sceneMgr.app.getAssetMgr().use(this)},texture.prototype.unuse=function(t){void 0===t&&(t=!1),e.sceneMgr.app.getAssetMgr().unuse(this,t)},texture.prototype.dispose=function(){this.glTexture.dispose(e.sceneMgr.app.getAssetMgr().webgl)},texture.prototype.caclByteLength=function(){if(this.glTexture)return this.glTexture.caclByteLength()},Object.defineProperty(texture.prototype,"realName",{get:function(){return this._realName},set:function(t){this._realName=t},enumerable:!0,configurable:!0}),texture}();__decorate([t.reflect.Field("constText"),__metadata("design:type",e.constText)],a.prototype,"name",void 0),a=__decorate([t.reflect.SerializeType,__metadata("design:paramtypes",[String])],a),e.texture=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(t){var e=function(){function AudioChannel(){}return Object.defineProperty(AudioChannel.prototype,"volume",{get:function(){return this.gainNode.gain.value},set:function(t){t=(t=t>1?1:t)<=-1?-.999:t,this.gainNode.gain.value=t},enumerable:!0,configurable:!0}),AudioChannel.prototype.stop=function(){null!=this.source&&(this.source.stop(),this.source=null),this.isplay=!1},AudioChannel}();t.AudioChannel=e;var a=function(){function AudioEx(){this.channelOnce={},this.channelLoop={},this._soundVolume=0,this._musicVolume=0;try{var t=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext;this.audioContext=new t,console.log("audio Context inited")}catch(t){console.error("!Your browser does not support AudioContext")}}return AudioEx.prototype.clickInit=function(){if(this.isAvailable()&&null!=this.audioContext){var t=this.audioContext.createBuffer(1,1,22050),e=this.audioContext.createBufferSource();e.buffer=t,e.connect(this.audioContext.destination),e.start()}},AudioEx.instance=function(){return null==AudioEx.g_this&&(AudioEx.g_this=new AudioEx),AudioEx.g_this},AudioEx.loadArrayBuffer=function(t,e){var a=new XMLHttpRequest;a.open("GET",t),a.responseType="arraybuffer",a.onreadystatechange=function(){4==a.readyState&&(404==a.status?e(null,new Error("onerr 404")):e(a.response,null))},a.onerror=function(){e(null,new Error("onerr in req:"))},a.send()},AudioEx.prototype.isAvailable=function(){return!!this.audioContext},AudioEx.prototype.loadAudioBufferFromArrayBuffer=function(t,e){this.audioContext.decodeAudioData(t,function(t){e(t,null)})},AudioEx.prototype.loadAudioBuffer=function(t,e){var a=this;AudioEx.loadArrayBuffer(t,function(t,r){null!=r?e(null,r):a.audioContext.decodeAudioData(t,function(t){e(t,null)})})},AudioEx.prototype.getNewChannel=function(){var t=new e;return t.source=this.audioContext.createBufferSource(),t.pannerNode=this.audioContext.createPanner(),t.source.connect(this.audioContext.destination),t.gainNode=AudioEx.instance().audioContext.createGain(),t.source.connect(t.gainNode),t.gainNode.connect(AudioEx.instance().audioContext.destination),t.gainNode.gain.value=1,t},AudioEx.prototype.getFreeChannelOnce=function(){for(var t in this.channelOnce)if(0==this.channelOnce[t].isplay){var e=this.getNewChannel();return this.channelOnce[t]=e,this.channelOnce[t]}return this.getNewChannel()},AudioEx.prototype.playOnce=function(t,e,a,r,i){var o=this.getFreeChannelOnce();return o.source.loop=!1,o.source.buffer=e,o.volume=this._soundVolume,o.source.start(),a&&r&&i&&o.pannerNode.setPosition(a,r,i),o.isplay=!0,o.source.onended=function(){o.isplay=!1,o.source=null},this.channelOnce[t]=o,o},AudioEx.prototype.playOnceInterrupt=function(t,e,a,r,i){for(var o in this.channelOnce)o==t&&this.channelOnce[o].isplay&&this.channelOnce[o].stop();var n=this.getFreeChannelOnce();return n.source.loop=!1,n.source.buffer=e,n.volume=this._soundVolume,a&&r&&i&&n.pannerNode.setPosition(a,r,i),n.source.start(),n.isplay=!0,n.source.onended=function(){n.isplay=!1,n.source=null},this.channelOnce[t]=n,n},AudioEx.prototype.playOnceBlocking=function(t,e,a,r,i){for(var o in this.channelOnce)if(o==t&&this.channelOnce[o].isplay)return;var n=this.getFreeChannelOnce();return n.source.loop=!1,n.source.buffer=e,n.volume=this._soundVolume,a&&r&&i&&n.pannerNode.setPosition(a,r,i),n.source.start(),n.isplay=!0,n.source.onended=function(){n.isplay=!1,n.source=null},this.channelOnce[t]=n,n},AudioEx.prototype.playLooped=function(t,e){void 0!=this.channelLoop[t]&&this.channelLoop[t].isplay&&(this.channelLoop[t].source.stop(),this.channelLoop[t].isplay=!1);var a=this.getNewChannel();a.source.loop=!0,a.volume=this._musicVolume,this.channelLoop[t]=a,this.channelLoop[t].source.buffer=e,this.channelLoop[t].source.start(),this.channelLoop[t].isplay=!0},AudioEx.prototype.stopLooped=function(t){void 0!=this.channelLoop[t]&&null!=this.channelLoop[t]&&null!=this.channelLoop[t].source&&(this.channelLoop[t].source.stop(),this.channelLoop[t].source=null,this.channelLoop[t].isplay=!1)},AudioEx.prototype.setSoundVolume=function(t){this._soundVolume=t;for(var e in this.channelOnce)this.channelOnce[e]&&(this.channelOnce[e].volume=this._soundVolume)},AudioEx.prototype.setMusicVolume=function(t){this._musicVolume=t;for(var e in this.channelLoop)this.channelLoop[e]&&(this.channelLoop[e].volume=this._musicVolume)},AudioEx}();t.AudioEx=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function aniplayer(){this._clipnameCount=0,this._clipnames=null,this.autoplay=!0,this.playIndex=0,this._playClip=null,this.tpose={},this.nowpose={},this.lerppose={},this.carelist={},this._playFrameid=0,this._playTimer=0,this.speed=1,this.crossdelta=0,this.crossspeed=0,this.beRevert=!1,this.playStyle=i.NormalPlay,this.percent=0,this.mix=!1}return Object.defineProperty(aniplayer.prototype,"clipnames",{get:function(){if(null==this._clipnames||this._clipnameCount!=this.clips.length){this._clipnameCount=this.clips.length,this._clipnames={};for(var t in this.clips)this.clipnames[this.clips[t].getName()]=parseInt(t)}return this._clipnames},enumerable:!0,configurable:!0}),Object.defineProperty(aniplayer.prototype,"cacheKey",{get:function(){return this._playClip?this._playClip.getGUID()+"_"+this._playFrameid:this._playFrameid},enumerable:!0,configurable:!0}),aniplayer.prototype.init=function(){for(var t=0;t<this.bones.length;t++){var a=this.bones[t],r=a.name,i=new e.PoseBoneMatrix;i.r=a.tposeq,i.t=a.tposep,i.invert(),this.tpose[r]=i,this.nowpose[r]=this.startPos[t].Clone()}var o=this.gameObject.getComponentsInChildren("asbone");for(var n in o)this.care(o[n].gameObject.transform);this.autoplay&&null!=this.clips&&this.clips.length>0&&this.playByIndex(this.playIndex)},aniplayer.prototype.start=function(){null!=this.bones&&this.init()},aniplayer.prototype.update=function(a){if(null!=this._playClip){this.checkFrameId(a),this.mix=!1,this.crossdelta>0&&(this.crossdelta-=a/this.speed*this.crossspeed,this.mix=!0);for(var r=0;r<this._playClip.boneCount;r++){var i=this._playClip.bones[r],o=this._playClip.frames[this._playFrameid],n=7*r+1,s=this.nowpose[i],l=this.tpose[i];if(void 0!=s)if(this.mix){var h=this.lerppose[i];void 0!=h?s.lerpInWorldWithData(l,h,o,n,1-this.crossdelta):s.copyFromData(o,n)}else s.copyFromData(o,n);var c=this.carelist[i];if(void 0!=c){var u=e.PoseBoneMatrix.sMultiply(s,l),d=t.math.pool.new_matrix();t.math.matrixMakeTransformRTS(u.t,t.math.pool.vector3_one,u.r,d);var m=t.math.pool.new_matrix();t.math.matrixMultiply(this.gameObject.transform.getWorldMatrix(),d,m),c.setWorldMatrix(m),c.updateTran(!1),t.math.pool.delete_matrix(d),t.math.pool.delete_matrix(m)}}}},aniplayer.prototype.playByIndex=function(t,e,a){void 0===e&&(e=1),void 0===a&&(a=!1),this.playIndex=t,this.clips.length<=t?console.error("animIndex out Array of clips"):(this.playAniamtion(t.toString(),e,a),this.crossdelta=0)},aniplayer.prototype.playCrossByIndex=function(t,e,a,r){void 0===a&&(a=1),void 0===r&&(r=!1),this.playIndex=t,this.clips.length<=t?console.error("animIndex out Array of clips"):(this.playAniamtion(t.toString(),a,r),this.crossspeed=1/e,this.crossdelta=1)},aniplayer.prototype.play=function(t,e,a){void 0===e&&(e=1),void 0===a&&(a=!1),null!=this.clipnames[t]?this.playByIndex(this.clipnames[t],e,a):console.error("animclip "+this.gameObject.transform.name+"  "+t+" is not exist")},aniplayer.prototype.playCross=function(t,e,a,r){void 0===a&&(a=1),void 0===r&&(r=!1),null!=this.clipnames[t]?e<=0?this.playByIndex(this.clipnames[t],a,r):this.playCrossByIndex(this.clipnames[t],e,a,r):console.error("animclip "+this.gameObject.transform.name+"  "+t+" is not exist")},aniplayer.prototype.playAniamtion=function(t,e,a){if(void 0===e&&(e=1),void 0===a&&(a=!1),void 0!=this.clips[t]){this._playClip=this.clips[t],this._playTimer=0,this._playFrameid=0,this.speed=e,this.beRevert=a,this.playStyle=i.NormalPlay,this.speed=e,this.lerppose={};for(var r in this.nowpose){var o=this.nowpose[r];this.lerppose[r]=o.Clone()}}},aniplayer.prototype.stop=function(){this._playClip=null},aniplayer.prototype.isPlay=function(){return null!=this._playClip},aniplayer.prototype.isStop=function(){return null!=this._playClip&&(this.playStyle==i.NormalPlay&&(!this._playClip.loop&&this._playFrameid==this._playClip.frameCount-1))},aniplayer.prototype.remove=function(){this.clips.length=0,this.bones.length=0,this.startPos.length=0,delete this.tpose,delete this.nowpose,delete this.lerppose,delete this.carelist,delete this._clipnames},aniplayer.prototype.clone=function(){},aniplayer.prototype.addFinishedEventListener=function(t,e){this.finishCallBack=t,this.thisObject=e},aniplayer.prototype.checkFrameId=function(t){this.playStyle==i.NormalPlay?(this._playTimer+=t*this.speed,this._playFrameid=this._playClip.fps*this._playTimer|0,this._playClip.loop?this._playFrameid%=this._playClip.frameCount:this._playFrameid>this._playClip.frameCount-1&&(this._playFrameid=this._playClip.frameCount-1),this.beRevert&&(this._playFrameid=this._playClip.frameCount-this._playFrameid-1)):this.playStyle==i.FramePlay&&(this._playFrameid=this._playClip.frameCount*this.percent-1,this._playFrameid=Math.round(this._playFrameid)),this._playFrameid<0&&(this._playFrameid=0),this._playFrameid>this._playClip.frameCount-1&&(this._playFrameid=this._playClip.frameCount-1),this.isStop()&&this.finishCallBack&&(this.finishCallBack(this.thisObject),this.finishCallBack=null)},aniplayer.prototype.fillPoseData=function(e,a,r){void 0===r&&(r=!0);var i=0;for(var o in a){var n=a[o].name,s=this.nowpose[n];if(void 0==s)r?(e[8*i+0]=0,e[8*i+1]=0,e[8*i+2]=0,e[8*i+3]=1,e[8*i+4]=0,e[8*i+5]=0,e[8*i+6]=0,e[8*i+7]=1):(e[16*i+0]=1,e[16*i+1]=0,e[16*i+2]=0,e[16*i+3]=0,e[16*i+4]=0,e[16*i+5]=1,e[16*i+6]=0,e[16*i+7]=0,e[16*i+8]=0,e[16*i+9]=0,e[16*i+10]=1,e[16*i+11]=0,e[16*i+12]=0,e[16*i+13]=0,e[16*i+14]=0,e[16*i+15]=1);else{var l=t.math.pool.new_matrix();if(r)e[8*i+0]=s.r.x,e[8*i+1]=s.r.y,e[8*i+2]=s.r.z,e[8*i+3]=s.r.w,e[8*i+4]=s.t.x,e[8*i+5]=s.t.y,e[8*i+6]=s.t.z,e[8*i+7]=1;else{t.math.matrixMakeTransformRTS(s.t,t.math.pool.vector3_one,s.r,l);for(var h=0;h<16;h++)e[16*i+h]=l.rawData[h]}}i++}},aniplayer.prototype.care=function(t){for(var e=t;;){if(void 0!=this.nowpose[e.name])return void(this.carelist[e.name]=e);e=e.parent}},aniplayer}();__decorate([t.reflect.Field("animationClip[]"),__metadata("design:type",Array)],a.prototype,"clips",void 0),__decorate([t.reflect.Field("boolean"),__metadata("design:type",Boolean)],a.prototype,"autoplay",void 0),__decorate([t.reflect.Field("tPoseInfo[]"),__metadata("design:type",Array)],a.prototype,"bones",void 0),__decorate([t.reflect.Field("PoseBoneMatrix[]"),__metadata("design:type",Array)],a.prototype,"startPos",void 0),a=__decorate([t.reflect.nodeComponent],a),e.aniplayer=a;var r=function(){return function tPoseInfo(){}}();__decorate([t.reflect.Field("string"),__metadata("design:type",String)],r.prototype,"name",void 0),__decorate([t.reflect.Field("vector3"),__metadata("design:type",t.math.vector3)],r.prototype,"tposep",void 0),__decorate([t.reflect.Field("quaternion"),__metadata("design:type",t.math.quaternion)],r.prototype,"tposeq",void 0),r=__decorate([t.reflect.SerializeType],r),e.tPoseInfo=r;var i;!function(t){t[t.NormalPlay=0]="NormalPlay",t[t.FramePlay=1]="FramePlay",t[t.PingPang=2]="PingPang"}(i=e.PlayStyle||(e.PlayStyle={}))}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function asbone(){}return asbone.prototype.start=function(){},asbone.prototype.update=function(t){},asbone.prototype.remove=function(){},asbone.prototype.clone=function(){},asbone}();a=__decorate([t.reflect.nodeComponent,__metadata("design:paramtypes",[])],a),e.asbone=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function boxcollider(){this._colliderVisible=!1}return boxcollider.prototype.getBound=function(){return this.obb},Object.defineProperty(boxcollider.prototype,"matrix",{get:function(){return this.gameObject?this.gameObject.transform.getWorldMatrix():new t.math.matrix},enumerable:!0,configurable:!0}),boxcollider.prototype.start=function(){this.filter=this.gameObject.getComponent("meshFilter"),this.build()},boxcollider.prototype.update=function(t){this.obb&&this.obb.update(this.matrix)},Object.defineProperty(boxcollider.prototype,"colliderVisible",{get:function(){return this._colliderVisible},set:function(t){this._colliderVisible=t,this.subTran&&(this.subTran.gameObject.visible=this._colliderVisible)},enumerable:!0,configurable:!0}),boxcollider.prototype.intersectsTransform=function(t){if(null==t.gameObject.collider)return!1;if(null==this.obb||null==t.gameObject.collider.getBound())return!1;var e=t.gameObject.collider.getBound();return this.obb.intersects(e)},boxcollider.prototype.build=function(){if(this.obb=new e.obb,this.center&&this.size)this.obb.buildByCenterSize(this.center,this.size);else{var a=new t.math.vector3,r=new t.math.vector3;if(this.filter){var i=this.filter.getMeshOutput().data;t.math.vec3SetByFloat(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,a),t.math.vec3SetByFloat(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,r);for(var o=0;o<i.pos.length;o++)t.math.vec3Max(i.pos[o],r,r),t.math.vec3Min(i.pos[o],a,a);console.log("add obb filter "+a+"  "+r)}else a.x=-1,a.y=-1,a.z=-1,r.x=1,r.y=1,r.z=1;this.obb.buildByMaxMin(a,r)}this.buildMesh()},boxcollider.prototype.buildMesh=function(){this.subTran=new t.framework.transform,this.subTran.gameObject.hideFlags=e.HideFlags.DontSave|e.HideFlags.HideInHierarchy,this.subTran.name="boxcollider",this.subTran.gameObject.addComponent("meshFilter").mesh=this.getColliderMesh();this.subTran.gameObject.addComponent("meshRenderer");this.subTran.gameObject.visible=this._colliderVisible,this.gameObject.transform.addChild(this.subTran),this.gameObject.transform.markDirty(),this.subTran.markDirty(),this.gameObject.transform.updateWorldTran()},boxcollider.prototype.getColliderMesh=function(){var a=new e.mesh;a.data=t.render.meshData.genBoxByArray_Quad(this.obb.vectors);var r=t.render.VertexFormatMask.Position|t.render.VertexFormatMask.Normal,i=a.data.genVertexDataArray(r),o=a.data.genIndexDataArrayQuad2Line(),n=this.gameObject.getScene().webgl;a.glMesh=new t.render.glMesh,a.glMesh.initBuffer(n,r,a.data.pos.length),a.glMesh.uploadVertexSubData(n,i),a.glMesh.addIndex(n,o.length),a.glMesh.uploadIndexSubData(n,0,o),a.submesh=[];var s=new e.subMeshInfo;return s.matIndex=0,s.useVertexIndex=0,s.start=0,s.size=o.length,s.line=!0,a.submesh.push(s),a},boxcollider.prototype.remove=function(){this.subTran&&this.subTran.dispose(),this.obb&&this.obb.dispose()},boxcollider.prototype.clone=function(){},boxcollider}();__decorate([t.reflect.Field("vector3"),__metadata("design:type",t.math.vector3)],a.prototype,"center",void 0),__decorate([t.reflect.Field("vector3"),__metadata("design:type",t.math.vector3)],a.prototype,"size",void 0),a=__decorate([t.reflect.nodeComponent,t.reflect.nodeBoxCollider],a),e.boxcollider=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function cameraPostQueue_Depth(){this.renderTarget=null}return cameraPostQueue_Depth.prototype.render=function(e,a,r){r._targetAndViewport(this.renderTarget,e,a,!0),a.webgl.depthMask(!0),a.webgl.clearColor(0,0,0,0),a.webgl.clearDepth(1),a.webgl.clear(a.webgl.COLOR_BUFFER_BIT|a.webgl.DEPTH_BUFFER_BIT),r._renderOnce(e,a,"_depth"),t.render.glRenderTarget.useNull(a.webgl)},cameraPostQueue_Depth}();e.cameraPostQueue_Depth=a;var r=function(){function cameraPostQueue_Quad(){this.renderTarget=null,this.material=new e.material}return cameraPostQueue_Quad.prototype.render=function(t,e,a){a._targetAndViewport(this.renderTarget,t,e,!0),e.webgl.depthMask(!0),e.webgl.clearColor(0,.3,0,0),e.webgl.clearDepth(1),e.webgl.clear(e.webgl.COLOR_BUFFER_BIT|e.webgl.DEPTH_BUFFER_BIT);var r=t.app.getAssetMgr().getDefaultMesh("quad");e.drawtype="",this.material.draw(e,r,r.submesh[0],"quad")},cameraPostQueue_Quad}();e.cameraPostQueue_Quad=r;var i=function(){function cameraPostQueue_Color(){this.renderTarget=null}return cameraPostQueue_Color.prototype.render=function(e,a,r){r._targetAndViewport(this.renderTarget,e,a,!1),r._renderOnce(e,a,""),t.render.glRenderTarget.useNull(a.webgl)},cameraPostQueue_Color}();e.cameraPostQueue_Color=i;var o=function(){function camera(){this._near=.01,this._far=1e3,this.isMainCamera=!1,this.CullingMask=n.default|n.ui,this.clearOption_Color=!0,this.clearOption_Depth=!0,this.backgroundColor=new t.math.color(.5,.8,1,1),this.viewport=new t.math.rect(0,0,1,1),this.renderTarget=null,this.order=0,this.overlays=[],this.matView=new t.math.matrix,this.matProjP=new t.math.matrix,this.matProjO=new t.math.matrix,this.matProj=new t.math.matrix,this.frameVecs=[],this.fov=.25*Math.PI,this.size=2,this.opvalue=1,this.postQueues=[]}return Object.defineProperty(camera.prototype,"near",{get:function(){return this._near},set:function(t){t>=this.far&&(t=this.far-1),t<.01&&(t=.01),this._near=t},enumerable:!0,configurable:!0}),Object.defineProperty(camera.prototype,"far",{get:function(){return this._far},set:function(t){t<=this.near&&(t=this.near+1),t>=1e3&&(t=1e3),this._far=t},enumerable:!0,configurable:!0}),camera.prototype.markDirty=function(){},camera.prototype.start=function(){},camera.prototype.update=function(t){for(var e=0;e<this.overlays.length;e++)this.overlays[e].init||(this.overlays[e].start(this),this.overlays[e].init=!0),this.overlays[e].update(t)},camera.prototype.addOverLay=function(t){this.overlays.push(t)},camera.prototype.addOverLayAt=function(t,e){this.overlays.splice(e,0,t)},camera.prototype.getOverLays=function(){return this.overlays},camera.prototype.removeOverLay=function(t){if(null!=this.overlays){var e=this.overlays.indexOf(t);e>=0&&this.overlays.splice(e,1)}},camera.prototype.calcViewMatrix=function(e){var a=this.gameObject.transform.getWorldMatrix();t.math.matrixInverse(a,this.matView),t.math.matrixClone(this.matView,e)},camera.prototype.calcViewPortPixel=function(t,e){var a,r;null==this.renderTarget?(a=t.width,r=t.height):(a=this.renderTarget.width,r=this.renderTarget.height),e.x=a*this.viewport.x,e.y=r*this.viewport.y,e.w=a*this.viewport.w,e.h=r*this.viewport.h},camera.prototype.calcProjectMatrix=function(e,a){this.opvalue>0&&t.math.matrixProject_PerspectiveLH(this.fov,e,this.near,this.far,this.matProjP),this.opvalue<1&&t.math.matrixProject_OrthoLH(this.size*e,this.size,this.near,this.far,this.matProjO),0==this.opvalue?t.math.matrixClone(this.matProjO,this.matProj):1==this.opvalue?t.math.matrixClone(this.matProjP,this.matProj):t.math.matrixLerp(this.matProjO,this.matProjP,this.opvalue,this.matProj),t.math.matrixClone(this.matProj,a)},camera.prototype.creatRayByScreen=function(e,a){var r=t.math.pool.new_vector3();r.x=e.x,r.y=e.y,r.z=0;var i=t.math.pool.new_vector3();i.x=e.x,i.y=e.y,i.z=1;var o=t.math.pool.new_vector3(),n=t.math.pool.new_vector3();this.calcWorldPosFromScreenPos(a,r,o),this.calcWorldPosFromScreenPos(a,i,n);var s=t.math.pool.new_vector3();t.math.vec3Subtract(n,o,s),t.math.vec3Normalize(s,s);var l=new t.framework.ray(o,s);return t.math.pool.delete_vector3(r),t.math.pool.delete_vector3(i),t.math.pool.delete_vector3(o),t.math.pool.delete_vector3(n),t.math.pool.delete_vector3(s),l},camera.prototype.calcWorldPosFromScreenPos=function(e,a,r){var i=new t.math.rect;this.calcViewPortPixel(e,i);var o=new t.math.vector2(a.x/i.w*2-1,1-a.y/i.h*2),n=new t.math.matrix,s=new t.math.matrix,l=i.w/i.h;this.calcViewMatrix(n),this.calcProjectMatrix(l,s);var h=new t.math.matrix,c=new t.math.matrix;t.math.matrixMultiply(s,n,h),t.math.matrixInverse(h,c);var u=new t.math.vector3(o.x,o.y,a.z);t.math.matrixTransformVector3(u,c,r)},camera.prototype.calcScreenPosFromWorldPos=function(e,a,r){var i=new t.math.rect;this.calcViewPortPixel(e,i);var o=new t.math.matrix,n=new t.math.matrix,s=i.w/i.h;this.calcViewMatrix(o),this.calcProjectMatrix(s,n);var l=new t.math.matrix;t.math.matrixMultiply(n,o,l);var h=t.math.pool.new_vector3();t.math.matrixTransformVector3(a,l,h),r.x=(h.x+1)*i.w/2,r.y=(1-h.y)*i.h/2},camera.prototype.calcCameraFrame=function(e){var a=new t.math.rect;this.calcViewPortPixel(e,a);var r=this.near*Math.tan(.5*this.fov),i=a.w/a.h,o=r*i,n=new t.math.vector3(-o,r,this.near),s=new t.math.vector3(-o,-r,this.near),l=new t.math.vector3(o,r,this.near),h=new t.math.vector3(o,-r,this.near),c=this.far*Math.tan(.5*this.fov),u=c*i,d=new t.math.vector3(-u,c,this.far),m=new t.math.vector3(-u,-c,this.far),p=new t.math.vector3(u,c,this.far),f=new t.math.vector3(u,-c,this.far),v=this.gameObject.transform.getWorldMatrix();t.math.matrixTransformVector3(m,v,m),t.math.matrixTransformVector3(s,v,s),t.math.matrixTransformVector3(f,v,f),t.math.matrixTransformVector3(h,v,h),t.math.matrixTransformVector3(d,v,d),t.math.matrixTransformVector3(n,v,n),t.math.matrixTransformVector3(p,v,p),t.math.matrixTransformVector3(l,v,l),this.frameVecs.length=0,this.frameVecs.push(m),this.frameVecs.push(s),this.frameVecs.push(f),this.frameVecs.push(h),this.frameVecs.push(d),this.frameVecs.push(n),this.frameVecs.push(p),this.frameVecs.push(l)},camera.prototype.getPosAtXPanelInViewCoordinateByScreenPos=function(e,a,r,i){var o=new t.math.rect;this.calcViewPortPixel(a,o);var n=new t.math.vector3;n.z=-this.near,n.x=e.x-.5*o.w,n.y=.5*o.h-e.y;var s=new t.math.vector3;s.z=-this.far,s.x=this.far*n.x/this.near,s.y=this.far*n.y/this.near;var l=(n.z-r)/(n.z-s.z);i.x=n.x-(n.x-s.x)*l,i.y=n.y-(n.y-s.y)*l},camera.prototype.fillRenderer=function(t){t.renderList.clear(),t.app.isFrustumCulling&&this.calcCameraFrame(t.app),this._fillRenderer(t,t.getRoot())},camera.prototype._fillRenderer=function(t,e){if((!t.app.isFrustumCulling||this.testFrustumCulling(t,e))&&(null!=e.gameObject&&null!=e.gameObject.renderer&&e.gameObject.visible&&t.renderList.addRenderer(e.gameObject.renderer),null!=e.children&&e.gameObject.visible))for(var a=0;a<e.children.length;a++)this._fillRenderer(t,e.children[a])},camera.prototype.testFrustumCulling=function(t,e){if(!e.gameObject.getComponent("frustumculling"))return!0;var a=e.gameObject.getComponent("spherecollider");e.getWorldTranslate();return!!a.caclPlaneInDir(this.frameVecs[0],this.frameVecs[1],this.frameVecs[5])&&(!!a.caclPlaneInDir(this.frameVecs[1],this.frameVecs[3],this.frameVecs[7])&&(!!a.caclPlaneInDir(this.frameVecs[3],this.frameVecs[2],this.frameVecs[6])&&(!!a.caclPlaneInDir(this.frameVecs[2],this.frameVecs[0],this.frameVecs[4])&&(!!a.caclPlaneInDir(this.frameVecs[5],this.frameVecs[7],this.frameVecs[6])&&!!a.caclPlaneInDir(this.frameVecs[0],this.frameVecs[2],this.frameVecs[3])))))},camera.prototype._targetAndViewport=function(e,a,r,i){var o,n;null==e?(o=a.app.width,n=a.app.height,t.render.glRenderTarget.useNull(r.webgl)):(o=e.width,n=e.height,e.use(r.webgl)),r.webgl.viewport(o*this.viewport.x,n*this.viewport.y,o*this.viewport.w,n*this.viewport.h),r.webgl.depthRange(0,1),0==i&&(this.clearOption_Color&&this.clearOption_Depth?(r.webgl.depthMask(!0),r.webgl.clearColor(this.backgroundColor.r,this.backgroundColor.g,this.backgroundColor.b,this.backgroundColor.a),r.webgl.clearDepth(1),r.webgl.clear(r.webgl.COLOR_BUFFER_BIT|r.webgl.DEPTH_BUFFER_BIT)):this.clearOption_Depth?(r.webgl.depthMask(!0),r.webgl.clearDepth(1),r.webgl.clear(r.webgl.DEPTH_BUFFER_BIT)):this.clearOption_Color&&(r.webgl.clearColor(this.backgroundColor.r,this.backgroundColor.g,this.backgroundColor.b,this.backgroundColor.a),r.webgl.clear(r.webgl.COLOR_BUFFER_BIT)))},camera.prototype._renderOnce=function(t,e,a){e.drawtype=a;for(var r=t.app.getAssetMgr(),i=0;i<t.renderList.renderLayers.length;i++)for(var o=t.renderList.renderLayers[i].list,n=0;n<o.length;n++)this.CullingMask&o[n].renderLayer&&o[n].render(e,r,this)},camera.prototype.renderScene=function(e,a){for(o=0;o<e.renderList.renderLayers.length;o++){var r=e.renderList.renderLayers[o],i=r.list;r.needSort&&i.length>1&&i.sort(function(e,r){if(e.queue!=r.queue)return e.queue-r.queue;var i=a.matrixView,o=t.math.pool.new_vector3(),n=t.math.pool.new_vector3();return t.math.matrixTransformVector3(e.gameObject.transform.getWorldTranslate(),i,o),t.math.matrixTransformVector3(r.gameObject.transform.getWorldTranslate(),i,n),o.z-n.z})}if(0==this.postQueues.length)this._targetAndViewport(this.renderTarget,e,a,!1),this._renderOnce(e,a,""),a.webgl.flush();else{for(var o=0;o<this.postQueues.length;o++)this.postQueues[o].render(e,a,this);a.webgl.flush()}},camera.prototype.remove=function(){},camera.prototype.clone=function(){},camera}();__decorate([t.reflect.UIStyle("rangeFloat",1,1e3,2),t.reflect.Field("number"),__metadata("design:type",Number),__metadata("design:paramtypes",[Number])],o.prototype,"near",null),__decorate([t.reflect.UIStyle("rangeFloat",1,1e3,999),t.reflect.Field("number"),__metadata("design:type",Number),__metadata("design:paramtypes",[Number])],o.prototype,"far",null),__decorate([t.reflect.compCall({use:"dirty",display:"刷新camera"}),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",void 0)],o.prototype,"markDirty",null),__decorate([t.reflect.Field("IOverLay[]"),__metadata("design:type",Array)],o.prototype,"overlays",void 0),o=__decorate([t.reflect.nodeComponent,t.reflect.nodeCamera],o),e.camera=o;var n;!function(t){t[t.ui=1]="ui",t[t.default=2]="default",t[t.editor=4]="editor",t[t.model=8]="model",t[t.everything=4294967295]="everything",t[t.nothing=0]="nothing",t[t.modelbeforeui=8]="modelbeforeui"}(n=e.CullingMask||(e.CullingMask={}))}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=r=function(){function effectSystem(){this.layer=e.RenderLayerEnum.Transparent,this.renderLayer=e.CullingMask.default,this.queue=0,this.autoplay=!0,this.state=e.EffectPlayStateEnum.None,this.curFrameId=-1,this.frameId=0,this.playTimer=0,this.speed=1,this.parser=new t.framework.EffectParser,this.vf=t.render.VertexFormatMask.Position|t.render.VertexFormatMask.Normal|t.render.VertexFormatMask.Tangent|t.render.VertexFormatMask.Color|t.render.VertexFormatMask.UV0,this.particleVF=t.render.VertexFormatMask.Position|t.render.VertexFormatMask.Color|t.render.VertexFormatMask.UV0,this.effectBatchers=[],this.matDataGroups=[]}return effectSystem.prototype.setEffect=function(e){this.webgl=t.framework.sceneMgr.app.webgl,this.data=this.parser.Parse(e,t.framework.sceneMgr.app.getAssetMgr())},effectSystem.prototype.setJsonData=function(e){this.webgl=t.framework.sceneMgr.app.webgl,this.jsonData=e,this.data=this.parser.Parse(this.jsonData.content,t.framework.sceneMgr.app.getAssetMgr())},Object.defineProperty(effectSystem.prototype,"data",{get:function(){return this._data},set:function(t){this._data=t},enumerable:!0,configurable:!0}),effectSystem.prototype.init=function(){this._data&&this.addElements()},Object.defineProperty(effectSystem.prototype,"totalFrameCount",{get:function(){return this.data.life*r.fps},enumerable:!0,configurable:!0}),effectSystem.prototype.start=function(){this.init()},effectSystem.prototype.update=function(t){null!=this.gameObject.getScene()&&void 0!=this.gameObject.getScene()&&(this.state==e.EffectPlayStateEnum.Play||this.state==e.EffectPlayStateEnum.Pause?(this.state==e.EffectPlayStateEnum.Play&&(this.playTimer+=t*this.speed),this.beLoop||this.playTimer>=this.data.life&&this.stop(),this._update(t)):this.state==e.EffectPlayStateEnum.BeReady&&(this.autoplay?this.play():(this.gameObject.visible=!1,this.gameObject.transform.markDirty())))},effectSystem.prototype._update=function(t){if(this.checkFrameId()){for(var e in this.effectBatchers){var a=this.effectBatchers[e];for(var i in a.effectElements){var o=a.effectElements[i],n=this.curFrameId%o.loopFrame;if(o.active&&(o.actionActive=!1,this.mergeLerpAttribData(o.curAttrData,o.timelineFrame[n]),void 0!=o.actions)){o.actionActive=!0;for(var s in o.actions)o.actions[s].update(n)}o.update(),o.isActiveFrame(n)&&this.updateEffectBatcher(o.effectBatcher,o.curAttrData,o.data.initFrameData,o.startIndex)}}void 0!=this.particles&&(this.frameId=this.curFrameId%this.particles.loopFrame,this.particles.update(1/r.fps))}},effectSystem.prototype.mergeLerpAttribData=function(e,a){if(void 0!=a&&void 0!=e)for(var r in a.attrsData)if(void 0!=a.attrsData[r]&&void 0!=e[r]){var i=a.attrsData.getAttribute(r);if(null==i)continue;(i instanceof t.math.vector3||i instanceof t.math.vector2||"number"==typeof i)&&"renderModel"!=r&&(e[r]=i)}},effectSystem.prototype.updateEffectBatcher=function(e,a,r,i){var o=a.mesh;if(void 0==o&&(o=r.attrsData.mesh),void 0!=o){void 0==a.meshdataVbo&&(a.meshdataVbo=o.data.genVertexDataArray(this.vf));for(var n=o.data.pos.length,s=a.meshdataVbo,l=e.vertexSize,h=0;h<n;h++){var c=t.math.pool.new_vector3();c.x=s[h*l+0],c.y=s[h*l+1],c.z=s[h*l+2],t.math.matrixTransformVector3(c,a.matrix,c),e.dataForVbo[(i+h)*l+0]=c.x,e.dataForVbo[(i+h)*l+1]=c.y,e.dataForVbo[(i+h)*l+2]=c.z,t.math.pool.delete_vector3(c);var u=s[h*l+9],d=s[h*l+10],m=s[h*l+11],p=s[h*l+12];void 0!=a.color&&(u=a.color.x,d=a.color.y,m=a.color.z),void 0!=a.alpha&&(p=a.alpha),void 0!=a.colorRate&&(u*=a.colorRate,d*=a.colorRate,m*=a.colorRate,p*=a.colorRate),u=t.math.floatClamp(u,0,3),d=t.math.floatClamp(d,0,3),m=t.math.floatClamp(m,0,3),p=t.math.floatClamp(p,0,3),e.dataForVbo[15*(i+h)+9]=u,e.dataForVbo[15*(i+h)+10]=d,e.dataForVbo[15*(i+h)+11]=m,e.dataForVbo[15*(i+h)+12]=p,e.dataForVbo[(i+h)*l+13]=s[h*l+13]*a.tilling.x+a.uv.x,e.dataForVbo[(i+h)*l+14]=s[h*l+14]*a.tilling.y+a.uv.y}}},effectSystem.prototype.render=function(t,a,r){if(this.state==e.EffectPlayStateEnum.Play){t.updateModel(this.gameObject.transform);for(var i in this.effectBatchers){var o=this.effectBatchers[i],n=o.mesh;o.beBufferInited||(n.glMesh.initBuffer(t.webgl,this.vf,o.curTotalVertexCount),0==n.glMesh.ebos.length?n.glMesh.addIndex(t.webgl,o.dataForEbo.length):n.glMesh.resetEboSize(t.webgl,0,o.dataForEbo.length),n.glMesh.uploadIndexSubData(t.webgl,0,o.dataForEbo),n.submesh[0].size=o.dataForEbo.length,o.beBufferInited=!0),n.glMesh.uploadVertexSubData(t.webgl,o.dataForVbo),this.gameObject.getScene().fog?(t.fog=this.gameObject.getScene().fog,o.mat.draw(t,n,n.submesh[0],"base_fog")):o.mat.draw(t,n,n.submesh[0],"base")}void 0!=this.particles&&this.particles.render(t,a,r)}},effectSystem.prototype.clone=function(){var t=new r;return t.data=this.data.clone(),t},effectSystem.prototype.play=function(t){void 0===t&&(t=1),this.speed=t,this.state=e.EffectPlayStateEnum.Play,this.gameObject.visible=!0,this.gameObject.transform.markDirty()},effectSystem.prototype.pause=function(){this.state=e.EffectPlayStateEnum.Pause},effectSystem.prototype.stop=function(){this.reset(),this.state=e.EffectPlayStateEnum.Stop},effectSystem.prototype.reset=function(t,a){void 0===t&&(t=!0),void 0===a&&(a=!0),this.state=e.EffectPlayStateEnum.BeReady,this.gameObject.visible=!1,this.playTimer=0,this.resetSingleMesh(),this.resetparticle()},effectSystem.prototype.resetSingleMesh=function(){for(var t in this.effectBatchers){var e=this.effectBatchers[t];for(var a in e.effectElements){var r=e.effectElements[a];r.setActive(!0),void 0!=r.data.initFrameData&&(r.curAttrData=r.data.initFrameData.attrsData.copyandinit())}}},effectSystem.prototype.resetparticle=function(){void 0!=this.particles&&this.particles.dispose();for(var t in this.data.elements){var a=this.data.elements[t];a.type==e.EffectElementTypeEnum.EmissionType&&(void 0==this.particles&&(this.particles=new e.Particles(this)),this.particles.addEmission(a))}},effectSystem.prototype.addElements=function(){for(var t in this.data.elements){var a=this.data.elements[t];a.type==e.EffectElementTypeEnum.EmissionType?(void 0==this.particles&&(this.particles=new e.Particles(this)),this.particles.addEmission(a)):a.type==e.EffectElementTypeEnum.SingleMeshType&&this.addInitFrame(a)}this.state=e.EffectPlayStateEnum.BeReady,this.beLoop=this.data.beLoop},effectSystem.prototype.addInitFrame=function(a){var r=new e.EffectElement(a);r.transform=this.gameObject.transform;var i=r.data.initFrameData;if(void 0!=i&&void 0!=i.attrsData&&void 0!=i.attrsData.mesh){var o=-1;if(null!=i.attrsData.mat)for(var n=0;n<this.matDataGroups.length;n++)if(e.EffectMatData.beEqual(this.matDataGroups[n],i.attrsData.mat)){o=n;break}var s=0,l=i.attrsData.mesh.data.pos.length,h=null;if(o>=0)s=(h=this.effectBatchers[o]).curTotalVertexCount,h.curTotalVertexCount+=l;else{(h=new e.EffectBatcher(this.vf)).curTotalVertexCount=l,h.mesh=new e.mesh,h.mesh.data=new t.render.meshData,h.mesh.glMesh=new t.render.glMesh,h.mat=new e.material,h.mesh.submesh=[];var c=new e.subMeshInfo;c.matIndex=0,c.useVertexIndex=0,c.start=0,c.size=0,c.line=!1,h.mesh.submesh.push(c),s=0,o=0,null==i.attrsData.mat.shader?(h.mat.setShader(e.sceneMgr.app.getAssetMgr().getShader("diffuse.shader.json")),console.error("特效{0}shader为空",a.name)):h.mat.setShader(i.attrsData.mat.shader),void 0!=i.attrsData.mat.alphaCut&&h.mat.setFloat("_AlphaCut",i.attrsData.mat.alphaCut),null!=i.attrsData.mat.diffuseTexture&&h.mat.setTexture("_MainTex",i.attrsData.mat.diffuseTexture),this.effectBatchers.push(h),this.matDataGroups.push(i.attrsData.mat)}r.effectBatcher=h,r.startIndex=s,r.curAttrData=a.initFrameData.attrsData.copyandinit();var u=h.vertexSize,d=i.attrsData.mesh.data.genVertexDataArray(this.vf);r.update(),h.effectElements.push(r);for(var m=0;m<l;m++){var p=t.math.pool.new_vector3();p.x=d[m*u+0],p.y=d[m*u+1],p.z=d[m*u+2],t.math.matrixTransformVector3(p,r.curAttrData.matrix,p),h.dataForVbo[(s+m)*u+0]=p.x,h.dataForVbo[(s+m)*u+1]=p.y,h.dataForVbo[(s+m)*u+2]=p.z,t.math.pool.delete_vector3(p),h.dataForVbo[(s+m)*u+3]=d[m*u+3],h.dataForVbo[(s+m)*u+4]=d[m*u+4],h.dataForVbo[(s+m)*u+5]=d[m*u+5],h.dataForVbo[(s+m)*u+6]=d[m*u+6],h.dataForVbo[(s+m)*u+7]=d[m*u+7],h.dataForVbo[(s+m)*u+8]=d[m*u+8];var f=t.math.floatClamp(r.curAttrData.color.x,0,1),v=t.math.floatClamp(r.curAttrData.color.y,0,1),g=t.math.floatClamp(r.curAttrData.color.z,0,1),y=t.math.floatClamp(d[m*u+12]*r.curAttrData.alpha,0,1);h.dataForVbo[15*(s+m)+9]=f,h.dataForVbo[15*(s+m)+10]=v,h.dataForVbo[15*(s+m)+11]=g,h.dataForVbo[15*(s+m)+12]=y,h.dataForVbo[(s+m)*u+13]=d[m*u+13]*r.curAttrData.tilling.x,h.dataForVbo[(s+m)*u+14]=d[m*u+14]*r.curAttrData.tilling.y}var _=i.attrsData.mesh.data.genIndexDataArray(),w=h.indexStartIndex;h.indexStartIndex+=_.length;for(var b=0;b<_.length;b++)h.dataForEbo[w+b]=_[b]+s;this.effectBatchers[o].beBufferInited=!1}},effectSystem.prototype.setFrameId=function(t){this.state==e.EffectPlayStateEnum.Pause&&t>=0&&t<this.totalFrameCount&&(this.curFrameId=t)},effectSystem.prototype.checkFrameId=function(){var t=r.fps*this.playTimer|0;return t!=this.curFrameId&&(this.state==e.EffectPlayStateEnum.Play&&(this.curFrameId=t),!0)},effectSystem.prototype.remove=function(){this.state=e.EffectPlayStateEnum.Dispose,this.data.dispose();for(var t in this.effectBatchers)this.effectBatchers[t].dispose();this.particles&&this.particles.dispose()},Object.defineProperty(effectSystem.prototype,"leftLifeTime",{get:function(){return null!=this.data?this.data.life-this.playTimer:9999999999},enumerable:!0,configurable:!0}),effectSystem}();a.fps=30,__decorate([t.reflect.Field("textasset"),__metadata("design:type",e.textasset)],a.prototype,"jsonData",void 0),a=r=__decorate([t.reflect.nodeRender,t.reflect.nodeComponent,t.reflect.selfClone],a),e.effectSystem=a;var r}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function frustumculling(){}return frustumculling.prototype.start=function(){},frustumculling.prototype.update=function(t){},frustumculling.prototype.remove=function(){},frustumculling.prototype.clone=function(){},frustumculling}();a=__decorate([t.reflect.nodeComponent,__metadata("design:paramtypes",[])],a),e.frustumculling=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function guidpath(){this.speed=1,this.isactived=!1,this.datasafe=!1,this.folowindex=0,this.isloop=!1,this.lookforward=!1,this.loopCount=1,this.adjustDir=!1}return Object.defineProperty(guidpath.prototype,"pathasset",{get:function(){return this._pathasset},set:function(t){this._pathasset&&this._pathasset.unuse(),this._pathasset=t,this._pathasset&&this._pathasset.use()},enumerable:!0,configurable:!0}),guidpath.prototype.play=function(t){void 0===t&&(t=1),this.isactived=!0,this.loopCount=t},guidpath.prototype.pause=function(){this.isactived=!1},guidpath.prototype.stop=function(){this.isactived=!1,this.folowindex=0},guidpath.prototype.replay=function(t){void 0===t&&(t=1),this.isactived=!0,this.folowindex=0,this.loopCount=t},guidpath.prototype.setpathasset=function(e,a,r){void 0===a&&(a=1),void 0===r&&(r=null),this.pathasset=e,null!=e?(this.paths=e.paths,null!=this.paths[0]&&(t.math.vec3Clone(this.paths[0],this.gameObject.transform.localTranslate),this.gameObject.transform.markDirty(),this.datasafe=!0),this.mystrans=this.gameObject.transform,this.speed=a,this.oncomplete=r):console.log(this.gameObject.getName().toString+":are you sure set the right pathasset（error：null）")},guidpath.prototype.start=function(){},guidpath.prototype.update=function(t){this.isactived&&this.datasafe&&this.followmove(t)},guidpath.prototype.followmove=function(e){var a=t.math.vec3Distance(this.mystrans.localTranslate,this.paths[this.folowindex]);if(a<.01)if(this.folowindex<this.paths.length-1){r=new t.math.vector3;t.math.vec3Clone(this.paths[this.folowindex],this.mystrans.localTranslate),this.folowindex++,this.adjustDir=!0,this.mystrans.markDirty()}else this.folowindex=0,this.isloop||0==--this.loopCount&&(this.isactived=!1,this.loopCount=1,this.oncomplete&&this.oncomplete());else{var r=new t.math.vector3;if(t.math.vec3Subtract(this.paths[this.folowindex],this.mystrans.localTranslate,r),this.adjustDir){var i=this.paths[this.folowindex],o=this.mystrans.localTranslate,n=t.math.pool.new_quaternion();t.math.quatLookat(o,i,n),t.math.quatClone(n,this.mystrans.localRotate),t.math.pool.delete_quaternion(n),this.adjustDir=!1}var s=this.speed*e;s>a&&(s=a);var l=s/a;t.math.vec3SLerp(this.mystrans.localTranslate,this.paths[this.folowindex],l,this.mystrans.localTranslate),this.mystrans.markDirty()}},guidpath.prototype.remove=function(){this._pathasset&&this._pathasset.unuse()},guidpath.prototype.clone=function(){},guidpath}();a=__decorate([t.reflect.nodeComponent],a),e.guidpath=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){!function(t){t[t.Direction=0]="Direction",t[t.Point=1]="Point",t[t.Spot=2]="Spot"}(e.LightTypeEnum||(e.LightTypeEnum={}));var a=function(){function light(){this.isOpen=!1,this.spotAngelCos=.9}return light.prototype.start=function(){},light.prototype.update=function(t){},light.prototype.remove=function(){},light.prototype.clone=function(){},light}();__decorate([t.reflect.Field("boolean"),__metadata("design:type",Boolean)],a.prototype,"isOpen",void 0),__decorate([t.reflect.Field("string"),__metadata("design:type",String)],a.prototype,"lightName",void 0),a=__decorate([t.reflect.nodeComponent,t.reflect.nodeLight],a),e.light=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function meshcollider(){this._colliderVisible=!1}return meshcollider.prototype.getBound=function(){return this.mesh},meshcollider.prototype.start=function(){var t=this.gameObject.getComponent("meshFilter");null!=t&&(this.mesh=t.getMeshOutput(),this.buildMesh())},meshcollider.prototype.update=function(t){},Object.defineProperty(meshcollider.prototype,"colliderVisible",{get:function(){return this._colliderVisible},set:function(t){this._colliderVisible=t,this.subTran&&(this.subTran.gameObject.visible=this._colliderVisible)},enumerable:!0,configurable:!0}),meshcollider.prototype.intersectsTransform=function(t){return!1},meshcollider.prototype.buildMesh=function(){this.subTran=new t.framework.transform,this.subTran.gameObject.hideFlags=e.HideFlags.DontSave|e.HideFlags.HideInHierarchy,this.subTran.name="meshcollider",this.subTran.gameObject.addComponent("meshFilter").mesh=this.getColliderMesh();this.subTran.gameObject.addComponent("meshRenderer");this.subTran.gameObject.visible=this._colliderVisible,this.gameObject.transform.addChild(this.subTran),this.gameObject.transform.markDirty(),this.subTran.markDirty(),this.gameObject.transform.updateWorldTran()},meshcollider.prototype.getColliderMesh=function(){var a=new e.mesh;a.data=this.mesh.data;var r=t.render.VertexFormatMask.Position|t.render.VertexFormatMask.Normal,i=a.data.genVertexDataArray(r),o=a.data.genIndexDataArrayTri2Line(),n=this.gameObject.getScene().webgl;a.glMesh=new t.render.glMesh,a.glMesh.initBuffer(n,r,a.data.pos.length),a.glMesh.uploadVertexSubData(n,i),a.glMesh.addIndex(n,o.length),a.glMesh.uploadIndexSubData(n,0,o),a.submesh=[];var s=new e.subMeshInfo;return s.matIndex=0,s.useVertexIndex=0,s.start=0,s.size=o.length,s.line=!0,a.submesh.push(s),a},meshcollider.prototype.remove=function(){this.subTran&&this.subTran.dispose()},meshcollider.prototype.clone=function(){},meshcollider}();a=__decorate([t.reflect.nodeComponent,t.reflect.nodeMeshCollider],a),e.meshcollider=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function meshFilter(){}return meshFilter.prototype.start=function(){},meshFilter.prototype.update=function(t){},Object.defineProperty(meshFilter.prototype,"mesh",{get:function(){return this._mesh},set:function(t){null!=this._mesh&&this._mesh.unuse(),this._mesh=t,null!=this._mesh&&this._mesh.use()},enumerable:!0,configurable:!0}),meshFilter.prototype.getMeshOutput=function(){return this._mesh},meshFilter.prototype.remove=function(){this.mesh&&this.mesh.unuse(!0)},meshFilter.prototype.clone=function(){},meshFilter}();__decorate([t.reflect.Field("mesh"),t.reflect.UIStyle("WidgetDragSelect"),__metadata("design:type",Object),__metadata("design:paramtypes",[e.mesh])],a.prototype,"mesh",null),a=__decorate([t.reflect.nodeComponent],a),e.meshFilter=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function meshRenderer(){this.materials=[],this.lightmapIndex=-1,this.lightmapScaleOffset=new t.math.vector4(1,1,0,0),this.layer=e.RenderLayerEnum.Common,this.renderLayer=e.CullingMask.default,this.issetq=!1,this._queue=0}return Object.defineProperty(meshRenderer.prototype,"queue",{get:function(){return this._queue},set:function(t){this._queue=t,this.issetq=!0},enumerable:!0,configurable:!0}),meshRenderer.prototype.start=function(){this.filter=this.gameObject.getComponent("meshFilter"),this.refreshLayerAndQue()},meshRenderer.prototype.refreshLayerAndQue=function(){null!=this.materials&&0!=this.materials.length||(this.materials=[],this.materials.push(new e.material),this.materials[0].setShader(e.sceneMgr.app.getAssetMgr().getShader("shader/def"))),this.layer=this.materials[0].getLayer(),this.issetq||(this._queue=this.materials[0].getQueue())},meshRenderer.prototype.update=function(t){if(null!=this.materials&&this.materials.length>0){var e=this.materials[0];e&&(this.layer=e.getLayer(),this.issetq||(this._queue=e.getQueue()))}},meshRenderer.prototype.render=function(e,a,r){if(e.updateModel(this.gameObject.transform),null!=this.filter){var i=this.filter.getMeshOutput();if(null!=i&&null!=i.submesh)for(var o=0;o<i.submesh.length;o++){var n=i.submesh[o],s=i.submesh[o].matIndex,l=this.materials[s],h=this.gameObject.transform.scene.fog?"base_fog":"base";this.lightmapIndex>=0&&(h=this.gameObject.transform.scene.fog?"lightmap_fog":"lightmap",this.gameObject.transform.scene.lightmaps.length>this.lightmapIndex&&(e.lightmap=this.gameObject.transform.scene.lightmaps[this.lightmapIndex],e.lightmapOffset=this.lightmapScaleOffset,e.lightmapUV=i.glMesh.vertexFormat&t.render.VertexFormatMask.UV1?1:0)),this.gameObject.transform.scene.fog&&(e.fog=this.gameObject.transform.scene.fog),null!=l&&l.draw(e,i,n,h)}}},meshRenderer.prototype.remove=function(){this.materials.length=0},meshRenderer.prototype.clone=function(){},meshRenderer}();__decorate([t.reflect.Field("material[]"),__metadata("design:type",Array)],a.prototype,"materials",void 0),__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],a.prototype,"lightmapIndex",void 0),__decorate([t.reflect.Field("vector4"),__metadata("design:type",t.math.vector4)],a.prototype,"lightmapScaleOffset",void 0),a=__decorate([t.reflect.nodeRender,t.reflect.nodeComponent,__metadata("design:paramtypes",[])],a),e.meshRenderer=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=r=function(){function skinnedMeshRenderer(){this.layer=e.RenderLayerEnum.Common,this.renderLayer=e.CullingMask.default,this.issetq=!1,this._queue=0,this.maxBoneCount=0,this._efficient=!0}return Object.defineProperty(skinnedMeshRenderer.prototype,"queue",{get:function(){return this._queue},set:function(t){this._queue=t,this.issetq=!0},enumerable:!0,configurable:!0}),Object.defineProperty(skinnedMeshRenderer.prototype,"player",{get:function(){return null==this._player&&(this._player=this.gameObject.getComponentInParent("aniplayer")),this._player},enumerable:!0,configurable:!0}),Object.defineProperty(skinnedMeshRenderer.prototype,"mesh",{get:function(){return this._mesh},set:function(t){null!=this._mesh&&this._mesh.unuse(),this._mesh=t,null!=this._mesh&&this._mesh.use()},enumerable:!0,configurable:!0}),skinnedMeshRenderer.prototype.start=function(){},skinnedMeshRenderer.prototype.getMatByIndex=function(e){var a=this.mesh.data;if(a.blendIndex[e].v0>=this.maxBoneCount||a.blendIndex[e].v1>=this.maxBoneCount||a.blendIndex[e].v2>=this.maxBoneCount||a.blendIndex[e].v3>=this.maxBoneCount)return null;var r=new t.math.matrix;if(this._efficient){var i=t.math.pool.new_vector4(),o=t.math.pool.new_vector3();i.x=this._skeletonMatrixData[8*a.blendIndex[e].v0+0],i.y=this._skeletonMatrixData[8*a.blendIndex[e].v0+1],i.z=this._skeletonMatrixData[8*a.blendIndex[e].v0+2],i.w=this._skeletonMatrixData[8*a.blendIndex[e].v0+3],o.x=this._skeletonMatrixData[8*a.blendIndex[e].v0+4],o.y=this._skeletonMatrixData[8*a.blendIndex[e].v0+5],o.z=this._skeletonMatrixData[8*a.blendIndex[e].v0+6];var n=t.math.pool.new_vector4(),s=t.math.pool.new_vector3();n.x=this._skeletonMatrixData[8*a.blendIndex[e].v1+0],n.y=this._skeletonMatrixData[8*a.blendIndex[e].v1+1],n.z=this._skeletonMatrixData[8*a.blendIndex[e].v1+2],n.w=this._skeletonMatrixData[8*a.blendIndex[e].v1+3],s.x=this._skeletonMatrixData[8*a.blendIndex[e].v1+4],s.y=this._skeletonMatrixData[8*a.blendIndex[e].v1+5],s.z=this._skeletonMatrixData[8*a.blendIndex[e].v1+6];var l=t.math.pool.new_vector4(),h=t.math.pool.new_vector3();l.x=this._skeletonMatrixData[8*a.blendIndex[e].v2+0],l.y=this._skeletonMatrixData[8*a.blendIndex[e].v2+1],l.z=this._skeletonMatrixData[8*a.blendIndex[e].v2+2],l.w=this._skeletonMatrixData[8*a.blendIndex[e].v2+3],h.x=this._skeletonMatrixData[8*a.blendIndex[e].v2+4],h.y=this._skeletonMatrixData[8*a.blendIndex[e].v2+5],h.z=this._skeletonMatrixData[8*a.blendIndex[e].v2+6];var c=t.math.pool.new_vector4(),u=t.math.pool.new_vector3();c.x=this._skeletonMatrixData[8*a.blendIndex[e].v3+0],c.y=this._skeletonMatrixData[8*a.blendIndex[e].v3+1],c.z=this._skeletonMatrixData[8*a.blendIndex[e].v3+2],c.w=this._skeletonMatrixData[8*a.blendIndex[e].v3+3],u.x=this._skeletonMatrixData[8*a.blendIndex[e].v3+4],u.y=this._skeletonMatrixData[8*a.blendIndex[e].v3+5],u.z=this._skeletonMatrixData[8*a.blendIndex[e].v3+6];var d=t.math.pool.new_matrix(),m=t.math.pool.new_matrix(),p=t.math.pool.new_matrix(),f=t.math.pool.new_matrix();t.math.matrixMakeTransformRTS(o,t.math.pool.vector3_one,i,d),t.math.matrixMakeTransformRTS(s,t.math.pool.vector3_one,n,m),t.math.matrixMakeTransformRTS(h,t.math.pool.vector3_one,l,p),t.math.matrixMakeTransformRTS(u,t.math.pool.vector3_one,c,f),t.math.matrixScaleByNum(a.blendWeight[e].v0,d),t.math.matrixScaleByNum(a.blendWeight[e].v1,m),t.math.matrixScaleByNum(a.blendWeight[e].v2,p),t.math.matrixScaleByNum(a.blendWeight[e].v3,f),t.math.matrixAdd(d,m,r),t.math.matrixAdd(r,p,r),t.math.matrixAdd(r,f,r),t.math.pool.delete_vector4(i),t.math.pool.delete_vector4(n),t.math.pool.delete_vector4(l),t.math.pool.delete_vector4(c),t.math.pool.delete_vector3(o),t.math.pool.delete_vector3(s),t.math.pool.delete_vector3(h),t.math.pool.delete_vector3(u),t.math.pool.delete_matrix(d),t.math.pool.delete_matrix(m),t.math.pool.delete_matrix(p),t.math.pool.delete_matrix(f)}else(d=t.math.pool.new_matrix()).rawData=this._skeletonMatrixData.slice(16*a.blendIndex[e].v0,16*a.blendIndex[e].v0+16),(m=t.math.pool.new_matrix()).rawData=this._skeletonMatrixData.slice(16*a.blendIndex[e].v1,16*a.blendIndex[e].v1+16),(p=t.math.pool.new_matrix()).rawData=this._skeletonMatrixData.slice(16*a.blendIndex[e].v2,16*a.blendIndex[e].v2+16),(f=t.math.pool.new_matrix()).rawData=this._skeletonMatrixData.slice(16*a.blendIndex[e].v3,16*a.blendIndex[e].v3+16),t.math.matrixScaleByNum(a.blendWeight[e].v0,d),t.math.matrixScaleByNum(a.blendWeight[e].v1,m),t.math.matrixScaleByNum(a.blendWeight[e].v2,p),t.math.matrixScaleByNum(a.blendWeight[e].v3,f),t.math.matrixAdd(d,m,r),t.math.matrixAdd(r,p,r),t.math.matrixAdd(r,f,r),t.math.pool.delete_matrix(d),t.math.pool.delete_matrix(m),t.math.pool.delete_matrix(p),t.math.pool.delete_matrix(f);return r},skinnedMeshRenderer.prototype.intersects=function(e){for(var a=this.player.gameObject.transform.getWorldMatrix(),r=null,i=this.mesh.data,o=0;o<this.mesh.submesh.length;o++){for(var n=this.mesh.submesh[o],s=t.math.pool.new_vector3(),l=t.math.pool.new_vector3(),h=t.math.pool.new_vector3(),c=n.start;c<n.size;c+=3){var u=i.trisindex[c],d=i.trisindex[c+1],m=i.trisindex[c+2],p=i.pos[u],f=i.pos[d],v=i.pos[m],g=this.getMatByIndex(u),y=this.getMatByIndex(d),_=this.getMatByIndex(m);if(null!=g&&null!=y&&null!=_){var w=t.math.pool.new_matrix();t.math.matrixMultiply(a,g,w);var b=t.math.pool.new_matrix();t.math.matrixMultiply(a,y,b);var x=t.math.pool.new_matrix();t.math.matrixMultiply(a,_,x),t.math.matrixTransformVector3(p,w,s),t.math.matrixTransformVector3(f,b,l),t.math.matrixTransformVector3(v,x,h);var D=e.intersectsTriangle(s,l,h);if(D){if(D.distance<0)continue;if(!r||r.distance>D.distance){(r=D).faceId=c/3,r.subMeshId=o;var T=t.math.pool.new_vector3();t.math.vec3ScaleByNum(e.direction,D.distance,T),t.math.vec3Add(e.origin,T,r.hitposition)}}}}t.math.pool.delete_vector3(s),t.math.pool.delete_vector3(l),t.math.pool.delete_vector3(h)}return r},skinnedMeshRenderer.prototype.update=function(t){if(null==this._skeletonMatrixData){var e=this.useBoneShader(this.materials[0]);1==e?(this.maxBoneCount=24,this._skeletonMatrixData=new Float32Array(16*this.maxBoneCount),this._efficient=!1):2==e&&(this.maxBoneCount=40,this._skeletonMatrixData=new Float32Array(8*this.maxBoneCount),this._efficient=!0)}if(null!=this.player){if(!this.player.mix){var a=this.player.cacheKey+"_"+this.mesh.getGUID(),i=r.dataCaches[a];return i||(i=new Float32Array(320),this.player.fillPoseData(i,this.bones,!0),r.dataCaches[a]=i),void(this.cacheData=i)}this.cacheData=null,null!=this._skeletonMatrixData&&this.player.fillPoseData(this._skeletonMatrixData,this.bones,this._efficient)}if(null!=this.materials&&this.materials.length>0){var o=this.materials[0];o&&(this.layer=o.getLayer(),this.issetq||(this._queue=o.getQueue()))}},skinnedMeshRenderer.prototype.render=function(t,e,a){null!=this.player&&t.updateModel(this.player.gameObject.transform);for(var r=0;r<this.materials.length;r++)null==this.cacheData?null!=this._skeletonMatrixData&&(this._efficient?this.materials[r].setVector4v("glstate_vec4_bones",this._skeletonMatrixData):this.materials[r].setMatrixv("glstate_matrix_bones",this._skeletonMatrixData)):this._efficient?this.materials[r].setVector4v("glstate_vec4_bones",this.cacheData):this.materials[r].setMatrixv("glstate_matrix_bones",this.cacheData);if(null!=this._mesh&&null!=this._mesh&&null!=this._mesh.submesh)for(var i=0;i<this._mesh.submesh.length;i++){var o=this._mesh.submesh[i],n=this._mesh.submesh[i].matIndex,s=this.materials[n];null!=s&&(this.gameObject.transform.scene.fog?(t.fog=this.gameObject.transform.scene.fog,s.draw(t,this._mesh,o,"skin_fog")):s.draw(t,this._mesh,o,"skin"))}},skinnedMeshRenderer.prototype.remove=function(){this.mesh&&this.mesh.unuse(!0),this.bones.length=0},skinnedMeshRenderer.prototype.clone=function(){},skinnedMeshRenderer.prototype.useBoneShader=function(t){var e=t.getShader().passes.skin;return null==e||0==e.length?0:null!=e[0].uniforms.glstate_vec4_bones?2:null!=e[0].uniforms.glstate_matrix_bones?1:0},skinnedMeshRenderer}();a.dataCaches=[],__decorate([t.reflect.Field("material[]"),__metadata("design:type",Array)],a.prototype,"materials",void 0),__decorate([t.reflect.Field("mesh"),__metadata("design:type",Object),__metadata("design:paramtypes",[e.mesh])],a.prototype,"mesh",null),__decorate([t.reflect.Field("transform[]"),__metadata("design:type",Array)],a.prototype,"bones",void 0),__decorate([t.reflect.Field("transform"),__metadata("design:type",e.transform)],a.prototype,"rootBone",void 0),__decorate([t.reflect.Field("vector3"),__metadata("design:type",t.math.vector3)],a.prototype,"center",void 0),__decorate([t.reflect.Field("vector3"),__metadata("design:type",t.math.vector3)],a.prototype,"size",void 0),a=r=__decorate([t.reflect.nodeRender,t.reflect.nodeComponent,__metadata("design:paramtypes",[])],a),e.skinnedMeshRenderer=a;var r}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function spherestruct(e,a){this.center=t.math.pool.clone_vector3(e),this.srcradius=a,this.tempScale=new t.math.vector3}return spherestruct.prototype.update=function(e){t.math.matrixGetTranslation(e,this.center),t.math.matrixGetScale(e,this.tempScale),this.tempScale.x<this.tempScale.y&&(this.tempScale.x=this.tempScale.y),this.tempScale.x<this.tempScale.z&&(this.tempScale.x=this.tempScale.z),this.radius=this.srcradius*this.tempScale.x},spherestruct.prototype.intersects=function(a){if(a instanceof spherestruct)return!(t.math.vec3Distance(this.center,a.center)>this.radius+a.radius);e.obb},spherestruct}();e.spherestruct=a;var r=function(){function spherecollider(){this._worldCenter=new t.math.vector3,this._colliderVisible=!1}return Object.defineProperty(spherecollider.prototype,"worldCenter",{get:function(){return t.math.vec3Clone(this.center,this._worldCenter),t.math.matrixTransformVector3(this._worldCenter,this.gameObject.transform.getWorldMatrix(),this._worldCenter),this._worldCenter},enumerable:!0,configurable:!0}),spherecollider.prototype.getBound=function(){return this.spherestruct},Object.defineProperty(spherecollider.prototype,"matrix",{get:function(){return this.gameObject?this.gameObject.transform.getWorldMatrix():new t.math.matrix},enumerable:!0,configurable:!0}),spherecollider.prototype.start=function(){this.filter=this.gameObject.getComponent("meshFilter"),this.build()},spherecollider.prototype.update=function(t){this.spherestruct&&this.spherestruct.update(this.matrix)},Object.defineProperty(spherecollider.prototype,"colliderVisible",{get:function(){return this._colliderVisible},set:function(t){this._colliderVisible=t,this.subTran&&(this.subTran.gameObject.visible=this._colliderVisible)},enumerable:!0,configurable:!0}),spherecollider.prototype.caclPlaneInDir=function(e,a,r){var i=t.math.pool.new_vector3(),o=t.math.pool.new_vector3(),n=t.math.pool.new_vector3(),s=t.math.pool.new_vector3();t.math.vec3Subtract(a,e,i),t.math.vec3Subtract(r,a,o),t.math.vec3Cross(i,o,n),t.math.calPlaneLineIntersectPoint(n,e,n,this.worldCenter,s);var l=t.math.pool.new_vector3();t.math.vec3Subtract(s,this.worldCenter,l);var h=t.math.vec3Dot(n,l);if(t.math.pool.delete_vector3(i),t.math.pool.delete_vector3(o),t.math.pool.delete_vector3(n),h<=0)return!0;var c=t.math.vec3Distance(this.worldCenter,s);return t.math.pool.delete_vector3(s),c<this.radius},spherecollider.prototype.intersectsTransform=function(t){if(null==t.gameObject.collider)return!1;if(null==this.spherestruct||null==t.gameObject.collider.getBound())return!1;var e=t.gameObject.collider.getBound();return this.spherestruct.intersects(e)},spherecollider.prototype.build=function(){this.center&&this.radius&&(this.spherestruct=new a(this.center,this.radius))},spherecollider.prototype.buildMesh=function(){this.subTran=new t.framework.transform,this.subTran.gameObject.hideFlags=e.HideFlags.DontSave|e.HideFlags.HideInHierarchy,this.subTran.name="spherecollider",this.subTran.gameObject.addComponent("meshFilter").mesh=this.getColliderMesh();this.subTran.gameObject.addComponent("meshRenderer");this.subTran.gameObject.visible=this._colliderVisible,this.gameObject.transform.addChild(this.subTran),this.gameObject.transform.markDirty(),this.subTran.markDirty(),this.gameObject.transform.updateWorldTran()},spherecollider.prototype.getColliderMesh=function(){return new e.mesh},spherecollider.prototype.remove=function(){this.subTran&&this.subTran.dispose()},spherecollider.prototype.clone=function(){},spherecollider}();__decorate([t.reflect.Field("vector3"),__metadata("design:type",t.math.vector3)],r.prototype,"center",void 0),__decorate([t.reflect.Field("number"),__metadata("design:type",Number)],r.prototype,"radius",void 0),r=__decorate([t.reflect.nodeComponent,t.reflect.nodeSphereCollider],r),e.spherecollider=r}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function trailRender_recorde(){this.layer=e.RenderLayerEnum.Common,this.renderLayer=e.CullingMask.default,this.queue=0,this._startWidth=1,this._endWidth=0,this.lifetime=.35,this.minStickDistance=.1,this.maxStickCout=12,this.nodes=[],this.interpolate=!1,this.interpNumber=3,this.interpPath=[],this.activeMaxpointlimit=!1,this.notRender=!1}return Object.defineProperty(trailRender_recorde.prototype,"material",{get:function(){if(void 0!=this._material)return this._material;var e=new t.framework.material;return e.setShader(this.app.getAssetMgr().getShader("shader/def")),this._material=e,this._material},set:function(t){this._material=t,this.layer=this._material.getLayer()},enumerable:!0,configurable:!0}),Object.defineProperty(trailRender_recorde.prototype,"startColor",{get:function(){return void 0==this._startColor&&(this._startColor=new t.math.color(1,1,1,1)),this._startColor},set:function(t){this._startColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(trailRender_recorde.prototype,"endColor",{get:function(){return void 0==this._endColor&&(this._endColor=new t.math.color(this.startColor.r,this.startColor.g,this.startColor.b,0)),this._endColor},set:function(t){this._endColor=t},enumerable:!0,configurable:!0}),trailRender_recorde.prototype.setWidth=function(t,e){void 0===e&&(e=0),this._startWidth=t,this._endWidth=e},trailRender_recorde.prototype.setMaxpointcontroll=function(t){void 0===t&&(t=!1),this.activeMaxpointlimit=t},trailRender_recorde.prototype.start=function(){this.app=this.gameObject.getScene().app,this.webgl=this.app.webgl,this.mesh=new t.framework.mesh,this.mesh.data=new t.render.meshData,this.mesh.glMesh=new t.render.glMesh,this.dataForVbo=new Float32Array(128),this.dataForEbo=new Uint16Array(128);var a=t.render.VertexFormatMask.Position|t.render.VertexFormatMask.Color|t.render.VertexFormatMask.UV0;this.mesh.glMesh.initBuffer(this.webgl,a,128,t.render.MeshTypeEnum.Dynamic),this.mesh.glMesh.addIndex(this.webgl,this.dataForEbo.length),this.mesh.submesh=[];var r=new e.subMeshInfo;r.matIndex=0,r.useVertexIndex=0,r.start=0,r.size=this.dataForEbo.length,r.line=!1,this.mesh.submesh.push(r),this.interpolate?(this.maxStickCout*=this.interpNumber,this.targetPath=this.interpPath):this.targetPath=this.nodes},trailRender_recorde.prototype.update=function(t){var e=this.app.getTotalTime();this.refreshTrailNode(e),this.updateTrailData(e)},trailRender_recorde.prototype.remove=function(){},trailRender_recorde.prototype.refreshTrailNode=function(e){for(;this.targetPath.length>0&&e>this.targetPath[this.targetPath.length-1].time+this.lifetime;)this.targetPath.pop();var a=new t.math.vector3;if(t.math.vec3Clone(this.gameObject.transform.getWorldTranslate(),a),!(0!=this.targetPath.length&&t.math.vec3Distance(a,this.targetPath[0].location)<this.minStickDistance)){var i=new t.math.vector3;this.gameObject.transform.getUpInWorld(i);var o=new r(a,i,e);if(this.nodes.unshift(o),this.interpolate&&this.nodes.length>2){var n=new t.math.vector3;if(t.math.vec3Subtract(this.nodes[2].location,this.nodes[0].location,n),t.math.vec3Normalize(n,n),this.nodes[1].handle=n,void 0==this.nodes[2].handle){var s=new t.math.vector3;t.math.vec3Subtract(this.nodes[2].location,this.nodes[1].location,s),t.math.vec3Normalize(s,s),this.nodes[2].handle=s}for(var l=t.math.vec3Distance(this.nodes[2].location,this.nodes[1].location),h=0;h<this.interpNumber;h++){var c=(h+1)/(this.interpNumber+1),u=new t.math.vector3,d=t.math.pool.new_vector3(),m=t.math.pool.new_vector3();m.x=-this.nodes[2].handle.x,m.y=-this.nodes[2].handle.y,m.z=-this.nodes[2].handle.z,t.math.vec3ScaleByNum(m,l/2,m),t.math.vec3Add(m,this.nodes[2].location,m),t.math.vec3ScaleByNum(this.nodes[1].handle,l/2,d),t.math.vec3Add(d,this.nodes[1].location,d),t.math.GetPointAlongCurve(this.nodes[2].location,m,this.nodes[1].location,d,(h+1)/(this.interpNumber+1),u);var p=new t.math.vector3;t.math.vec3SLerp(this.nodes[1].updir,this.nodes[2].updir,c,p);var f=new r(u,p,e);this.interpPath.splice(1,0,f),t.math.pool.delete_vector3(d),t.math.pool.delete_vector3(m)}this.interpPath.unshift(o)}if(this.activeMaxpointlimit)for(;this.targetPath.length>this.maxStickCout;)this.targetPath.pop()}},trailRender_recorde.prototype.updateTrailData=function(e){if(this.nodes.length<2)this.notRender=!0;else{this.notRender=!1,this.checkBufferSize();for(var a=0;a<this.targetPath.length;a++){var r=this.targetPath[a],i=a/this.targetPath.length,o=(e-r.time)/this.lifetime,n=new t.math.vector3;t.math.vec3Clone(r.updir,n);var s=this._startWidth+(this._endWidth-this._startWidth)*o;t.math.vec3ScaleByNum(n,s,n);var l=t.math.pool.new_vector3();t.math.vec3Add(r.location,n,l),this.dataForVbo[2*a*9+0]=l.x,this.dataForVbo[2*a*9+1]=l.y,this.dataForVbo[2*a*9+2]=l.z;var h=t.math.pool.new_color();t.math.colorLerp(this.startColor,this.endColor,o,h),this.dataForVbo[2*a*9+3]=h.r,this.dataForVbo[2*a*9+4]=h.g,this.dataForVbo[2*a*9+5]=h.b,this.dataForVbo[2*a*9+6]=h.a,this.dataForVbo[2*a*9+7]=i,this.dataForVbo[2*a*9+8]=1,this.dataForVbo[9*(2*a+1)+0]=r.location.x,this.dataForVbo[9*(2*a+1)+1]=r.location.y,this.dataForVbo[9*(2*a+1)+2]=r.location.z,this.dataForVbo[9*(2*a+1)+3]=h.r,this.dataForVbo[9*(2*a+1)+4]=h.g,this.dataForVbo[9*(2*a+1)+5]=h.b,this.dataForVbo[9*(2*a+1)+6]=h.a;i=a/this.nodes.length;this.dataForVbo[9*(2*a+1)+7]=i,this.dataForVbo[9*(2*a+1)+8]=0,t.math.pool.delete_vector3(l),t.math.pool.delete_color(h)}for(var c=0;c<this.nodes.length-1;c++)this.dataForEbo[6*c+0]=2*c,this.dataForEbo[6*c+1]=2*(c+1),this.dataForEbo[6*c+2]=2*c+1,this.dataForEbo[6*c+3]=2*c+1,this.dataForEbo[6*c+4]=2*(c+1),this.dataForEbo[6*c+5]=2*(c+1)+1}},trailRender_recorde.prototype.checkBufferSize=function(){var t=this.targetPath.length;if(2*t*9>this.dataForVbo.length){e=this.dataForVbo.length;this.mesh.glMesh.resetVboSize(this.webgl,2*e),this.dataForVbo=new Float32Array(2*e)}if(6*(t-1)>this.dataForEbo.length){var e=this.dataForEbo.length;this.mesh.glMesh.resetEboSize(this.webgl,0,2*e),this.dataForEbo=new Uint16Array(2*e)}},trailRender_recorde.prototype.render=function(t,e,a){this.notRender||(t.updateModeTrail(),this.mesh.glMesh.uploadVertexSubData(t.webgl,this.dataForVbo),this.mesh.glMesh.uploadIndexSubData(t.webgl,0,this.dataForEbo),this.mesh.submesh[0].size=6*(this.targetPath.length-1),this.gameObject.getScene().fog?(t.fog=this.gameObject.getScene().fog,this.material.draw(t,this.mesh,this.mesh.submesh[0],"base_fog")):this.material.draw(t,this.mesh,this.mesh.submesh[0],"base"))},trailRender_recorde.prototype.clone=function(){},trailRender_recorde}();a=__decorate([t.reflect.nodeRender,t.reflect.nodeComponent],a),e.trailRender_recorde=a;var r=function(){return function trailNode(t,e,a){this.location=t,this.updir=e,this.time=a}}();e.trailNode=r}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function trailRender(){this.layer=e.RenderLayerEnum.Common,this.renderLayer=e.CullingMask.default,this.queue=0,this.width=1,this.vertexcount=24,this.active=!1,this.reInit=!1,this.extenedOneSide=!0,this.lookAtCamera=!1,this.speed=.5}return trailRender.prototype.start=function(){this.app=this.gameObject.getScene().app,this.webgl=this.app.webgl,this.initmesh()},trailRender.prototype.update=function(a){if(this.active){this.reInit&&(this.intidata(),this.reInit=!1);var r=this.gameObject.transform.getWorldTranslate();if(this.lookAtCamera){this.camerapositon=e.sceneMgr.app.getScene().mainCamera.gameObject.transform.getWorldTranslate();var i=t.math.pool.new_vector3();t.math.vec3Subtract(this.camerapositon,this.sticks[0].location,i),t.math.vec3Normalize(i,i);var o=t.math.pool.new_vector3();t.math.vec3Subtract(r,this.sticks[0].location,o),t.math.vec3Normalize(o,o),t.math.vec3Cross(i,o,this.sticks[0].updir),t.math.vec3ScaleByNum(this.sticks[0].updir,this.width,this.sticks[0].updir),t.math.pool.delete_vector3(o)}t.math.vec3Clone(r,this.sticks[0].location);for(var n=this.sticks.length,s=1;s<n;s++)t.math.vec3SLerp(this.sticks[s].location,this.sticks[s-1].location,this.speed,this.sticks[s].location);if(this.lookAtCamera)for(s=1;s<n;s++){var l=t.math.pool.new_vector3();t.math.vec3Subtract(this.camerapositon,this.sticks[s].location,l),t.math.vec3Normalize(l,l);var h=t.math.pool.new_vector3();t.math.vec3Subtract(this.sticks[s-1].location,this.sticks[s].location,h),t.math.vec3Normalize(h,h),t.math.vec3Cross(l,h,this.sticks[s].updir),t.math.vec3ScaleByNum(this.sticks[s].updir,this.width,this.sticks[s].updir),t.math.pool.delete_vector3(l)}else{this.gameObject.transform.getUpInWorld(this.sticks[0].updir),t.math.vec3ScaleByNum(this.sticks[0].updir,this.width,this.sticks[0].updir);for(s=1;s<n;s++)t.math.vec3SLerp(this.sticks[s].updir,this.sticks[s-1].updir,this.speed,this.sticks[s].updir)}this.updateTrailData()}},Object.defineProperty(trailRender.prototype,"material",{get:function(){if(void 0!=this._material)return this._material;var e=new t.framework.material;return e.setShader(this.app.getAssetMgr().getShader("shader/def")),this.material=e,this._material},set:function(t){this._material=t,this.layer=this.material.getLayer()},enumerable:!0,configurable:!0}),Object.defineProperty(trailRender.prototype,"color",{get:function(){return void 0==this._color&&(this._color=new t.math.color(1,1,1,1)),this._color},set:function(t){this._color=t},enumerable:!0,configurable:!0}),trailRender.prototype.setspeed=function(t){this.speed=t},trailRender.prototype.setWidth=function(t){this.width=t},trailRender.prototype.play=function(){this.reInit=!0,this.active=!0},trailRender.prototype.stop=function(){this.active=!1},trailRender.prototype.initmesh=function(){this.mesh=new t.framework.mesh,this.mesh.data=new t.render.meshData,this.mesh.glMesh=new t.render.glMesh,this.dataForVbo=new Float32Array(9*this.vertexcount),this.dataForEbo=new Uint16Array(6*(this.vertexcount/2-1));var a=t.render.VertexFormatMask.Position|t.render.VertexFormatMask.Color|t.render.VertexFormatMask.UV0;this.mesh.glMesh.initBuffer(this.webgl,a,this.vertexcount,t.render.MeshTypeEnum.Dynamic),this.mesh.glMesh.addIndex(this.webgl,this.dataForEbo.length),this.mesh.submesh=[];var r=new e.subMeshInfo;r.matIndex=0,r.useVertexIndex=0,r.start=0,r.size=this.dataForEbo.length,r.line=!1,this.mesh.submesh.push(r)},trailRender.prototype.intidata=function(){this.sticks=[];for(l=0;l<this.vertexcount/2;l++){var e=new r;this.sticks.push(e),e.location=new t.math.vector3,t.math.vec3Clone(this.gameObject.transform.getWorldTranslate(),e.location),e.updir=new t.math.vector3,this.gameObject.transform.getUpInWorld(e.updir),t.math.vec3ScaleByNum(e.updir,this.width,e.updir)}var a=this.vertexcount/2,i=t.math.pool.new_vector3();this.gameObject.transform.getUpInWorld(i),t.math.vec3ScaleByNum(i,this.width,i);var o=t.math.pool.new_vector3();t.math.vec3Clone(this.gameObject.transform.getWorldTranslate(),o);var n=t.math.pool.new_vector3();t.math.vec3Add(o,i,n);var s=t.math.pool.new_vector3();t.math.vec3Subtract(o,i,s);for(var l=0;l<a;l++)this.dataForVbo[2*l*9]=n.x,this.dataForVbo[2*l*9+1]=n.y,this.dataForVbo[2*l*9+2]=n.z,this.dataForVbo[2*l*9+3]=this.color.r,this.dataForVbo[2*l*9+4]=this.color.g,this.dataForVbo[2*l*9+5]=this.color.b,this.dataForVbo[2*l*9+6]=this.color.a,this.dataForVbo[2*l*9+7]=l/(a-1),this.dataForVbo[2*l*9+8]=0,this.dataForVbo[9*(2*l+1)]=s.x,this.dataForVbo[9*(2*l+1)+1]=s.y,this.dataForVbo[9*(2*l+1)+2]=s.z,this.dataForVbo[9*(2*l+1)+3]=this.color.r,this.dataForVbo[9*(2*l+1)+4]=this.color.g,this.dataForVbo[9*(2*l+1)+5]=this.color.b,this.dataForVbo[9*(2*l+1)+6]=this.color.a,this.dataForVbo[9*(2*l+1)+7]=l/(a-1),this.dataForVbo[9*(2*l+1)+8]=1;for(var h=0;h<a-1;h++)this.dataForEbo[6*h+0]=2*h,this.dataForEbo[6*h+1]=2*(h+1),this.dataForEbo[6*h+2]=2*h+1,this.dataForEbo[6*h+3]=2*h+1,this.dataForEbo[6*h+4]=2*(h+1),this.dataForEbo[6*h+5]=2*(h+1)+1;this.mesh.glMesh.uploadVertexSubData(this.webgl,this.dataForVbo),this.mesh.glMesh.uploadIndexSubData(this.webgl,0,this.dataForEbo),t.math.pool.delete_vector3(i),t.math.pool.delete_vector3(o),t.math.pool.delete_vector3(n),t.math.pool.delete_vector3(s)},trailRender.prototype.updateTrailData=function(){var t=this.vertexcount/2;if(this.extenedOneSide)for(r=0;r<t;r++){var e=this.sticks[r].location,a=this.sticks[r].updir;this.dataForVbo[2*r*9]=e.x,this.dataForVbo[2*r*9+1]=e.y,this.dataForVbo[2*r*9+2]=e.z,this.dataForVbo[9*(2*r+1)]=e.x+a.x,this.dataForVbo[9*(2*r+1)+1]=e.y+a.y,this.dataForVbo[9*(2*r+1)+2]=e.z+a.z}else for(var r=0;r<t;r++){var e=this.sticks[r].location,a=this.sticks[r].updir;this.dataForVbo[2*r*9]=e.x-a.x,this.dataForVbo[2*r*9+1]=e.y-a.y,this.dataForVbo[2*r*9+2]=e.z-a.z,this.dataForVbo[9*(2*r+1)]=e.x+a.x,this.dataForVbo[9*(2*r+1)+1]=e.y+a.y,this.dataForVbo[9*(2*r+1)+2]=e.z+a.z}},trailRender.prototype.render=function(t,e,a){this.active&&(t.updateModeTrail(),this.mesh.glMesh.uploadVertexSubData(t.webgl,this.dataForVbo),this.gameObject.getScene().fog?(t.fog=this.gameObject.getScene().fog,this.material.draw(t,this.mesh,this.mesh.submesh[0],"base_fog")):this.material.draw(t,this.mesh,this.mesh.submesh[0],"base"))},trailRender.prototype.clone=function(){},trailRender.prototype.remove=function(){},trailRender}();a=__decorate([t.reflect.nodeRender,t.reflect.nodeComponent],a),e.trailRender=a;var r=function(){return function trailStick(){}}();e.trailStick=r}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(t){var e=function(){return function pointinfo(){}}();t.pointinfo=e;var a=function(){return function inputMgr(t){var a=this;this.inputlast=null,this.point=new e,this.touches={},this.keyboardMap={},t.webgl.canvas.addEventListener("touchstart",function(t){a.point.x=t.touches[0].clientX,a.point.y=t.touches[0].clientY,a.point.touch=!0;for(var r=0;r<t.changedTouches.length;r++){var i=t.changedTouches[r],o=i.identifier;null==a.touches[o]&&(a.touches[o]=new e,a.touches[o].id=o),a.touches[o].touch=!0,a.touches[o].x=i.clientX,a.touches[o].y=i.clientY}}),t.webgl.canvas.addEventListener("mousedown",function(t){a.point.x=t.offsetX,a.point.y=t.offsetY,a.point.touch=!0}),t.webgl.canvas.addEventListener("touchend",function(t){for(var r=0;r<t.changedTouches.length;r++){var i=t.changedTouches[r].identifier;null==a.touches[i]&&(a.touches[i]=new e,a.touches[i].id=i),a.touches[i].touch=!1}for(var o in a.touches)if(1==a.touches[o].touch)return;a.point.touch=!1}),t.webgl.canvas.addEventListener("touchcancel",function(t){for(var r=0;r<t.changedTouches.length;r++){var i=t.changedTouches[r].identifier;null==a.touches[i]&&(a.touches[i]=new e,a.touches[i].id=i),a.touches[i].touch=!1}for(var o in a.touches)if(1==a.touches[o].touch)return;a.point.touch=!1}),t.webgl.canvas.addEventListener("mouseup",function(t){a.point.touch=!1}),t.webgl.canvas.addEventListener("touchmove",function(t){for(var r=0;r<t.changedTouches.length;r++){var i=t.changedTouches[r],o=i.identifier;null==a.touches[o]&&(a.touches[o]=new e,a.touches[o].id=o),a.touches[o].touch=!0,a.touches[o].x=i.clientX,a.touches[o].y=i.clientY}var n=0,s=0,l=0;for(var h in a.touches)1==a.touches[h].touch&&(s+=a.touches[h].x,l+=a.touches[h].y,n++);a.point.x=s/n,a.point.y=l/n}),t.webgl.canvas.addEventListener("mousemove",function(t){a.point.x=t.offsetX,a.point.y=t.offsetY}),t.webgl.canvas.addEventListener("keydown",function(t){a.keyboardMap[t.keyCode]=!0},!1),t.webgl.canvas.addEventListener("keyup",function(t){a.keyboardMap[t.keyCode]=!1},!1)}}();t.inputMgr=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(t){var e=function(){function binBuffer(t){void 0===t&&(t=65536),t<1024&&(t=1024),t>262144&&(t=262144),this._bufSize=t,this._buf=[],this._seekWritePos=0,this._seekWriteIndex=0,this._buf[0]=new Uint8Array(t),this._seekReadPos=0}return binBuffer.prototype.getLength=function(){return this._seekWriteIndex*this._bufSize+this._seekWritePos-this._seekReadPos},binBuffer.prototype.getBufLength=function(){return this._buf.length*this._bufSize},binBuffer.prototype.getBytesAvailable=function(){return this.getLength()},binBuffer.prototype.reset=function(){this._buf=[],this._seekWritePos=0,this._seekWriteIndex=0,this._buf[0]=new Uint8Array(this._bufSize),this._seekReadPos=0},binBuffer.prototype.dispose=function(){this._buf.splice(0),this._seekWritePos=0,this._seekWriteIndex=0,this._seekReadPos=0},binBuffer.prototype.read=function(t,e,a){void 0===e&&(e=0),void 0===a&&(a=-1),a<0&&(a=t.length);for(var r=e;r<e+a;r++){if(this._seekReadPos>=this._seekWritePos&&0==this._seekWriteIndex)throw this.reset(),new Error("no data to read.");if(t[r]=this._buf[0][this._seekReadPos],++this._seekReadPos>=this._bufSize){this._seekWriteIndex--,this._seekReadPos=0;var i=this._buf.shift();this._buf.push(i)}}},binBuffer.prototype.write=function(t,e,a){void 0===e&&(e=0),void 0===a&&(a=-1),a<0&&(a=t.length);for(var r=e;r<e+a;r++)this._buf[this._seekWriteIndex][this._seekWritePos]=t[r],++this._seekWritePos>=this._bufSize&&(this._seekWriteIndex++,this._seekWritePos=0,this._buf.length<=this._seekWriteIndex&&this._buf.push(new Uint8Array(this._bufSize)))},binBuffer.prototype.getBuffer=function(){var t=0;t=this._seekWriteIndex>0?this._bufSize*(this._seekWriteIndex-1)+this._seekWritePos:this._seekWritePos;for(var e=new Uint8Array(t),a=0;a<this._seekWriteIndex-1;a++)e.set(this._buf[a],a*this._bufSize);for(a=0;a<this._seekWritePos;a++)e[t-this._seekWritePos+a]=this._buf[this._seekWriteIndex][a];return e},binBuffer.prototype.getUint8Array=function(){return new Uint8Array(this.getBuffer())},binBuffer}();t.binBuffer=e;var a=function(){function converter(){}return converter.getApplyFun=function(t){return Array.prototype.concat.apply([],t)},converter.ULongToArray=function(t,e,a){void 0===e&&(e=null),void 0===a&&(a=0);var r=t%4294967296,i=t/4294967296|0;converter.dataView.setUint32(0,r,!0),converter.dataView.setUint32(4,i,!0);var o=new Uint8Array(converter.dataView.buffer);if(null==e)e=new Uint8Array(converter.dataView.buffer);else for(var n=0;n<8;n++)e[a+n]=o[n];return e},converter.LongToArray=function(t,e,a){void 0===e&&(e=null),void 0===a&&(a=0);var r=t%4294967296,i=t/4294967296|0;converter.dataView.setInt32(0,r,!0),converter.dataView.setInt32(4,i,!0);var o=new Int8Array(converter.dataView.buffer);if(null==e)e=new Int8Array(converter.dataView.buffer);else for(var n=0;n<8;n++)e[a+n]=o[n];return e},converter.Float64ToArray=function(t,e,a){if(void 0===e&&(e=null),void 0===a&&(a=0),converter.dataView.setFloat64(0,t,!1),null==e)e=new Uint8Array(converter.dataView.buffer);else for(var r=0;r<8;r++)e[a+r]=converter.dataView.buffer[r];return e},converter.Float32ToArray=function(t,e,a){void 0===e&&(e=null),void 0===a&&(a=0),converter.dataView.setFloat32(0,t,!0);var r=new Uint8Array(converter.dataView.buffer);if(null==e)e=converter.getApplyFun(r).slice(0,4);else for(var i=0;i<4;i++)e[a+i]=r[i];return e},converter.Int32ToArray=function(t,e,a){void 0===e&&(e=null),void 0===a&&(a=0),converter.dataView.setInt32(0,t,!0);var r=new Uint8Array(converter.dataView.buffer);if(null==e)e=converter.getApplyFun(r).slice(0,4);else for(var i=0;i<4;i++)e[a+i]=r[i];return e},converter.Int16ToArray=function(t,e,a){void 0===e&&(e=null),void 0===a&&(a=0),converter.dataView.setInt16(0,t,!0);var r=new Uint8Array(converter.dataView.buffer);if(null==e)e=converter.getApplyFun(r).slice(0,2);else for(var i=0;i<2;i++)e[a+i]=r[i];return e},converter.Int8ToArray=function(t,e,a){void 0===e&&(e=null),void 0===a&&(a=0),converter.dataView.setInt8(0,t);var r=new Uint8Array(converter.dataView.buffer);if(null==e)e=converter.getApplyFun(r).slice(0,1);else for(var i=0;i<1;i++)e[a+i]=r[i];return e},converter.Uint32toArray=function(t,e,a){void 0===e&&(e=null),void 0===a&&(a=0),converter.dataView.setInt32(0,t,!0);var r=new Uint8Array(converter.dataView.buffer);if(null==e)e=converter.getApplyFun(r).slice(0,4);else for(var i=0;i<4;i++)e[a+i]=r[i];return e},converter.Uint16ToArray=function(t,e,a){void 0===e&&(e=null),void 0===a&&(a=0),converter.dataView.setUint16(0,t,!0);var r=new Uint8Array(converter.dataView.buffer);if(null==e)e=converter.getApplyFun(r).slice(0,2);else for(var i=0;i<2;i++)e[a+i]=r[i];return e},converter.Uint8ToArray=function(t,e,a){void 0===e&&(e=null),void 0===a&&(a=0),converter.dataView.setUint8(0,t);var r=new Uint8Array(converter.dataView.buffer);if(null==e)e=converter.getApplyFun(r).slice(0,1);else for(var i=0;i<1;i++)e[a+i]=r[i];return e},converter.StringToUtf8Array=function(t){for(var e=[],a=0;a<t.length;a++){var r=t.charAt(a).charCodeAt(0);if(r>65535)throw new Error("InvalidCharacterError");if(r>128)if(r<2047){var i=r>>>6|192,o=63&r|128;e.push(i,o)}else{var i=r>>>12|224,o=r>>>6&63|128,n=63&r|128;e.push(i,o,n)}else e.push(r)}return new Uint8Array(e)},converter.ArrayToLong=function(t,e){void 0===e&&(e=0);for(r=0;r<4;r++)converter.dataView.setInt8(r,t[e+r]);for(var a=converter.dataView.getInt32(0,!0),r=4;r<8;r++)converter.dataView.setInt8(r,t[e+r]);return a+=4294967296*converter.dataView.getInt32(4,!0)},converter.ArrayToULong=function(t,e){void 0===e&&(e=0);for(r=0;r<4;r++)converter.dataView.setUint8(r,t[e+r]);for(var a=converter.dataView.getUint32(0,!0),r=4;r<8;r++)converter.dataView.setUint8(r,t[e+r]);return a+=4294967296*converter.dataView.getUint32(4,!0)},converter.ArrayToFloat64=function(t,e){void 0===e&&(e=0);for(var a=0;a<8;a++)converter.dataView.setUint8(a,t[e+a]);return converter.dataView.getFloat64(0,!0)},converter.ArrayToFloat32=function(t,e){void 0===e&&(e=0);for(var a=0;a<4;a++)converter.dataView.setUint8(a,t[e+a]);return converter.dataView.getFloat32(0,!0)},converter.ArrayToInt32=function(t,e){void 0===e&&(e=0);for(var a=0;a<4;a++)converter.dataView.setUint8(a,t[e+a]);return converter.dataView.getInt32(0,!0)},converter.ArrayToInt16=function(t,e){void 0===e&&(e=0);for(var a=0;a<2;a++)converter.dataView.setUint8(a,t[e+a]);return converter.dataView.getInt16(0,!0)},converter.ArrayToInt8=function(t,e){void 0===e&&(e=0);for(var a=0;a<1;a++)converter.dataView.setUint8(a,t[e+a]);return converter.dataView.getInt8(0)},converter.ArraytoUint32=function(t,e){void 0===e&&(e=0);for(var a=0;a<4;a++)converter.dataView.setUint8(a,t[e+a]);return converter.dataView.getUint32(0,!0)},converter.ArrayToUint16=function(t,e){void 0===e&&(e=0);for(var a=0;a<2;a++)converter.dataView.setUint8(a,t[e+a]);return converter.dataView.getUint16(0,!0)},converter.ArrayToUint8=function(t,e){void 0===e&&(e=0);for(var a=0;a<1;a++)converter.dataView.setUint8(a,t[e+a]);return converter.dataView.getUint8(0)},converter.ArrayToString=function(t,e){void 0===e&&(e=0);for(var a=[],r=0;r<t.length;r++){var i=t[r];if(0==i)break;var o=0;if(i>224)o=(15&i)<<12,o|=(63&(i=t[++r]))<<6,o|=63&(i=t[++r]),a.push(String.fromCharCode(o));else if(i>192)o=(31&i)<<6,o|=(63&(i=t[++r]))<<6,a.push(String.fromCharCode(o));else{if(i>128)throw new Error("InvalidCharacterError");a.push(String.fromCharCode(t[r]))}}return a.join("")},converter}();a.dataView=new DataView(new ArrayBuffer(8),0,8),t.converter=a;var r=function(t){function binTool(){return null!==t&&t.apply(this,arguments)||this}return __extends(binTool,t),binTool.prototype.readSingle=function(){var t=new Uint8Array(4);return this.read(t),a.ArrayToFloat32(t)},binTool.prototype.readLong=function(){var t=new Uint8Array(8);return this.read(t),a.ArrayToLong(t)},binTool.prototype.readULong=function(){var t=new Uint8Array(8);return this.read(t),a.ArrayToULong(t)},binTool.prototype.readDouble=function(){var t=new Uint8Array(8);return this.read(t),a.ArrayToFloat64(t)},binTool.prototype.readInt8=function(){var t=new Uint8Array(1);return this.read(t),a.ArrayToInt8(t)},binTool.prototype.readUInt8=function(){var t=new Uint8Array(1);return this.read(t),a.ArrayToUint8(t)},binTool.prototype.readInt16=function(){var t=new Uint8Array(2);return this.read(t),a.ArrayToInt16(t)},binTool.prototype.readUInt16=function(){var t=new Uint8Array(2);return this.read(t),a.ArrayToUint16(t)},binTool.prototype.readInt32=function(){var t=new Uint8Array(4);return this.read(t),a.ArrayToInt32(t)},binTool.prototype.readUInt32=function(){var t=new Uint8Array(4);return this.read(t),a.ArraytoUint32(t)},binTool.prototype.readBoolean=function(){return this.readUInt8()>0},binTool.prototype.readByte=function(){return this.readUInt8()},binTool.prototype.readUnsignedShort=function(){return this.readUInt16()},binTool.prototype.readUnsignedInt=function(){return this.readUInt32()},binTool.prototype.readFloat=function(){return this.readSingle()},binTool.prototype.readSymbolByte=function(){return this.readInt8()},binTool.prototype.readShort=function(){return this.readInt16()},binTool.prototype.readInt=function(){return this.readInt32()},binTool.prototype.readBytes=function(t){var e=new Uint8Array(t);return this.read(e),e},binTool.prototype.readStringUtf8=function(){var t=this.readInt8(),e=new Uint8Array(t);return this.read(e),a.ArrayToString(e)},binTool.prototype.readStringUtf8FixLength=function(t){var e=new Uint8Array(t);return this.read(e),a.ArrayToString(e)},binTool.prototype.readUTFBytes=function(t){var e=new Uint8Array(t);return this.read(e),a.ArrayToString(e)},binTool.prototype.readStringAnsi=function(){for(var t=this.readUInt8(),e="",a=0;a<t;a++)e+=String.fromCharCode(this.readByte());return e},Object.defineProperty(binTool.prototype,"length",{get:function(){return this.getLength()},enumerable:!0,configurable:!0}),binTool.prototype.writeInt8=function(t){this.write(a.Int8ToArray(t))},binTool.prototype.writeUInt8=function(t){this.write(a.Uint8ToArray(t))},binTool.prototype.writeInt16=function(t){this.write(a.Int16ToArray(t))},binTool.prototype.writeUInt16=function(t){this.write(a.Uint16ToArray(t))},binTool.prototype.writeInt32=function(t){this.write(a.Int32ToArray(t))},binTool.prototype.writeUInt32=function(t){this.write(a.Uint32toArray(t))},binTool.prototype.writeSingle=function(t){this.write(a.Float32ToArray(t))},binTool.prototype.writeLong=function(t){this.write(a.LongToArray(t))},binTool.prototype.writeULong=function(t){this.write(a.ULongToArray(t))},binTool.prototype.writeDouble=function(t){this.write(a.Float64ToArray(t))},binTool.prototype.writeStringAnsi=function(t){var e=t.length;this.writeUInt8(e);for(var a=0;a<e;a++)this.writeUInt8(t.charCodeAt(a))},binTool.prototype.writeStringUtf8=function(t){var e=a.StringToUtf8Array(t);this.writeUInt8(e.length),this.write(e)},binTool.prototype.writeStringUtf8DataOnly=function(t){var e=a.StringToUtf8Array(t);this.write(e)},binTool.prototype.writeByte=function(t){this.write(a.Uint8ToArray(t))},binTool.prototype.writeBytes=function(t,e,a){void 0===e&&(e=0),void 0===a&&(a=-1),this.write(t,e,a)},binTool.prototype.writeUint8Array=function(t,e,a){void 0===e&&(e=0),void 0===a&&(a=-1),this.write(t,e,a)},binTool.prototype.writeUnsignedShort=function(t){this.write(a.Uint16ToArray(t))},binTool.prototype.writeUnsignedInt=function(t){this.write(a.Uint32toArray(t))},binTool.prototype.writeFloat=function(t){this.write(a.Float32ToArray(t))},binTool.prototype.writeUTFBytes=function(t){this.write(a.StringToUtf8Array(t))},binTool.prototype.writeSymbolByte=function(t){this.write(a.Int8ToArray(t))},binTool.prototype.writeShort=function(t){this.write(a.Int16ToArray(t))},binTool.prototype.writeInt=function(t){this.write(a.Int32ToArray(t))},binTool}(e);t.binTool=r}(t.io||(t.io={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){function fillCloneReference(e,a){var r,i=t.framework.HideFlags.None;if(e.__gdmeta__&&e.__gdmeta__.class&&(r=t.reflect.getClassName(e)),"transform"==r?i=e.gameObject.hideFlags:"transform2D"==r&&(i=e.hideFlags),i&t.framework.HideFlags.DontSaveInBuild||i&t.framework.HideFlags.DontSaveInEditor||i&t.framework.HideFlags.HideInHierarchy)return null;for(var o in e.__gdmeta__){var n=e.__gdmeta__[o];if(null!=n.custom&&(null!=n.custom.SerializeField||null!=n.custom.nodecomp||null!=n.custom["2dcomp"])){var s=n.custom.valueType;if(null!=s)switch(s.toLowerCase()){case"number":case"string":case"boolean":break;default:fillCloneReferenceTypeOrArray(e,a,o)}}}return a}function fillCloneReferenceTypeOrArray(t,e,a){if(t[a])if(t[a].__gdmeta__)fillCloneReferenceType(t,e,a);else if(t.__gdmeta__[a]&&t.__gdmeta__[a].custom&&t.__gdmeta__[a].custom.valueType)for(var r in t[a]){var i=t[a][r];if(i&&i.__gdmeta__){var o=i.__gdmeta__;o.class&&"UniformData"==o.class.typename&&3==i.type||fillCloneReferenceType(t[a],e[a],r,t,e,a)}}}function fillCloneReferenceType(t,a,r,i,o,n){void 0===i&&(i=null),void 0===o&&(o=null),void 0===n&&(n="");var s=t[r].__gdmeta__;if(s.class&&s.class.custom&&(s.class.custom.SerializeType||s.class.custom.nodecomp||s.class.custom["2dcomp"])){var l=t instanceof Array,h=s.class.typename;if(e.isAsset(h));else{var c=!1,u=-1,d=void 0;(l&&i.__gdmeta__&&i.__gdmeta__.class&&i.__gdmeta__.class.custom&&(i.__gdmeta__.class.custom.nodecomp||i.__gdmeta__.class.custom["2dcomp"])||!l&&t.__gdmeta__&&t.__gdmeta__.class&&t.__gdmeta__.class.custom&&(t.__gdmeta__.class.custom.nodecomp||t.__gdmeta__.class.custom["2dcomp"]))&&(s.class.custom.nodecomp?(u=t[r].gameObject.transform.insId.getInsID(),c=!0,d=e.referenceInfo.oldmap[u].gameObject.getComponent(h)):s.class.custom["2dcomp"]?(u=t[r].transform.insId.getInsID(),c=!0,d=e.referenceInfo.oldmap[u].getComponent(h)):"transform"!=h&&"transform2D"!=h||(u=t[r].insId.getInsID(),c=!0,d=e.referenceInfo.oldmap[u])),c?l?a.push(d):a[r]=d:fillCloneReference(t[r],a[r])}}}function _cloneObj(a,r){void 0===r&&(r=void 0);var i,o=t.framework.HideFlags.None;if(a.__gdmeta__&&a.__gdmeta__.class&&(i=t.reflect.getClassName(a)),"transform"==i?o=a.gameObject.hideFlags:"transform2D"==i&&(o=a.hideFlags),o&t.framework.HideFlags.DontSaveInBuild||o&t.framework.HideFlags.DontSaveInEditor||o&t.framework.HideFlags.HideInHierarchy)return null;if(void 0==r){var n=-1;r=t.reflect.createInstance(a,null),a.__gdmeta__.class.custom.nodecomp?n=a.gameObject.transform.insId.getInsID():a.__gdmeta__.class.custom["2dcomp"]?n=a.transform.insId.getInsID():"transform"!=a.__gdmeta__.class.typename&&"transform2D"!=a.__gdmeta__.class.typename||(n=a.insId.getInsID(),e.referenceInfo.oldmap[n]=r)}for(var s in a.__gdmeta__){var l=a.__gdmeta__[s];if(null!=l.custom&&(null!=l.custom.SerializeField||null!=l.custom.nodecomp||null!=l.custom["2dcomp"])){var h=l.custom.valueType;if(null!=h)switch(h.toLowerCase()){case"number":case"string":case"boolean":r[s]=a[s];break;default:cloneOtherTypeOrArray(a,r,s)}}}return r}function cloneOtherTypeOrArray(t,e,a){if(t[a])if(t[a].__gdmeta__)cloneOtherType(t,e,a);else if(t.__gdmeta__[a]&&t.__gdmeta__[a].custom&&t.__gdmeta__[a].custom.valueType){var r=t[a]instanceof Array;e[a]=r?[]:{};for(var i in t[a]){var o=t[a][i];if(o&&o.__gdmeta__){var n=o.__gdmeta__;n.class&&"UniformData"==n.class.typename&&3==o.type||cloneOtherType(t[a],e[a],i,t,e,a)}else if(!t[a].__gdmeta__)switch((typeof o).toLowerCase()){case"number":case"string":case"boolean":r?e[a].push(o):e[a][i]=o}}}}function cloneOtherType(a,r,i,o,n,s){void 0===o&&(o=null),void 0===n&&(n=null),void 0===s&&(s="");var l=a[i].__gdmeta__;if(l.class&&l.class.custom&&(l.class.custom.SerializeType||l.class.custom.nodecomp||l.class.custom["2dcomp"])){var h=a instanceof Array,c=l.class.typename;if(e.isAsset(c)){a[i].defaultAsset;h?r.push(a[i]):r[i]=a[i]}else{var u=!1;if((h&&o.__gdmeta__&&o.__gdmeta__.class&&o.__gdmeta__.class.custom&&(o.__gdmeta__.class.custom.nodecomp||o.__gdmeta__.class.custom["2dcomp"])||!h&&a.__gdmeta__&&a.__gdmeta__.class&&a.__gdmeta__.class.custom&&(a.__gdmeta__.class.custom.nodecomp||a.__gdmeta__.class.custom["2dcomp"]))&&(l.class.custom.nodecomp||l.class.custom["2dcomp"]||"transform"==c||"transform2D"==c)&&(u=!0),u);else{var d=void 0;null!=(d=l.class.custom.selfclone?a[i].clone():_cloneObj(a[i],r[i]))&&(h?"nodeComponent"==c&&"components"==s&&"gameObject"==t.reflect.getClassName(o)?n.addComponentDirect(d.comp):"transform"==c&&"children"==s&&"transform"==t.reflect.getClassName(o)?n.addChild(d):"C2DComponent"==c&&"components"==s&&"transform2D"==t.reflect.getClassName(o)?n.addComponentDirect(d.comp):"transform2D"==c&&"children"==s&&"transform2D"==t.reflect.getClassName(o)?n.addChild(d):r.push(d):r[i]=d)}}}}e.cloneObj=function cloneObj(t,a){return void 0===a&&(a=void 0),e.referenceInfo.oldmap={},a=_cloneObj(t,a),e.referenceInfo.oldmap[t.insId.getInsID()]=a,fillCloneReference(t,a),a},e.fillCloneReference=fillCloneReference,e.fillCloneReferenceTypeOrArray=fillCloneReferenceTypeOrArray,e.fillCloneReferenceType=fillCloneReferenceType,e._cloneObj=_cloneObj,e.cloneOtherTypeOrArray=cloneOtherTypeOrArray,e.cloneOtherType=cloneOtherType}(t.io||(t.io={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(t){function stringToUtf8Array(t){for(var e=[],a=0;a<t.length;a++){var r=t.charAt(a).charCodeAt(0);if(r>65535)throw new Error("InvalidCharacterError");if(r>128)if(r<2047){var i=r>>>6|192,o=63&r|128;e.push(i,o)}else{var i=r>>>12|224,o=r>>>6&63|128,n=63&r|128;e.push(i,o,n)}else e.push(r)}return e}t.stringToBlob=function stringToBlob(t){var e=new Uint8Array(stringToUtf8Array(t));return new Blob([e])},t.stringToUtf8Array=stringToUtf8Array}(t.io||(t.io={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){function serializeObjForInspector(e,a,r){void 0===r&&(r=void 0);var o,n=t.framework.HideFlags.None;if(e.__gdmeta__&&e.__gdmeta__.class&&(o=t.reflect.getClassName(e)),"transform"==o?n=e.gameObject.hideFlags:"transform2D"==o&&(n=e.hideFlags),n&t.framework.HideFlags.HideInInspector)return null;void 0==r&&(r={});for(var s in e.__gdmeta__)if("children"!=s){var l=e.__gdmeta__[s];if(null!=l.custom&&(null!=l.custom.SerializeField||null!=l.custom.nodecomp||null!=l.custom["2dcomp"])){var h=l.custom.valueType;if(null!=h)switch(h.toLowerCase()){case"number":case"string":case"boolean":var c=new i(e[s],h);l.custom.FieldUIStyle&&(c.UIStyle=l.custom.FieldUIStyle),l.custom.defvalue&&(c.defvalue=l.custom.defvalue),l.custom.min&&(c.min=l.custom.min),l.custom.max&&(c.max=l.custom.max),r[s]=c;break;default:serializeOtherTypeOrArrayForInspector(e,r,s,a)}}}return r}function serializeOtherTypeOrArrayForInspector(t,e,a,r){if(t[a]){if(t[a].__gdmeta__)serializeOtherTypeForInspector(t,e,a,r);else if(t.__gdmeta__[a]&&t.__gdmeta__[a].custom&&t.__gdmeta__[a].custom.valueType){var o=t[a]instanceof Array;e[a]=o?new i([],t.__gdmeta__[a].custom.valueType):new i({},t.__gdmeta__[a].custom.valueType);for(var n in t[a])if(t[a][n].__gdmeta__){var s=t[a][n].__gdmeta__;s.class&&"UniformData"==s.class.typename&&3==t[a][n].type||serializeOtherTypeForInspector(t[a],e[a].value,n,r,t)}else if(!t[a].__gdmeta__){var l=typeof t[a][n];switch(l.toLowerCase()){case"number":case"string":case"boolean":var h=new i(t[a][n],l);o?e[a].value.push(h):e[a].value[n]=h}}}}else{var c=t instanceof Array;if(t.__gdmeta__[a]&&t.__gdmeta__&&t.__gdmeta__[a]&&t.__gdmeta__[a].custom){var u=t.__gdmeta__[a].custom,d=new i(null,u.valueType);u.FieldUIStyle&&(d.UIStyle=u.FieldUIStyle),u.defvalue&&(d.defvalue=u),u.min&&(d.min=u.min),u.max&&(d.max=u.max),c?e.push(d):e[a]=d}}}function serializeOtherTypeForInspector(t,e,a,r,n){void 0===n&&(n=null);var s=t[a].__gdmeta__;if(s.class&&s.class.custom&&(s.class.custom.SerializeType||s.class.custom.nodecomp||s.class.custom["2dcomp"])){var l=t instanceof Array,h=s.class.typename;if(isAssetInspector(h)){var c=t[a].defaultAsset,u=t[a].getName();if(null!=u){c&&(u="SystemDefaultAsset-"+u);f=new i(u,h);l?e.push(f):e[a]=f}}else{var d=!1,m=-1;if(l&&n.__gdmeta__&&n.__gdmeta__.class&&n.__gdmeta__.class.custom&&(n.__gdmeta__.class.custom.nodecomp||n.__gdmeta__.class.custom["2dcomp"])||!l&&t.__gdmeta__&&t.__gdmeta__.class&&t.__gdmeta__.class.custom&&(t.__gdmeta__.class.custom.nodecomp||t.__gdmeta__.class.custom["2dcomp"]))if(r=!0,s.class.custom.nodecomp)m=t[a].gameObject.transform.insId.getInsID(),d=!0;else if(s.class.custom["2dcomp"])m=t[a].transform.insId.getInsID(),d=!0;else if("transform"==h||"transform2D"==h)m=t[a].insId.getInsID(),d=!0;else if(!o.isRegType(h))return;if(d){f=new i(m,h,"reference");if(t.__gdmeta__&&t.__gdmeta__[a]&&t.__gdmeta__[a].custom&&t.__gdmeta__[a].custom.FieldUIStyle){v=t.__gdmeta__[a].custom;f.UIStyle=t.__gdmeta__[a].custom.FieldUIStyle,v.defvalue&&(f.defvalue=v),v.min&&(f.min=v.min),v.max&&(f.max=v.max)}l?e.push(f):e[a]=f}else{if(!o.isRegType(h)&&r)return;var p=serializeObjForInspector(t[a],r,e[a]);if(null!=p){var f=new i(p,h);if(t.__gdmeta__&&t.__gdmeta__[a]&&t.__gdmeta__[a].custom&&t.__gdmeta__[a].custom.FieldUIStyle){var v=t.__gdmeta__[a].custom;f.UIStyle=v.FieldUIStyle,v.defvalue&&(f.defvalue=v),v.min&&(f.min=v.min),v.max&&(f.max=v.max)}l?e.push(f):e[a]=f}}}}}function serializeObj(e,a,i){void 0===a&&(a=void 0),void 0===i&&(i=null);var o,n=t.framework.HideFlags.None;if(e.__gdmeta__&&e.__gdmeta__.class&&(o=t.reflect.getClassName(e)),"transform"==o?n=e.gameObject.hideFlags:"transform2D"==o&&(n=e.hideFlags),n&t.framework.HideFlags.DontSaveInBuild||n&t.framework.HideFlags.DontSaveInEditor||n&t.framework.HideFlags.HideInHierarchy)return null;void 0==a&&(a=new r({},o),void 0!=e.insId&&(a.insid=e.insId.getInsID()));for(var s in e.__gdmeta__){var l=e.__gdmeta__[s];if(null!=l.custom&&(null!=l.custom.SerializeField||null!=l.custom.nodecomp||null!=l.custom["2dcomp"])){var h=l.custom.valueType;if(null!=h)switch(h.toLowerCase()){case"number":case"string":case"boolean":var c=new r(e[s],h);a.value[s]=c;break;default:serializeOtherTypeOrArray(e,a.value,s,i)}}}return a}function serializeOtherTypeOrArray(t,e,a,i){if(void 0===i&&(i=null),t[a])if(t[a].__gdmeta__)serializeOtherType(t,e,a,null,i);else if(t.__gdmeta__[a]&&t.__gdmeta__[a].custom&&t.__gdmeta__[a].custom.valueType){var o=t[a]instanceof Array;e[a]=o?new r([],t.__gdmeta__[a].custom.valueType):new r({},t.__gdmeta__[a].custom.valueType);for(var n in t[a])if(t[a][n].__gdmeta__){var s=t[a][n].__gdmeta__;s.class&&"UniformData"==s.class.typename&&3==t[a][n].type||serializeOtherType(t[a],e[a].value,n,t,i)}else if(!t[a].__gdmeta__){var l=typeof t[a][n];switch(l.toLowerCase()){case"number":case"string":case"boolean":var h=new r(t[a][n],l);o?e[a].value.push(h):e[a].value[n]=h}}}}function serializeOtherType(t,e,i,o,n){void 0===o&&(o=null),void 0===n&&(n=null);var s=t[i].__gdmeta__;if(s.class&&s.class.custom&&(s.class.custom.SerializeType||s.class.custom.nodecomp||s.class.custom["2dcomp"])){var l=t instanceof Array,h=s.class.typename;if(isAsset(h)){var c=t[i].defaultAsset,u=t[i].getName();null!=u&&(c?u="SystemDefaultAsset-"+u:n&&a.GetAssetUrl(t[i],n),l?e.push(new r(u,h)):e[i]=new r(u,h))}else{var d=!1,m=-1;if((l&&o.__gdmeta__&&o.__gdmeta__.class&&o.__gdmeta__.class.custom&&(o.__gdmeta__.class.custom.nodecomp||o.__gdmeta__.class.custom["2dcomp"])||!l&&t.__gdmeta__&&t.__gdmeta__.class&&t.__gdmeta__.class.custom&&(t.__gdmeta__.class.custom.nodecomp||t.__gdmeta__.class.custom["2dcomp"]))&&(s.class.custom.nodecomp?(m=t[i].gameObject.transform.insId.getInsID(),d=!0):s.class.custom["2dcomp"]?(m=t[i].transform.insId.getInsID(),d=!0):"transform"!=h&&"transform2D"!=h||(m=t[i].insId.getInsID(),d=!0)),d)l?e.push(new r(m,h,"reference")):e[i]=new r(m,h,"reference");else{var p=serializeObj(t[i],e[i],n);null!=p&&(l?e.push(p):e[i]=p)}}}}function fillReference(t,e){for(var a in e.__gdmeta__){var r=e.__gdmeta__[a];if(null!=r.custom&&(null!=r.custom.SerializeField||null!=r.custom.nodecomp||null!=r.custom["2dcomp"])){var i=r.custom.valueType;if(null!=i)switch(i.toLowerCase()){case"number":case"string":case"boolean":break;default:dofillReferenceOrArray(t,e,a)}}}}function dofillReferenceOrArray(t,e,a){if(t[a])if(isArrayOrDic(t[a].type.toLowerCase())){var r=t[a].value instanceof Array;e[a]||(e[a]=r?[]:{});var i=null;if(e.__gdmeta__[a].custom.valueType!=t[a].type)throw new Error("反序列化失败，类型不匹配："+e.__gdmeta__[a].custom.valueType+" as "+t[a].type);i=t[a].value;for(var o in i)switch(i[o].type.toLowerCase()){case"number":case"string":case"boolean":break;default:dofillReference(t[a].value,e[a],o)}}else dofillReference(t,e,a)}function dofillReference(e,a,r){var i=a instanceof Array,n=e[r].type;if(isAsset(n));else if("reference"==e[r].parse){var s=o.oldmap[e[r].value];"transform"==n||"transform2D"==n||(s instanceof t.framework.transform2D?s=s.getComponent(n):s instanceof t.framework.transform&&(s=s.gameObject.getComponent(n))),i?a.push(s):a[r]=s}else fillReference(e[r].value,a[r])}function deSerializeObj(t,e,a,r){if(void 0===r&&(r=null),void 0==e)throw new Error("必须传入一个实例，用来赋值");for(var i in e.__gdmeta__){var o=e.__gdmeta__[i];if(null!=o.custom&&(null!=o.custom.SerializeField||null!=o.custom.nodecomp||null!=o.custom["2dcomp"])){var n=o.custom.valueType;if(null!=n)switch(n.toLowerCase()){case"number":case"string":case"boolean":if(void 0==t[i]||n!=t[i].type)continue;e[i]=t[i].value;break;default:deSerializeOtherTypeOrArray(t,e,i,a,r)}}}}function deSerializeOtherTypeOrArray(e,a,r,i,o){if(void 0===o&&(o=null),e[r])if(isArrayOrDic(e[r].type.toLowerCase())){var n=e[r].value instanceof Array;a[r]||(a[r]=n?[]:{});var s=null;if(a.__gdmeta__[r].custom.valueType!=e[r].type)throw new Error("反序列化失败，类型不匹配："+a.__gdmeta__[r].custom.valueType+" as "+e[r].type);s=e[r].value;for(var l in s){var h=s[l].type;switch(h.toLowerCase()){case"number":case"string":case"boolean":if(h!=e[r][l].type)throw new Error("反序列化失败，类型不匹配："+h+" as "+e[r].type);n?a[r].push(e[r][l].value):a[r][l]=e[r][l].value;break;default:if("nodeComponent"==h&&"components"==r&&"gameObject"==t.reflect.getClassName(a)){u=[];deSerializeOtherType(e[r].value,u,l,i,o),a.addComponentDirect(u[0].comp)}else if("transform"==h&&"children"==r&&"transform"==t.reflect.getClassName(a)){var c=[];deSerializeOtherType(e[r].value,c,l,i,o),a.addChild(c[0])}else if("C2DComponent"==h&&"components"==r&&"transform2D"==t.reflect.getClassName(a)){var u=[];deSerializeOtherType(e[r].value,u,l,i,o),a.addComponentDirect(u[0].comp)}else if("transform2D"==h&&"children"==r&&"transform2D"==t.reflect.getClassName(a)){var d=[];deSerializeOtherType(e[r].value,d,l,i,o),a.addChild(d[0])}else deSerializeOtherType(e[r].value,a[r],l,i,o)}}}else deSerializeOtherType(e,a,r,i,o)}function deSerializeOtherType(e,a,r,i,n){void 0===n&&(n=null);var s=a instanceof Array,l=e[r].type;if(isAsset(l)){var h=e[r].value,c=void 0;h.indexOf("SystemDefaultAsset-")>=0?(h=h.replace("SystemDefaultAsset-",""),"mesh"==l?c=i.getDefaultMesh(h):"texture"==l&&(c=i.getDefaultTexture(h))):c=i.getAssetByName(h,n),a instanceof Array?a.push(c):a[r]=c}else if("reference"==e[r].parse);else{var u=void 0;"gameObject"==l&&"gameObject"==r&&"transform"==t.reflect.getClassName(a)?u=a.gameObject:"transform2D"==l&&"rootNode"==r&&"canvas"==t.reflect.getClassName(a)?(u=t.reflect.createInstance(document.__gdmeta__[l],null),a.rootNode=u,u.canvas=a):(u=t.reflect.createInstance(document.__gdmeta__[l],null),s?a.push(u):a[r]=u),deSerializeObj(e[r].value,u,i,n),o.oldmap[e[r].insid]=u}}function isArrayOrDic(t){return t.indexOf("[]")>0||t.indexOf("array")>=0||t.indexOf("dic")>=0}function isAsset(t){return"mesh"==t||"texture"==t||"shader"==t||"material"==t||"animationClip"==t||"atlas"==t||"font"==t||"prefab"==t||"sprite"==t||"textasset"==t}function isAssetInspector(t){if("prefab"==t)return!0}var a=function(){function SerializeDependent(){}return SerializeDependent.GetAssetUrl=function(e,a){if(a&&e){var r=a.getAssetUrl(e);if(r&&(SerializeDependent.resoursePaths.push(r),e instanceof t.framework.material)){var i=e.mapUniform;if(!i)return;for(var o in i)if(i[o]&&i[o].type==t.render.UniformTypeEnum.Texture){var n=i[o].value;n&&(r=a.getAssetUrl(n))&&(SerializeDependent.resoursePaths.push(r),r.indexOf(".imgdesc.json")<0||n.realName&&(r=r.replace(n.getName(),n.realName),SerializeDependent.resoursePaths.push(r)))}}}},SerializeDependent}();a.resoursePaths=[],e.SerializeDependent=a,e.SerializeForInspector=function SerializeForInspector(t){return JSON.stringify(serializeObjForInspector(t,!1))},e.serializeObjForInspector=serializeObjForInspector,e.serializeOtherTypeOrArrayForInspector=serializeOtherTypeOrArrayForInspector,e.serializeOtherTypeForInspector=serializeOtherTypeForInspector,e.Serialize=function Serialize(t,e){return void 0===e&&(e=null),JSON.stringify(serializeObj(t,null,e))},e.serializeObj=serializeObj,e.serializeOtherTypeOrArray=serializeOtherTypeOrArray,e.serializeOtherType=serializeOtherType,e.deSerialize=function deSerialize(t,e,a,r){void 0===r&&(r=null),o.oldmap={},deSerializeObj(t.value,e,a,r),o.oldmap[t.insid]=e,fillReference(t.value,e)},e.fillReference=fillReference,e.dofillReferenceOrArray=dofillReferenceOrArray,e.dofillReference=dofillReference,e.deSerializeObj=deSerializeObj,e.deSerializeOtherTypeOrArray=deSerializeOtherTypeOrArray,e.deSerializeOtherType=deSerializeOtherType,e.isArray=function isArray(t){return t.indexOf("[]")>0||t.indexOf("array")>=0},e.isArrayOrDic=isArrayOrDic,e.isAsset=isAsset,e.isAssetInspector=isAssetInspector;var r=function(){return function valueInfo(t,e,a){void 0===a&&(a="direct"),this.value=t,this.type=e,isAsset(e)&&(a="nameonly"),this.parse=a}}(),i=function(){return function inspectorValueInfo(t,e,a){void 0===a&&(a="direct"),this.value=t,this.type=e,isAssetInspector(e)&&(a="nameonly"),this.parse=a}}(),o=function(){function referenceInfo(){}return referenceInfo.regDefaultType=function(){referenceInfo.regType("vector3"),referenceInfo.regType("vector4"),referenceInfo.regType("color"),referenceInfo.regType("quaternion"),referenceInfo.regType("material"),referenceInfo.regType("gameObject"),referenceInfo.regType("transform2D"),referenceInfo.regType("shader"),referenceInfo.regType("atlas"),referenceInfo.regType("font"),referenceInfo.regType("sprite"),referenceInfo.regType("texture"),referenceInfo.regType("mesh"),referenceInfo.regType("animationclip"),referenceInfo.regType("constText"),referenceInfo.regType("UniformData")},referenceInfo.regType=function(t){referenceInfo.regtypelist.push(t)},referenceInfo.isRegType=function(t){return this.regtypelist.indexOf(t)>=0},referenceInfo}();o.oldmap={},o.regtypelist=[],e.referenceInfo=o;var n=function(){return function enumMgr(){}}();n.enumMap={},e.enumMgr=n}(t.io||(t.io={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(t){var e=function(){function binReader(t,e){void 0===e&&(e=0),this._seek=e,this._data=new DataView(t,e)}return binReader.prototype.seek=function(t){this._seek=t},binReader.prototype.peek=function(){return this._seek},binReader.prototype.length=function(){return this._data.byteLength},binReader.prototype.canread=function(){return this._data.byteLength-this._seek},binReader.prototype.readStringAnsi=function(){var t=this._data.getUint8(this._seek);this._seek++;for(var e="",a=0;a<t;a++)e+=String.fromCharCode(this._data.getUint8(this._seek)),this._seek++;return e},binReader.utf8ArrayToString=function(t){for(var e=[],a=0;a<t.length;a++){var r=t[a];if(0==r)break;var i=0;if(r>224)i=(15&r)<<12,i|=(63&(r=t[++a]))<<6,i|=63&(r=t[++a]),e.push(String.fromCharCode(i));else if(r>192)i=(31&r)<<6,i|=(63&(r=t[++a]))<<6,e.push(String.fromCharCode(i));else{if(r>128)throw new Error("InvalidCharacterError");e.push(String.fromCharCode(t[a]))}}return e.join("")},binReader.prototype.readStringUtf8=function(){var t=this._data.getInt8(this._seek);this._seek++;var e=new Uint8Array(t);return this.readUint8Array(e),binReader.utf8ArrayToString(e)},binReader.prototype.readStringUtf8FixLength=function(t){var e=new Uint8Array(t);return this.readUint8Array(e),binReader.utf8ArrayToString(e)},binReader.prototype.readSingle=function(){var t=this._data.getFloat32(this._seek,!0);return this._seek+=4,t},binReader.prototype.readDouble=function(){var t=this._data.getFloat64(this._seek,!0);return this._seek+=8,t},binReader.prototype.readInt8=function(){var t=this._data.getInt8(this._seek);return this._seek+=1,t},binReader.prototype.readUInt8=function(){var t=this._data.getUint8(this._seek);return this._seek+=1,t},binReader.prototype.readInt16=function(){var t=this._data.getInt16(this._seek,!0);return this._seek+=2,t},binReader.prototype.readUInt16=function(){var t=this._data.getUint16(this._seek,!0);return this._seek+=2,t},binReader.prototype.readInt32=function(){var t=this._data.getInt32(this._seek,!0);return this._seek+=4,t},binReader.prototype.readUInt32=function(){var t=this._data.getUint32(this._seek,!0);return this._seek+=4,t},binReader.prototype.readUint8Array=function(t,e,a){void 0===t&&(t=null),void 0===e&&(e=0),void 0===a&&(a=-1),a<0&&(a=t.length);for(var r=0;r<a;r++)t[r]=this._data.getUint8(this._seek),this._seek++;return t},binReader.prototype.readUint8ArrayByOffset=function(t,e,a){void 0===a&&(a=0),a<0&&(a=t.length);for(var r=0;r<a;r++)t[r]=this._data.getUint8(e),e++;return t},Object.defineProperty(binReader.prototype,"position",{get:function(){return this.peek()},set:function(t){this.seek(t)},enumerable:!0,configurable:!0}),binReader.prototype.readBoolean=function(){return this.readUInt8()>0},binReader.prototype.readByte=function(){return this.readUInt8()},binReader.prototype.readBytes=function(t,e,a){return void 0===t&&(t=null),void 0===e&&(e=0),void 0===a&&(a=-1),this.readUint8Array(t,e,a)},binReader.prototype.readUnsignedShort=function(){return this.readUInt16()},binReader.prototype.readUnsignedInt=function(){return this.readUInt32()},binReader.prototype.readFloat=function(){return this.readSingle()},binReader.prototype.readUTFBytes=function(t){var e=new Uint8Array(t);return binReader.utf8ArrayToString(this.readUint8Array(e))},binReader.prototype.readSymbolByte=function(){return this.readInt8()},binReader.prototype.readShort=function(){return this.readInt16()},binReader.prototype.readInt=function(){return this.readInt32()},binReader}();t.binReader=e;var a=function(){function binWriter(){var t=new ArrayBuffer(1024);this._length=0,this._buf=new Uint8Array(t),this._data=new DataView(this._buf.buffer),this._seek=0}return binWriter.prototype.sureData=function(t){for(var e=this._buf.byteLength;e<this._length+t;)e+=1024;if(e!=this._buf.byteLength){for(var a=new Uint8Array(e),r=0;r<this._length;r++)a[r]=this._buf[r];this._buf=a,this._data=new DataView(this._buf.buffer)}this._length+=t},binWriter.prototype.getLength=function(){return length},binWriter.prototype.getBuffer=function(){return this._buf.buffer.slice(0,this._length)},binWriter.prototype.seek=function(t){this._seek=t},binWriter.prototype.peek=function(){return this._seek},binWriter.prototype.writeInt8=function(t){this.sureData(1),this._data.setInt8(this._seek,t),this._seek++},binWriter.prototype.writeUInt8=function(t){this.sureData(1),this._data.setUint8(this._seek,t),this._seek++},binWriter.prototype.writeInt16=function(t){this.sureData(2),this._data.setInt16(this._seek,t,!0),this._seek+=2},binWriter.prototype.writeUInt16=function(t){this.sureData(2),this._data.setUint16(this._seek,t,!0),this._seek+=2},binWriter.prototype.writeInt32=function(t){this.sureData(4),this._data.setInt32(this._seek,t,!0),this._seek+=4},binWriter.prototype.writeUInt32=function(t){this.sureData(4),this._data.setUint32(this._seek,t,!0),this._seek+=4},binWriter.prototype.writeSingle=function(t){this.sureData(4),this._data.setFloat32(this._seek,t,!0),this._seek+=4},binWriter.prototype.writeDouble=function(t){this.sureData(8),this._data.setFloat64(this._seek,t,!0),this._seek+=8},binWriter.prototype.writeStringAnsi=function(t){var e=t.length;this.sureData(e+1),this._data.setUint8(this._seek,e),this._seek++;for(var a=0;a<e;a++)this._data.setUint8(this._seek,t.charCodeAt(a)),this._seek++},binWriter.prototype.writeStringUtf8=function(t){var e=binWriter.stringToUtf8Array(t);this.writeUInt8(e.length),this.writeUint8Array(e)},binWriter.stringToUtf8Array=function(t){for(var e=[],a=0;a<t.length;a++){var r=t.charAt(a).charCodeAt(0);if(r>65535)throw new Error("InvalidCharacterError");if(r>128)if(r<2047){var i=r>>>6|192,o=63&r|128;e.push(i,o)}else{var i=r>>>12|224,o=r>>>6&63|128,n=63&r|128;e.push(i,o,n)}else e.push(r)}return e},binWriter.prototype.writeStringUtf8DataOnly=function(t){var e=binWriter.stringToUtf8Array(t);this.writeUint8Array(e)},binWriter.prototype.writeUint8Array=function(t,e,a){void 0===e&&(e=0),void 0===a&&(a=-1),a<0&&(a=t.length),this.sureData(a);for(var r=e;r<e+a;r++)this._data.setUint8(this._seek,t[r]),this._seek++},Object.defineProperty(binWriter.prototype,"length",{get:function(){return this._seek},enumerable:!0,configurable:!0}),binWriter.prototype.writeByte=function(t){this.writeUInt8(t)},binWriter.prototype.writeBytes=function(t,e,a){void 0===e&&(e=0),void 0===a&&(a=0),this.writeUint8Array(t,e,a)},binWriter.prototype.writeUnsignedShort=function(t){this.writeUInt16(t)},binWriter.prototype.writeUnsignedInt=function(t){this.writeUInt32(t)},binWriter.prototype.writeFloat=function(t){this.writeSingle(t)},binWriter.prototype.writeUTFBytes=function(t){var e=binWriter.stringToUtf8Array(t);this.writeUint8Array(e)},binWriter.prototype.writeSymbolByte=function(t){this.writeInt8(t)},binWriter.prototype.writeShort=function(t){this.writeInt16(t)},binWriter.prototype.writeInt=function(t){this.writeInt32(t)},binWriter}();t.binWriter=a}(t.io||(t.io={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(t){t.colorSet_White=function colorSet_White(t){t.r=1,t.g=1,t.b=1,t.a=1},t.colorSet_Black=function colorSet_Black(t){t.r=0,t.g=0,t.b=0,t.a=1},t.colorSet_Gray=function colorSet_Gray(t){t.r=.5,t.g=.5,t.b=.5,t.a=1},t.colorMultiply=function colorMultiply(t,e,a){a.r=t.r*e.r,a.g=t.g*e.g,a.b=t.b*e.b,a.a=t.a*e.a},t.scaleToRef=function scaleToRef(t,e,a){a.r=t.r*e,a.g=t.g*e,a.b=t.b*e,a.a=t.a*e},t.colorClone=function colorClone(t,e){e.a=t.a,e.r=t.r,e.g=t.g,e.b=t.b},t.colorLerp=function colorLerp(t,e,a,r){r.a=a*(e.a-t.a)+t.a,r.r=a*(e.r-t.r)+t.r,r.g=a*(e.g-t.g)+t.g,r.b=a*(e.b-t.b)+t.b,r.a=Math.floor(r.a),r.r=Math.floor(r.r),r.g=Math.floor(r.g),r.b=Math.floor(r.b)}}(t.math||(t.math={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(t){function Multiply(t,e,a){return(t.x-a.x)*(e.y-a.y)-(e.x-a.x)*(t.y-a.y)}t.calPlaneLineIntersectPoint=function calPlaneLineIntersectPoint(t,e,a,r,i){var o=t.x,n=t.y,s=t.z,l=e.x,h=e.y,c=e.z,u=a.x,d=a.y,m=a.z,p=r.x,f=r.y,v=r.z,g=u*o+d*n+m*s;if(0===g)i=null;else{var y=((l-p)*o+(h-f)*n+(c-v)*s)/g;i.x=p+u*y,i.y=f+d*y,i.z=v+m*y}},t.isContain=function isContain(t,e,a,r,i){return Multiply(i,t,e)*Multiply(i,r,a)<=0&&Multiply(i,r,t)*Multiply(i,a,e)<=0},t.Multiply=Multiply}(t.math||(t.math={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){function matrix2Quaternion(t,e){var a,r=t.rawData,i=r[0],o=r[4],n=r[8],s=r[1],l=r[5],h=r[9],c=r[2],u=r[6],d=r[10],m=i+l+d;m>0?(a=.5/Math.sqrt(m+1),e.w=.25/a,e.x=(u-h)*a,e.y=(n-c)*a,e.z=(s-o)*a):i>l&&i>d?(a=2*Math.sqrt(1+i-l-d),e.w=(u-h)/a,e.x=.25*a,e.y=(o+s)/a,e.z=(n+c)/a):l>d?(a=2*Math.sqrt(1+l-i-d),e.w=(n-c)/a,e.x=(o+s)/a,e.y=.25*a,e.z=(h+u)/a):(a=2*Math.sqrt(1+d-i-l),e.w=(s-o)/a,e.x=(n+c)/a,e.y=(h+u)/a,e.z=.25*a)}function matrixMakeScale(t,e,a,r){r.rawData[0]=t,r.rawData[1]=0,r.rawData[2]=0,r.rawData[3]=0,r.rawData[4]=0,r.rawData[5]=e,r.rawData[6]=0,r.rawData[7]=0,r.rawData[8]=0,r.rawData[9]=0,r.rawData[10]=a,r.rawData[11]=0,r.rawData[12]=0,r.rawData[13]=0,r.rawData[14]=0,r.rawData[15]=1}function matrix3x2MakeScale(t,e,a){a.rawData[0]=t,a.rawData[1]=0,a.rawData[2]=0,a.rawData[3]=e,a.rawData[4]=0,a.rawData[5]=0}function matrix3x2MakeRotate(t,e){var a=Math.sin(t),r=Math.cos(t);e.rawData[0]=r,e.rawData[1]=a,e.rawData[2]=-a,e.rawData[3]=r,e.rawData[4]=0,e.rawData[5]=0}function matrixMultiply(t,e,a){var r=t.rawData[0],i=t.rawData[1],o=t.rawData[2],n=t.rawData[3],s=t.rawData[4],l=t.rawData[5],h=t.rawData[6],c=t.rawData[7],u=t.rawData[8],d=t.rawData[9],m=t.rawData[10],p=t.rawData[11],f=t.rawData[12],v=t.rawData[13],g=t.rawData[14],y=t.rawData[15],_=e.rawData[0],w=e.rawData[1],b=e.rawData[2],x=e.rawData[3];a.rawData[0]=_*r+w*s+b*u+x*f,a.rawData[1]=_*i+w*l+b*d+x*v,a.rawData[2]=_*o+w*h+b*m+x*g,a.rawData[3]=_*n+w*c+b*p+x*y,_=e.rawData[4],w=e.rawData[5],b=e.rawData[6],x=e.rawData[7],a.rawData[4]=_*r+w*s+b*u+x*f,a.rawData[5]=_*i+w*l+b*d+x*v,a.rawData[6]=_*o+w*h+b*m+x*g,a.rawData[7]=_*n+w*c+b*p+x*y,_=e.rawData[8],w=e.rawData[9],b=e.rawData[10],x=e.rawData[11],a.rawData[8]=_*r+w*s+b*u+x*f,a.rawData[9]=_*i+w*l+b*d+x*v,a.rawData[10]=_*o+w*h+b*m+x*g,a.rawData[11]=_*n+w*c+b*p+x*y,_=e.rawData[12],w=e.rawData[13],b=e.rawData[14],x=e.rawData[15],a.rawData[12]=_*r+w*s+b*u+x*f,a.rawData[13]=_*i+w*l+b*d+x*v,a.rawData[14]=_*o+w*h+b*m+x*g,a.rawData[15]=_*n+w*c+b*p+x*y}function matrix3x2Multiply(t,e,a){var r=t.rawData[0],i=t.rawData[1],o=t.rawData[2],n=t.rawData[3],s=t.rawData[4],l=t.rawData[5],h=e.rawData[0],c=e.rawData[1],u=0;a.rawData[0]=h*r+c*o+u*s,a.rawData[1]=h*i+c*n+u*l,h=e.rawData[2],c=e.rawData[3],u=0,a.rawData[2]=h*r+c*o+u*s,a.rawData[3]=h*i+c*n+u*l,h=e.rawData[4],c=e.rawData[5],u=1,a.rawData[4]=h*r+c*o+u*s,a.rawData[5]=h*i+c*n+u*l}e.matrixGetTranslation=function matrixGetTranslation(t,e){e.x=t.rawData[12],e.y=t.rawData[13],e.z=t.rawData[14]},e.matrixTranspose=function matrixTranspose(t,e){e.rawData[1]=t.rawData[4],e.rawData[2]=t.rawData[8],e.rawData[3]=t.rawData[12],e.rawData[4]=t.rawData[1],e.rawData[6]=t.rawData[9],e.rawData[7]=t.rawData[13],e.rawData[8]=t.rawData[2],e.rawData[9]=t.rawData[6],e.rawData[11]=t.rawData[14],e.rawData[12]=t.rawData[3],e.rawData[13]=t.rawData[7],e.rawData[14]=t.rawData[11]},e.matrixDecompose=function matrixDecompose(t,a,r,i){i.x=t.rawData[12],i.y=t.rawData[13],i.z=t.rawData[14];var o=e.sign(t.rawData[0]*t.rawData[1]*t.rawData[2]*t.rawData[3])<0?-1:1,n=e.sign(t.rawData[4]*t.rawData[5]*t.rawData[6]*t.rawData[7])<0?-1:1,s=e.sign(t.rawData[8]*t.rawData[9]*t.rawData[10]*t.rawData[11])<0?-1:1;if(a.x=o*Math.sqrt(t.rawData[0]*t.rawData[0]+t.rawData[1]*t.rawData[1]+t.rawData[2]*t.rawData[2]),a.y=n*Math.sqrt(t.rawData[4]*t.rawData[4]+t.rawData[5]*t.rawData[5]+t.rawData[6]*t.rawData[6]),a.z=s*Math.sqrt(t.rawData[8]*t.rawData[8]+t.rawData[9]*t.rawData[9]+t.rawData[10]*t.rawData[10]),0===a.x||0===a.y||0===a.z)return r.x=0,r.y=0,r.z=0,r.w=1,!1;var l=e.pool.new_matrix();return l.rawData[0]=t.rawData[0]/a.x,l.rawData[1]=t.rawData[1]/a.x,l.rawData[2]=t.rawData[2]/a.x,l.rawData[3]=0,l.rawData[4]=t.rawData[4]/a.y,l.rawData[5]=t.rawData[5]/a.y,l.rawData[6]=t.rawData[6]/a.y,l.rawData[7]=0,l.rawData[8]=t.rawData[8]/a.z,l.rawData[9]=t.rawData[9]/a.z,l.rawData[10]=t.rawData[10]/a.z,l.rawData[11]=0,matrix2Quaternion(l,r),!0};var a=function(){return function angelref(){}}();e.angelref=a,e.matrix3x2Decompose=function matrix3x2Decompose(t,a,r,i){i.x=t.rawData[4],i.y=t.rawData[5];var o=e.sign(t.rawData[0]*t.rawData[1])<0?-1:1,n=e.sign(t.rawData[2]*t.rawData[3])<0?-1:1;if(a.x=o*Math.sqrt(t.rawData[0]*t.rawData[0]+t.rawData[1]*t.rawData[1]),a.y=n*Math.sqrt(t.rawData[2]*t.rawData[2]+t.rawData[3]*t.rawData[3]),0===a.x||0===a.y)return r.v=0,!1;var s=t.rawData[0]/a.x,l=t.rawData[1]/a.x,h=Math.asin(s);Math.acos(l);return r.v=h,!0},e.matrix2Quaternion=matrix2Quaternion,e.matrixClone=function matrixClone(t,e){for(var a=0;a<16;a++)e.rawData[a]=t.rawData[a]},e.matrix3x2Clone=function matrix3x2Clone(t,e){for(var a=0;a<16;a++)e.rawData[a]=t.rawData[a]},e.matrixMakeIdentity=function matrixMakeIdentity(t){t.rawData[0]=1,t.rawData[1]=0,t.rawData[2]=0,t.rawData[3]=0,t.rawData[4]=0,t.rawData[5]=1,t.rawData[6]=0,t.rawData[7]=0,t.rawData[8]=0,t.rawData[9]=0,t.rawData[10]=1,t.rawData[11]=0,t.rawData[12]=0,t.rawData[13]=0,t.rawData[14]=0,t.rawData[15]=1},e.matrix3x2MakeIdentity=function matrix3x2MakeIdentity(t){t.rawData[0]=1,t.rawData[1]=0,t.rawData[2]=0,t.rawData[3]=1,t.rawData[4]=0,t.rawData[5]=0},e.matrixInverse=function matrixInverse(t,e){var a=t.rawData[0],r=t.rawData[1],i=t.rawData[2],o=t.rawData[3],n=t.rawData[4],s=t.rawData[5],l=t.rawData[6],h=t.rawData[7],c=t.rawData[8],u=t.rawData[9],d=t.rawData[10],m=t.rawData[11],p=t.rawData[12],f=t.rawData[13],v=t.rawData[14],g=t.rawData[15],y=d*g-m*v,_=u*g-m*f,w=u*v-d*f,b=c*g-m*p,x=c*v-d*p,D=c*f-u*p,T=s*y-l*_+h*w,E=-(n*y-l*b+h*x),S=n*_-s*b+h*D,A=-(n*w-s*x+l*D),M=1/(a*T+r*E+i*S+o*A),R=l*g-h*v,C=s*g-h*f,P=s*v-l*f,F=n*g-h*p,I=n*v-l*p,V=n*f-s*p,U=l*m-h*d,k=s*m-h*u,N=s*d-l*u,B=n*m-h*c,O=n*d-l*c,L=n*u-s*c;e.rawData[0]=T*M,e.rawData[4]=E*M,e.rawData[8]=S*M,e.rawData[12]=A*M,e.rawData[1]=-(r*y-i*_+o*w)*M,e.rawData[5]=(a*y-i*b+o*x)*M,e.rawData[9]=-(a*_-r*b+o*D)*M,e.rawData[13]=(a*w-r*x+i*D)*M,e.rawData[2]=(r*R-i*C+o*P)*M,e.rawData[6]=-(a*R-i*F+o*I)*M,e.rawData[10]=(a*C-r*F+o*V)*M,e.rawData[14]=-(a*P-r*I+i*V)*M,e.rawData[3]=-(r*U-i*k+o*N)*M,e.rawData[7]=(a*U-i*B+o*O)*M,e.rawData[11]=-(a*k-r*B+o*L)*M,e.rawData[15]=(a*N-r*O+i*L)*M},e.matrix3x2Inverse=function matrix3x2Inverse(t,e){var a=t.rawData[0],r=t.rawData[1],i=t.rawData[2],o=t.rawData[3],n=t.rawData[4],s=t.rawData[5],l=-(i*-s-o*-n),h=1/(a*o+r*-i);e.rawData[0]=o*h,e.rawData[2]=-i*h,e.rawData[4]=l*h,e.rawData[1]=-r*h,e.rawData[3]=a*h,e.rawData[5]=(a*-s-r*-n)*h},e.matrixMakeTransformRTS=function matrixMakeTransformRTS(a,r,i,o){var n=t.math.pool.new_matrix();matrixMakeScale(r.x,r.y,r.z,n);var s=t.math.pool.new_matrix();e.quatToMatrix(i,s),matrixMultiply(s,n,o),o.rawData[12]=a.x,o.rawData[13]=a.y,o.rawData[14]=a.z,o.rawData[15]=1,t.math.pool.delete_matrix(n),t.math.pool.delete_matrix(s)},e.matrix3x2MakeTransformRTS=function matrix3x2MakeTransformRTS(e,a,r,i){var o=t.math.pool.new_matrix3x2();matrix3x2MakeScale(a.x,a.y,o);var n=t.math.pool.new_matrix3x2();matrix3x2MakeRotate(r,n),matrix3x2Multiply(n,o,i),i.rawData[4]=e.x,i.rawData[5]=e.y,t.math.pool.delete_matrix3x2(o),t.math.pool.delete_matrix3x2(n)},e.matrixMakeTranslate=function matrixMakeTranslate(t,e,a,r){r.rawData[0]=1,r.rawData[1]=0,r.rawData[2]=0,r.rawData[3]=0,r.rawData[4]=0,r.rawData[5]=1,r.rawData[6]=0,r.rawData[7]=0,r.rawData[8]=0,r.rawData[9]=0,r.rawData[10]=1,r.rawData[11]=0,r.rawData[12]=t,r.rawData[13]=e,r.rawData[14]=a,r.rawData[15]=1},e.matrix3x2MakeTranslate=function matrix3x2MakeTranslate(t,e,a){a.rawData[0]=1,a.rawData[1]=0,a.rawData[2]=0,a.rawData[3]=1,a.rawData[4]=t,a.rawData[5]=e},e.matrixGetScale=function matrixGetScale(t,e){e.x=t.rawData[0],e.y=t.rawData[5],e.z=t.rawData[10]},e.matrixMakeScale=matrixMakeScale,e.matrix3x2TransformVector2=function matrix3x2TransformVector2(t,e,a){a.x=e.x*t.rawData[0]+e.y*t.rawData[2]+t.rawData[4],a.y=e.x*t.rawData[1]+e.y*t.rawData[3]+t.rawData[5]},e.matrix3x2TransformNormal=function matrix3x2TransformNormal(t,e,a){a.x=e.x*t.rawData[0]+e.y*t.rawData[2],a.y=e.x*t.rawData[1]+e.y*t.rawData[3]},e.matrix3x2MakeScale=matrix3x2MakeScale,e.matrixMakeRotateAxisAngle=function matrixMakeRotateAxisAngle(t,e,a){var r=t.x,i=t.y,o=t.z,n=Math.sqrt(r*r+i*i+o*o);if(n){1!==n&&(r*=n=1/n,i*=n,o*=n);var s=Math.sin(e),l=Math.cos(e),h=1-l,c=r*r*h+l,u=i*r*h+o*s,d=o*r*h-i*s,m=r*i*h-o*s,p=i*i*h+l,f=o*i*h+r*s,v=r*o*h+i*s,g=i*o*h-r*s,y=o*o*h+l;a.rawData[0]=c,a.rawData[1]=u,a.rawData[2]=d,a.rawData[3]=0,a.rawData[4]=m,a.rawData[5]=p,a.rawData[6]=f,a.rawData[7]=0,a.rawData[8]=v,a.rawData[9]=g,a.rawData[10]=y,a.rawData[11]=0,a.rawData[12]=0,a.rawData[13]=0,a.rawData[14]=0,a.rawData[15]=1}},e.matrix3x2MakeRotate=matrix3x2MakeRotate,e.matrixMultiply=matrixMultiply,e.matrix3x2Multiply=matrix3x2Multiply,e.matrixProject_PerspectiveLH=function matrixProject_PerspectiveLH(t,e,a,r,i){var o=1/Math.tan(.5*t);i.rawData[0]=o/e,i.rawData[1]=i.rawData[2]=i.rawData[3]=0,i.rawData[4]=i.rawData[6]=i.rawData[7]=0,i.rawData[5]=o,i.rawData[8]=i.rawData[9]=0,i.rawData[10]=-r/(a-r),i.rawData[11]=1,i.rawData[12]=i.rawData[13]=i.rawData[15]=0,i.rawData[14]=a*r/(a-r)},e.matrixProject_OrthoLH=function matrixProject_OrthoLH(t,e,a,r,i){var o=2/t,n=2/e,s=1/(r-a),l=a/(a-r);i.rawData[0]=o,i.rawData[1]=0,i.rawData[2]=0,i.rawData[3]=0,i.rawData[4]=0,i.rawData[5]=n,i.rawData[6]=0,i.rawData[7]=0,i.rawData[8]=0,i.rawData[9]=0,i.rawData[10]=s,i.rawData[11]=0,i.rawData[12]=0,i.rawData[13]=0,i.rawData[14]=l,i.rawData[15]=1},e.matrixLookatLH=function matrixLookatLH(t,a,r){var i=new e.vector3(-t.x,-t.y,-t.z);e.vec3Normalize(i,i);n=new e.vector3;e.vec3Clone(a,n),e.vec3Normalize(n,n);var o=new e.vector3;e.vec3Cross(n,i,o),e.vec3SqrLength(o),0==e.vec3SqrLength(o)?o.x=1:e.vec3Normalize(o,o);var n=new e.vector3;e.vec3Cross(i,o,n),e.vec3Normalize(n,n),r.rawData[0]=o.x,r.rawData[1]=n.x,r.rawData[2]=i.x,r.rawData[3]=0,r.rawData[4]=o.y,r.rawData[5]=n.y,r.rawData[6]=i.y,r.rawData[7]=0,r.rawData[8]=o.z,r.rawData[9]=n.z,r.rawData[10]=i.z,r.rawData[11]=0,r.rawData[12]=0,r.rawData[13]=0,r.rawData[14]=0,r.rawData[15]=1},e.matrixViewLookatLH=function matrixViewLookatLH(t,a,r,i){var o=new e.vector3(a.x,a.y,a.z);e.vec3Normalize(o,o);s=new e.vector3;e.vec3Clone(r,s),e.vec3Normalize(s,s);var n=new e.vector3;e.vec3Cross(s,o,n),e.vec3SqrLength(n),0==e.vec3SqrLength(n)?n.x=1:e.vec3Normalize(n,n);var s=new e.vector3;e.vec3Cross(o,n,s),e.vec3Normalize(s,s);var l=-e.vec3Dot(n,t),h=-e.vec3Dot(s,t),c=-e.vec3Dot(o,t);i.rawData[0]=n.x,i.rawData[1]=s.x,i.rawData[2]=o.x,i.rawData[3]=0,i.rawData[4]=n.y,i.rawData[5]=s.y,i.rawData[6]=o.y,i.rawData[7]=0,i.rawData[8]=n.z,i.rawData[9]=s.z,i.rawData[10]=o.z,i.rawData[11]=0,i.rawData[12]=l,i.rawData[13]=h,i.rawData[14]=c,i.rawData[15]=1},e.matrixLerp=function matrixLerp(t,e,a,r){for(var i=0;i<16;i++)r.rawData[i]=t.rawData[i]*(1-a)+e.rawData[i]*a},e.matrixTransformVector3=function matrixTransformVector3(t,e,a){var r=t.x*e.rawData[0]+t.y*e.rawData[4]+t.z*e.rawData[8]+e.rawData[12],i=t.x*e.rawData[1]+t.y*e.rawData[5]+t.z*e.rawData[9]+e.rawData[13],o=t.x*e.rawData[2]+t.y*e.rawData[6]+t.z*e.rawData[10]+e.rawData[14],n=t.x*e.rawData[3]+t.y*e.rawData[7]+t.z*e.rawData[11]+e.rawData[15];a.x=r/n,a.y=i/n,a.z=o/n},e.matrixTransformNormal=function matrixTransformNormal(t,e,a){var r=t.x*e.rawData[0]+t.y*e.rawData[4]+t.z*e.rawData[8],i=t.x*e.rawData[1]+t.y*e.rawData[5]+t.z*e.rawData[9],o=t.x*e.rawData[2]+t.y*e.rawData[6]+t.z*e.rawData[10];a.x=r,a.y=i,a.z=o},e.matrixGetVector3ByOffset=function matrixGetVector3ByOffset(t,e,a){a.x=t.rawData[e],a.y=t.rawData[e+1],a.z=t.rawData[e+2]},e.matrixReset=function matrixReset(t){t.rawData[0]=1,t.rawData[1]=0,t.rawData[2]=0,t.rawData[3]=0,t.rawData[4]=0,t.rawData[5]=1,t.rawData[6]=0,t.rawData[7]=0,t.rawData[8]=0,t.rawData[9]=0,t.rawData[10]=1,t.rawData[11]=0,t.rawData[12]=0,t.rawData[13]=0,t.rawData[14]=0,t.rawData[15]=1},e.matrixZero=function matrixZero(t){t.rawData[0]=0,t.rawData[1]=0,t.rawData[2]=0,t.rawData[3]=0,t.rawData[4]=0,t.rawData[5]=0,t.rawData[6]=0,t.rawData[7]=0,t.rawData[8]=0,t.rawData[9]=0,t.rawData[10]=0,t.rawData[11]=0,t.rawData[12]=0,t.rawData[13]=0,t.rawData[14]=0,t.rawData[15]=1},e.matrixScaleByNum=function matrixScaleByNum(t,e){e.rawData[0]*=t,e.rawData[1]*=t,e.rawData[2]*=t,e.rawData[3]*=t,e.rawData[4]*=t,e.rawData[5]*=t,e.rawData[6]*=t,e.rawData[7]*=t,e.rawData[8]*=t,e.rawData[9]*=t,e.rawData[10]*=t,e.rawData[11]*=t,e.rawData[12]*=t,e.rawData[13]*=t,e.rawData[14]*=t,e.rawData[15]*=t},e.matrixAdd=function matrixAdd(t,e,a){a.rawData[0]=t.rawData[0]+e.rawData[0],a.rawData[1]=t.rawData[1]+e.rawData[1],a.rawData[2]=t.rawData[2]+e.rawData[2],a.rawData[3]=t.rawData[3]+e.rawData[3],a.rawData[4]=t.rawData[4]+e.rawData[4],a.rawData[5]=t.rawData[5]+e.rawData[5],a.rawData[6]=t.rawData[6]+e.rawData[6],a.rawData[7]=t.rawData[7]+e.rawData[7],a.rawData[8]=t.rawData[8]+e.rawData[8],a.rawData[9]=t.rawData[9]+e.rawData[9],a.rawData[10]=t.rawData[10]+e.rawData[10],a.rawData[11]=t.rawData[11]+e.rawData[11],a.rawData[12]=t.rawData[12]+e.rawData[12],a.rawData[13]=t.rawData[13]+e.rawData[13],a.rawData[14]=t.rawData[14]+e.rawData[14],a.rawData[15]=t.rawData[15]+e.rawData[15]}}(t.math||(t.math={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){e.floatClamp=function floatClamp(t,e,a){return void 0===e&&(e=0),void 0===a&&(a=1),t<e?e:t>a?a:t},e.sign=function sign(t){return t=+t,0===t||isNaN(t)?t:t>0?1:-1},e.getKeyCodeByAscii=function getKeyCodeByAscii(t){return t.shiftKey?t.keyCode-32:t.keyCode},e.numberLerp=function numberLerp(t,e,a){return t*(1-a)+e*a},e.x_AXIS=function x_AXIS(){return a.x_axis},e.y_AXIS=function y_AXIS(){return a.y_axis},e.z_AXIS=function z_AXIS(){return a.z_axis};var a=function(){return function commonStatic(){}}();a.x_axis=new t.math.vector3(1,0,0),a.y_axis=new t.math.vector3(0,1,0),a.z_axis=new t.math.vector3(0,0,1),e.commonStatic=a}(t.math||(t.math={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){function quatFromYawPitchRoll(t,e,a,r){var i=.5*a,o=.5*e,n=.5*t,s=Math.sin(i),l=Math.cos(i),h=Math.sin(o),c=Math.cos(o),u=Math.sin(n),d=Math.cos(n);r.x=d*h*l+u*c*s,r.y=u*c*l-d*h*s,r.z=d*c*s-u*h*l,r.w=d*c*l+u*h*s}e.quatNormalize=function quatNormalize(t,e){var a=1/Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w);e.x*=a,e.y*=a,e.z*=a,e.w*=a},e.quatTransformVector=function quatTransformVector(t,e,a){var r,i,o,n,s=e.x,l=e.y,h=e.z;n=-t.x*s-t.y*l-t.z*h,r=t.w*s+t.y*h-t.z*l,i=t.w*l-t.x*h+t.z*s,o=t.w*h+t.x*l-t.y*s,a.x=-n*t.x+r*t.w-i*t.z+o*t.y,a.y=-n*t.y+r*t.z+i*t.w-o*t.x,a.z=-n*t.z-r*t.y+i*t.x+o*t.w},e.quatTransformVectorDataAndQuat=function quatTransformVectorDataAndQuat(t,e,a,r){var i,o,n,s,l=a.x,h=a.y,c=a.z,u=t[e],d=t[e+1],m=t[e+2],p=t[e+3];s=-u*l-d*h-m*c,i=p*l+d*c-m*h,o=p*h-u*c+m*l,n=p*c+u*h-d*l,r.x=-s*u+i*p-o*m+n*d,r.y=-s*d+i*m+o*p-n*u,r.z=-s*m-i*d+o*u+n*p},e.quatMagnitude=function quatMagnitude(t){return Math.sqrt(t.w*t.w+t.x*t.x+t.y*t.y+t.z*t.z)},e.quatClone=function quatClone(t,e){e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w},e.quatToMatrix=function quatToMatrix(t,e){var a=2*t.x*t.y,r=2*t.x*t.z,i=2*t.x*t.w,o=2*t.y*t.z,n=2*t.y*t.w,s=2*t.z*t.w,l=t.x*t.x,h=t.y*t.y,c=t.z*t.z,u=t.w*t.w;e.rawData[0]=l-h-c+u,e.rawData[4]=a-s,e.rawData[8]=r+n,e.rawData[12]=0,e.rawData[1]=a+s,e.rawData[5]=-l+h-c+u,e.rawData[9]=o-i,e.rawData[13]=0,e.rawData[2]=r-n,e.rawData[6]=o+i,e.rawData[10]=-l-h+c+u,e.rawData[14]=0,e.rawData[3]=0,e.rawData[7]=0,e.rawData[11]=0,e.rawData[15]=1},e.quatInverse=function quatInverse(t,e){var a=t.w*t.w+t.x*t.x+t.y*t.y+t.z*t.z;if(a>0){var r=1/a;e.w=t.w*r,e.x=-t.x*r,e.y=-t.y*r,e.z=-t.z*r}},e.quatFromYawPitchRoll=quatFromYawPitchRoll,e.quatMultiply=function quatMultiply(t,a,r){var i=t.w,o=t.x,n=t.y,s=t.z,l=a.w,h=a.x,c=a.y,u=a.z;r.w=i*l-o*h-n*c-s*u,r.x=i*h+o*l+n*u-s*c,r.y=i*c-o*u+n*l+s*h,r.z=i*u+o*c-n*h+s*l,e.quatNormalize(r,r)},e.quatMultiplyDataAndQuat=function quatMultiplyDataAndQuat(t,a,r,i){var o=t[a+3],n=t[a+0],s=t[a+1],l=t[a+2],h=r.w,c=r.x,u=r.y,d=r.z;i.w=o*h-n*c-s*u-l*d,i.x=o*c+n*h+s*d-l*u,i.y=o*u-n*d+s*h+l*c,i.z=o*d+n*u-s*c+l*h,e.quatNormalize(i,i)},e.quatMultiplyVector=function quatMultiplyVector(t,e,a){var r=t.x,i=t.y,o=t.z;a.w=-e.x*r-e.y*i-e.z*o,a.x=e.w*r+e.y*o-e.z*i,a.y=e.w*i-e.x*o+e.z*r,a.z=e.w*o+e.x*i-e.y*r},e.quatLerp=function quatLerp(t,e,a,r){var i=t.w,o=t.x,n=t.y,s=t.z,l=e.w,h=e.x,c=e.y,u=e.z;i*l+o*h+n*c+s*u<0&&(l=-l,h=-h,c=-c,u=-u),a.w=i+r*(l-i),a.x=o+r*(h-o),a.y=n+r*(c-n),a.z=s+r*(u-s);var d=1/Math.sqrt(a.w*a.w+a.x*a.x+a.y*a.y+a.z*a.z);a.w*=d,a.x*=d,a.y*=d,a.z*=d},e.quatFromAxisAngle=function quatFromAxisAngle(t,a,r){var i=.5*(a*=Math.PI/180),o=Math.sin(i);r.w=Math.cos(i),r.x=t.x*o,r.y=t.y*o,r.z=t.z*o,e.quatNormalize(r,r)},e.quatToAxisAngle=function quatToAxisAngle(t,e){var a=t.x*t.x+t.y*t.y+t.z*t.z,r=0;return a>0?(r=2*Math.acos(t.w),a=1/Math.sqrt(a),e.x=t.x*a,e.y=t.y*a,e.z=t.z*a):(r=0,e.x=1,e.y=0,e.z=0),r/=Math.PI/180},e.quatFromEulerAngles=function quatFromEulerAngles(t,a,r,i){var o=.5*(t*=Math.PI/180),n=.5*(a*=Math.PI/180),s=.5*(r*=Math.PI/180),l=Math.cos(o),h=Math.sin(o),c=Math.cos(n),u=Math.sin(n),d=Math.cos(s),m=Math.sin(s);i.w=l*c*d+h*u*m,i.x=h*c*d+l*u*m,i.y=l*u*d-h*c*m,i.z=l*c*m-h*u*d,e.quatNormalize(i,i)},e.quatToEulerAngles=function quatToEulerAngles(t,a){var r=2*(t.w*t.x-t.y*t.z);r=e.floatClamp(r,-1,1),a.x=Math.asin(r),a.y=Math.atan2(2*(t.w*t.y+t.z*t.x),1-2*(t.y*t.y+t.x*t.x)),a.z=Math.atan2(2*(t.w*t.z+t.y*t.x),1-2*(t.x*t.x+t.z*t.z)),a.x/=Math.PI/180,a.y/=Math.PI/180,a.z/=Math.PI/180},e.quatReset=function quatReset(t){t.x=0,t.y=0,t.z=0,t.w=1},e.quatLookat=function quatLookat(t,a,r){var i=new e.vector3;e.vec3Subtract(a,t,i),e.vec3Normalize(i,i);var o=new e.vector3(i.x,0,i.z);e.vec3Normalize(o,o);var n=Math.acos(o.z);o.x<0&&(n=-n);var s=new e.vector3(i.x,0,i.z),l=e.vec3Length(s);l>.999&&(l=1),l<-.999&&(l=-1);var h=Math.acos(l);i.y>0&&(h=-h),quatFromYawPitchRoll(n,h,0,r),e.quatNormalize(r,r)},e.quat2Lookat=function quat2Lookat(a,r,i,o){void 0===o&&(o=t.math.pool.vector3_up);var n=t.math.pool.new_vector3();e.vec3Subtract(r,a,n),e.vec3Normalize(n,n);var s=t.math.vec3Dot(t.math.pool.vector3_forward,n);s=t.math.floatClamp(s,-1,1);var l=180*Math.acos(s)/Math.PI;if(l<.01)return i.x=0,i.y=0,i.z=0,void(i.w=1);if(l>179.9)t.math.quatFromAxisAngle(o,180,i);else{var h=t.math.pool.new_vector3();t.math.vec3Cross(t.math.pool.vector3_forward,n,h),t.math.vec3Normalize(h,h),t.math.quatFromAxisAngle(h,l,i)}},e.quatYAxis=function quatYAxis(t,a,r){var i=new e.vector3;e.vec3Subtract(a,t,i),e.vec3Normalize(i,i);var o=new e.vector3(i.x,0,i.z);e.vec3Normalize(o,o);var n=Math.acos(o.z);o.x<0&&(n=-n),quatFromYawPitchRoll(n,0,0,r),e.quatNormalize(r,r)}}(t.math||(t.math={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(t){t.rectSet_One=function rectSet_One(t){t.x=0,t.y=0,t.w=1,t.h=1},t.rectSet_Zero=function rectSet_Zero(t){t.x=0,t.y=0,t.w=0,t.h=0},t.rectEqul=function rectEqul(t,e){return!(t.x!=e.x||t.y!=e.y||t.w!=e.w||t.h!=e.h)},t.rectInner=function rectInner(t,e,a){return!(t<a.x||t>a.x+a.w||e<a.y||e>a.y+a.h)}}(t.math||(t.math={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(t){t.caclStringByteLength=function caclStringByteLength(t){for(var e=0,a=0;a<t.length;a++){var r=t.charCodeAt(a);e+=r<=127?1:r<=2047?2:r<=65535?3:4}return e}}(t.math||(t.math={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){e.spriteAnimation=function spriteAnimation(t,e,a,r){var i=1/e,o=1/t,n=i*(a%e),s=o*Math.floor(a/e);r.x=i,r.y=o,r.z=n,r.w=s},e.GetPointAlongCurve=function GetPointAlongCurve(e,a,r,i,o,n,s){void 0===s&&(s=.3);var l=1-o,h=Math.pow(l,3),c=Math.pow(l,2),u=1-s,d=t.math.pool.new_vector3();t.math.vec3ScaleByNum(e,h*u,d);var m=t.math.pool.new_vector3();t.math.vec3ScaleByNum(a,3*c*o*s,m);var p=t.math.pool.new_vector3();t.math.vec3ScaleByNum(i,3*l*Math.pow(o,2)*s,p);var f=t.math.pool.new_vector3();t.math.vec3ScaleByNum(r,Math.pow(o,3)*u,f);var v=t.math.pool.new_vector3();t.math.vec3Add(d,m,v),t.math.vec3Add(v,p,v),t.math.vec3Add(v,f,v),t.math.vec3ScaleByNum(v,1/(h*u+3*c*o*s+3*l*Math.pow(o,2)*s+Math.pow(o,3)*u),n),t.math.pool.delete_vector3(d),t.math.pool.delete_vector3(m),t.math.pool.delete_vector3(p),t.math.pool.delete_vector3(f),t.math.pool.delete_vector3(v)}}(t.math||(t.math={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(t){function vec2Subtract(t,e,a){a.x=t.x-e.x,a.y=t.y-e.y}function vec2Length(t){return Math.sqrt(t.x*t.x+t.y*t.y)}t.vec2Subtract=vec2Subtract,t.vec2Add=function vec2Add(t,e,a){a.x=t.x+e.x,a.y=t.y+e.y},t.vec2Clone=function vec2Clone(t,e){e.x=t.x,e.y=t.y},t.vec2Distance=function vec2Distance(e,a){var r=t.pool.new_vector2();vec2Subtract(e,a,r);var i=Math.sqrt(r.x*r.x+r.y*r.y);return t.pool.delete_vector2(r),i},t.vec2ScaleByNum=function vec2ScaleByNum(t,e,a){a.x=t.x*e,a.y=t.y*e},t.vec4Clone=function vec4Clone(t,e){e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w},t.vec2Length=vec2Length,t.vec2SLerp=function vec2SLerp(t,e,a,r){r.x=t.x*(1-a)+e.x*a,r.y=t.y*(1-a)+e.y*a},t.vec2Normalize=function vec2Normalize(t,e){var a=vec2Length(t);a>Number.MIN_VALUE?(e.x=t.x/a,e.y=t.y/a):(e.x=0,e.y=0)},t.vec2Multiply=function vec2Multiply(t,e){return t.x*e.x+t.y*e.y},t.vec2Equal=function vec2Equal(t,e,a){return void 0===a&&(a=1e-5),!(Math.abs(t.x-e.x)>a||Math.abs(t.y-e.y)>a)}}(t.math||(t.math={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(t){function vec3Add(t,e,a){a.x=t.x+e.x,a.y=t.y+e.y,a.z=t.z+e.z}function vec3Subtract(t,e,a){a.x=t.x-e.x,a.y=t.y-e.y,a.z=t.z-e.z}function vec3Length(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z)}function vec3SqrLength(t){return t.x*t.x+t.y*t.y+t.z*t.z}function vec3Normalize(t,e){var a=vec3Length(t);a>Number.MIN_VALUE?(e.x=t.x/a,e.y=t.y/a,e.z=t.z/a):(e.x=0,e.y=0,e.z=0)}function vec3ScaleByNum(t,e,a){a.x=t.x*e,a.y=t.y*e,a.z=t.z*e}function vec3Dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}function vec3Project(t,e,a){var r=0;if((r=vec3Dot(e,e))<Number.MIN_VALUE)a.x=a.y=a.z=0;else{vec3ScaleByNum(e,vec3Dot(t,e)/r,a)}}function floatFormat(t,e){var a=Math.pow(10,e);return Math.round(t*a)/a}t.vec3Clone=function vec3Clone(t,e){e.x=t.x,e.y=t.y,e.z=t.z},t.vec3ToString=function vec3ToString(t){this.x,this.y,this.z},t.vec3Add=vec3Add,t.vec3Subtract=vec3Subtract,t.vec3Minus=function vec3Minus(t,e){e.x=-t.x,e.y=-t.y,e.z=-t.z},t.vec3Length=vec3Length,t.vec3SqrLength=vec3SqrLength,t.vec3Set_One=function vec3Set_One(t){t.x=t.y=t.z=1},t.vec3Set_Forward=function vec3Set_Forward(t){t.x=t.y=0,t.z=1},t.vec3Set_Back=function vec3Set_Back(t){t.x=t.y=0,t.z=-1},t.vec3Set_Up=function vec3Set_Up(t){t.x=t.z=0,t.y=1},t.vec3Set_Down=function vec3Set_Down(t){t.x=t.z=0,t.y=-1},t.vec3Set_Left=function vec3Set_Left(t){t.x=-1,t.y=t.z=0},t.vec3Set_Right=function vec3Set_Right(t){t.x=1,t.y=t.z=0},t.vec3Normalize=vec3Normalize,t.vec3ScaleByVec3=function vec3ScaleByVec3(t,e,a){a.x=t.x*e.x,a.y=t.y*e.y,a.z=t.z*e.z},t.vec3ScaleByNum=vec3ScaleByNum,t.vec3Product=function vec3Product(t,e,a){a.x=t.x*e.x,a.y=t.y*e.y,a.z=t.z*e.z},t.vec3Cross=function vec3Cross(t,e,a){a.x=t.y*e.z-t.z*e.y,a.y=t.z*e.x-t.x*e.z,a.z=t.x*e.y-t.y*e.x},t.vec3Reflect=function vec3Reflect(t,e,a){vec3ScaleByNum(a,-2*vec3Dot(e,t),a),vec3Add(a,t,a)},t.vec3Dot=vec3Dot,t.vec3Project=vec3Project,t.vec3ProjectOnPlane=function vec3ProjectOnPlane(t,e,a){vec3Project(t,e,a),vec3Subtract(t,a,a)},t.vec3Exclude=function vec3Exclude(t,e,a){vec3Project(e,t,a),vec3Subtract(e,a,a)},t.vec3Angle=function vec3Angle(e,a){var r=t.pool.new_vector3(),i=t.pool.new_vector3();vec3Normalize(e,r),vec3Normalize(a,i);var o=vec3Dot(r,i);return o=t.floatClamp(o,-1,1),o=57.29578*Math.acos(o),t.pool.delete_vector3(r),t.pool.delete_vector3(r),o},t.vec3Distance=function vec3Distance(e,a){var r=t.pool.new_vector3();vec3Subtract(e,a,r);var i=Math.sqrt(r.x*r.x+r.y*r.y+r.z*r.z);return t.pool.delete_vector3(r),i},t.vec3ClampLength=function vec3ClampLength(t,e,a){vec3SqrLength(t)>e*e&&(vec3Normalize(t,a),vec3ScaleByNum(a,e,a)),a=t},t.vec3Min=function vec3Min(t,e,a){a.x=Math.min(t.x,e.x),a.y=Math.min(t.y,e.y),a.z=Math.min(t.z,e.z)},t.vec3Max=function vec3Max(t,e,a){a.x=Math.max(t.x,e.x),a.y=Math.max(t.y,e.y),a.z=Math.max(t.z,e.z)},t.vec3AngleBetween=function vec3AngleBetween(e,a){vec3Normalize(e,e),vec3Normalize(a,a);var r=vec3Dot(e,a);return r=t.floatClamp(r,-1,1),r=Math.acos(r)},t.vec3Reset=function vec3Reset(t){t.x=0,t.y=0,t.z=0},t.vec3SLerp=function vec3SLerp(t,e,a,r){r.x=t.x*(1-a)+e.x*a,r.y=t.y*(1-a)+e.y*a,r.z=t.z*(1-a)+e.z*a},t.vec3SetByFloat=function vec3SetByFloat(t,e,a,r){r.x=t,r.y=e,r.z=a},t.vec3Format=function vec3Format(t,e,a){a.x=floatFormat(t.x,e),a.y=floatFormat(t.y,e),a.z=floatFormat(t.z,e)},t.quaternionFormat=function quaternionFormat(t,e,a){a.x=floatFormat(t.x,e),a.y=floatFormat(t.y,e),a.z=floatFormat(t.z,e),a.w=floatFormat(t.w,e)},t.floatFormat=floatFormat,t.vec3Equal=function vec3Equal(t,e,a){return void 0===a&&(a=1e-5),!(Math.abs(t.x-e.x)>a||Math.abs(t.y-e.y)>a||Math.abs(t.z-e.z)>a)}}(t.math||(t.math={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function EffectSystemData(){this.beLoop=!1,this.elements=[]}return EffectSystemData.prototype.clone=function(){var t=new EffectSystemData;t.life=this.life,t.beLoop=this.beLoop;for(var e in this.elements)t.elements[e]=this.elements[e].clone();return t},EffectSystemData.prototype.dispose=function(){for(var t in this.elements)this.elements[t].dispose();this.elements.length=0},EffectSystemData}();e.EffectSystemData=a;var r=function(){function EffectElement(t){this.startIndex=0,this.actionActive=!1,this.loopFrame=Number.MAX_VALUE,this.active=!0,this.data=t,this.name=this.data.name,this.timelineFrame={},this.initActions(),this.recordElementLerpAttributes()}return EffectElement.prototype.recordElementLerpAttributes=function(){if(void 0!=this.data.timelineFrame)for(var t in this.data.timelineFrame){var e=this.data.timelineFrame[t];if(-1!=e.frameIndex)if(void 0!=e.lerpDatas&&0!=e.lerpDatas.length)this.recordLerpValues(e);else if(void 0!=e.attrsData){void 0==this.timelineFrame[e.frameIndex]&&(this.timelineFrame[e.frameIndex]=new n,this.timelineFrame[e.frameIndex].attrsData=new o,this.timelineFrame[e.frameIndex].frameIndex=e.frameIndex);for(var a in e.attrsData)this.timelineFrame[e.frameIndex].attrsData.setLerpAttribute(a,e.attrsData.getAttribute(a))}}},EffectElement.prototype.recordLerpValues=function(t){for(var e in t.lerpDatas)if(t.lerpDatas[e].type==u.Linear)for(var a in t.lerpDatas[e].attrsList){var r=t.lerpDatas[e].attrsList[a];this.recordLerp(t,t.lerpDatas[e],r)}},EffectElement.prototype.recordLerp=function(e,a,r){var i=a.fromFrame,s=a.toFrame.getValue(),l=a.attrsData.getAttribute(r);void 0==e.attrsData[r]&&e.attrsData.initAttribute(r);for(var h=e.attrsData.getAttribute(r),c=i+1;c<=s;c++){var u=void 0;h instanceof t.math.vector3?(u=new t.math.vector3,t.math.vec3SLerp(h,l,(c-i)/(s-i),u)):h instanceof t.math.vector2?(u=new t.math.vector2,t.math.vec2SLerp(h,l,(c-i)/(s-i),u)):"number"==typeof h&&(u=t.math.numberLerp(h,l,(c-i)/(s-i)));var d=this.timelineFrame[c];void 0==d&&((d=new n).attrsData=new o,d.frameIndex=c,this.timelineFrame[c]=d),d.attrsData.setLerpAttribute(r,u)}},EffectElement.prototype.initActions=function(){this.actions=[];var t;for(var a in this.data.actionData){var r=this.data.actionData[a];switch(r.actionType){case"linear":t=new e.LinearAction;break;case"destroy":t=new e.DestroyAction;break;case"loop":t=new e.LoopAction;break;case"destroy":t=new e.DestroyAction;break;case"rotation":t=new e.RotationAction;break;case"breath":t=new e.BreathAction;break;case"uvroll":t=new e.UVRollAction;break;case"uvsprite":t=new e.UVSpriteAnimationAction;break;case"rosepath":t=new e.RoseCurveAction;break;case"trail":t=new e.TrailAction}t.init(r.startFrame,r.endFrame,r.params,this),this.actions.push(t)}},EffectElement.prototype.update=function(){void 0!=this.curAttrData&&null!=this.curAttrData&&(this.active?(void 0!=this.curAttrData.euler&&t.math.quatFromEulerAngles(this.curAttrData.euler.x,this.curAttrData.euler.y,this.curAttrData.euler.z,this.curAttrData.rotationByEuler),this.updateElementRotation(),t.math.matrixMakeTransformRTS(this.curAttrData.pos,this.curAttrData.scale,this.curAttrData.localRotation,this.curAttrData.matrix)):this.curAttrData.resetMatrix())},EffectElement.prototype.updateElementRotation=function(){var a=t.framework.sceneMgr.app.getScene().mainCamera.gameObject.transform,r=t.math.pool.new_quaternion(),i=t.math.pool.new_quaternion();if(this.curAttrData.renderModel!=d.None){var o=t.math.pool.new_quaternion(),n=t.math.pool.new_vector3(),s=t.math.pool.new_vector3();if(t.math.vec3Clone(this.curAttrData.pos,s),void 0!=this.transform&&t.math.matrixTransformVector3(s,this.transform.getWorldMatrix(),n),this.curAttrData.renderModel==d.BillBoard)t.math.quatLookat(n,a.getWorldTranslate(),r);else if(this.curAttrData.renderModel==d.HorizontalBillBoard)r.x=-.5,r.y=.5,r.z=.5,r.w=.5;else if(this.curAttrData.renderModel==d.VerticalBillBoard){var l=t.math.pool.new_vector3();t.math.vec3Clone(a.getWorldTranslate(),l),l.y=n.y,t.math.quatLookat(n,l,r),t.math.pool.delete_vector3(l)}else{if(this.curAttrData.renderModel==d.StretchedBillBoard){t.math.quatMultiply(r,this.curAttrData.rotationByEuler,this.curAttrData.localRotation),t.math.quatLookat(n,a.getWorldTranslate(),r);var h=new t.math.quaternion;t.math.quatClone(this.transform.getWorldRotate(),o),t.math.quatInverse(o,o),t.math.quatMultiply(o,r,h);var c=t.math.pool.new_quaternion();t.math.quatInverse(this.curAttrData.localRotation,c),t.math.quatMultiply(c,h,h);var u=t.math.pool.new_vector3();return t.math.quatToEulerAngles(h,u),t.math.quatFromEulerAngles(0,u.y,0,h),t.math.quatMultiply(this.curAttrData.localRotation,h,this.curAttrData.localRotation),t.math.pool.delete_quaternion(c),t.math.pool.delete_vector3(u),void t.math.pool.delete_quaternion(h)}this.curAttrData.renderModel==d.Mesh&&e.EffectUtil.quatLookatZ(n,a.getWorldTranslate(),r)}t.math.quatMultiply(r,this.curAttrData.rotationByEuler,r),t.math.quatClone(this.transform.gameObject.transform.getWorldRotate(),o),t.math.quatInverse(o,o),t.math.quatMultiply(o,r,this.curAttrData.localRotation),t.math.pool.delete_vector3(s),t.math.pool.delete_vector3(n),t.math.pool.delete_quaternion(o)}else t.math.quatMultiply(r,this.curAttrData.rotationByEuler,this.curAttrData.localRotation);t.math.pool.delete_quaternion(i),t.math.pool.delete_quaternion(r)},EffectElement.prototype.isActiveFrame=function(t){return void 0!=this.timelineFrame[t]||(void 0!=this.curAttrData&&this.curAttrData.renderModel!=d.None||this.actionActive)},EffectElement.prototype.setActive=function(t){this.active!=t&&(this.active=t,this.active||this.curAttrData.resetMatrix())},EffectElement.prototype.dispose=function(){this.data.dispose(),this.curAttrData=null,this.actions.length=0,delete this.timelineFrame},EffectElement}();e.EffectElement=r;var i=function(){function EffectElementData(){}return EffectElementData.prototype.clone=function(){var t=new EffectElementData;t.name=this.name,t.type=this.type,t.ref=this.ref,t.beloop=this.beloop,t.actionData=[],t.timelineFrame=[],this.initFrameData&&(t.initFrameData=this.initFrameData.clone()),this.emissionData&&(t.emissionData=this.emissionData.clone());for(var e in this.timelineFrame)this.timelineFrame[e]&&(t.timelineFrame[e]=this.timelineFrame[e].clone());for(var e in this.actionData)this.actionData[e]&&(t.actionData[e]=this.actionData[e].clone());return t},EffectElementData.prototype.dispose=function(){this.actionData&&(this.actionData.length=0),this.initFrameData&&this.initFrameData.dispose();for(var t in this.timelineFrame)this.timelineFrame[t].dispose();delete this.timelineFrame},EffectElementData}();e.EffectElementData=i;var o=function(){function EffectAttrsData(){this.renderModel=d.None,this.matrix=new t.math.matrix,this.rotationByEuler=new t.math.quaternion,this.localRotation=new t.math.quaternion}return EffectAttrsData.prototype.setLerpAttribute=function(t,e){switch(t){case"pos":this.pos=e;break;case"scale":this.scale=e;break;case"euler":this.euler=e;break;case"alpha":this.alpha=e;break;case"uv":this.uv=e;break;case"color":this.color=e;break;case"tilling":console.log("tilling 逻辑上不需要插值")}},EffectAttrsData.prototype.getAttribute=function(e){switch(e){case"pos":return t.math.pool.clone_vector3(this.pos);case"scale":return t.math.pool.clone_vector3(this.scale);case"euler":return t.math.pool.clone_vector3(this.euler);case"alpha":return this.alpha;case"color":return t.math.pool.clone_vector3(this.color);case"tilling":return t.math.pool.clone_vector2(this.tilling);case"uv":return t.math.pool.clone_vector2(this.uv);case"mat":return this.mat.clone();case"renderModel":return this.renderModel;case"rotationByEuler":return t.math.pool.clone_quaternion(this.rotationByEuler);case"localRotation":return t.math.pool.clone_quaternion(this.localRotation);case"matrix":return t.math.pool.clone_matrix(this.matrix);case"colorRate":return this.colorRate}},EffectAttrsData.prototype.initAttribute=function(e){switch(e){case"pos":this.pos=new t.math.vector3(0,0,0);break;case"scale":this.scale=new t.math.vector3(1,1,1);break;case"euler":this.euler=new t.math.vector3(0,0,0);break;case"alpha":this.alpha=0;break;case"color":this.color=new t.math.vector3(0,0,0);break;case"uv":this.uv=new t.math.vector2(0,0);break;case"tilling":this.tilling=new t.math.vector2(1,1);break;case"colorRate":this.colorRate=1;break;default:console.log("不支持的属性："+e)}},EffectAttrsData.prototype.resetMatrix=function(){t.math.matrixZero(this.matrix)},EffectAttrsData.prototype.copyandinit=function(){var e=new EffectAttrsData;return void 0!=this.pos?e.pos=t.math.pool.clone_vector3(this.pos):e.initAttribute("pos"),void 0!=this.euler?e.euler=t.math.pool.clone_vector3(this.euler):e.initAttribute("euler"),void 0!=this.color?e.color=t.math.pool.clone_vector3(this.color):e.initAttribute("color"),void 0!=this.scale?e.scale=t.math.pool.clone_vector3(this.scale):e.initAttribute("scale"),void 0!=this.uv?e.uv=t.math.pool.clone_vector2(this.uv):e.initAttribute("uv"),void 0!=this.tilling?e.tilling=t.math.pool.clone_vector2(this.tilling):e.initAttribute("tilling"),void 0!=this.colorRate?e.colorRate=this.colorRate:e.initAttribute("colorRate"),void 0!=this.mat&&(e.mat=this.mat.clone()),void 0!=this.rotationByEuler&&(e.rotationByEuler=t.math.pool.clone_quaternion(this.rotationByEuler)),void 0!=this.localRotation&&(e.localRotation=t.math.pool.clone_quaternion(this.localRotation)),void 0!=this.meshdataVbo&&(e.meshdataVbo=this.meshdataVbo),e.alpha=this.alpha,e.renderModel=this.renderModel,e.mesh=this.mesh,e},EffectAttrsData.prototype.clone=function(){var e=new EffectAttrsData;return void 0!=this.pos&&(e.pos=t.math.pool.clone_vector3(this.pos)),void 0!=this.euler&&(e.euler=t.math.pool.clone_vector3(this.euler)),void 0!=this.color&&(e.color=t.math.pool.clone_vector3(this.color)),void 0!=this.scale&&(e.scale=t.math.pool.clone_vector3(this.scale)),void 0!=this.tilling&&(e.tilling=t.math.pool.clone_vector2(this.tilling)),void 0!=this.colorRate&&(e.colorRate=this.colorRate),void 0!=this.uv&&(e.uv=t.math.pool.clone_vector2(this.uv)),void 0!=this.mat&&(e.mat=this.mat.clone()),void 0!=this.rotationByEuler&&(e.rotationByEuler=t.math.pool.clone_quaternion(this.rotationByEuler)),void 0!=this.localRotation&&(e.localRotation=t.math.pool.clone_quaternion(this.localRotation)),void 0!=this.meshdataVbo&&(e.meshdataVbo=this.meshdataVbo),e.alpha=this.alpha,e.renderModel=this.renderModel,e.mesh=this.mesh,e},EffectAttrsData}();e.EffectAttrsData=o;var n=function(){function EffectFrameData(){}return EffectFrameData.prototype.clone=function(){var t=new EffectFrameData;t.frameIndex=this.frameIndex,t.attrsData=this.attrsData.clone(),t.lerpDatas=[];for(var e in this.lerpDatas)t.lerpDatas[e]=this.lerpDatas[e].clone();return t},EffectFrameData.prototype.dispose=function(){this.attrsData=null,this.lerpDatas&&(this.lerpDatas.length=0)},EffectFrameData}();e.EffectFrameData=n;var s=function(){function EffectLerpData(){this.attrsList=[]}return EffectLerpData.prototype.clone=function(){var t=new EffectLerpData;t.type=this.type,t.fromFrame=this.fromFrame,t.toFrame=this.toFrame,t.attrsData=this.attrsData.clone();for(var e in this.attrsList)t.attrsList[e]=this.attrsList[e];return t},EffectLerpData}();e.EffectLerpData=s;var l=function(){function EffectActionData(){}return EffectActionData.prototype.clone=function(){var t=new EffectActionData;t.actionType=this.actionType,t.startFrame=this.startFrame,t.endFrame=this.endFrame,t.params=[];for(var e in this.params)t.params[e]=this.params[e];return t},EffectActionData}();e.EffectActionData=l;var h=function(){function EffectMatData(){}return EffectMatData.beEqual=function(t,e){return t.alphaCut==e.alphaCut&&t.diffuseTexture==e.diffuseTexture&&t.shader==e.shader},EffectMatData.prototype.clone=function(){var t=new EffectMatData;return t.shader=this.shader,t.diffuseTexture=this.diffuseTexture,t.alphaCut=this.alphaCut,t},EffectMatData}();e.EffectMatData=h;var c=function(){function EffectBatcher(e){this.beBufferInited=!1,this.effectElements=[],this._totalVertexCount=0,this._indexStartIndex=0,this._vbosize=0,this.vertexSize=0,this.vertexSize=t.render.meshData.calcByteSize(e)/4}return Object.defineProperty(EffectBatcher.prototype,"curTotalVertexCount",{get:function(){return this._totalVertexCount},set:function(t){this._totalVertexCount=t,this.resizeVboSize(this._totalVertexCount*this.vertexSize)},enumerable:!0,configurable:!0}),Object.defineProperty(EffectBatcher.prototype,"indexStartIndex",{get:function(){return this._indexStartIndex},set:function(t){if(this._indexStartIndex=t,null!=this.dataForEbo){var e=new Uint16Array(this._indexStartIndex);e.set(this.dataForEbo,0),this.dataForEbo=e}else this.dataForEbo=new Uint16Array(this._indexStartIndex)},enumerable:!0,configurable:!0}),EffectBatcher.prototype.resizeVboSize=function(t){if(!(this._vbosize>t))if(this._vbosize=t,null!=this.dataForVbo){var e=new Float32Array(this._vbosize);e.set(this.dataForVbo,0),this.dataForVbo=e}else this.dataForVbo=new Float32Array(this._vbosize)},EffectBatcher.prototype.dispose=function(){this.mesh.dispose(),this.mat.dispose(),this.dataForVbo=null,this.dataForEbo=null;for(var t in this.effectElements)this.effectElements[t].dispose()},EffectBatcher}();e.EffectBatcher=c;!function(t){t[t.None=0]="None",t[t.BeReady=1]="BeReady",t[t.Play=2]="Play",t[t.Pause=3]="Pause",t[t.Stop=4]="Stop",t[t.Dispose=5]="Dispose"}(e.EffectPlayStateEnum||(e.EffectPlayStateEnum={}));!function(t){t[t.SingleMeshType=0]="SingleMeshType",t[t.EmissionType=1]="EmissionType",t[t.MultiMeshType=2]="MultiMeshType"}(e.EffectElementTypeEnum||(e.EffectElementTypeEnum={}));var u;!function(t){t[t.Linear=0]="Linear"}(u=e.EffectLerpTypeEnum||(e.EffectLerpTypeEnum={}));var d;!function(t){t[t.None=0]="None",t[t.BillBoard=1]="BillBoard",t[t.StretchedBillBoard=2]="StretchedBillBoard",t[t.HorizontalBillBoard=3]="HorizontalBillBoard",t[t.VerticalBillBoard=4]="VerticalBillBoard",t[t.Mesh=5]="Mesh"}(d=e.RenderModel||(e.RenderModel={}))}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(t){var e;!function(t){t[t.burst=0]="burst",t[t.continue=1]="continue"}(e=t.ParticleEmissionType||(t.ParticleEmissionType={}));var a=function(){return function EmissionData(){this.type=e.burst}}();t.EmissionData=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function Emission(){this.beLoop=!1,this.paricleLoop=!1,this.singleMeshLoop=!1,this.renderModel=e.RenderModel.None,this.particleStartData=new t.framework.ParticleStartData}return Emission.prototype.getVboData=function(t){return void 0==this.dataForVbo&&(this.dataForVbo=this.mesh.data.genVertexDataArray(t)),this.dataForVbo},Emission.prototype.clone=function(){var e=new Emission;return void 0!=this.emissionType&&(e.emissionType=this.emissionType),void 0!=this.rootpos&&(e.rootpos=t.math.pool.clone_vector3(this.rootpos)),void 0!=this.rootRotAngle&&(e.rootRotAngle=t.math.pool.clone_vector3(this.rootRotAngle)),void 0!=this.rootScale&&(e.rootScale=t.math.pool.clone_vector3(this.rootScale)),void 0!=this.maxEmissionCount&&(e.maxEmissionCount=this.maxEmissionCount),void 0!=this.emissionCount&&(e.emissionCount=this.emissionCount),void 0!=this.time&&(e.time=this.time),void 0!=this.pos&&(e.pos=this.pos.clone()),e.beLoop=this.beLoop,void 0!=this.simulationSpeed&&(e.simulationSpeed=this.simulationSpeed.clone()),void 0!=this.moveSpeed&&(e.moveSpeed=this.moveSpeed.clone()),void 0!=this.gravity&&(e.gravity=this.gravity),void 0!=this.euler&&(e.euler=this.euler.clone()),void 0!=this.eulerNodes&&(e.eulerNodes=this.cloneParticleNodeArray(this.eulerNodes)),void 0!=this.eulerSpeed&&(e.eulerSpeed=this.eulerSpeed.clone()),void 0!=this.scale&&(e.scale=this.scale.clone()),void 0!=this.scaleNodes&&(e.scaleNodes=this.cloneParticleNodeNumberArray(this.scaleNodes)),void 0!=this.scaleSpeed&&(e.scaleSpeed=this.scaleSpeed.clone()),void 0!=this.color&&(e.color=this.color.clone()),void 0!=this.colorRate&&(e.colorRate=this.colorRate),void 0!=this.colorNodes&&(e.colorNodes=this.cloneParticleNodeArray(this.colorNodes)),void 0!=this.colorSpeed&&(e.colorSpeed=this.colorSpeed.clone()),void 0!=this.simulationSpeed&&(e.simulationSpeed=this.simulationSpeed.clone()),void 0!=this.alpha&&(e.alpha=this.alpha.clone()),void 0!=this.alphaNodes&&(e.alphaNodes=this.cloneParticleNodeNumberArray(this.alphaNodes)),void 0!=this.alphaSpeed&&(e.alphaSpeed=this.alphaSpeed.clone()),void 0!=this.uv&&(e.uv=this.uv.clone()),void 0!=this.uvType&&(e.uvType=this.uvType),void 0!=this.uvRoll&&(e.uvRoll=this.uvRoll.clone()),void 0!=this.uvSprite&&(e.uvSprite=this.uvSprite.clone()),void 0!=this.mat&&(e.mat=this.mat.clone()),void 0!=this.life&&(e.life=this.life.clone()),void 0!=this.renderModel&&(e.renderModel=this.renderModel),void 0!=this.mesh&&(e.mesh=this.mesh),void 0!=this.dataForVbo&&(e.dataForVbo=this.dataForVbo),void 0!=this.particleStartData&&(e.particleStartData=this.particleStartData.clone()),e},Emission.prototype.getworldRotation=function(){},Emission.prototype.cloneParticleNodeArray=function(t){var e=new Array;for(var a in t)e.push(t[a].clone());return e},Emission.prototype.cloneParticleNodeNumberArray=function(t){var e=new Array;for(var a in t)e.push(t[a].clone());return e},Emission}();e.Emission=a;var r=function(){function UVSprite(){}return UVSprite.prototype.clone=function(){var t=new UVSprite;return t.row=this.row,t.column=this.column,t.totalCount=this.totalCount,t},UVSprite}();e.UVSprite=r;var i=function(){function UVRoll(){}return UVRoll.prototype.clone=function(){var t=new UVRoll;if(void 0!=this.uvSpeed&&(t.uvSpeed=this.uvSpeed),void 0!=this.uvSpeedNodes){var e=new Array;for(var a in this.uvSpeedNodes)e.push(this.uvSpeedNodes[a].clone());t.uvSpeedNodes=e}return t},UVRoll}();e.UVRoll=i;!function(t){t[t.NONE=0]="NONE",t[t.UVRoll=1]="UVRoll",t[t.UVSprite=2]="UVSprite"}(e.UVTypeEnum||(e.UVTypeEnum={}))}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function ParticleNode(){this.x=new e.ValueData,this.y=new e.ValueData,this.z=new e.ValueData}return ParticleNode.prototype.getValue=function(){return new t.math.vector3(this.x.getValue(),this.y.getValue(),this.z.getValue())},ParticleNode.prototype.getValueRandom=function(){return new t.math.vector3(this.x.getValueRandom(),this.y.getValueRandom(),this.z.getValueRandom())},ParticleNode.prototype.clone=function(){var t=new ParticleNode;return void 0!=this.x&&(t.x=this.x.clone()),void 0!=this.y&&(t.y=this.y.clone()),void 0!=this.z&&(t.z=this.z.clone()),void 0!=this.key&&(t.key=this.key),t},ParticleNode}();e.ParticleNode=a;var r=function(){function AlphaNode(){this.alpha=new e.ValueData}return AlphaNode.prototype.getValue=function(){return this.alpha.getValue()},AlphaNode}();e.AlphaNode=r;var i=function(){function UVSpeedNode(){this.u=new e.ValueData,this.v=new e.ValueData}return UVSpeedNode.prototype.getValue=function(){return new t.math.vector2(this.u.getValue(),this.v.getValue())},UVSpeedNode.prototype.getValueRandom=function(){return new t.math.vector2(this.u.getValueRandom(),this.v.getValueRandom())},UVSpeedNode.prototype.clone=function(){var t=new UVSpeedNode;return t.u=this.u.clone(),t.v=this.v.clone(),void 0!=this.key&&(t.key=this.key),t},UVSpeedNode}();e.UVSpeedNode=i;var o=function(){function ParticleNodeVec2(){this.x=new e.ValueData,this.y=new e.ValueData}return ParticleNodeVec2.prototype.getValue=function(){return new t.math.vector2(this.x.getValue(),this.y.getValue())},ParticleNodeVec2.prototype.getValueRandom=function(){return new t.math.vector2(this.x.getValueRandom(),this.y.getValueRandom())},ParticleNodeVec2.prototype.clone=function(){var t=new ParticleNodeVec2;return t.x=this.x.clone(),t.y=this.y.clone(),void 0!=this.key&&(t.key=this.key),t},ParticleNodeVec2}();e.ParticleNodeVec2=o;var n=function(){function ParticleNodeNumber(){this.num=new e.ValueData}return ParticleNodeNumber.prototype.getValue=function(){return this.num.getValue()},ParticleNodeNumber.prototype.getValueRandom=function(){return this.num.getValueRandom()},ParticleNodeNumber.prototype.clone=function(){var t=new ParticleNodeNumber;return t.num=this.num.clone(),void 0!=this.key&&(t.key=this.key),t},ParticleNodeNumber}();e.ParticleNodeNumber=n}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a;!function(t){t[t.NORMAL=0]="NORMAL",t[t.BOX=1]="BOX",t[t.SPHERE=2]="SPHERE",t[t.HEMISPHERE=3]="HEMISPHERE",t[t.CONE=4]="CONE",t[t.EDGE=5]="EDGE",t[t.CIRCLE=6]="CIRCLE"}(a=e.ParticleSystemShape||(e.ParticleSystemShape={}));var r=function(){function ParticleStartData(){this.shapeType=a.NORMAL,this._position=new t.math.vector3(0,0,0),this._direction=new t.math.vector3(0,1,0),this._width=0,this._height=0,this.depth=0,this._radius=0,this._angle=0,this.emitFrom=i.base}return Object.defineProperty(ParticleStartData.prototype,"position",{get:function(){return this._position},set:function(e){t.math.vec3Clone(e,this._position)},enumerable:!0,configurable:!0}),Object.defineProperty(ParticleStartData.prototype,"direction",{get:function(){return this._direction},set:function(e){t.math.vec3Clone(e,this._direction)},enumerable:!0,configurable:!0}),Object.defineProperty(ParticleStartData.prototype,"width",{get:function(){return this._width},set:function(t){this._width=t},enumerable:!0,configurable:!0}),Object.defineProperty(ParticleStartData.prototype,"height",{get:function(){return this._height},set:function(t){this._height=t},enumerable:!0,configurable:!0}),Object.defineProperty(ParticleStartData.prototype,"radius",{get:function(){return this._radius},set:function(t){this._radius=t},enumerable:!0,configurable:!0}),Object.defineProperty(ParticleStartData.prototype,"angle",{get:function(){return this._angle},set:function(t){this._angle=t},enumerable:!0,configurable:!0}),Object.defineProperty(ParticleStartData.prototype,"randomDirection",{get:function(){switch(this.shapeType){case a.BOX:return this.boxDirection;case a.SPHERE:return this.sphereDirection;case a.HEMISPHERE:return this.hemisphereDirection;case a.CONE:return this.coneDirection;case a.CIRCLE:return this.circleDirection;case a.EDGE:return this.edgeDirection;default:return this.direction}},enumerable:!0,configurable:!0}),Object.defineProperty(ParticleStartData.prototype,"boxDirection",{get:function(){return this.position.x=e.ValueData.RandomRange(-this.width/2,this.width/2),this.position.y=e.ValueData.RandomRange(-this.height/2,this.height/2),this.position.z=e.ValueData.RandomRange(-this.depth/2,this.depth/2),t.math.vec3Normalize(this.position,this.direction),this.direction},enumerable:!0,configurable:!0}),Object.defineProperty(ParticleStartData.prototype,"sphereDirection",{get:function(){var e=Math.random()*Math.PI*2,a=Math.random()*Math.PI,r=Math.random()*this.radius;return this.direction.x=Math.sin(a)*Math.cos(e),this.direction.y=Math.cos(a),this.direction.z=Math.sin(a)*Math.sin(e),t.math.vec3ScaleByNum(this.direction,r,this.position),this.direction},enumerable:!0,configurable:!0}),Object.defineProperty(ParticleStartData.prototype,"hemisphereDirection",{get:function(){var e=Math.random()*Math.PI*2,a=Math.random()*Math.PI*.5,r=Math.random()*this.radius;return this.direction.x=Math.sin(a)*Math.cos(e),this.direction.y=Math.cos(a),this.direction.z=Math.sin(a)*Math.sin(e),t.math.vec3ScaleByNum(this.direction,r,this.position),this.direction},enumerable:!0,configurable:!0}),Object.defineProperty(ParticleStartData.prototype,"coneDirection",{get:function(){var e=Math.random()*Math.PI*2,a=Math.random()*this.height,r=a*Math.tan(this.angle*Math.PI/180)+this.radius,o=Math.random()*r,n=t.math.pool.new_vector3();return n.x=this.radius*Math.cos(e),n.y=0,n.z=this.radius*Math.sin(e),this.emitFrom==i.base?t.math.vec3Clone(n,this.position):this.emitFrom==i.volume&&(this.position.x=o*Math.cos(e),this.position.z=o*Math.sin(e),this.position.y=a),this.direction.x=Math.cos(e)*Math.sin(this.angle*Math.PI/180),this.direction.z=Math.sin(e)*Math.sin(this.angle*Math.PI/180),this.direction.y=Math.cos(this.angle*Math.PI/180),this.direction},enumerable:!0,configurable:!0}),Object.defineProperty(ParticleStartData.prototype,"circleDirection",{get:function(){var a=this.angle*(Math.PI/180),r=e.ValueData.RandomRange(-a/2,a/2),i=e.ValueData.RandomRange(0,this.radius);this.direction.x=i*Math.cos(r),this.direction.z=i*Math.sin(r),this.direction.y=0;var o=t.math.vec3Length(this.direction);return t.math.vec3Normalize(this.direction,this.direction),e.EffectUtil.RotateVector3(this.direction,this.direction,this.direction),this.getposition(this.direction,o),this.direction},enumerable:!0,configurable:!0}),Object.defineProperty(ParticleStartData.prototype,"edgeDirection",{get:function(){var a=new t.math.vector3(0,0,0);a.y+=e.ValueData.RandomRange(-this.radius/2,this.radius/2);t.math.vec3Length(a);return e.EffectUtil.RotateVector3(a,this.direction,a),t.math.vec3Clone(this.direction,this.direction),this.getposition(a,length),this.direction},enumerable:!0,configurable:!0}),ParticleStartData.prototype.getposition=function(e,a){t.math.vec3ScaleByNum(e,a,e),this.position.x=e.x,this.position.y=e.y,this.position.z=e.z},ParticleStartData.prototype.clone=function(){var e=new ParticleStartData;return e.shapeType=this.shapeType,e._position=new t.math.vector3,t.math.vec3Clone(this._position,e._position),e._direction=new t.math.vector3,t.math.vec3Clone(this._direction,e._direction),e._width=this._width,e._height=this._height,e.depth=this.depth,e._radius=this._radius,e._angle=this._angle,e.position=new t.math.vector3,t.math.vec3Clone(this.position,e.position),e.direction=new t.math.vector3,t.math.vec3Clone(this.direction,e.direction),e},ParticleStartData}();e.ParticleStartData=r;var i;!function(t){t[t.base=0]="base",t[t.volume=1]="volume"}(i=e.emitfromenum||(e.emitfromenum={}))}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(t){var e=function(){function ValueData(){this.isRandom=!0,this._value=0,this._valueLimitMin=0,this._valueLimitMax=0,this.beInited=!1}return Object.defineProperty(ValueData.prototype,"value",{set:function(t){this._value=t,this.isRandom=!1},enumerable:!0,configurable:!0}),Object.defineProperty(ValueData.prototype,"valueLimitMin",{set:function(t){this._valueLimitMin=t,this.isRandom=!0},enumerable:!0,configurable:!0}),Object.defineProperty(ValueData.prototype,"valueLimitMax",{set:function(t){this._valueLimitMax=t,this.isRandom=!0},enumerable:!0,configurable:!0}),ValueData.prototype.clone=function(){var t=new ValueData;return t.isRandom=this.isRandom,t._value=this._value,t._valueLimitMin=this._valueLimitMin,t._valueLimitMax=this._valueLimitMax,t},ValueData.prototype.getValue=function(){return this.isRandom&&(this.beInited||(this._value=ValueData.RandomRange(this._valueLimitMin,this._valueLimitMax),this.beInited=!0)),this._value},ValueData.prototype.getValueRandom=function(){return this.isRandom&&(this._value=ValueData.RandomRange(this._valueLimitMin,this._valueLimitMax)),this._value},ValueData.RandomRange=function(t,e,a){return void 0===a&&(a=!1),a?Math.floor(Math.random()*(e-t+1)+t):Math.random()*(e-t)+t},ValueData}();t.ValueData=e}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function Curve3(t,e){this._beizerPoints=t,this._bezierPointNum=e}return Object.defineProperty(Curve3.prototype,"beizerPoints",{get:function(){return this._beizerPoints},set:function(t){this._beizerPoints=t},enumerable:!0,configurable:!0}),Object.defineProperty(Curve3.prototype,"bezierPointNum",{get:function(){return this._bezierPointNum},set:function(t){this._bezierPointNum=t},enumerable:!0,configurable:!0}),Curve3.CreateLinearBezier=function(e,a,r){r=r>2?r:3;var i=new Array,o=function(t,e,a){return(1-t)*e+t*a};i.push(e);for(var n=1;n<=r;n++)i.push(new t.math.vector3(o(n/r,e.x,a.x),o(n/r,e.y,e.y),o(n/r,e.z,e.z)));return new Curve3(i,r)},Curve3.GetLerpBezier=function(t){for(var e=new Array,a=0;a<t.length;a++)e.push(t[a].getValue());return new Curve3(e,t.length)},Curve3.CreateQuadraticBezier=function(e,a,r,i){i=i>2?i:3;for(var o=new Array,n=function(t,e,a,r){return(1-t)*(1-t)*e+2*t*(1-t)*a+t*t*r},s=1;s<=i;s++)o.push(new t.math.vector3(n(s/i,e.x,a.x,r.x),n(s/i,e.y,a.y,r.y),n(s/i,e.z,a.z,r.z)));return new Curve3(o,i)},Curve3.CreateCubicBezier=function(e,a,r,i,o){o=o>3?o:4;for(var n=new Array,s=function(t,e,a,r,i){return(1-t)*(1-t)*(1-t)*e+3*t*(1-t)*(1-t)*a+3*t*t*(1-t)*r+t*t*t*i},l=1;l<=o;l++)n.push(new t.math.vector3(s(l/o,e.x,a.x,r.x,i.x),s(l/o,e.y,a.y,r.y,i.y),s(l/o,e.z,a.z,r.z,i.z)));return new Curve3(n,o)},Curve3.prototype.getPoints=function(){return this._beizerPoints},Curve3}();e.Curve3=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function LinearAction(){}return LinearAction.prototype.init=function(t,a,r,i){if(this.startFrame=t,this.endFrame=a,this.params=r,this.elements=i,void 0!=this.params)switch(this.attriname=this.params.name,this.attriname){case"pos":case"scale":case"euler":case"color":this.attrival=e.EffectUtil.parseEffectVec3(this.params.value);break;case"uv":this.attrival=e.EffectUtil.parseEffectUVSpeed(this.params.value);break;case"alpha":this.attrival=this.params.value}},LinearAction.prototype.update=function(t){if(!(this.startFrame>t||this.endFrame<t)){var e=this.elements.curAttrData;switch(this.attriname){case"pos":e.pos.x=e.pos.x+this.attrival.x.getValue(),e.pos.y=e.pos.y+this.attrival.y.getValue(),e.pos.z=e.pos.z+this.attrival.z.getValue();break;case"scale":e.scale.x=e.scale.x+this.attrival.x.getValue(),e.scale.y=e.scale.y+this.attrival.y.getValue(),e.scale.z=e.scale.z+this.attrival.z.getValue();break;case"euler":e.euler.x=e.euler.x+this.attrival.x.getValue(),e.euler.y=e.euler.y+this.attrival.y.getValue(),e.euler.z=e.euler.z+this.attrival.z.getValue();break;case"color":e.color.x=e.color.x+this.attrival.x.getValue(),e.color.y=e.color.y+this.attrival.y.getValue(),e.color.z=e.color.z+this.attrival.z.getValue();break;case"uv":e.uv.x=e.uv.x+this.attrival.u.getValue(),e.uv.y=e.uv.y+this.attrival.v.getValue();break;case"alpha":e.alpha=e.alpha+this.attrival}}},LinearAction}();e.LinearAction=a;var r=function(){function DestroyAction(){}return DestroyAction.prototype.init=function(t,e,a,r){this.startFrame=t,this.endFrame=e,this.params=a,this.elements=r},DestroyAction.prototype.update=function(t){t>=this.startFrame&&this.elements.setActive(!1)},DestroyAction}();e.DestroyAction=r;var i=function(){function LoopAction(){}return LoopAction.prototype.init=function(t,e,a,r){this.startFrame=t,this.endFrame=e,this.params=a,this.elements=r},LoopAction.prototype.update=function(t){t==this.startFrame&&(this.elements.loopFrame=this.startFrame+1,this.elements.curAttrData=this.elements.data.initFrameData.attrsData.copyandinit())},LoopAction}();e.LoopAction=i;var o=function(){function UVRollAction(){this.speedu=0,this.speedv=0,this.startu=0,this.startv=0}return UVRollAction.prototype.init=function(t,e,a,r){this.startFrame=t,this.endFrame=e,this.params=a,this.elements=r,void 0!=this.params.speedu&&(this.speedu=this.params.speedu),void 0!=this.params.speedv&&(this.speedv=this.params.speedv),void 0!=this.params.startu&&(this.startu=this.params.startu),void 0!=this.params.startv&&(this.startv=this.params.startv)},UVRollAction.prototype.update=function(t){if(!(this.startFrame>t||this.endFrame<t)){if(this.startFrame==t)return this.elements.curAttrData.uv.x=this.startu,void(this.elements.curAttrData.uv.y=this.startv);this.elements.curAttrData.uv.x+=this.speedu,this.elements.curAttrData.uv.y+=this.speedv}},UVRollAction}();e.UVRollAction=o;var n=function(){function UVSpriteAnimationAction(){this.fps=30,this.row=1,this.colum=1,this.frameInternal=1,this.spriteIndex=0}return UVSpriteAnimationAction.prototype.init=function(t,a,r,i){this.startFrame=t,this.endFrame=a,this.params=r,this.elements=i,void 0!=this.params.fps&&(this.fps=this.params.fps,this.frameInternal=e.effectSystem.fps/this.fps),void 0!=this.params.row&&(this.row=this.params.row),void 0!=this.params.colum&&(this.colum=this.params.colum)},UVSpriteAnimationAction.prototype.update=function(t){this.startFrame>t||this.endFrame<t||(t-this.startFrame)%this.frameInternal==0&&(this.spriteIndex=(t-this.startFrame)/this.frameInternal,this.spriteIndex%=this.colum*this.row,this.elements.curAttrData.uv.x=this.spriteIndex%this.colum/this.colum,this.elements.curAttrData.uv.y=Math.floor(this.spriteIndex/this.colum)/this.row,this.elements.curAttrData.tilling.x=1/this.colum,this.elements.curAttrData.tilling.y=1/this.row)},UVSpriteAnimationAction}();e.UVSpriteAnimationAction=n;var s=function(){function RotationAction(){}return RotationAction.prototype.init=function(t,a,r,i){this.startFrame=t,this.endFrame=a,this.params=r,this.elements=i,void 0!=this.params.velocity&&(this.velocity=e.EffectUtil.parseEffectVec3(this.params.velocity)),this.frameInternal=1/e.effectSystem.fps},RotationAction.prototype.update=function(t){this.elements.curAttrData.euler.z=this.elements.curAttrData.euler.z+this.velocity.z.getValue()*this.frameInternal,this.elements.curAttrData.renderModel==e.RenderModel.None&&(this.elements.curAttrData.euler.x=this.elements.curAttrData.euler.x+this.velocity.x.getValue()*this.frameInternal,this.elements.curAttrData.euler.y=this.elements.curAttrData.euler.y+this.velocity.y.getValue()*this.frameInternal)},RotationAction}();e.RotationAction=s;var l=function(){function RoseCurveAction(){}return RoseCurveAction.prototype.init=function(t,a,r,i){this.startFrame=t,this.endFrame=a,this.params=r,this.elements=i,void 0!=this.params.radius&&(this.radius=this.params.radius),void 0!=this.params.level&&(this.level=this.params.radius),void 0!=this.params.speed&&(this.speed=this.params.speed),void 0!=this.params.polar&&(this.polar=e.EffectUtil.parseEffectVec3(this.params.polar)),this.frameInternal=1/e.effectSystem.fps},RoseCurveAction.prototype.update=function(e){var a=t.math.pool.new_vector3();t.math.vec3Clone(this.elements.data.initFrameData.attrsData.pos,a);var r=this.radius,i=this.polar.x.getValue(),o=this.polar.y.getValue(),n=(this.polar.z.getValue(),e*this.speed);this.elements.curAttrData.pos.x=a.x+r*Math.cos(3*n+i)*Math.cos(n),this.elements.curAttrData.pos.z=a.z+r*Math.cos(3*n+i)*Math.sin(n),this.elements.curAttrData.pos.y=a.y+o*Math.cos(e*this.speed);var s=e*this.speed+.001,l=t.math.pool.new_vector3();l.x=a.x+r*Math.cos(3*s+i)*Math.cos(s),l.z=a.z+r*Math.cos(3*s+i)*Math.sin(s),l.y=a.y+o*Math.cos(e*this.speed);var h=t.math.pool.new_quaternion();t.math.quatLookat(this.elements.curAttrData.pos,l,h),t.math.quatToEulerAngles(h,this.elements.curAttrData.euler),t.math.pool.delete_vector3(l),t.math.pool.delete_quaternion(h),t.math.pool.delete_vector3(a)},RoseCurveAction}();e.RoseCurveAction=l;var h=function(){function TrailAction(){this.offsetTransalte=new t.math.vector3}return TrailAction.prototype.init=function(a,r,i,o){this.startFrame=a,this.endFrame=r,this.params=i,this.elements=o,void 0!=this.params.pos&&(this.position=e.EffectUtil.parseEffectVec3(this.params.pos)),this.offsetTransalte.x=this.position.x.getValue(),this.offsetTransalte.y=this.position.y.getValue(),this.offsetTransalte.z=this.position.z.getValue(),void 0!=this.params.eular&&(this.eular=e.EffectUtil.parseEffectVec3(this.params.eular)),void 0!=this.params.color&&(this.color=e.EffectUtil.parseEffectVec3(this.params.color)),void 0!=this.params.width&&(this.width=this.params.width),void 0!=this.params.speed&&(this.speed=this.params.speed),void 0!=this.params.speed&&(this.speed=this.params.speed),void 0!=this.params.alpha&&(this.alpha=this.params.alpha);var n=new t.framework.material,s=new t.framework.shader,l=new t.framework.texture;s=void 0!=this.params.shader?e.sceneMgr.app.getAssetMgr().getShader(this.params.shader):e.sceneMgr.app.getAssetMgr().getShader("shader/def"),n.setShader(s),void 0!=this.params.diffuseTexture&&(l=e.sceneMgr.app.getAssetMgr().getAssetByName(this.params.diffuseTexture)),n.setTexture("_MainTex",l),this.frameInternal=1/e.effectSystem.fps,this.transform=new t.framework.transform,e.sceneMgr.scene.addChild(this.transform);var h=this.elements.data.initFrameData.attrsData.clone(),c=t.math.pool.new_vector3();t.math.vec3Clone(h.pos,c),void 0!=this.elements.transform&&t.math.matrixTransformVector3(c,this.elements.transform.getWorldMatrix(),c),t.math.vec3Clone(c,this.transform.localTranslate),t.math.pool.delete_vector3(c);var u=new t.framework.transform;this.transform.addChild(u);var d=this.eular.x.getValue(),m=this.eular.y.getValue(),p=this.eular.z.getValue();this.startRotation=new t.math.quaternion,t.math.quatFromEulerAngles(d,m,p,this.startRotation),t.math.quatMultiply(this.startRotation,h.localRotation,this.transform.localRotate),this.transform.markDirty(),u.markDirty();var f=u.gameObject.addComponent("trailRender");f.color=new t.math.color(this.color.x.getValue(),this.color.y.getValue(),this.color.z.getValue(),this.alpha),f.setspeed(this.speed),f.setWidth(this.width),f.material=n},TrailAction.prototype.update=function(e){var a=t.math.pool.new_vector3();t.math.vec3Clone(this.elements.curAttrData.pos,a),void 0!=this.elements.transform&&t.math.matrixTransformVector3(a,this.elements.transform.getWorldMatrix(),a),t.math.vec3Clone(a,this.transform.localTranslate),t.math.vec3Add(this.transform.localTranslate,this.offsetTransalte,this.transform.localTranslate),t.math.pool.delete_vector3(a),t.math.quatMultiply(this.startRotation,this.elements.curAttrData.localRotation,this.transform.localRotate),this.transform.markDirty()},TrailAction}();e.TrailAction=h;var c=function(){function BreathAction(){}return BreathAction.prototype.init=function(t,a,r,i){if(this.startFrame=t,this.endFrame=a,this.params=r,this.elements=i,void 0!=this.params)switch(this.attriname=this.params.name,this.loopframe=this.params.loopframe,this.halfloopframe=this.loopframe/2,this.curTargetFrame=this.startFrame+this.halfloopframe,this.attriname){case"pos":case"scale":case"euler":case"color":this.startvalue=e.EffectUtil.parseEffectVec3(this.params.startvalue).getValue(),this.targetvalue=e.EffectUtil.parseEffectVec3(this.params.targetvalue).getValue();break;case"uv":this.startvalue=e.EffectUtil.parseEffectUVSpeed(this.params.startvalue).getValue(),this.targetvalue=e.EffectUtil.parseEffectUVSpeed(this.params.targetvalue).getValue();break;case"alpha":this.startvalue=this.params.startvalue,this.targetvalue=this.params.targetvalue}},BreathAction.prototype.update=function(t){if(!(this.startFrame>t)){t>=this.curTargetFrame&&(this.swap(),this.curTargetFrame+=this.halfloopframe);var e=this.elements.curAttrData;switch(this.attriname){case"pos":e.pos=this.getLerpValue(t);break;case"scale":e.scale=this.getLerpValue(t);break;case"euler":e.euler=this.getLerpValue(t);break;case"color":e.color=this.getLerpValue(t);break;case"uv":e.uv=this.getLerpValue(t);break;case"alpha":e.alpha=this.getLerpValue(t)}}},BreathAction.prototype.swap=function(){var e;this.startvalue instanceof t.math.vector3?(e=t.math.pool.clone_vector3(this.startvalue),this.startvalue=t.math.pool.clone_vector3(this.targetvalue),this.targetvalue=e):this.startvalue instanceof t.math.vector2?(e=t.math.pool.clone_vector2(this.startvalue),this.startvalue=t.math.pool.clone_vector2(this.targetvalue),this.targetvalue=e):(e=this.startvalue,this.startvalue=this.targetvalue,this.targetvalue=e)},BreathAction.prototype.getLerpValue=function(e){var a,r=(e-this.startFrame)%this.halfloopframe;return this.startvalue instanceof t.math.vector3?(a=new t.math.vector3,t.math.vec3SLerp(this.startvalue,this.targetvalue,r/this.halfloopframe,a)):this.startvalue instanceof t.math.vector2?(a=new t.math.vector2,t.math.vec2SLerp(this.startvalue,this.targetvalue,r/this.halfloopframe,a)):a=t.math.numberLerp(this.startvalue,this.targetvalue,r/this.halfloopframe),a},BreathAction}();e.BreathAction=c}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function EffectParser(){}return EffectParser.prototype.Parse=function(t,a){if(null==t)return null;this.asMgr=a;var r=new e.EffectSystemData,i=JSON.parse(t);if(void 0!=i.life&&(r.life=i.life),void 0!=i.beloop&&(r.beLoop=i.beloop),void 0!=i.elements){r.elements=[];var o=i.elements;for(var n in o){var s=new e.EffectElementData;r.elements.push(s);var l=o[n];if(void 0!=l.name&&(s.name=l.name),void 0!=l.ref&&(s.ref=l.ref),void 0!=l.beloop&&(s.beloop=l.beloop),void 0!=l.type)switch(l.type){case"singlemesh":s.type=e.EffectElementTypeEnum.SingleMeshType;break;case"emission":s.type=e.EffectElementTypeEnum.EmissionType}switch(s.type){case e.EffectElementTypeEnum.SingleMeshType:this._parseSingleMeshTypeData(l,s);break;case e.EffectElementTypeEnum.EmissionType:this._parseEmissionTypeData(l,s)}}}return r},EffectParser.prototype._parseSingleMeshTypeData=function(t,a){if(void 0!=t.timeline){a.timelineFrame={},a.actionData=[];var r=t.timeline;for(var i in r){var o=r[i];if(void 0!=o.frame){var n=new e.EffectFrameData;if(n.frameIndex=o.frame,a.timelineFrame[n.frameIndex]=n,n.attrsData=new e.EffectAttrsData,void 0!=o.attrs){var s=o.attrs;for(var l in s){m=this._parseToObjData(l,s[l]);"mat"==l?n.attrsData.mat=m:"pos"==l?n.attrsData.pos=m.getValue():"scale"==l?n.attrsData.scale=m.getValue():"euler"==l?n.attrsData.euler=m.getValue():"mesh"==l?n.attrsData.mesh=m:"color"==l?n.attrsData.color=m.getValue():"alpha"==l?n.attrsData.alpha=m.getValue():"tilling"==l?n.attrsData.tilling=m.getValue():"billboard"==l?n.attrsData.renderModel=m:"colorRate"==l&&(n.attrsData.colorRate=m)}}if(-1==n.frameIndex&&(a.initFrameData=n),void 0!=o.lerp){n.lerpDatas=[];for(var h in o.lerp){var c=new e.EffectLerpData;c.fromFrame=n.frameIndex,n.lerpDatas.push(c);var u=o.lerp[h];if(void 0!=u.type)switch(u.type){case"linear":c.type=e.EffectLerpTypeEnum.Linear}if(void 0!=u.to&&(c.toFrame=this._parseToValueData(u.to)),void 0!=u.attribute){c.attrsData=new e.EffectAttrsData;var d=u.attribute;for(var l in d){c.attrsList.push(l);var m=this._parseToObjData(l,d[l]);"pos"==l?c.attrsData.pos=m.getValue():"scale"==l?c.attrsData.scale=m.getValue():"euler"==l?c.attrsData.euler=m.getValue():"color"==l?c.attrsData.color=m.getValue():"alpha"==l?c.attrsData.alpha=m.getValue():console.error("未支持的插值属性："+l)}}}}if(void 0!=o.actions){var p=o.actions;for(var f in p){var v=new e.EffectActionData,g=p[f];v.actionType=g.action,v.startFrame=n.frameIndex,void 0!=g.end?v.endFrame=g.end:v.endFrame=-1,void 0!=g.param&&(v.params=g.param),a.actionData.push(v)}}}else console.error("必须要配一个关键帧的索引")}}},EffectParser.prototype._parseEmissionTypeData=function(a,r){if(void 0!=a.timeline&&void 0!=a.timeline.attrs){var i=a.timeline.attrs,o=new e.Emission;if(r.emissionData=o,void 0!=i.emissionType){switch(i.emissionType){case"burst":o.emissionType=e.ParticleEmissionType.burst;break;case"continue":o.emissionType=e.ParticleEmissionType.continue}if(void 0!=i.maxcount&&(o.maxEmissionCount=i.maxcount),void 0!=i.emissioncount&&(o.emissionCount=i.emissioncount),void 0!=i.time&&(o.time=i.time),void 0!=i.mesh&&(o.mesh=this._parseToObjData("mesh",i.mesh)),void 0!=i.mat&&(o.mat=this._parseToObjData("mat",i.mat)),void 0!=i.rootpos?o.rootpos=e.EffectUtil.parseVector3(i.rootpos):o.rootpos=new t.math.vector3,void 0!=i.rootRotAngle?o.rootRotAngle=e.EffectUtil.parseVector3(i.rootRotAngle):o.rootRotAngle=new t.math.vector3,i.rootscale?o.rootScale=e.EffectUtil.parseVector3(i.rootscale):o.rootScale=new t.math.vector3(1,1,1),void 0!=i.moveSpeed&&(o.moveSpeed=this._parseToObjData("moveSpeed",i.moveSpeed)),void 0!=i.gravity&&(o.gravity=i.gravity),void 0!=i.euler&&(o.euler=this._parseToObjData("euler",i.euler)),void 0!=i.eulerSpeed&&(o.eulerSpeed=this._parseToObjData("eulerSpeed",i.eulerSpeed)),void 0!=i.eulerNodes){o.eulerNodes=[],void 0!=o.euler&&(o.eulerNodes.push(o.euler),o.euler.key=0);for(var n in i.eulerNodes){l=e.EffectUtil.parseEffectVec3(i.eulerNodes[n]);o.eulerNodes.push(l)}}if(void 0!=i.scale&&(o.scale=this._parseToObjData("scale",i.scale)),void 0!=i.scaleSpeed&&(o.scaleSpeed=this._parseToObjData("scaleSpeed",i.scaleSpeed)),void 0!=i.scaleNodes){o.scaleNodes=[];var s=new e.ParticleNodeNumber;s.num.value=1,s.key=0,o.scaleNodes.push(s);for(var n in i.scaleNodes){l=e.EffectUtil.parseEffectNumNode(i.scaleNodes[n]);o.scaleNodes.push(l)}}if(void 0!=i.simulationSpeed&&(o.simulationSpeed=this._parseToObjData("simulationSpeed",i.simulationSpeed)),void 0!=i.alpha&&(o.alpha=this._parseToObjData("alpha",i.alpha)),void 0!=i.alphaSpeed&&(o.alphaSpeed=this._parseToObjData("alphaSpeed",i.alphaSpeed)),void 0!=i.alphaNodes){o.alphaNodes=[],void 0!=o.alpha&&(o.alphaNodes.push(o.alpha),o.alpha.key=0);for(var n in i.alphaNodes){var l=new e.ParticleNodeNumber,h=i.alphaNodes[n];null!=h.key&&(l.key=h.key);var c=h.alpha;null!=c&&(c instanceof Array?(l.num.valueLimitMin=c[0],l.num.valueLimitMax=c[1]):l.num.value=c),o.alphaNodes.push(l)}}if(void 0!=i.color&&(o.color=this._parseToObjData("color",i.color)),void 0!=i.colorRate&&(o.colorRate=i.colorRate),void 0!=i.colorSpeed&&(o.colorSpeed=this._parseToObjData("colorSpeed",i.colorSpeed)),void 0!=i.colorNodes){o.colorNodes=[],void 0!=o.color&&(o.colorNodes.push(o.color),o.color.key=0);for(var n in i.colorNodes){l=e.EffectUtil.parseEffectVec3(i.colorNodes[n]);o.colorNodes.push(l)}}if(void 0!=i.uv&&(o.uv=e.EffectUtil.parseEffectVec2(i.uv)),void 0!=i.uvtype)switch(i.uvtype){case"uvroll":o.uvType=e.UVTypeEnum.UVRoll,void 0!=i.uvroll&&(o.uvRoll=new e.UVRoll,o.uvRoll.uvSpeed=e.EffectUtil.parseEffectUVSpeed(i.uvroll));break;case"uvsprite":var u=i.uvsprite;o.uvType=e.UVTypeEnum.UVSprite,o.uvSprite=new e.UVSprite,void 0!=u.row&&(o.uvSprite.row=u.row),void 0!=u.colum&&(o.uvSprite.column=u.colum),void 0!=u.count&&(o.uvSprite.totalCount=u.count);break;default:o.uvType=e.UVTypeEnum.NONE}else o.uvType=e.UVTypeEnum.NONE;void 0!=i.billboard&&(o.renderModel=this._parseToObjData("billboard",i.billboard)),void 0!=i.life&&(o.life=e.EffectUtil.parseEffectValueData(i.life)),void 0!=i.startpos&&this._parseEmissionShape(i.startpos,r)}}},EffectParser.prototype._parseEmissionShape=function(e,a){var r=a.emissionData.particleStartData;switch(e.type){case"normal":r.shapeType=t.framework.ParticleSystemShape.NORMAL;break;case"box":r.shapeType=t.framework.ParticleSystemShape.BOX;break;case"sphere":r.shapeType=t.framework.ParticleSystemShape.SPHERE;break;case"hemisphere":r.shapeType=t.framework.ParticleSystemShape.HEMISPHERE;break;case"cone":r.shapeType=t.framework.ParticleSystemShape.CONE;break;case"circle":r.shapeType=t.framework.ParticleSystemShape.CIRCLE;break;case"edge":r.shapeType=t.framework.ParticleSystemShape.EDGE;break;default:r.shapeType=t.framework.ParticleSystemShape.NORMAL}if(void 0!=e.width&&(r.width=e.width),void 0!=e.height&&(r.height=e.height),void 0!=e.depth&&(r.depth=e.depth),void 0!=e.angle&&(r.angle=e.angle),void 0!=e.radius&&(r.radius=e.radius),void 0!=e.direction){var i=e.direction;r.direction.x=i.x,r.direction.y=i.y,r.direction.z=i.z}},EffectParser.prototype._parseToObjData=function(t,a){switch(t){case"pos":case"scale":case"euler":case"color":case"moveSpeed":case"eulerSpeed":case"scaleSpeed":case"colorSpeed":return e.EffectUtil.parseEffectVec3(a);case"":return e.EffectUtil.parseEffectVec2(a);case"alphaSpeed":case"alpha":case"simulationSpeed":return e.EffectUtil.parseEffectNum(a);case"tilling":return e.EffectUtil.parseEffectVec2(a);case"mat":var r=new e.EffectMatData;return void 0!=a&&(void 0!=a.shader?r.shader=this.asMgr.getShader(a.shader):r.shader=this.asMgr.getShader("shader/def"),void 0!=a.diffuseTexture&&(r.diffuseTexture=this.asMgr.getAssetByName(a.diffuseTexture)),void 0!=a.alphaCut&&(r.alphaCut=a.alphaCut)),r;case"emmision":var i=new e.EmissionData;return void 0!=a.type&&(i.type=a.type),void 0!=a.time&&(i.time=a.time),void 0!=a.count&&(i.count=a.count),i;case"billboard":e.RenderModel.Mesh;return"billboard"==a?e.RenderModel.BillBoard:"horizontal"==a?e.RenderModel.HorizontalBillBoard:"stretched"==a?e.RenderModel.StretchedBillBoard:"vertical"==a?e.RenderModel.VerticalBillBoard:"mesh"==a?e.RenderModel.Mesh:e.RenderModel.None;case"mesh":return a.toString().indexOf(".mesh.bin")>=0?this.asMgr.getAssetByName(a):this.asMgr.getDefaultMesh(a);default:return a}},EffectParser.prototype._parseToParticleNode=function(t){var a=(t=e.StringUtil.replaceAll(t," ","")).match(e.RegexpUtil.vector3FloatOrRangeRegexp);if(void 0!=a){for(var r=new e.ParticleNode,i=1;i<a.length;i++)1==i?r.x=this._parseToValueData(a[i]):2==i?r.y=this._parseToValueData(a[i]):3==i&&(r.z=this._parseToValueData(a[i]));return r}return null},EffectParser.prototype._parseToValueData=function(t){var a=new e.ValueData,r=this._parseToNumberArray(t);return null!=r&&(r.length>1?(a.valueLimitMin=r[0],a.valueLimitMax=r[1],a.isRandom=!0):(a.value=r[0],a.isRandom=!1)),a},EffectParser.prototype._parseToNumberArray=function(t){t=e.StringUtil.trimAll(t),t=e.StringUtil.replaceAll(t,"\\[","");for(var a=(t=e.StringUtil.replaceAll(t,"\\]","")).split(","),r=[],i=0;i<a.length;i++)r.push(parseInt(a[i]));return r},EffectParser}();e.EffectParser=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function EffectUtil(){}return EffectUtil.lookatbyXAxis=function(e,a,r,i,o,n){var s=t.math.pool.new_vector3();t.math.vec3Subtract(o,e,s),t.math.vec3Normalize(s,s);var l=t.math.pool.new_vector3();t.math.vec3Cross(s,a,l),t.math.vec3Normalize(l,l);var h=t.math.vec3Dot(r,l);h=180*Math.acos(h)/Math.PI;var c=t.math.vec3Dot(i,l);(c=180*Math.acos(c)/Math.PI)>90&&(h=-h),t.math.quatFromAxisAngle(t.math.pool.vector3_right,h,n),t.math.pool.delete_vector3(s),t.math.pool.delete_vector3(l)},EffectUtil.RandomRange=function(t,e,a){return void 0===a&&(a=!1),a?Math.floor(Math.random()*(e-t+1)+t):Math.random()*(e-t)+t},EffectUtil.vecMuliNum=function(e,a){return new t.math.vector3(e.x*a,e.y*a,e.z*a)},EffectUtil.parseVector3=function(e){var a=new t.math.vector3;return a.x=e.x,a.y=e.y,a.z=e.z,a},EffectUtil.parseEffectVec3=function(t){var a=new e.ParticleNode;for(var r in t)t[r]instanceof Array?(a[r].valueLimitMin=t[r][0],a[r].valueLimitMax=t[r][1],a[r].isRandom=!0):"key"==r?a[r]=t[r]:(a[r].value=t[r],a[r].isRandom=!1);return a},EffectUtil.parseEffectVec2=function(t){var a=new e.ParticleNodeVec2;for(var r in t)t[r]instanceof Array?(a[r].valueLimitMin=t[r][0],a[r].valueLimitMax=t[r][1],a[r].isRandom=!0):"key"==r?a[r]=t[r]:(a[r].value=t[r],a[r].isRandom=!1);return a},EffectUtil.parseEffectNum=function(t){var a=new e.ParticleNodeNumber;return t instanceof Array?(a.num.valueLimitMin=t[0],a.num.valueLimitMax=t[1],a.num.isRandom=!0):(a.num.value=t,a.num.isRandom=!1),a},EffectUtil.parseEffectNumNode=function(t){var a=new e.ParticleNodeNumber;for(var r in t)t[r]instanceof Array?(a[r].valueLimitMin=t[r][0],a[r].valueLimitMax=t[r][1]):"key"==r?a[r]=t[r]:a.num.value=t[r];return a},EffectUtil.parseEffectValueData=function(t){var a=new e.ValueData;return t instanceof Array?(a.valueLimitMin=t[0],a.valueLimitMax=t[1],a.isRandom=!0):(a.value=t,a.isRandom=!1),a},EffectUtil.parseEffectUVSpeed=function(t){var a=new e.UVSpeedNode;for(var r in t)a[r].value=t[r];return a},EffectUtil.lookat=function(e,a,r,i){void 0===i&&(i=t.math.pool.vector3_up);var o=new t.math.vector3;t.math.vec3Subtract(a,e,o),t.math.vec3Normalize(o,o);var n=new t.math.vector3(o.x,0,o.z);t.math.vec3Normalize(n,n);var s=Math.acos(n.z)/Math.PI*180;n.x<0&&(s=-s),t.math.quatFromAxisAngle(i,s,r);var l=t.math.pool.new_vector3();t.math.vec3Cross(i,o,l),t.math.vec3Normalize(l,l);var h=new t.math.vector3(o.x,0,o.z),c=t.math.vec3Length(h),u=Math.acos(c)/Math.PI*180;o.y<0&&(u=-u);var d=t.math.pool.new_quaternion();t.math.quatFromAxisAngle(l,u,d)},EffectUtil.RotateVector3=function(e,a,r){t.math.vec3Normalize(e,e),t.math.vec3Normalize(a,a);var i=new t.math.vector3(0,0,1),o=t.math.pool.new_vector3();t.math.vec3Cross(i,a,o),t.math.vec3Normalize(o,o),0==o.x&&0==o.y&&0==o.z&&(o.x=1,o.y=0,o.z=0);var n=t.math.vec3Dot(i,a),s=180*Math.acos(n)/Math.PI;n<0&&(s=-s);var l=t.math.pool.new_quaternion();t.math.quatFromAxisAngle(o,s,l),t.math.quatTransformVector(l,e,r),t.math.pool.delete_vector3(o),t.math.pool.delete_quaternion(l)},EffectUtil.bindAxisBillboard=function(e,a){t.math.vec3Normalize(e,e);var r=t.math.pool.vector3_up,i=t.math.pool.new_vector3();t.math.vec3Cross(r,e,i),t.math.vec3Normalize(i,i),0==i.x&&0==i.y&&0==i.z&&(i.x=1,i.y=0,i.z=0);var o=t.math.vec3Dot(r,e),n=180*Math.acos(o)/Math.PI;o<0&&(n=-n),t.math.quatFromAxisAngle(i,n,a)},EffectUtil.lookatVerticalBillboard=function(e,a,r,i){void 0===i&&(i=t.math.pool.vector3_up);var o=new t.math.vector3;t.math.vec3Subtract(a,e,o),t.math.vec3Normalize(o,o);var n=new t.math.vector3(o.x,0,o.z);t.math.vec3Normalize(n,n);var s=Math.acos(n.z)/Math.PI*180;n.x<0&&(s=-s),t.math.quatFromAxisAngle(i,s,r)},EffectUtil.quatLookatZ=function(e,a,r,i){void 0===i&&(i=t.math.pool.vector3_forward);var o=new t.math.vector3;t.math.vec3Subtract(a,e,o),t.math.vec3Normalize(o,o);var n=new t.math.vector3(-o.x,o.y,0);t.math.vec3Normalize(n,n);var s=Math.acos(n.y)/Math.PI*180;n.x<0&&(s=-s),t.math.quatFromAxisAngle(i,s,r)},EffectUtil.quatLookatX=function(e,a,r,i){void 0===i&&(i=t.math.pool.vector3_right);var o=t.math.pool.new_vector3();t.math.vec3Subtract(a,e,o),t.math.vec3Normalize(o,o);var n=new t.math.vector3(0,-o.y,o.z);t.math.vec3Normalize(n,n);var s=Math.acos(n.z)/Math.PI*180;n.y<0&&(s=-s),t.math.quatFromAxisAngle(i,s,r)},EffectUtil}();e.EffectUtil=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function EmissionBatcher(a,r,i){this.particles=[],this.vertexSize=0,this.formate=0,this.curVerCount=0,this.curIndexCount=0,this.webgl=i.webgl,this.gameObject=r.gameObject,this.effectSys=r,this.emissionElement=i,this.data=a,this.formate=r.particleVF,this.vertexSize=t.render.meshData.calcByteSize(this.formate)/4,this.initMesh(),this.mat=new e.material,null==this.data.mat.shader?this.mat.setShader(e.sceneMgr.app.getAssetMgr().getShader("diffuse.shader.json")):this.mat.setShader(this.data.mat.shader),void 0!=this.data.mat.alphaCut&&this.mat.setFloat("_AlphaCut",this.data.mat.alphaCut),null!=this.data.mat.diffuseTexture&&this.mat.setTexture("_MainTex",this.data.mat.diffuseTexture)}return EmissionBatcher.prototype.initMesh=function(){this.mesh=new e.mesh,this.mesh.data=new t.render.meshData,this.mesh.glMesh=new t.render.glMesh,this.mesh.submesh=[];var a=new e.subMeshInfo;a.matIndex=0,a.useVertexIndex=0,a.start=0,a.size=0,a.line=!1,this.mesh.submesh.push(a),this.dataForVbo=new Float32Array(128),this.dataForEbo=new Uint16Array(128),this.mesh.glMesh.initBuffer(this.webgl,this.effectSys.particleVF,128,t.render.MeshTypeEnum.Dynamic),this.mesh.glMesh.addIndex(this.webgl,this.dataForEbo.length)},EmissionBatcher.prototype.addParticle=function(){this.refreshBuffer();var t=new e.Particle(this);t.uploadData(this.dataForVbo);for(var a=0;a<t.dataForEbo.length;a++)this.dataForEbo[this.curIndexCount+a]=t.dataForEbo[a]+this.curVerCount;this.particles.push(t),this.curVerCount+=this.emissionElement.perVertexCount,this.curIndexCount+=this.emissionElement.perIndexxCount,this.mesh.glMesh.uploadIndexSubData(this.webgl,0,this.dataForEbo),this.mesh.submesh[0].size=this.curIndexCount},EmissionBatcher.prototype.refreshBuffer=function(){var t=this.curVerCount+this.emissionElement.perVertexCount,e=this.curIndexCount+this.emissionElement.perIndexxCount;if(t*this.vertexSize>this.dataForVbo.length){r=this.dataForVbo.length;this.mesh.glMesh.resetVboSize(this.webgl,2*r);var a=new Float32Array(2*r);a.set(this.dataForVbo,0),this.dataForVbo=a}if(e>this.dataForEbo.length){var r=this.dataForEbo.length;this.mesh.glMesh.resetEboSize(this.webgl,0,2*r);var i=new Uint16Array(2*r);i.set(this.dataForEbo,0),this.dataForEbo=i}},EmissionBatcher.prototype.update=function(t){for(var e in this.particles)this.particles[e].update(t),this.particles[e].uploadData(this.dataForVbo)},EmissionBatcher.prototype.render=function(t,e,a){var r=this.mesh;r.glMesh.uploadVertexSubData(t.webgl,this.dataForVbo),e.app.getScene().fog?(t.fog=e.app.getScene().fog,this.mat.draw(t,r,r.submesh[0],"base_fog")):this.mat.draw(t,r,r.submesh[0],"base")},EmissionBatcher.prototype.dispose=function(){this.dataForVbo=null,this.dataForEbo=null,this.mesh.dispose(),this.mat.dispose();for(var t in this.particles)this.particles[t].dispose()},EmissionBatcher}();e.EmissionBatcher=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function Particle(a){this.renderModel=e.RenderModel.Mesh,this.localMatrix=new t.math.matrix,this.startScale=new t.math.vector3,this.startRotation=new t.math.quaternion,this.rotationByShape=new t.math.quaternion,this.rotationByEuler=new t.math.quaternion,this.localRotation=new t.math.quaternion,this.tilling=new t.math.vector2(1,1),this.speedDir=new t.math.vector3(0,0,0),this.actived=!0,this.matToBatcher=new t.math.matrix,this.matToworld=new t.math.matrix,this.tex_ST=new t.math.vector4(1,1,0,0),this.gameObject=a.effectSys.gameObject,this.emisson=a.emissionElement,this.batcher=a,this.format=a.formate,this.data=a.data.clone(),this.vertexSize=t.render.meshData.calcByteSize(this.format)/4,this.vertexStartIndex=a.curVerCount,this.vertexCount=this.emisson.perVertexCount,this.dataForVbo=new Float32Array(this.vertexCount*this.vertexSize),this.dataForEbo=this.data.mesh.data.genIndexDataArray(),this.dataForVbo.set(this.data.mesh.data.genVertexDataArray(this.format),0),this.sourceVbo=this.data.getVboData(this.format),this.initByData()}return Particle.prototype.uploadData=function(t){t.set(this.dataForVbo,this.vertexStartIndex*this.vertexSize)},Particle.prototype.initByData=function(){this.totalLife=this.data.life.getValueRandom(),this.renderModel=this.data.renderModel,this.curLife=0,this.startFrameId=this.batcher.effectSys.frameId;var a=this.data.particleStartData.randomDirection;this.speedDir=t.math.pool.clone_vector3(a);var r=this.data.particleStartData.position;if(this.localTranslate=t.math.pool.clone_vector3(r),this.simulationSpeed=void 0!=this.data.simulationSpeed?this.data.simulationSpeed.getValue():0,void 0==this.data.euler?this.euler=new t.math.vector3(0,0,0):this.euler=this.data.euler.getValueRandom(),void 0==this.data.scale?this.localScale=new t.math.vector3(1,1,1):this.localScale=this.data.scale.getValueRandom(),void 0==this.data.color?this.color=new t.math.vector3(0,0,0):this.color=this.data.color.getValueRandom(),void 0==this.data.alpha?this.alpha=1:this.alpha=this.data.alpha.getValueRandom(),void 0==this.data.uv?this.uv=new t.math.vector2:this.uv=this.data.uv.getValueRandom(),void 0!=this.data.moveSpeed?this.movespeed=this.data.moveSpeed.getValue():this.movespeed=new t.math.vector3,void 0==this.data.colorRate?this.colorRate=this.data.colorRate:this.colorRate=1,t.math.vec3Clone(this.localScale,this.startScale),t.math.quatFromEulerAngles(this.euler.x,this.euler.y,this.euler.z,this.rotationByEuler),(this.renderModel==e.RenderModel.None||this.renderModel==e.RenderModel.StretchedBillBoard)&&this.data.particleStartData.shapeType!=e.ParticleSystemShape.NORMAL){var i=t.math.pool.vector3_zero;t.math.quatLookat(i,a,this.rotationByShape);var o=t.math.pool.new_quaternion();t.math.quatFromEulerAngles(90,0,90,o),t.math.quatMultiply(this.rotationByShape,o,this.rotationByShape),t.math.quatClone(this.rotationByShape,this.localRotation),t.math.pool.delete_quaternion(o)}},Particle.prototype.update=function(e){if(this.actived){if(this.curLife+=e,this.curLife>=this.totalLife)return t.math.matrixZero(this.matToBatcher),this._updateVBO(),this.emisson.deadParticles.push(this),this.curLife=0,void(this.actived=!1);this._updatePos(e),this._updateScale(e),this._updateEuler(e),this._updateRotation(e),this._updateLocalMatrix(e),this._updateColor(e),this._updateAlpha(e),this._updateUV(e),this._updateVBO()}},Particle.prototype._updateLocalMatrix=function(e){t.math.matrixMakeTransformRTS(this.localTranslate,this.localScale,this.localRotation,this.localMatrix),t.math.matrixMultiply(this.emisson.matToBatcher,this.localMatrix,this.matToBatcher)},Particle.prototype._updateRotation=function(t){this._updateElementRotation()},Particle.prototype._updateElementRotation=function(){var a=t.framework.sceneMgr.app.getScene().mainCamera.gameObject.transform,r=t.math.pool.new_vector3(),i=t.math.pool.new_quaternion(),o=t.math.pool.new_vector3(),n=t.math.pool.new_quaternion();if(t.math.vec3Clone(this.localTranslate,r),t.math.matrixTransformVector3(r,this.emisson.getmatrixToWorld(),o),this.renderModel!=e.RenderModel.Mesh){if(this.renderModel==e.RenderModel.BillBoard)t.math.quatLookat(o,a.getWorldTranslate(),i);else if(this.renderModel==e.RenderModel.HorizontalBillBoard)i.x=-.5,i.y=.5,i.z=.5,i.w=.5;else if(this.renderModel==e.RenderModel.VerticalBillBoard){var s=t.math.pool.new_vector3();t.math.vec3Clone(a.getWorldTranslate(),s),s.y=o.y,t.math.quatLookat(o,s,i),t.math.pool.delete_vector3(s)}else if(this.renderModel==e.RenderModel.StretchedBillBoard){t.math.matrixMakeTransformRTS(this.localTranslate,this.localScale,this.localRotation,this.localMatrix),t.math.matrixMultiply(this.emisson.getmatrixToWorld(),this.localMatrix,this.matToworld);var l=t.math.pool.new_vector3(),h=t.math.pool.new_vector3(),c=t.math.pool.new_vector3();return t.math.matrixTransformNormal(t.math.pool.vector3_right,this.matToworld,l),t.math.vec3Normalize(l,l),t.math.matrixTransformNormal(t.math.pool.vector3_up,this.matToworld,h),t.math.vec3Normalize(h,h),t.math.matrixTransformNormal(t.math.pool.vector3_forward,this.matToworld,c),t.math.vec3Normalize(c,c),e.EffectUtil.lookatbyXAxis(o,l,h,c,a.getWorldTranslate(),i),t.math.quatMultiply(this.localRotation,i,this.localRotation),t.math.pool.delete_quaternion(i),t.math.pool.delete_vector3(r),t.math.pool.delete_quaternion(n),t.math.pool.delete_vector3(l),t.math.pool.delete_vector3(h),void t.math.pool.delete_vector3(c)}t.math.quatClone(this.emisson.getWorldRotation(),n),t.math.quatInverse(n,n),t.math.quatMultiply(n,i,this.localRotation),t.math.quatMultiply(this.localRotation,this.rotationByEuler,this.localRotation)}else t.math.quatClone(this.rotationByEuler,this.localRotation);t.math.pool.delete_vector3(r),t.math.pool.delete_quaternion(i),t.math.pool.delete_vector3(o),t.math.pool.delete_quaternion(n)},Particle.prototype._updatePos=function(a){void 0!=this.data.moveSpeed&&(this.localTranslate.x+=this.movespeed.x*a,this.localTranslate.y+=this.movespeed.y*a,this.localTranslate.z+=this.movespeed.z*a);var r=e.EffectUtil.vecMuliNum(this.speedDir,this.simulationSpeed);t.math.vec3Add(this.localTranslate,r,this.localTranslate)},Particle.prototype._updateEuler=function(e){void 0==this.data.eulerNodes||void 0==this.data.eulerSpeed?void 0!=this.data.eulerNodes?(this._updateNode(this.data.eulerNodes,this.totalLife,this.euler),t.math.quatFromEulerAngles(this.euler.x,this.euler.y,this.euler.z,this.rotationByEuler)):void 0!=this.data.eulerSpeed&&(void 0!=this.data.eulerSpeed.x&&(this.euler.x+=this.data.eulerSpeed.x.getValue()*e),void 0!=this.data.eulerSpeed.y&&(this.euler.y+=this.data.eulerSpeed.y.getValue()*e),void 0!=this.data.eulerSpeed.z&&(this.euler.z+=this.data.eulerSpeed.z.getValue()*e),t.math.quatFromEulerAngles(this.euler.x,this.euler.y,this.euler.z,this.rotationByEuler)):console.error("scale只能通过插值或者speed来修改，不能两个同时存在！")},Particle.prototype._updateScale=function(t){void 0==this.data.scaleNodes||void 0==this.data.scaleSpeed?void 0!=this.data.scaleNodes?this._updateNode(this.data.scaleNodes,this.totalLife,this.localScale,r.scale):void 0!=this.data.scaleSpeed&&(void 0!=this.data.scaleSpeed.x&&(this.localScale.x+=this.data.scaleSpeed.x.getValue()*t),void 0!=this.data.scaleSpeed.y&&(this.localScale.y+=this.data.scaleSpeed.y.getValue()*t),void 0!=this.data.scaleSpeed.z&&(this.localScale.z+=this.data.scaleSpeed.z.getValue()*t)):console.error("scale只能通过插值或者speed来修改，不能两个同时存在！")},Particle.prototype._updateColor=function(t){void 0==this.data.colorNodes||void 0==this.data.colorSpeed?void 0!=this.data.colorNodes?this._updateNode(this.data.colorNodes,this.totalLife,this.color):void 0!=this.data.colorSpeed&&(void 0!=this.data.colorSpeed.x&&(this.color.x+=this.data.colorSpeed.x.getValue()*t),void 0!=this.data.colorSpeed.y&&(this.color.y+=this.data.colorSpeed.y.getValue()*t),void 0!=this.data.colorSpeed.z&&(this.color.z+=this.data.colorSpeed.z.getValue()*t)):console.error("color只能通过插值或者speed来修改，不能两个同时存在！")},Particle.prototype._updateNode=function(a,i,o,n){void 0===n&&(n=r.none);var s=0,l=0;if(void 0!=a){for(var h=0;h<a.length;h++)if(h+1<a.length){if(a[h].key*i<=this.curLife&&a[h+1].key*i>=this.curLife){this.tempStartNode=a[h],this.tempEndNode=a[h+1],s++,l=(this.tempEndNode.key-this.tempStartNode.key)*i;break}}else this.curLife<a[h].key*i&&(this.tempStartNode=a[h-1],this.tempEndNode=a[h],l=(this.tempEndNode.key-this.tempStartNode.key)*i);if(this.tempStartNode instanceof e.ParticleNode)l>0&&t.math.vec3SLerp(this.tempStartNode.getValue(),this.tempEndNode.getValue(),(this.curLife-this.tempStartNode.key*i)/l,o);else if(this.tempStartNode instanceof e.ParticleNodeNumber){if(l>0)if(n==r.alpha)this.alpha=t.math.numberLerp(this.tempStartNode.getValue(),this.tempEndNode.getValue(),(this.curLife-this.tempStartNode.key*i)/l);else if(n=r.scale){var c=t.math.numberLerp(this.tempStartNode.getValue(),this.tempEndNode.getValue(),(this.curLife-this.tempStartNode.key*i)/l);t.math.vec3ScaleByNum(this.startScale,c,o)}}else this.tempStartNode instanceof e.UVSpeedNode&&l>0&&t.math.vec2SLerp(this.tempStartNode.getValue(),this.tempEndNode.getValue(),(this.curLife-this.tempStartNode.key*i)/l,o)}},Particle.prototype._updateAlpha=function(t){void 0==this.data.alphaNodes||void 0==this.data.alphaSpeed?void 0!=this.data.alphaNodes?this._updateNode(this.data.alphaNodes,this.totalLife,this.alpha,r.alpha):void 0!=this.data.alphaSpeed&&(this.alpha+=this.data.alphaSpeed.getValue()*t):console.error("color只能通过插值或者speed来修改，不能两个同时存在！")},Particle.prototype._updateUV=function(a){if(void 0==this.uv&&(this.uv=new t.math.vector2),this.data.uvType==e.UVTypeEnum.NONE)this.uv=this.data.uv.getValue();else if(this.data.uvType==e.UVTypeEnum.UVRoll){if(void 0!=this.data.uvRoll){if(void 0!=this.data.uvRoll.uvSpeedNodes&&void 0!=this.data.uvRoll.uvSpeed)return void console.error("uv只能通过插值或者speed来修改，不能两个同时存在！");void 0!=this.data.uvRoll.uvSpeedNodes?this._updateNode(this.data.uvRoll.uvSpeedNodes,this.totalLife,this.uv):void 0!=this.data.uvRoll.uvSpeed&&(void 0!=this.data.uvRoll.uvSpeed.u&&(this.tex_ST.z+=this.data.uvRoll.uvSpeed.u.getValue()*a),void 0!=this.data.uvRoll.uvSpeed.v&&(this.tex_ST.w+=this.data.uvRoll.uvSpeed.v.getValue()*a))}}else if(this.data.uvType==e.UVTypeEnum.UVSprite&&void 0!=this.data.uvSprite){var r=Math.floor(this.curLife/this.totalLife*this.data.uvSprite.totalCount);t.math.spriteAnimation(this.data.uvSprite.row,this.data.uvSprite.column,r,this.tex_ST)}},Particle.prototype._updateVBO=function(){for(var e=this.vertexSize,a=0;a<this.vertexCount;a++){var r=t.math.pool.new_vector3();r.x=this.sourceVbo[a*e+0],r.y=this.sourceVbo[a*e+1],r.z=this.sourceVbo[a*e+2],t.math.matrixTransformVector3(r,this.matToBatcher,r),this.dataForVbo[a*e+0]=r.x,this.dataForVbo[a*e+1]=r.y,this.dataForVbo[a*e+2]=r.z,t.math.pool.delete_vector3(r);var i=t.math.floatClamp(this.sourceVbo[a*e+3],0,1),o=t.math.floatClamp(this.sourceVbo[a*e+4],0,1),n=t.math.floatClamp(this.sourceVbo[a*e+5],0,1),s=t.math.floatClamp(this.sourceVbo[a*e+6],0,1);void 0!=this.color&&(i=this.color.x,o=this.color.y,n=this.color.z),void 0!=this.alpha&&(s=this.alpha),void 0!=this.colorRate&&(i*=this.colorRate,o*=this.colorRate,n*=this.colorRate,s*=this.colorRate),i=t.math.floatClamp(i,0,3),o=t.math.floatClamp(i,0,3),n=t.math.floatClamp(i,0,3),s=t.math.floatClamp(i,0,3),this.dataForVbo[a*this.vertexSize+3]=i,this.dataForVbo[a*this.vertexSize+4]=o,this.dataForVbo[a*this.vertexSize+5]=n,this.dataForVbo[a*this.vertexSize+6]=s,this.dataForVbo[a*e+7]=this.sourceVbo[a*e+7]*this.tex_ST.x+this.tex_ST.z,this.dataForVbo[a*e+8]=this.sourceVbo[a*e+8]*this.tex_ST.y+this.tex_ST.w}},Particle.prototype.dispose=function(){this.dataForVbo=null,this.dataForEbo=null,this.startRotation=null,this.localRotation=null,this.rotationByEuler=null,this.rotationByShape=null,this.tilling=null,this.localMatrix=null,this.localTranslate=null,this.euler=null,this.localScale=null,this.colorRate=1,this.color=null,this.uv=null},Particle}();e.Particle=a;var r;!function(t){t[t.none=0]="none",t[t.alpha=1]="alpha",t[t.scale=2]="scale"}(r=e.nodeType||(e.nodeType={}))}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function Particles(t){this.emissionElements=[],this.loopFrame=Number.MAX_VALUE,this.effectSys=t,this.vf=t.particleVF}return Particles.prototype.addEmission=function(t){var e=new r(t,this.effectSys);this.emissionElements.push(e)},Particles.prototype.update=function(t){for(var e in this.emissionElements)this.emissionElements[e].update(t)},Particles.prototype.render=function(t,e,a){for(var r in this.emissionElements)this.emissionElements[r].render(t,e,a)},Particles.prototype.dispose=function(){for(var t in this.emissionElements)this.emissionElements[t].dispose();this.emissionElements.length=0},Particles}();e.Particles=a;var r=function(){function EmissionElement(a,r){switch(this.beloop=!1,this.active=!0,this.isover=!1,this.maxVertexCount=2048,this.localtranslate=new t.math.vector3,this.localScale=new t.math.vector3(1,1,1),this.localrotate=new t.math.quaternion,this.eluerAngle=new t.math.quaternion,this.worldRotation=new t.math.quaternion,this.matToBatcher=new t.math.matrix,this.matToWorld=new t.math.matrix,this.webgl=t.framework.sceneMgr.app.webgl,this.effectSys=r,this.vf=r.particleVF,this.gameObject=r.gameObject,this.emission=a.emissionData,this.emission.emissionType){case e.ParticleEmissionType.burst:break;case e.ParticleEmissionType.continue:this._continueSpaceTime=this.emission.time/this.emission.emissionCount}this.curTime=0,this.numcount=0,this.beloop=a.beloop,this.emissionBatchers=[],this.deadParticles=[],this.addBatcher(),this.perVertexCount=this.emission.mesh.data.pos.length,this.perIndexxCount=this.emission.mesh.data.trisindex.length,t.math.vec3Clone(this.emission.rootpos,this.localtranslate),t.math.vec3Clone(this.emission.rootRotAngle,this.eluerAngle),t.math.vec3Clone(this.emission.rootScale,this.localScale),t.math.quatFromEulerAngles(this.eluerAngle.x,this.eluerAngle.y,this.eluerAngle.z,this.localrotate),t.math.matrixMakeTransformRTS(this.localtranslate,this.localScale,this.localrotate,this.matToBatcher)}return EmissionElement.prototype.getWorldRotation=function(){var e=this.gameObject.transform.getWorldRotate();return t.math.quatMultiply(e,this.localrotate,this.worldRotation),this.worldRotation},EmissionElement.prototype.getmatrixToWorld=function(){var e=this.gameObject.transform.getWorldMatrix();return t.math.matrixMultiply(e,this.matToBatcher,this.matToWorld),this.matToWorld},EmissionElement.prototype.update=function(t){this.curTime+=t,this.updateEmission(t),this.updateBatcher(t)},EmissionElement.prototype.updateBatcher=function(t){for(var e in this.emissionBatchers)this.emissionBatchers[e].update(t)},EmissionElement.prototype.updateEmission=function(t){this.isover||(this.emission.emissionType==e.ParticleEmissionType.continue?(0==this.numcount&&(this.addParticle(),this.numcount++),this.curTime>this._continueSpaceTime&&(this.numcount<this.emission.emissionCount?(this.addParticle(),this.curTime=0,this.numcount++):this.beloop?(this.curTime=0,this.numcount=0,this.isover=!1):this.isover=!0)):this.emission.emissionType==e.ParticleEmissionType.burst&&this.curTime>this.emission.time&&(this.addParticle(this.emission.emissionCount),this.beloop?(this.curTime=0,this.isover=!1):this.isover=!0))},EmissionElement.prototype.addParticle=function(t){void 0===t&&(t=1);for(var e=0;e<t;e++)if(this.deadParticles.length>0){var a=this.deadParticles.pop();a.initByData(),a.actived=!0}else this.curbatcher.curVerCount+this.perVertexCount<=this.maxVertexCount?this.curbatcher.addParticle():(this.addBatcher(),this.curbatcher.addParticle())},EmissionElement.prototype.addBatcher=function(){var t=new e.EmissionBatcher(this.emission,this.effectSys,this);this.emissionBatchers.push(t),this.curbatcher=t},EmissionElement.prototype.render=function(t,e,a){for(var r in this.emissionBatchers)this.emissionBatchers[r].render(t,e,a)},EmissionElement.prototype.dispose=function(){for(var t in this.emissionBatchers)this.emissionBatchers[t].dispose();this.emissionBatchers.length=0},EmissionElement.prototype.isOver=function(){return this.isover},EmissionElement}();e.EmissionElement=r}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a;!function(t){t[t.None=0]="None",t[t.HideInHierarchy=1]="HideInHierarchy",t[t.HideInInspector=2]="HideInInspector",t[t.DontSaveInEditor=4]="DontSaveInEditor",t[t.NotEditable=8]="NotEditable",t[t.DontSaveInBuild=16]="DontSaveInBuild",t[t.DontUnloadUnusedAsset=32]="DontUnloadUnusedAsset",t[t.DontSave=52]="DontSave",t[t.HideAndDontSave=61]="HideAndDontSave"}(a=e.HideFlags||(e.HideFlags={}));var r=function(){return function nodeComponent(t,e){void 0===e&&(e=!1),this.comp=t,this.init=e}}();__decorate([t.reflect.Field("INodeComponent"),__metadata("design:type",Object)],r.prototype,"comp",void 0),r=__decorate([t.reflect.SerializeType,__metadata("design:paramtypes",[Object,Boolean])],r),e.nodeComponent=r;var i=function(){function gameObject(){this.layer=0,this.hideFlags=a.None,this.components=[],this.componentsInit=[],this._visible=!0}return gameObject.prototype.getScene=function(){return this.transform.scene},Object.defineProperty(gameObject.prototype,"visibleInScene",{get:function(){for(var t=this;t.visible&&t.transform.parent;)t=t.transform.parent.gameObject;return t.visible},enumerable:!0,configurable:!0}),Object.defineProperty(gameObject.prototype,"visible",{get:function(){return this._visible},set:function(t){t!=this._visible&&(this._visible=t,e.sceneMgr.app.markNotify(this.transform,e.NotifyType.ChangeVisible))},enumerable:!0,configurable:!0}),gameObject.prototype.getName=function(){return this.transform.name},gameObject.prototype.init=function(){if(this.componentsInit.length>0){for(var t=0;t<this.componentsInit.length;t++)this.componentsInit[t].comp.start(),this.componentsInit[t].init=!0;this.componentsInit.length=0}},gameObject.prototype.update=function(t){if(0!=this.components.length)for(var e=0;e<this.components.length;e++)this.components[e].comp.update(t)},gameObject.prototype.addComponentDirect=function(a){if(null!=a.gameObject)throw new Error("this components has added to a  gameObject");a.gameObject=this;var i=new r(a,!1),o=!0;return"1"!=t.reflect.getClassTag(a.__proto__,"renderer")&&"1"!=t.reflect.getClassTag(a.__proto__,"effectbatcher")||(null==this.renderer?this.renderer=a:(o=!1,console.warn("已经有一个渲染器的组件了，不能俩"))),"1"==t.reflect.getClassTag(a.__proto__,"camera")&&(null==this.camera?this.camera=a:(o=!1,console.warn("已经有一个摄像机的组件了，不能俩"))),"1"==t.reflect.getClassTag(a.__proto__,"light")&&(null==this.light?(this.light=a,console.warn("add light:"+this.transform.name)):(o=!1,console.warn("已经有一个灯光的组件了，不能俩"))),"1"!=t.reflect.getClassTag(a.__proto__,"boxcollider")&&"1"!=t.reflect.getClassTag(a.__proto__,"meshcollider")&&"1"!=t.reflect.getClassTag(a.__proto__,"canvasRenderer")||(null==this.collider?this.collider=a:(o=!1,console.warn("已经有一个碰撞盒的组件了，不能俩"))),o&&(this.components.push(i),this.componentsInit.push(i),"1"==t.reflect.getClassTag(a.__proto__,"camera")&&e.sceneMgr.app.markNotify(this.transform,e.NotifyType.AddCamera),"1"==t.reflect.getClassTag(a.__proto__,"canvasRenderer")&&e.sceneMgr.app.markNotify(this.transform,e.NotifyType.AddCanvasRender)),a},gameObject.prototype.getComponent=function(e){for(var a=0;a<this.components.length;a++)if(t.reflect.getClassName(this.components[a].comp.__proto__)==e)return this.components[a].comp;return null},gameObject.prototype.getComponents=function(){for(var t=[],e=0;e<this.components.length;e++)t.push(this.components[e].comp);return t},gameObject.prototype.getComponentsInChildren=function(t){var e=[];return this._getComponentsInChildren(t,this,e),e},gameObject.prototype._getComponentsInChildren=function(e,a,r){for(var i=0;i<a.components.length;i++)t.reflect.getClassName(a.components[i].comp.__proto__)==e&&r.push(a.components[i].comp);for(var o=0;void 0!=a.transform.children&&o<a.transform.children.length;o++){var n=a.transform.children[o].gameObject;this._getComponentsInChildren(e,n,r)}},gameObject.prototype.getComponentInParent=function(t){for(var e=null,a=this.transform.parent;null==e&&null!=a;)e=a.gameObject.getComponent(t),a=a.parent;return e},gameObject.prototype.addComponent=function(e){for(var a in this.components)if(this.components[a].comp.constructor.name==e)throw new Error("已经有一个"+e+"的组件了，不能俩");var r=t.reflect.getPrototype(e),i=t.reflect.createInstance(r,{nodecomp:"1"});return this.addComponentDirect(i)},gameObject.prototype.removeComponent=function(t){for(var e=0;e<this.components.length;e++)if(this.components[e].comp==t){this.components[e].init&&this.components[e].comp.remove(),this.remove(this.components[e].comp),this.components.splice(e,1);break}},gameObject.prototype.remove=function(e){"1"==t.reflect.getClassTag(e.__proto__,"renderer")&&(this.renderer=null),"1"==t.reflect.getClassTag(e.__proto__,"camera")&&(this.camera=null),"1"==t.reflect.getClassTag(e.__proto__,"light")&&(this.light=null),"1"!=t.reflect.getClassTag(e.__proto__,"boxcollider")&&"1"!=t.reflect.getClassTag(e.__proto__,"meshcollider")&&"1"!=t.reflect.getClassTag(e.__proto__,"canvasRenderer")||(this.collider=null)},gameObject.prototype.removeComponentByTypeName=function(e){for(var a=0;a<this.components.length;a++)if(t.reflect.getClassName(this.components[a].comp)==e){this.components[a].init&&this.components[a].comp.remove(),this.remove(this.components[a].comp),this.components.splice(a,1);break}},gameObject.prototype.removeAllComponents=function(){for(var t=0;t<this.components.length;t++)this.components[t].comp.remove(),this.remove(this.components[t].comp);this.components.length=0},gameObject.prototype.dispose=function(){this.removeAllComponents()},gameObject}();__decorate([t.reflect.Field("number"),t.reflect.UIStyle("enum"),__metadata("design:type",Number)],i.prototype,"layer",void 0),__decorate([t.reflect.Field("nodeComponent[]"),__metadata("design:type",Array)],i.prototype,"components",void 0),i=__decorate([t.reflect.SerializeType],i),e.gameObject=i}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function renderContext(e){this.viewPortPixel=new t.math.rect(0,0,0,0),this.eyePos=new t.math.vector4,this.matrixView=new t.math.matrix,this.matrixProject=new t.math.matrix,this.matrixModel=new t.math.matrix,this.matrixModelViewProject=new t.math.matrix,this.matrixModelView=new t.math.matrix,this.matrixViewProject=new t.math.matrix,this.floatTimer=0,this.intLightCount=0,this.vec4LightPos=new Float32Array(32),this.vec4LightDir=new Float32Array(32),this.floatLightSpotAngleCos=new Float32Array(8),this.lightmap=null,this.lightmapUV=1,this.lightmapOffset=new t.math.vector4(1,1,0,0),this.webgl=e}return renderContext.prototype.updateCamera=function(e,a){a.calcViewPortPixel(e,this.viewPortPixel);var r=this.viewPortPixel.w/this.viewPortPixel.h;a.calcViewMatrix(this.matrixView),a.calcProjectMatrix(r,this.matrixProject),t.math.matrixMultiply(this.matrixProject,this.matrixView,this.matrixViewProject),this.floatTimer=e.getTotalTime();var i=a.gameObject.transform.getWorldTranslate();this.eyePos.x=i.x,this.eyePos.y=i.y,this.eyePos.z=i.z},renderContext.prototype.updateLights=function(a){this.intLightCount=a.length;for(var r=t.math.pool.new_vector3(),i=0;i<a.length;i++){var o=a[i].gameObject.transform.getWorldTranslate();this.vec4LightPos[4*i+0]=o.x,this.vec4LightPos[4*i+1]=o.y,this.vec4LightPos[4*i+2]=o.z,this.vec4LightPos[4*i+3]=a[i].type==e.LightTypeEnum.Direction?0:1,a[i].gameObject.transform.getForwardInWorld(r),this.vec4LightDir[4*i+0]=r.x,this.vec4LightDir[4*i+1]=r.y,this.vec4LightDir[4*i+2]=r.z,this.vec4LightDir[4*i+3]=a[i].type==e.LightTypeEnum.Point?0:1,this.floatLightSpotAngleCos[i]=a[i].spotAngelCos}t.math.pool.delete_vector3(r)},renderContext.prototype.updateOverlay=function(){t.math.matrixMakeIdentity(this.matrixModelViewProject)},renderContext.prototype.updateModel=function(e){t.math.matrixClone(e.getWorldMatrix(),this.matrixModel),t.math.matrixMultiply(this.matrixView,this.matrixModel,this.matrixModelView),t.math.matrixMultiply(this.matrixViewProject,this.matrixModel,this.matrixModelViewProject)},renderContext.prototype.updateModeTrail=function(){t.math.matrixClone(this.matrixView,this.matrixModelView),t.math.matrixClone(this.matrixViewProject,this.matrixModelViewProject)},renderContext}();e.renderContext=a;var r;!function(t){t[t.Common=0]="Common",t[t.Transparent=1]="Transparent",t[t.Overlay=2]="Overlay"}(r=e.RenderLayerEnum||(e.RenderLayerEnum={}));var i=function(){function renderList(){this.renderLayers=[];var t=new o,e=new o(!0),a=new o(!0);this.renderLayers.push(t),this.renderLayers.push(e),this.renderLayers.push(a)}return renderList.prototype.clear=function(){for(var t=0;t<this.renderLayers.length;t++)this.renderLayers[t].list.length=0},renderList.prototype.addRenderer=function(t){t.layer==r.Common?this.renderLayers[0].list.push(t):t.layer==r.Transparent?this.renderLayers[1].list.push(t):t.layer==r.Overlay&&this.renderLayers[2].list.push(t)},renderList}();e.renderList=i;var o=function(){return function renderLayer(t){void 0===t&&(t=!1),this.needSort=!1,this.list=[],this.needSort=t}}();e.renderLayer=o}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(t){var e=function(){function scene(e){this.renderCameras=[],this._mainCamera=null,this.renderContext=[],this.renderLights=[],this.lightmaps=[],this.RealCameraNumber=0,this.app=e,this.webgl=e.webgl,this.assetmgr=e.getAssetMgr(),this.rootNode=new t.transform,this.rootNode.scene=this,this.renderList=new t.renderList}return Object.defineProperty(scene.prototype,"mainCamera",{get:function(){return null==this._mainCamera&&(this._mainCamera=this.renderCameras[0]),this._mainCamera},set:function(t){for(var e in this.renderCameras)this.renderCameras[e]==t&&(this._mainCamera=t)},enumerable:!0,configurable:!0}),scene.prototype.update=function(t){this.rootNode.updateTran(!1),this.rootNode.updateAABBChild(),this.renderCameras.length=0,this.renderLights.length=0,this.renderList.clear(),this.updateScene(this.rootNode,t),this.renderCameras.length>1&&this.renderCameras.sort(function(t,e){return t.order-e.order}),this.RealCameraNumber=0;for(var e=0;e<this.renderCameras.length;e++)this._renderCamera(e);0==this.RealCameraNumber&&(this.webgl.clearColor(0,0,0,1),this.webgl.clearDepth(1),this.webgl.clear(this.webgl.COLOR_BUFFER_BIT|this.webgl.DEPTH_BUFFER_BIT))},scene.prototype._renderCamera=function(e){var a=this.renderCameras[e],r=this.renderContext[e];if(this.app.bePlay&&a.gameObject.transform.name.toLowerCase().indexOf("editor")<0){r.updateCamera(this.app,a),r.updateLights(this.renderLights),a.fillRenderer(this),a.renderScene(this,r),this.RealCameraNumber++;for(var i=a.getOverLays(),o=0;o<i.length;o++)a.CullingMask&t.CullingMask.ui&&i[o].render(r,this.assetmgr,a)}else if(!this.app.bePlay&&a.gameObject.transform.name.toLowerCase().indexOf("editor")>=0&&(r.updateCamera(this.app,a),r.updateLights(this.renderLights),a.fillRenderer(this),a.renderScene(this,r),this.RealCameraNumber++,this.app.be2dstate))for(var i=a.getOverLays(),o=0;o<i.length;o++)a.CullingMask&t.CullingMask.ui&&i[o].render(r,this.assetmgr,a);if(!this.app.bePlay&&this.app.be2dstate&&e==this.app.curcameraindex)for(var i=a.getOverLays(),o=0;o<i.length;o++)a.CullingMask&t.CullingMask.ui&&i[o].render(r,this.assetmgr,a)},scene.prototype.updateScene=function(t,e){this.app.bePlay?this.objupdate(t,e):this.objupdateInEditor(t,e)},scene.prototype.objupdateInEditor=function(t,e){if(t.gameObject.init(),null!=t.gameObject.renderer&&t.gameObject.renderer.update(e),null!=t.gameObject.camera&&t.gameObject.camera.update(e),this.collectCameraAndLight(t),null!=t.children)for(var a=0;a<t.children.length;a++)this.objupdateInEditor(t.children[a],e)},scene.prototype.objupdate=function(t,e){if(t.gameObject.init(),t.gameObject.components.length>0&&(t.gameObject.update(e),this.collectCameraAndLight(t)),null!=t.children)for(var a=0;a<t.children.length;a++)this.objupdate(t.children[a],e)},scene.prototype.collectCameraAndLight=function(e){var a=e.gameObject.camera;for(null!=a&&this.renderCameras.push(a);this.renderContext.length<this.renderCameras.length;)this.renderContext.push(new t.renderContext(this.webgl));var r=e.gameObject.light;null!=r&&this.renderLights.push(r)},scene.prototype.addChild=function(t){this.rootNode.addChild(t)},scene.prototype.removeChild=function(t){this.rootNode.removeChild(t)},scene.prototype.getChildren=function(){return this.rootNode.children},scene.prototype.getChildCount=function(){return null==this.rootNode.children?0:this.rootNode.children.length},scene.prototype.getChild=function(t){return this.rootNode.children[t]},scene.prototype.getChildByName=function(t){return this.rootNode.find(t)},scene.prototype.getRoot=function(){return this.rootNode},scene.prototype.pickAll=function(t,e){void 0===e&&(e=!1);var a=this.doPick(t,!0,e);return null==a?null:a},scene.prototype.pick=function(t,e){void 0===e&&(e=!1);var a=this.doPick(t,!1,e);return null==a?null:a},scene.prototype.doPick=function(t,e,a){void 0===e&&(e=!1),void 0===a&&(a=!1);var r=new Array;if(a?this.pickMesh(t,this.getRoot(),r):this.pickCollider(t,this.getRoot(),r),0==r.length)return null;if(e)return r;for(var i=0,o=1;o<r.length;o++)r[o].distance<r[i].distance&&(i=o);return r[i]},scene.prototype.pickMesh=function(t,e,a){if(null!=e.gameObject){if(!e.gameObject.visible)return;var r=e.gameObject.getComponent("meshFilter");if(null!=r)(o=r.getMeshOutput().intersects(t,e.getWorldMatrix()))&&(a.push(o),o.pickedtran=e);else{var i=e.gameObject.getComponent("skinnedMeshRenderer");if(null!=i){var o=i.intersects(t);o&&(a.push(o),o.pickedtran=e)}}}if(null!=e.children)for(var n=0;n<e.children.length;n++)this.pickMesh(t,e.children[n],a)},scene.prototype.pickCollider=function(t,e,a){if(null!=e.gameObject){if(!e.gameObject.visible)return;if(null!=e.gameObject.collider){var r=t.intersectCollider(e);r&&(a.push(r),r.pickedtran=e)}}if(null!=e.children)for(var i=0;i<e.children.length;i++)this.pickCollider(t,e.children[i],a)},scene}();t.scene=e}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(t){var e=function(){return function taskstate(){this.finish=!1,this.error=!1,this.message=null,this.cancel=!1,this.taskCall=null,this.taskInterface=null}}();t.taskstate=e;var a=function(){function taskMgr(){this.tasks=[],this.laststate=null}return taskMgr.prototype.addTaskCall=function(t){var a=new e;a.taskCall=t,this.tasks.push(a)},taskMgr.prototype.addTask=function(t){var a=new e;a.taskInterface=t,this.tasks.push(a)},taskMgr.prototype.move=function(t){if(!(null!=this.laststate&&this.laststate.cancel||null!=this.laststate&&0==this.laststate.finish)){var a=this.tasks.shift();if(null!=a){var r=new e,i=this.laststate;this.laststate=r,null==a.taskInterface?a.taskCall(i,r):a.taskInterface.move(t,i,r)}}},taskMgr.prototype.cancel=function(){null!=this.laststate&&(this.laststate.cancel=!0)},taskMgr}();t.taskMgr=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function aabb(e,a){this.opmin=new t.math.vector3,this.opmax=new t.math.vector3,this._center=new t.math.vector3,this.srcmin=t.math.pool.clone_vector3(e),this.srcmax=t.math.pool.clone_vector3(a),this.minimum=t.math.pool.clone_vector3(e),this.maximum=t.math.pool.clone_vector3(a)}return aabb.prototype.update=function(e){t.math.matrixGetTranslation(e,this.opmin),t.math.matrixGetTranslation(e,this.opmax),e.rawData[0]>0?(this.opmin.x+=e.rawData[0]*this.srcmin.x,this.opmax.x+=e.rawData[0]*this.srcmax.x):(this.opmin.x+=e.rawData[0]*this.srcmax.x,this.opmax.x+=e.rawData[0]*this.srcmin.x),e.rawData[1]>0?(this.opmin.y+=e.rawData[1]*this.srcmin.y,this.opmax.y+=e.rawData[1]*this.srcmax.y):(this.opmin.y+=e.rawData[1]*this.srcmax.y,this.opmax.y+=e.rawData[1]*this.srcmin.y),e.rawData[2]>0?(this.opmin.z+=e.rawData[2]*this.srcmin.z,this.opmax.z+=e.rawData[2]*this.srcmax.z):(this.opmin.z+=e.rawData[2]*this.srcmax.z,this.opmax.z+=e.rawData[2]*this.srcmin.z),e.rawData[4]>0?(this.opmin.x+=e.rawData[4]*this.srcmin.x,this.opmax.x+=e.rawData[4]*this.srcmax.x):(this.opmin.x+=e.rawData[4]*this.srcmax.x,this.opmax.x+=e.rawData[4]*this.srcmin.x),e.rawData[5]>0?(this.opmin.y+=e.rawData[5]*this.srcmin.y,this.opmax.y+=e.rawData[5]*this.srcmax.y):(this.opmin.y+=e.rawData[5]*this.srcmax.y,this.opmax.y+=e.rawData[5]*this.srcmin.y),e.rawData[6]>0?(this.opmin.z+=e.rawData[6]*this.srcmin.z,this.opmax.z+=e.rawData[6]*this.srcmax.z):(this.opmin.z+=e.rawData[6]*this.srcmax.z,this.opmax.z+=e.rawData[6]*this.srcmin.z),e.rawData[8]>0?(this.opmin.x+=e.rawData[8]*this.srcmin.x,this.opmax.x+=e.rawData[8]*this.srcmax.x):(this.opmin.x+=e.rawData[8]*this.srcmax.x,this.opmax.x+=e.rawData[8]*this.srcmin.x),e.rawData[9]>0?(this.opmin.y+=e.rawData[9]*this.srcmin.y,this.opmax.y+=e.rawData[9]*this.srcmax.y):(this.opmin.y+=e.rawData[9]*this.srcmax.y,this.opmax.y+=e.rawData[9]*this.srcmin.y),e.rawData[10]>0?(this.opmin.z+=e.rawData[10]*this.srcmin.z,this.opmax.z+=e.rawData[10]*this.srcmax.z):(this.opmin.z+=e.rawData[10]*this.srcmax.z,this.opmax.z+=e.rawData[10]*this.srcmin.z),this.minimum=t.math.pool.clone_vector3(this.opmin),this.maximum=t.math.pool.clone_vector3(this.opmax)},aabb.prototype.addVector3=function(e){t.math.vec3Max(this.maximum,e,this.maximum),t.math.vec3Max(this.minimum,e,this.minimum)},aabb.prototype.containsVector3=function(t){return t.x>this.minimum.x&&t.x<this.maximum.x&&t.y>this.minimum.y&&t.x<this.maximum.y&&t.z>this.minimum.z&&t.z<this.maximum.z},aabb.prototype.intersectAABB=function(t){return!(this.minimum.x>t.maximum.x)&&(!(this.maximum.x<t.minimum.x)&&(!(this.minimum.x>t.maximum.x)&&(!(this.maximum.x<t.minimum.x)&&(!(this.minimum.x>t.maximum.x)&&!(this.maximum.x<t.minimum.x)))))},aabb.prototype.addAABB=function(e){null!=e&&(t.math.vec3Max(this.maximum,e.maximum,this.maximum),t.math.vec3Min(this.minimum,e.minimum,this.minimum))},Object.defineProperty(aabb.prototype,"center",{get:function(){return t.math.vec3Add(this.maximum,this.minimum,this._center),t.math.vec3ScaleByNum(this._center,.5,this._center),this._center},enumerable:!0,configurable:!0}),aabb.prototype.clear=function(){t.math.vec3SetByFloat(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,this.minimum),t.math.vec3SetByFloat(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,this.maximum)},aabb.prototype.clone=function(){var e=t.math.pool.clone_vector3(this.minimum),a=t.math.pool.clone_vector3(this.maximum);return new t.framework.aabb(e,a)},aabb.prototype.getVec3=function(e){e[0]=t.math.pool.clone_vector3(this.minimum),e[1]=t.math.pool.clone_vector3(this.minimum),e[1].z=this.maximum.z,e[2]=t.math.pool.clone_vector3(this.minimum),e[2].x=this.maximum.x,e[3]=t.math.pool.clone_vector3(this.maximum),e[3].y=this.minimum.y,e[4]=t.math.pool.clone_vector3(this.minimum),e[4].y=this.maximum.y,e[5]=t.math.pool.clone_vector3(this.maximum),e[5].x=this.minimum.x,e[6]=t.math.pool.clone_vector3(this.maximum),e[6].z=this.minimum.z,e[7]=t.math.pool.clone_vector3(this.maximum)},aabb}();e.aabb=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function obb(){this.vectors=new Array}return obb.prototype.buildByMaxMin=function(e,a){this.vectors[0]=t.math.pool.clone_vector3(e),this.vectors[1]=t.math.pool.clone_vector3(e),this.vectors[1].z=a.z,this.vectors[2]=t.math.pool.clone_vector3(e),this.vectors[2].x=a.x,this.vectors[3]=t.math.pool.clone_vector3(a),this.vectors[3].y=e.y,this.vectors[4]=t.math.pool.clone_vector3(e),this.vectors[4].y=a.y,this.vectors[5]=t.math.pool.clone_vector3(a),this.vectors[5].x=e.x,this.vectors[6]=t.math.pool.clone_vector3(a),this.vectors[6].z=e.z,this.vectors[7]=t.math.pool.clone_vector3(a),this.center=new t.math.vector3,t.math.vec3Add(a,e,this.center),t.math.vec3ScaleByNum(this.center,.5,this.center),this.halfsize=new t.math.vector3,t.math.vec3Subtract(a,e,this.halfsize),t.math.vec3ScaleByNum(this.halfsize,.5,this.halfsize),this.directions=[new t.math.vector3,new t.math.vector3,new t.math.vector3]},obb.prototype.buildByCenterSize=function(e,a){this.center=t.math.pool.clone_vector3(e),this.halfsize=t.math.pool.clone_vector3(a),t.math.vec3ScaleByNum(this.halfsize,.5,this.halfsize);var r=this.halfsize.x,i=this.halfsize.y,o=this.halfsize.z,n=this.center.x,s=this.center.y,l=this.center.z;this.vectors[0]=new t.math.vector3(n-r,s-i,l-o),this.vectors[1]=new t.math.vector3(n-r,s-i,l+o),this.vectors[2]=new t.math.vector3(n+r,s-i,l-o),this.vectors[3]=new t.math.vector3(n+r,s-i,l+o),this.vectors[4]=new t.math.vector3(n-r,s+i,l-o),this.vectors[5]=new t.math.vector3(n-r,s+i,l+o),this.vectors[6]=new t.math.vector3(n+r,s+i,l-o),this.vectors[7]=new t.math.vector3(n+r,s+i,l+o),this.directions=[new t.math.vector3,new t.math.vector3,new t.math.vector3]},obb.prototype.update=function(e){t.math.matrixGetTranslation(e,this.center),t.math.matrixGetVector3ByOffset(e,0,this.directions[0]),t.math.matrixGetVector3ByOffset(e,4,this.directions[1]),t.math.matrixGetVector3ByOffset(e,8,this.directions[2])},obb.prototype.caclWorldVecs=function(e,a){for(var r=0;r<this.vectors.length;r++)e[r]=new t.math.vector3,t.math.matrixTransformVector3(this.vectors[r],a,e[r])},obb.prototype.intersects=function(e){if(null==e)return!1;var a=this,r=e;if(!this.axisOverlap(a.directions[0],a,r))return!1;if(!this.axisOverlap(a.directions[1],a,r))return!1;if(!this.axisOverlap(a.directions[2],a,r))return!1;if(!this.axisOverlap(r.directions[0],a,r))return!1;if(!this.axisOverlap(r.directions[1],a,r))return!1;if(!this.axisOverlap(r.directions[2],a,r))return!1;var i=t.math.pool.new_vector3();return t.math.vec3Cross(a.directions[0],r.directions[0],i),!!this.axisOverlap(i,a,r)&&(t.math.vec3Cross(a.directions[0],r.directions[1],i),!!this.axisOverlap(i,a,r)&&(t.math.vec3Cross(a.directions[0],r.directions[2],i),!!this.axisOverlap(i,a,r)&&(t.math.vec3Cross(a.directions[1],r.directions[0],i),!!this.axisOverlap(i,a,r)&&(t.math.vec3Cross(a.directions[1],r.directions[1],i),!!this.axisOverlap(i,a,r)&&(t.math.vec3Cross(a.directions[1],r.directions[2],i),!!this.axisOverlap(i,a,r)&&(t.math.vec3Cross(a.directions[2],r.directions[0],i),!!this.axisOverlap(i,a,r)&&(t.math.vec3Cross(a.directions[2],r.directions[1],i),!!this.axisOverlap(i,a,r)&&(t.math.vec3Cross(a.directions[2],r.directions[2],i),!!this.axisOverlap(i,a,r)))))))))},obb.prototype.computeBoxExtents=function(e,a){var r=t.math.vec3Dot(a.center,e),i=Math.abs(t.math.vec3Dot(a.directions[0],e))*a.halfsize.x+Math.abs(t.math.vec3Dot(a.directions[1],e))*a.halfsize.y+Math.abs(t.math.vec3Dot(a.directions[2],e))*a.halfsize.z,o=t.math.pool.new_vector3();return o.x=r-i,o.y=r+i,o},obb.prototype.axisOverlap=function(t,e,a){var r=this.computeBoxExtents(t,e),i=this.computeBoxExtents(t,a);return this.extentsOverlap(r.x,r.y,i.x,i.y)},obb.prototype.extentsOverlap=function(t,e,a,r){return!(t>r||a>e)},obb.prototype.clone=function(){var e=new obb;e.center=t.math.pool.clone_vector3(this.center),e.halfsize=this.halfsize;for(var a in this.directions)e.directions[a]=t.math.pool.clone_vector3(this.directions[a]);return e},obb.prototype.dispose=function(){this.vectors.length=0,this.directions.length=0},obb}();e.obb=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){return function pickinfo(e,a,r){this.hitposition=new t.math.vector3,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshId=0,this.distance=r,this.bu=e,this.bv=a}}();e.pickinfo=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function ray(e,a){this.origin=t.math.pool.clone_vector3(e),this.direction=t.math.pool.clone_vector3(a)}return ray.prototype.intersectAABB=function(t){return this.intersectBoxMinMax(t.minimum,t.maximum)},ray.prototype.intersectPlaneTransform=function(e){var a=null,r=e.getWorldTranslate(),i=t.math.pool.new_vector3();e.getForwardInWorld(i);var o=this.intersectPlane(r,i);return o&&((a=new t.framework.pickinfo(0,0,0)).hitposition=o,a.distance=t.math.vec3Distance(a.hitposition,this.origin)),t.math.pool.delete_vector3(i),a},ray.prototype.intersectPlane=function(e,a){var r=a.x,i=a.y,o=a.z,n=e.x,s=e.y,l=e.z,h=this.direction.x,c=this.direction.y,u=this.direction.z,d=this.origin.x,m=this.origin.y,p=this.origin.z,f=h*r+c*i+u*o;if(0===f)return null;var v=((n-d)*r+(s-m)*i+(l-p)*o)/f;return new t.math.vector3(d+h*v,m+c*v,p+u*v)},ray.prototype.intersectCollider=function(a){var r=a.gameObject.collider,i=null;if(r instanceof e.boxcollider){var o=r.getBound();if(!o)return null;var n=[];o.caclWorldVecs(n,r.gameObject.transform.getWorldMatrix());for(var s=t.render.meshData.genBoxByArray(n),l=0;l<s.pos.length;l+=3){var h=s.pos[s.trisindex[l]],c=s.pos[s.trisindex[l+1]],u=s.pos[s.trisindex[l+2]],d=this.intersectsTriangle(h,c,u);if(d){if(d.distance<0)continue;if(!i||i.distance>d.distance){i=d;var m=t.math.pool.new_vector3();t.math.vec3ScaleByNum(this.direction,d.distance,m),t.math.vec3Add(this.origin,m,i.hitposition),t.math.pool.delete_vector3(m)}}}}else if(r instanceof e.meshcollider){var p=r.getBound();null!=p&&(i=p.intersects(this,a.getWorldMatrix()))}else r instanceof e.canvasRenderer&&(i=this.intersectPlaneTransform(a));return i},ray.prototype.intersectBoxMinMax=function(t,e){var a,r,i,o,n=0,s=Number.MAX_VALUE;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<t.x||this.origin.x>e.x)return!1}else if(a=1/this.direction.x,r=(t.x-this.origin.x)*a,(i=(e.x-this.origin.x)*a)===-1/0&&(i=1/0),r>i&&(o=r,r=i,i=o),n=Math.max(r,n),s=Math.min(i,s),n>s)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<t.y||this.origin.y>e.y)return!1}else if(a=1/this.direction.y,r=(t.y-this.origin.y)*a,(i=(e.y-this.origin.y)*a)===-1/0&&(i=1/0),r>i&&(o=r,r=i,i=o),n=Math.max(r,n),s=Math.min(i,s),n>s)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<t.z||this.origin.z>e.z)return!1}else if(a=1/this.direction.z,r=(t.z-this.origin.z)*a,(i=(e.z-this.origin.z)*a)===-1/0&&(i=1/0),r>i&&(o=r,r=i,i=o),n=Math.max(r,n),s=Math.min(i,s),n>s)return!1;return!0},ray.prototype.intersectsSphere=function(e,a){var r=t.math.pool.new_vector3();t.math.vec3Subtract(e,this.origin,r);var i=t.math.vec3Dot(this.direction,r);if(o<n)return!0;if(i<0)return!1;var o=t.math.vec3SqrLength(r);t.math.pool.delete_vector3(r);var n=a*a;return!(n-(o-i*i)<0)},ray.prototype.intersectsTriangle=function(a,r,i){var o=t.math.pool.new_vector3(),n=t.math.pool.new_vector3(),s=t.math.pool.new_vector3(),l=t.math.pool.new_vector3(),h=t.math.pool.new_vector3();t.math.vec3Subtract(r,a,o),t.math.vec3Subtract(i,a,n),t.math.vec3Cross(this.direction,n,s);var c=t.math.vec3Dot(o,s);if(0===c)return null;var u=1/c;t.math.vec3Subtract(this.origin,a,l);var d=t.math.vec3Dot(l,s)*u;if(d<0||d>1)return null;t.math.vec3Cross(l,o,h);var m=t.math.vec3Dot(this.direction,h)*u;if(m<0||d+m>1)return null;var p=t.math.vec3Dot(n,h)*u;return t.math.pool.delete_vector3(o),t.math.pool.delete_vector3(n),t.math.pool.delete_vector3(s),t.math.pool.delete_vector3(l),t.math.pool.delete_vector3(h),new e.pickinfo(d,m,p)},ray}();e.ray=a}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function transform(){this.name="noname",this.insId=new r,this.prefab=null,this.aabbdirty=!0,this.aabbchilddirty=!0,this.dirty=!0,this.dirtyChild=!0,this.dirtyWorldDecompose=!1,this.localRotate=new t.math.quaternion,this.localTranslate=new t.math.vector3(0,0,0),this.localScale=new t.math.vector3(1,1,1),this.localMatrix=new t.math.matrix,this._localEulerAngles=new t.math.vector3(0,0,0),this.worldMatrix=new t.math.matrix,this.worldRotate=new t.math.quaternion,this.worldTranslate=new t.math.vector3(0,0,0),this.worldScale=new t.math.vector3(1,1,1),this._beDispose=!1}return Object.defineProperty(transform.prototype,"scene",{get:function(){if(null==this._scene){if(null==this.parent)return null;this._scene=this.parent.scene}return this._scene},set:function(t){this._scene=t},enumerable:!0,configurable:!0}),transform.prototype.markAABBDirty=function(){this.aabbdirty=!0,this.markAABBChildDirty();for(var t=this.parent;null!=t;)t.markAABBChildDirty(),t=t.parent},transform.prototype.markAABBChildDirty=function(){this.aabbchilddirty=!0},transform.prototype.caclAABB=function(){null!=this.gameObject.components&&(null==this.aabb&&(this.aabb=this.buildAABB(),this.aabbchild=this.aabb.clone()),this.aabb.update(this.worldMatrix))},transform.prototype.caclAABBChild=function(){if(null!=this.aabb&&(this.aabbchild=this.aabb.clone(),null!=this.children))for(var t=0;t<this.children.length;t++)this.aabbchild.addAABB(this.children[t].aabbchild)},transform.prototype.buildAABB=function(){var a=new t.math.vector3,r=new t.math.vector3,i=this.gameObject.getComponent("meshFilter");if(null!=i&&null!=i.mesh){var o=i.mesh.data;t.math.vec3SetByFloat(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,a),t.math.vec3SetByFloat(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,r);for(l=0;l<o.pos.length;l++)t.math.vec3Max(o.pos[l],r,r),t.math.vec3Min(o.pos[l],a,a)}else{var n=this.gameObject.getComponent("skinnedMeshRenderer");if(null!=n){var s=n.mesh.data;t.math.vec3SetByFloat(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,a),t.math.vec3SetByFloat(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,r);for(var l=0;l<s.pos.length;l++)t.math.vec3Max(s.pos[l],r,r),t.math.vec3Min(s.pos[l],a,a)}else a.x=-1,a.y=-1,a.z=-1,r.x=1,r.y=1,r.z=1}return new e.aabb(a,r)},transform.prototype.addChild=function(t){null!=t.parent&&t.parent.removeChild(t),null==this.children&&(this.children=[]),this.children.push(t),t.scene=this.scene,t.parent=this,e.sceneMgr.app.markNotify(t,e.NotifyType.AddChild)},transform.prototype.addChildAt=function(t,a){a<0||(null!=t.parent&&t.parent.removeChild(t),null==this.children&&(this.children=[]),this.children.splice(a,0,t),t.scene=this.scene,t.parent=this,e.sceneMgr.app.markNotify(t,e.NotifyType.AddChild))},transform.prototype.removeAllChild=function(){if(void 0!=this.children)for(;this.children.length>0;)this.removeChild(this.children[0])},transform.prototype.removeChild=function(t){if(t.parent!=this||null==this.children)throw new Error("not my child.");var a=this.children.indexOf(t);a>=0&&(this.children.splice(a,1),e.sceneMgr.app.markNotify(t,e.NotifyType.RemoveChild),t.parent=null)},transform.prototype.find=function(t){if(this.name==t)return this;if(void 0!=this.children)for(var e in this.children){var a=this.children[e].find(t);if(null!=a)return a}return null},transform.prototype.checkImpactTran=function(t){return null!=this.gameObject.collider&&this.gameObject.collider.intersectsTransform(t)},transform.prototype.checkImpact=function(){var t=new Array;return this.doImpact(this.scene.getRoot(),t),t},transform.prototype.doImpact=function(t,e){if(t!=this&&(null!=t.gameObject&&null!=t.gameObject.collider&&this.checkImpactTran(t)&&e.push(t),null!=t.children))for(var a=0;a<t.children.length;a++)this.doImpact(t.children[a],e)},transform.prototype.markDirty=function(){this.dirty=!0;for(var t=this.parent;null!=t;)t.dirtyChild=!0,t=t.parent},transform.prototype.updateTran=function(e){if(0!=this.dirtyChild||0!=this.dirty||0!=e){if(this.dirty&&t.math.matrixMakeTransformRTS(this.localTranslate,this.localScale,this.localRotate,this.localMatrix),(this.dirty||e)&&(null==this.parent?t.math.matrixClone(this.localMatrix,this.worldMatrix):t.math.matrixMultiply(this.parent.worldMatrix,this.localMatrix,this.worldMatrix),this.dirtyWorldDecompose=!0,this.markAABBDirty()),null!=this.children)for(var a=0;a<this.children.length;a++)this.children[a].updateTran(e||this.dirty);this.dirty=!1,this.dirtyChild=!1,this.aabbdirty&&(this.caclAABB(),this.aabbdirty=!1)}},transform.prototype.updateWorldTran=function(){var t=this.parent,e=[];for(e.push(this);null!=t;)t.dirty&&e.push(t),t=t.parent;e.pop().updateTran(!1)},transform.prototype.updateAABBChild=function(){if(this.aabbchilddirty){if(null!=this.children)for(var t=0;t<this.children.length;t++)this.children[t].updateAABBChild();this.caclAABBChild(),this.aabbchilddirty=!1}},Object.defineProperty(transform.prototype,"localEulerAngles",{get:function(){return t.math.quatToEulerAngles(this.localRotate,this._localEulerAngles),this._localEulerAngles},set:function(e){t.math.quatFromEulerAngles(e.x,e.y,e.z,this.localRotate)},enumerable:!0,configurable:!0}),transform.prototype.getWorldTranslate=function(){return this.dirtyWorldDecompose&&(t.math.matrixDecompose(this.worldMatrix,this.worldScale,this.worldRotate,this.worldTranslate),this.dirtyWorldDecompose=!1),this.worldTranslate},transform.prototype.getWorldScale=function(){return this.dirtyWorldDecompose&&(t.math.matrixDecompose(this.worldMatrix,this.worldScale,this.worldRotate,this.worldTranslate),this.dirtyWorldDecompose=!1),this.worldScale},transform.prototype.getWorldRotate=function(){return this.dirtyWorldDecompose&&(t.math.matrixDecompose(this.worldMatrix,this.worldScale,this.worldRotate,this.worldTranslate),this.dirtyWorldDecompose=!1),this.worldRotate},transform.prototype.getLocalMatrix=function(){return this.localMatrix},transform.prototype.getWorldMatrix=function(){return this.worldMatrix},transform.prototype.getForwardInWorld=function(e){var a=t.math.pool.new_vector3();a.x=0,a.y=0,a.z=1,t.math.matrixTransformNormal(a,this.worldMatrix,e),t.math.vec3Normalize(e,e),t.math.pool.delete_vector3(a)},transform.prototype.getRightInWorld=function(e){var a=t.math.pool.new_vector3();a.x=1,a.y=0,a.z=0,t.math.matrixTransformNormal(a,this.worldMatrix,e),t.math.vec3Normalize(e,e),t.math.pool.delete_vector3(a)},transform.prototype.getUpInWorld=function(e){var a=t.math.pool.new_vector3();a.x=0,a.y=1,a.z=0,t.math.matrixTransformNormal(a,this.worldMatrix,e),t.math.vec3Normalize(e,e),t.math.pool.delete_vector3(a)},transform.prototype.setWorldMatrix=function(e){this.dirty=!0,this.updateWorldTran();var a=t.math.pool.new_matrix();null!=this.parent?t.math.matrixClone(this.parent.worldMatrix,a):t.math.matrixMakeIdentity(a);var r=t.math.pool.new_matrix();t.math.matrixInverse(a,r),t.math.matrixClone(e,this.worldMatrix),this.dirtyWorldDecompose=!0,t.math.matrixMultiply(r,this.worldMatrix,this.localMatrix),t.math.matrixDecompose(this.localMatrix,this.localScale,this.localRotate,this.localTranslate),this.markDirty(),t.math.pool.delete_matrix(a),t.math.pool.delete_matrix(r)},transform.prototype.setWorldPosition=function(e){this.dirty=!0,this.updateWorldTran();var a=t.math.pool.new_matrix();null!=this.parent?t.math.matrixClone(this.parent.worldMatrix,a):t.math.matrixMakeIdentity(a);var r=t.math.pool.new_matrix();t.math.matrixInverse(a,r),this.worldMatrix.rawData[12]=e.x,this.worldMatrix.rawData[13]=e.y,this.worldMatrix.rawData[14]=e.z,t.math.matrixMultiply(r,this.worldMatrix,this.localMatrix),t.math.matrixDecompose(this.localMatrix,this.localScale,this.localRotate,this.localTranslate),this.markDirty(),t.math.pool.delete_matrix(a),t.math.pool.delete_matrix(r)},transform.prototype.lookat=function(e){this.dirty=!0,e.updateWorldTran(),this.updateWorldTran();var a=this.getWorldTranslate(),r=e.getWorldTranslate(),i=t.math.pool.new_vector3();t.math.vec3Subtract(r,a,i);var o=t.math.pool.new_quaternion(),n=t.math.pool.new_quaternion();t.math.quatLookat(a,r,o);var s=this.parent.getWorldRotate();t.math.quatInverse(s,n),t.math.quatMultiply(n,o,this.localRotate),t.math.pool.delete_vector3(i),t.math.pool.delete_quaternion(o),t.math.pool.delete_quaternion(n)},transform.prototype.lookatPoint=function(e){this.dirty=!0,this.updateWorldTran();var a=this.getWorldTranslate(),r=e,i=t.math.pool.new_vector3();t.math.vec3Subtract(r,a,i);var o=t.math.pool.new_quaternion(),n=t.math.pool.new_quaternion();t.math.quatLookat(a,r,o);var s=this.parent.getWorldRotate();t.math.quatInverse(s,n),t.math.quatMultiply(n,o,this.localRotate),this.markDirty(),t.math.pool.delete_vector3(i),t.math.pool.delete_quaternion(o),t.math.pool.delete_quaternion(n)},Object.defineProperty(transform.prototype,"gameObject",{get:function(){return null==this._gameObject&&(this._gameObject=new e.gameObject,this._gameObject.transform=this),this._gameObject},enumerable:!0,configurable:!0}),transform.prototype.clone=function(){return t.io.cloneObj(this)},Object.defineProperty(transform.prototype,"beDispose",{get:function(){return this._beDispose},enumerable:!0,configurable:!0}),transform.prototype.dispose=function(){if(!this._beDispose){if(this.children){for(var t in this.children)this.children[t].dispose();this.removeAllChild()}this._gameObject.dispose(),this._beDispose=!0}},transform}();__decorate([t.reflect.Field("string"),__metadata("design:type",String)],a.prototype,"name",void 0),__decorate([t.reflect.Field("transform[]"),__metadata("design:type",Array)],a.prototype,"children",void 0),__decorate([t.reflect.Field("quaternion"),__metadata("design:type",t.math.quaternion)],a.prototype,"localRotate",void 0),__decorate([t.reflect.Field("vector3",new t.math.vector3(0,0,0)),__metadata("design:type",t.math.vector3)],a.prototype,"localTranslate",void 0),__decorate([t.reflect.Field("vector3",new t.math.vector3(1,1,1)),__metadata("design:type",t.math.vector3)],a.prototype,"localScale",void 0),__decorate([t.reflect.Field("gameObject"),__metadata("design:type",Object),__metadata("design:paramtypes",[])],a.prototype,"gameObject",null),a=__decorate([t.reflect.SerializeType],a),e.transform=a;var r=function(){function insID(){this.id=insID.next()}return insID.next=function(){var t=insID.idAll;return insID.idAll++,t},insID.prototype.getInsID=function(){return this.id},insID}();r.idAll=1,e.insID=r}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(gd3d){var framework;!function(framework){var EnumUtil=function(){function EnumUtil(){}return EnumUtil.getEnumObjByType=function(enumType){var index=enumType.indexOf("gd3d.framework.");return 0==index&&(enumType=enumType.substr(15)),eval("{result:"+enumType+"}")},EnumUtil}();framework.EnumUtil=EnumUtil}(framework=gd3d.framework||(gd3d.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(t){var e=function(){return function NumberUtil(){}}();e.KEY_A=65,e.KEY_D=68,e.KEY_E=69,e.KEY_Q=81,e.KEY_R=82,e.KEY_S=83,e.KEY_W=87,e.KEY_a=97,e.KEY_d=100,e.KEY_e=101,e.KEY_q=113,e.KEY_r=114,e.KEY_s=115,e.KEY_w=119,t.NumberUtil=e}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(t){var e=function(){return function RegexpUtil(){}}();e.textureRegexp=/([_0-9a-zA-Z]+)[ ]*\([ ]*'(.+)'[ ]*,[ ]*([0-9a-zA-Z]+)[ ]*\)[ ]*=[ ]*'(.+)'[ ]*\{[ ]*([a-zA-Z]*)[ ]*([a-zA-Z]*)[ ]*\}/,e.vectorRegexp=/([_0-9a-zA-Z]+)[ ]*\([ ]*'(.+)'[ ]*,[ ]*([0-9a-zA-Z]+)[ ]*\)[ ]*=[ ]*\([ ]*([0-9.-]+)[ ]*,[ ]*([0-9.-]+)[ ]*,[ ]*([0-9.-]+)[ ]*,[ ]*([0-9.-]+)[ ]*\)/,e.floatRegexp=/([_0-9a-zA-Z]+)[ ]*\([ ]*'(.+)'[ ]*,[ ]*([0-9a-zA-Z]+)[ ]*\)[ ]*=[ ]*([0-9.-]+)/,e.rangeRegexp=/([_0-9a-zA-Z]+)[ ]*\([ ]*'(.+)'[ ]*,[ ]*([0-9a-zA-Z]+)[ ]*\([ ]*([0-9.-]+)[ ]*,[ ]*([0-9.-]+)[ ]*\)[ ]*\)[ ]*=[ ]*([0-9.-]+)/,e.vector4Regexp=/\([ ]*([0-9.-]+)[ ]*,[ ]*([0-9.-]+)[ ]*,[ ]*([0-9.-]+)[ ]*,[ ]*([0-9.-]+)[ ]*\)/,e.vector3FloatOrRangeRegexp=/([0-9.-]+|\[[0-9.-]+,[0-9.-]+\]),([0-9.-]+|\[[0-9.-]+,[0-9.-]+\]),([0-9.-]+|\[[0-9.-]+,[0-9.-]+\])/,t.RegexpUtil=e}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(t){var e=function(){function StringUtil(){}return StringUtil.replaceAll=function(t,e,a){return t.replace(new RegExp(e,"gm"),a)},StringUtil.trimAll=function(t){var e=(t+="").replace(/(^\s+)|(\s+$)/g,"");return e=e.replace(/\s/g,"")},StringUtil.firstCharToLowerCase=function(t){return t.substr(0,1).toLowerCase()+t.substr(1)},StringUtil}();e.COMPONENT_CAMERA="camera",e.COMPONENT_BOXCOLLIDER="boxcollider",e.COMPONENT_LIGHT="light",e.COMPONENT_MESHFILTER="meshFilter",e.COMPONENT_MESHRENDER="meshRenderer",e.COMPONENT_EFFECTSYSTEM="effectSystem",e.COMPONENT_LABEL="label",e.COMPONENT_IMAGE="image2D",e.COMPONENT_RAWIMAGE="rawImage2D",e.COMPONENT_BUTTON="button",e.COMPONENT_SKINMESHRENDER="skinnedMeshRenderer",e.COMPONENT_CAMERACONTROLLER="cameraController",e.COMPONENT_CANVASRENDER="canvasRenderer",e.UIStyle_RangeFloat="rangeFloat",e.UIStyle_Enum="enum",e.RESOURCES_MESH_CUBE="cube",t.StringUtil=e}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a;!function(t){t[t.Sphere=0]="Sphere",t[t.Capsule=1]="Capsule",t[t.Cylinder=2]="Cylinder",t[t.Cube=3]="Cube",t[t.Plane=4]="Plane",t[t.Quad=5]="Quad",t[t.Pyramid=6]="Pyramid"}(a=e.PrimitiveType||(e.PrimitiveType={}));var r;!function(t){t[t.RawImage2D=0]="RawImage2D",t[t.Image2D=1]="Image2D",t[t.Label=2]="Label",t[t.Button=3]="Button"}(r=e.Primitive2DType||(e.Primitive2DType={}));var i=function(){function TransformUtil(){}return TransformUtil.CreatePrimitive=function(t,r){var i=a[t],o=new e.transform;o.name=i;var n=o.gameObject.addComponent("meshFilter"),s=r.getAssetMgr().getDefaultMesh(i.toLowerCase());n.mesh=s;var l=o.gameObject.addComponent("meshRenderer");return l.materials=[],l.materials.push(new e.material),l.materials[0].setShader(r.getAssetMgr().getShader("shader/def")),o},TransformUtil.Create2DPrimitive=function(t,a){var i=r[t],o=e.StringUtil.firstCharToLowerCase(i),n=new e.transform2D;n.name=i;var s=n.addComponent(o);switch(n.pivot.x=0,n.pivot.y=0,t){case r.RawImage2D:TransformUtil.create2D_rawImage(s,a);break;case r.Image2D:TransformUtil.create2D_image2D(s,a);break;case r.Label:TransformUtil.create2D_label(s,a);break;case r.Button:TransformUtil.create2D_button(s,a)}return n},TransformUtil.create2D_rawImage=function(t,e){t.transform.width=100,t.transform.height=100,t.image=e.getAssetMgr().getDefaultTexture("white")},TransformUtil.create2D_image2D=function(t,e){t.transform.width=100,t.transform.height=100,t.setTexture(e.getAssetMgr().getDefaultTexture("white"))},TransformUtil.create2D_label=function(e,a){e.transform.width=150,e.transform.height=50,e.text="label",e.fontsize=25,e.color=new t.math.color(1,0,0,1);var r=a.getAssetMgr().getAssetByName("STXINGKA.font.json");null==r?a.getAssetMgr().load("res/STXINGKA.TTF.png",t.framework.AssetTypeEnum.Auto,function(r){r.isfinish&&a.getAssetMgr().load("res/resources/STXINGKA.font.json",t.framework.AssetTypeEnum.Auto,function(t){e.font=a.getAssetMgr().getAssetByName("STXINGKA.font.json"),e.transform.markDirty()})}):(e.font=r,e.transform.markDirty())},TransformUtil.create2D_button=function(e,a){e.transform.width=150,e.transform.height=50;var r=e.transform.addComponent("image2D");r.setTexture(a.getAssetMgr().getDefaultTexture("white")),r.imageType=t.framework.ImageType.Sliced,e.targetImage=r,e.transition=t.framework.TransitionType.ColorTint;var i=new t.framework.transform2D;i.name="label",i.width=150,i.height=50,i.pivot.x=0,i.pivot.y=0,i.localTranslate.y=-10;var o=i.addComponent("label");o.text="button",o.fontsize=25,o.color=new t.math.color(1,0,0,1),e.transform.addChild(i);var n=a.getAssetMgr().getAssetByName("STXINGKA.font.json");null==n?a.getAssetMgr().load("res/STXINGKA.TTF.png",t.framework.AssetTypeEnum.Auto,function(r){r.isfinish&&a.getAssetMgr().load("res/resources/STXINGKA.font.json",t.framework.AssetTypeEnum.Auto,function(t){o.font=a.getAssetMgr().getAssetByName("STXINGKA.font.json"),e.transform.markDirty()})}):(o.font=n,e.transform.markDirty())},TransformUtil}();e.TransformUtil=i}(t.framework||(t.framework={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(t){t.loadText=function loadText(t,e){var a=new XMLHttpRequest;a.open("GET",t),a.responseType="text",a.onreadystatechange=function(){if(4==a.readyState){if(404==a.status)return void e(null,new Error("got a 404:"+t));e(a.responseText,null)}},a.onerror=function(){e(null,new Error("onerr in req:"))},a.send()},t.loadArrayBuffer=function loadArrayBuffer(t,e){var a=new XMLHttpRequest;a.open("GET",t),a.responseType="arraybuffer",a.onreadystatechange=function(){if(4==a.readyState){if(404==a.status)return void e(null,new Error("got a 404:"+t));e(a.response,null)}},a.onerror=function(){e(null,new Error("onerr in req:"))},a.send()},t.loadBlob=function loadBlob(t,e){var a=new XMLHttpRequest;a.open("GET",t),a.responseType="blob",a.onreadystatechange=function(){if(4==a.readyState){if(404==a.status)return void e(null,new Error("got a 404:"+t));e(a.response,null)}},a.onerror=function(){e(null,new Error("onerr in req:"))},a.send()},t.loadImg=function loadImg(t,e,a){var r=new Image;r.src=t,r.onerror=function(t){null!=t&&e(null,new Error(t.message))},r.onprogress=function(t){if(a){var e=t.loaded/t.total*100;a(e)}},r.onload=function(){e(r,null)}}}(t.io||(t.io={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(t){var e=function(){function pool(){}return pool.collect_all=function(){pool.collect_vector4(),pool.collect_vector3(),pool.collect_vector2(),pool.collect_matrix(),pool.collect_quaternion(),pool.collect_color()},Object.defineProperty(pool,"vector4_one",{get:function(){return null==pool._vector4_one&&(pool._vector4_one=new t.vector4(1,1,1,1)),pool._vector4_one},enumerable:!0,configurable:!0}),pool.new_vector4=function(){return pool.unused_vector4.length>0?pool.unused_vector4.pop():new t.vector4},pool.clone_vector4=function(e){if(pool.unused_vector4.length>0){var a=pool.unused_vector4.pop();return a.x=e.x,a.y=e.y,a.z=e.z,a.w=e.w,a}return new t.vector4(e.x,e.y,e.z)},pool.delete_vector4=function(e){null!=e&&(e instanceof t.vector4?(e.x=e.y=e.z=0,e.w=1,pool.unused_vector4.push(e)):console.error("kindding me?确定你要回收的是vector4吗？"))},pool.collect_vector4=function(){pool.unused_vector4.length=0},Object.defineProperty(pool,"color_one",{get:function(){return null==pool._color_one&&(pool._color_one=new t.color(1,1,1,1)),pool._color_one},enumerable:!0,configurable:!0}),pool.new_color=function(){return pool.unused_color.length>0?pool.unused_color.pop():new t.color},pool.delete_color=function(e){null!=e&&(e instanceof t.color?(e.r=e.g=e.b=0,e.a=1,pool.unused_color.push(e)):console.error("kindding me?确定你要回收的是color吗？"))},pool.collect_color=function(){pool.unused_color.length=0},Object.defineProperty(pool,"vector3_up",{get:function(){return null==pool._vector3_up&&(pool._vector3_up=new t.vector3(0,1,0)),pool._vector3_up},enumerable:!0,configurable:!0}),Object.defineProperty(pool,"vector3_right",{get:function(){return null==pool._vector3_right&&(pool._vector3_right=new t.vector3(1,0,0)),pool._vector3_right},enumerable:!0,configurable:!0}),Object.defineProperty(pool,"vector3_forward",{get:function(){return null==pool._vector3_forward&&(pool._vector3_forward=new t.vector3(0,0,1)),pool._vector3_forward},enumerable:!0,configurable:!0}),Object.defineProperty(pool,"vector3_zero",{get:function(){return null==pool._vector3_zero&&(pool._vector3_zero=new t.vector3(0,0,0)),pool._vector3_zero},enumerable:!0,configurable:!0}),Object.defineProperty(pool,"vector3_one",{get:function(){return null==pool._vector3_one&&(pool._vector3_one=new t.vector3(1,1,1)),pool._vector3_one},enumerable:!0,configurable:!0}),pool.new_vector3=function(){return pool.unused_vector3.length>0?pool.unused_vector3.pop():new t.vector3},pool.clone_vector3=function(e){if(pool.unused_vector3.length>0){var a=pool.unused_vector3.pop();return a.x=e.x,a.y=e.y,a.z=e.z,a}return new t.vector3(e.x,e.y,e.z)},pool.delete_vector3=function(e){null!=e&&(e instanceof t.vector3?(e.x=e.y=e.z=0,pool.unused_vector3.push(e)):console.error("kindding me?确定你要回收的是vector3吗？"))},pool.collect_vector3=function(){pool.unused_vector3.length=0},Object.defineProperty(pool,"vector2_up",{get:function(){return null==pool._vector2_up&&(pool._vector2_up=new t.vector2(0,1)),pool._vector2_up},enumerable:!0,configurable:!0}),Object.defineProperty(pool,"vector2_right",{get:function(){return null==pool._vector2_right&&(pool._vector2_right=new t.vector2(1,0)),pool._vector2_right},enumerable:!0,configurable:!0}),pool.new_vector2=function(){return pool.unused_vector2.length>0?pool.unused_vector2.pop():new t.vector2},pool.clone_vector2=function(e){if(pool.unused_vector2.length>0){var a=pool.unused_vector2.pop();return a.x=e.x,a.y=e.y,a}return new t.vector2(e.x,e.y)},pool.delete_vector2=function(e){null!=e&&(e instanceof t.vector2?(e.x=e.y=0,pool.unused_vector2.push(e)):console.error("kindding me?确定你要回收的是vector2吗？"))},pool.delete_vector2Array=function(t){for(var e=0;e<t.length;e++)void 0!=t[e]&&(t[e].x=t[e].y=0,pool.unused_vector2.push(t[e]));t.length=0},pool.collect_vector2=function(){pool.unused_vector2.length=0},pool.new_matrix3x2=function(){return pool.unused_matrix3x2.length>0?pool.unused_matrix3x2.pop():new t.matrix3x2},pool.clone_matrix3x2=function(t){for(var e=pool.new_matrix(),a=0;a<6;a++)e.rawData[a]=t.rawData[a];return e},pool.delete_matrix3x2=function(e){null!=e&&(e instanceof t.matrix3x2?(e.rawData[0]=1,e.rawData[1]=0,e.rawData[2]=0,e.rawData[3]=0,e.rawData[4]=1,e.rawData[5]=0,pool.unused_matrix3x2.push(e)):console.error("kindding me?确定你要回收的是matrix3x2吗？"))},pool.collect_matrix3x2=function(){pool.unused_matrix3x2.length=0},pool.new_matrix=function(){return pool.unused_matrix.length>0?pool.unused_matrix.pop():new t.matrix},pool.clone_matrix=function(t){for(var e=pool.new_matrix(),a=0;a<16;a++)e.rawData[a]=t.rawData[a];return e},pool.delete_matrix=function(e){null!=e&&(e instanceof t.matrix?(e.rawData[0]=1,e.rawData[1]=0,e.rawData[2]=0,e.rawData[3]=0,e.rawData[4]=0,e.rawData[5]=1,e.rawData[6]=0,e.rawData[7]=0,e.rawData[8]=0,e.rawData[9]=0,e.rawData[10]=1,e.rawData[11]=0,e.rawData[12]=0,e.rawData[13]=0,e.rawData[14]=0,e.rawData[15]=1,pool.unused_matrix.push(e)):console.error("kindding me?确定你要回收的是matrix吗？"))},pool.collect_matrix=function(){pool.unused_matrix.length=0},pool.new_quaternion=function(){return pool.unused_quaternion.length>0?pool.unused_quaternion.pop():new t.quaternion},pool.clone_quaternion=function(e){if(pool.unused_quaternion.length>0){var a=pool.unused_quaternion.pop();return a.x=e.x,a.y=e.y,a.z=e.z,a.w=e.w,a}return new t.quaternion(e.x,e.y,e.z,e.w)},pool.delete_quaternion=function(e){null!=e&&(e instanceof t.quaternion?(e.x=e.y=e.z=0,e.w=1,pool.unused_quaternion.push(e)):console.error("kindding me?确定你要回收的是quaternion吗？"))},pool.collect_quaternion=function(){pool.unused_quaternion.length=0},pool}();e.unused_vector4=[],e.unused_color=[],e.unused_vector3=[],e.unused_vector2=[],e.unused_matrix3x2=[],e.unused_matrix=[],e.unused_quaternion=[],t.pool=e}(t.math||(t.math={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(t){var e=function(){return function caps(){}}();t.caps=e;var a=function(){function webglkit(){}return webglkit.SetMaxVertexAttribArray=function(t,e){for(var a=e;a<webglkit._maxVertexAttribArray;a++)t.disableVertexAttribArray(a);webglkit._maxVertexAttribArray=e},webglkit.GetTextureNumber=function(t,e){return webglkit.initConst(t),webglkit._texNumber[e]},webglkit.initConst=function(t){null==webglkit._texNumber&&((webglkit._texNumber=[]).push(t.TEXTURE0),webglkit._texNumber.push(t.TEXTURE1),webglkit._texNumber.push(t.TEXTURE2),webglkit._texNumber.push(t.TEXTURE3),webglkit._texNumber.push(t.TEXTURE4),webglkit._texNumber.push(t.TEXTURE5),webglkit._texNumber.push(t.TEXTURE6),webglkit._texNumber.push(t.TEXTURE7),webglkit._texNumber.push(t.TEXTURE8),webglkit._texNumber.push(t.TEXTURE9),webglkit.LEQUAL=t.LEQUAL,webglkit.NEVER=t.NEVER,webglkit.EQUAL=t.EQUAL,webglkit.GEQUAL=t.GEQUAL,webglkit.NOTEQUAL=t.NOTEQUAL,webglkit.LESS=t.LESS,webglkit.GREATER=t.GREATER,webglkit.ALWAYS=t.ALWAYS,webglkit.FUNC_ADD=t.FUNC_ADD,webglkit.FUNC_SUBTRACT=t.FUNC_SUBTRACT,webglkit.FUNC_REVERSE_SUBTRACT=t.FUNC_REVERSE_SUBTRACT,webglkit.ONE=t.ONE,webglkit.ZERO=t.ZERO,webglkit.SRC_ALPHA=t.SRC_ALPHA,webglkit.SRC_COLOR=t.SRC_COLOR,webglkit.ONE_MINUS_SRC_ALPHA=t.ONE_MINUS_SRC_ALPHA,webglkit.ONE_MINUS_SRC_COLOR=t.ONE_MINUS_SRC_COLOR,webglkit.ONE_MINUS_DST_ALPHA=t.ONE_MINUS_DST_ALPHA,webglkit.ONE_MINUS_DST_COLOR=t.ONE_MINUS_DST_COLOR,webglkit.caps.standardDerivatives=null!==t.getExtension("OES_standard_derivatives"),webglkit.caps.pvrtcExtension=t.getExtension("WEBGL_compressed_texture_pvrtc"))},webglkit}();a._maxVertexAttribArray=0,a._texNumber=null,a.caps=new e,t.webglkit=a}(t.render||(t.render={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(t){var e;!function(t){t[t.ALL=0]="ALL",t[t.CCW=1]="CCW",t[t.CW=2]="CW"}(e=t.ShowFaceStateEnum||(t.ShowFaceStateEnum={}));var a;!function(t){t[t.VboTri=0]="VboTri",t[t.VboLine=1]="VboLine",t[t.EboTri=2]="EboTri",t[t.EboLine=3]="EboLine"}(a=t.DrawModeEnum||(t.DrawModeEnum={}));var r;!function(t){t[t.Close=0]="Close",t[t.Blend=1]="Blend",t[t.Blend_PreMultiply=2]="Blend_PreMultiply",t[t.Add=3]="Add",t[t.Add_PreMultiply=4]="Add_PreMultiply"}(r=t.BlendModeEnum||(t.BlendModeEnum={}));var i=function(){function glDrawPass(){this.state_showface=e.CCW,this.state_zwrite=!1,this.state_ztest=!1,this.state_ztest_method=t.webglkit.LEQUAL,this.state_blend=!1,this.state_blendEquation=0,this.state_blendSrcRGB=0,this.state_blendDestRGB=0,this.state_blendSrcAlpha=0,this.state_blendDestALpha=0,this.uniforms={},this.uniformallchange=!1}return glDrawPass.prototype.setProgram=function(e,a){void 0===a&&(a=!1),this.program=e,this.uniforms={};for(var r in this.program.mapUniform){var i=this.program.mapUniform[r].location;this.program.mapUniform[r].type==t.UniformTypeEnum.Texture?this.uniforms[r]={change:!1,location:i,type:t.UniformTypeEnum.Texture,value:null}:this.program.mapUniform[r].type==t.UniformTypeEnum.Float4x4v?this.uniforms[r]={change:!1,location:i,type:t.UniformTypeEnum.Float4x4v,value:a?new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]):null}:this.program.mapUniform[r].type==t.UniformTypeEnum.Float4x4?this.uniforms[r]={change:!1,location:i,type:t.UniformTypeEnum.Float4x4,value:a?new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]):null}:this.program.mapUniform[r].type==t.UniformTypeEnum.Float4v?this.uniforms[r]={change:!1,location:i,type:t.UniformTypeEnum.Float4v,value:a?new Float32Array([0,0,0,0]):null}:this.program.mapUniform[r].type==t.UniformTypeEnum.Float4?this.uniforms[r]={change:!1,location:i,type:t.UniformTypeEnum.Float4,value:a?new Float32Array([0,0,0,0]):null}:this.program.mapUniform[r].type==t.UniformTypeEnum.Float?this.uniforms[r]={change:!1,location:i,type:t.UniformTypeEnum.Float,value:a?0:null}:this.program.mapUniform[r].type==t.UniformTypeEnum.Floatv&&(this.uniforms[r]={change:!1,location:i,type:t.UniformTypeEnum.Floatv,value:a?new Float32Array([0]):null})}this.uniformallchange=!0},glDrawPass.prototype.setAlphaBlend=function(e){e==r.Add?(this.state_blend=!0,this.state_blendEquation=t.webglkit.FUNC_ADD,this.state_blendSrcRGB=t.webglkit.SRC_ALPHA,this.state_blendDestRGB=t.webglkit.ONE,this.state_blendSrcAlpha=t.webglkit.SRC_ALPHA,this.state_blendDestALpha=t.webglkit.ONE):e==r.Add_PreMultiply?(this.state_blend=!0,this.state_blendEquation=t.webglkit.FUNC_ADD,this.state_blendSrcRGB=t.webglkit.ONE,this.state_blendDestRGB=t.webglkit.ONE,this.state_blendSrcAlpha=t.webglkit.SRC_ALPHA,this.state_blendDestALpha=t.webglkit.ONE):e==r.Blend?(this.state_blend=!0,this.state_zwrite=!1,this.state_blendEquation=t.webglkit.FUNC_ADD,this.state_blendSrcRGB=t.webglkit.SRC_ALPHA,this.state_blendDestRGB=t.webglkit.ONE_MINUS_SRC_ALPHA,this.state_blendSrcAlpha=t.webglkit.SRC_ALPHA,this.state_blendDestALpha=t.webglkit.ONE):e==r.Blend_PreMultiply?(this.state_blend=!0,this.state_blendEquation=t.webglkit.FUNC_ADD,this.state_blendSrcRGB=t.webglkit.ONE,this.state_blendDestRGB=t.webglkit.ONE_MINUS_SRC_ALPHA,this.state_blendSrcAlpha=t.webglkit.SRC_ALPHA,this.state_blendDestALpha=t.webglkit.ONE):e==r.Close&&(this.state_blend=!1)},glDrawPass.prototype.uniformFloat=function(e,a){var r=this.uniforms[e];if(null==r)throw new Error("do not have this uniform");if(r.type!=t.UniformTypeEnum.Float)throw new Error("wrong uniform type:"+r.type);this.uniforms[e].value=a,this.uniforms[e].change=!0},glDrawPass.prototype.uniformFloatv=function(e,a){var r=this.uniforms[e];if(null==r)throw new Error("do not have this uniform");if(r.type!=t.UniformTypeEnum.Floatv)throw new Error("wrong uniform type:"+r.type);this.uniforms[e].value=a,this.uniforms[e].change=!0},glDrawPass.prototype.uniformVec4=function(e,a){var r=this.uniforms[e];if(null==r)throw new Error("do not have this uniform");if(r.type!=t.UniformTypeEnum.Float4)throw new Error("wrong uniform type:"+r.type);var i=this.uniforms[e].value;null==i&&(this.uniforms[e].value=[0,0,0,0],i=this.uniforms[e].value),i[0]=a.x,i[1]=a.y,i[2]=a.z,i[3]=a.w,this.uniforms[e].change=!0},glDrawPass.prototype.uniformVec4v=function(e,a){var r=this.uniforms[e];if(null==r)throw new Error("do not have this uniform");if(r.type!=t.UniformTypeEnum.Float4v)throw new Error("wrong uniform type:"+r.type);this.uniforms[e].value=a,this.uniforms[e].change=!0},glDrawPass.prototype.uniformMatrix=function(e,a){var r=this.uniforms[e];if(null==r)throw new Error("do not have this uniform");if(r.type!=t.UniformTypeEnum.Float4x4)throw new Error("wrong uniform type:"+r.type);this.uniforms[e].value=a.rawData,this.uniforms[e].change=!0},glDrawPass.prototype.uniformMatrixV=function(e,a){var r=this.uniforms[e];if(null==r)throw new Error("do not have this uniform");if(r.type!=t.UniformTypeEnum.Float4x4v)throw new Error("wrong uniform type:"+r.type);this.uniforms[e].value=a,this.uniforms[e].change=!0},glDrawPass.prototype.uniformTexture=function(e,a){var r=this.uniforms[e];if(null==r)throw new Error("do not have this uniform");if(r.type!=t.UniformTypeEnum.Texture)throw new Error("wrong uniform type:"+r.type);this.uniforms[e].value=a,this.uniforms[e].change=!0},glDrawPass.prototype.use=function(t,a){void 0===a&&(a=!0),this.state_showface==e.ALL?t.disable(t.CULL_FACE):(this.state_showface==e.CCW?t.frontFace(t.CCW):t.frontFace(t.CW),t.cullFace(t.BACK),t.enable(t.CULL_FACE)),this.state_zwrite?t.depthMask(!0):t.depthMask(!1),this.state_ztest?(t.enable(t.DEPTH_TEST),t.depthFunc(this.state_ztest_method)):t.disable(t.DEPTH_TEST),this.state_blend?(t.enable(t.BLEND),t.blendEquation(this.state_blendEquation),t.blendFuncSeparate(this.state_blendSrcRGB,this.state_blendDestRGB,this.state_blendSrcAlpha,this.state_blendDestALpha)):t.disable(t.BLEND),this.program.use(t),a&&this.applyUniformSaved(t)},glDrawPass.prototype.applyUniformSaved=function(e){var a=0;for(var r in this.uniforms){var i=this.uniforms[r];if(i.type==t.UniformTypeEnum.Texture){if(this.uniformallchange||i.change){var o=null!=i.value?i.value.texture:null;e.activeTexture(t.webglkit.GetTextureNumber(e,a)),e.bindTexture(e.TEXTURE_2D,o),e.uniform1i(i.location,a)}a++}else if(this.uniformallchange||i.change)if(i.type==t.UniformTypeEnum.Float)e.uniform1f(i.location,i.value);else if(i.type==t.UniformTypeEnum.Floatv)e.uniform1fv(i.location,i.value);else if(i.type==t.UniformTypeEnum.Float4||i.type==t.UniformTypeEnum.Float4v)try{e.uniform4fv(i.location,i.value)}catch(t){console.error(r+"  "+i.value);for(var n in this.uniforms)console.error(n)}else i.type!=t.UniformTypeEnum.Float4x4&&i.type!=t.UniformTypeEnum.Float4x4v||e.uniformMatrix4fv(i.location,!1,i.value);i.change=!1}this.uniformallchange=!1},glDrawPass.prototype.applyUniform_Float=function(t,e,a){var r=this.uniforms[e];t.uniform1f(r.location,a)},glDrawPass.prototype.applyUniform_Floatv=function(t,e,a){var r=this.uniforms[e];t.uniform1fv(r.location,a)},glDrawPass.prototype.applyUniform_Float4=function(t,e,a){var r=this.uniforms[e];t.uniform4f(r.location,a.x,a.y,a.z,a.w)},glDrawPass.prototype.applyUniform_Float4v=function(t,e,a){var r=this.uniforms[e];t.uniform4fv(r.location,a)},glDrawPass.prototype.applyUniform_Float4x4=function(t,e,a){var r=this.uniforms[e];t.uniformMatrix4fv(r.location,!1,a.rawData)},glDrawPass.prototype.applyUniform_Float4x4v=function(t,e,a){var r=this.uniforms[e];t.uniformMatrix4fv(r.location,!1,a)},glDrawPass.prototype.applyUniform_FloatTexture=function(e,a,r,i){var o=this.uniforms[r],n=null!=i?i.texture:null;e.activeTexture(t.webglkit.GetTextureNumber(e,a)),e.bindTexture(e.TEXTURE_2D,n),e.uniform1i(o.location,a)},glDrawPass.prototype.draw=function(t,e,r,i,o,n){void 0===r&&(r=a.EboTri),void 0===i&&(i=0),void 0===o&&(o=0),void 0===n&&(n=-1),this.use(t),e.bind(t,this.program,i),r==a.VboTri?e.drawArrayTris(t,o,n):r==a.VboLine?e.drawArrayLines(t,o,n):r==a.EboTri?e.drawElementTris(t,o,n):r==a.EboLine&&e.drawElementLines(t,o,n)},glDrawPass}();i.textureID=null,t.glDrawPass=i}(t.render||(t.render={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(t){var e;!function(t){t[t.Position=1]="Position",t[t.Normal=2]="Normal",t[t.Tangent=4]="Tangent",t[t.Color=8]="Color",t[t.UV0=16]="UV0",t[t.UV1=32]="UV1",t[t.BlendIndex4=64]="BlendIndex4",t[t.BlendWeight4=128]="BlendWeight4",t[t.ColorEX=256]="ColorEX"}(e=t.VertexFormatMask||(t.VertexFormatMask={}));var a=function(){return function number4(){}}();t.number4=a;var r;!function(t){t[t.Static=0]="Static",t[t.Dynamic=1]="Dynamic",t[t.Stream=2]="Stream"}(r=t.MeshTypeEnum||(t.MeshTypeEnum={}));var i=function(){function drawInfo(){}return Object.defineProperty(drawInfo,"ins",{get:function(){return null==drawInfo._ins&&(drawInfo._ins=new drawInfo),drawInfo._ins},enumerable:!0,configurable:!0}),drawInfo}();t.drawInfo=i;var o=function(){function glMesh(){this.bindIndex=-1,this.vertexFormat=e.Position}return glMesh.prototype.initBuffer=function(e,a,i,o){if(void 0===o&&(o=r.Static),null!=this.vbo)throw new Error("you can only initbuffer once.");o==r.Static?this.mode=e.STATIC_DRAW:o==r.Dynamic?this.mode=e.DYNAMIC_DRAW:o==r.Stream&&(this.mode=e.STREAM_DRAW),this.vertexFormat=a,this.vertexCount=i,i>0&&(this.vertexByteSize=t.meshData.calcByteSize(a),this.vbo=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.vbo),e.bufferData(e.ARRAY_BUFFER,i*this.vertexByteSize,this.mode)),this.indexCounts=[],this.ebos=[]},glMesh.prototype.addIndex=function(t,e){var a=this.ebos.length,r=t.createBuffer();return t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,r),t.bufferData(t.ELEMENT_ARRAY_BUFFER,2*e,this.mode),this.ebos.push(r),this.indexCounts.push(e),a},glMesh.prototype.resetVboSize=function(t,e){this.vertexCount=e,t.bindBuffer(t.ARRAY_BUFFER,this.vbo),t.bufferData(t.ARRAY_BUFFER,e*this.vertexByteSize,this.mode)},glMesh.prototype.resetEboSize=function(t,e,a){this.indexCounts[e]=a,t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.ebos[e]),t.bufferData(t.ELEMENT_ARRAY_BUFFER,2*a,this.mode)},glMesh.prototype.dispose=function(t){if(t.deleteBuffer(this.vbo),this.vbo=null,this.ebos){for(var e=0;e<this.ebos.length;e++)t.deleteBuffer(this.ebos[e]);this.ebos.length=0}},glMesh.prototype.caclByteLength=function(){var t=0;t+=this.vertexByteSize*this.vertexCount;for(var e in this.indexCounts)t+=2*this.indexCounts[e];return t},glMesh.prototype.bind=function(a,r,i){void 0===i&&(i=0),this.bindIndex=i,a.bindBuffer(a.ARRAY_BUFFER,this.vbo),i>=0&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.ebos[i]);var o=this.vertexByteSize,n=0,s=0;r.posPos>=0&&(a.enableVertexAttribArray(r.posPos),a.vertexAttribPointer(r.posPos,3,a.FLOAT,!1,o,n),s++),n+=12,this.vertexFormat&e.Normal?(r.posNormal>=0&&(a.enableVertexAttribArray(r.posNormal),a.vertexAttribPointer(r.posNormal,3,a.FLOAT,!0,o,n),s++),n+=12):r.posNormal>=0&&(a.disableVertexAttribArray(r.posNormal),s++),this.vertexFormat&e.Tangent?(r.posTangent>=0&&(a.enableVertexAttribArray(r.posTangent),a.vertexAttribPointer(r.posTangent,3,a.FLOAT,!0,o,n),s++),n+=12):r.posTangent>=0&&(a.disableVertexAttribArray(r.posTangent),s++),this.vertexFormat&e.Color?(r.posColor>=0&&(a.enableVertexAttribArray(r.posColor),a.vertexAttribPointer(r.posColor,4,a.FLOAT,!1,o,n),s++),n+=16):r.posColor>=0&&(a.disableVertexAttribArray(r.posColor),s++),this.vertexFormat&e.UV0?(r.posUV0>=0&&(a.enableVertexAttribArray(r.posUV0),a.vertexAttribPointer(r.posUV0,2,a.FLOAT,!1,o,n),s++),n+=8):r.posUV0>=0&&(a.disableVertexAttribArray(r.posUV0),s++),this.vertexFormat&e.UV1?(r.posUV2>=0&&(a.enableVertexAttribArray(r.posUV2),a.vertexAttribPointer(r.posUV2,2,a.FLOAT,!1,o,n),s++),n+=8):r.posUV2>=0&&(a.disableVertexAttribArray(r.posUV2),s++),this.vertexFormat&e.BlendIndex4?(r.posBlendIndex4>=0&&(a.enableVertexAttribArray(r.posBlendIndex4),a.vertexAttribPointer(r.posBlendIndex4,4,a.FLOAT,!1,o,n),s++),n+=16):r.posBlendIndex4>=0&&(a.disableVertexAttribArray(r.posBlendIndex4),s++),this.vertexFormat&e.BlendWeight4?(r.posBlendWeight4>=0&&(a.enableVertexAttribArray(r.posBlendWeight4),a.vertexAttribPointer(r.posBlendWeight4,4,a.FLOAT,!1,o,n),s++),n+=16):r.posBlendWeight4>=0&&(a.disableVertexAttribArray(r.posBlendWeight4),s++),this.vertexFormat&e.ColorEX?(r.posColorEx>=0&&(a.enableVertexAttribArray(r.posColorEx),a.vertexAttribPointer(r.posColorEx,4,a.FLOAT,!1,o,n),s++),n+=16):r.posColorEx>=0&&(a.disableVertexAttribArray(r.posColorEx),s++),t.webglkit.SetMaxVertexAttribArray(a,s)},glMesh.prototype.uploadVertexSubData=function(t,e,a){void 0===a&&(a=0),t.bindBuffer(t.ARRAY_BUFFER,this.vbo),t.bufferSubData(t.ARRAY_BUFFER,a,e)},glMesh.prototype.uploadIndexSubData=function(t,e,a,r){void 0===r&&(r=0),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.ebos[e]),t.bufferSubData(t.ELEMENT_ARRAY_BUFFER,r,a)},glMesh.prototype.drawArrayTris=function(t,e,a){void 0===e&&(e=0),void 0===a&&(a=-1),a<0&&(a=3*(this.vertexCount/3|0)),i.ins.triCount+=a/3,i.ins.renderCount++,t.drawArrays(t.TRIANGLES,e,a)},glMesh.prototype.drawArrayLines=function(t,e,a){void 0===e&&(e=0),void 0===a&&(a=-1),a<0&&(a=2*(this.vertexCount/2|0)),i.ins.renderCount++,t.drawArrays(t.LINES,e,a)},glMesh.prototype.drawElementTris=function(t,e,a){void 0===e&&(e=0),void 0===a&&(a=-1),a<0&&(a=3*(this.indexCounts[this.bindIndex]/3|0)),i.ins.triCount+=a/3,i.ins.renderCount++,t.drawElements(t.TRIANGLES,a,t.UNSIGNED_SHORT,2*e)},glMesh.prototype.drawElementLines=function(t,e,a){void 0===e&&(e=0),void 0===a&&(a=-1),a<0&&(a=2*(this.indexCounts[this.bindIndex]/2|0)),i.ins.renderCount++,t.drawElements(t.LINES,a,t.UNSIGNED_SHORT,2*e)},glMesh}();t.glMesh=o}(t.render||(t.render={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function meshData(){}return meshData.addQuadPos=function(t,e){var a=t.pos.length;meshData.addQuadVec3(t.pos,e),t.trisindex.push(a+0),t.trisindex.push(a+1),t.trisindex.push(a+2),t.trisindex.push(a+2),t.trisindex.push(a+1),t.trisindex.push(a+3)},meshData.addQuadPos_Quad=function(t,e){var a=t.pos.length;meshData.addQuadVec3(t.pos,e),t.trisindex.push(a+0),t.trisindex.push(a+1),t.trisindex.push(a+3),t.trisindex.push(a+2)},meshData.addQuadVec3ByValue=function(e,a){for(var r=0;r<4;r++){var i=t.math.pool.clone_vector3(a);e.push(i)}},meshData.addQuadVec3=function(t,e){t.push(e[0]),t.push(e[1]),t.push(e[2]),t.push(e[3])},meshData.addQuadVec2=function(t,e){t.push(e[0]),t.push(e[1]),t.push(e[2]),t.push(e[3])},meshData.genQuad=function(e){var a=.5*e,r=new meshData;return r.pos=[],r.trisindex=[],r.normal=[],r.tangent=[],r.uv=[],meshData.addQuadVec3ByValue(r.normal,new t.math.vector3(0,0,1)),meshData.addQuadPos(r,[new t.math.vector3(-a,a,0),new t.math.vector3(-a,-a,0),new t.math.vector3(a,a,0),new t.math.vector3(a,-a,0)]),meshData.addQuadVec2(r.uv,[new t.math.vector2(0,0),new t.math.vector2(0,1),new t.math.vector2(1,0),new t.math.vector2(1,1)]),meshData.addQuadVec3ByValue(r.tangent,new t.math.vector3(1,0,0)),r},meshData.genQuad_forparticle=function(e){var a=.5*e,r=new meshData;return r.pos=[],r.trisindex=[],r.normal=[],r.tangent=[],r.uv=[],meshData.addQuadVec3ByValue(r.normal,new t.math.vector3(0,0,1)),meshData.addQuadPos(r,[new t.math.vector3(0,a,0),new t.math.vector3(0,-a,0),new t.math.vector3(2*a,a,0),new t.math.vector3(2*a,-a,0)]),meshData.addQuadVec2(r.uv,[new t.math.vector2(0,0),new t.math.vector2(0,1),new t.math.vector2(1,0),new t.math.vector2(1,1)]),meshData.addQuadVec3ByValue(r.tangent,new t.math.vector3(1,0,0)),r},meshData.genPlaneCCW=function(e){var a=.5*e,r=new meshData;return r.pos=[],r.trisindex=[],r.normal=[],r.tangent=[],r.uv=[],meshData.addQuadVec3ByValue(r.normal,new t.math.vector3(0,1,0)),meshData.addQuadPos(r,[new t.math.vector3(-a,0,a),new t.math.vector3(-a,0,-a),new t.math.vector3(a,0,a),new t.math.vector3(a,0,-a)]),meshData.addQuadVec2(r.uv,[new t.math.vector2(0,0),new t.math.vector2(0,1),new t.math.vector2(1,0),new t.math.vector2(1,1)]),meshData.addQuadVec3ByValue(r.tangent,new t.math.vector3(1,0,0)),r},meshData.genCylinderCCW=function(e,a,r){void 0===r&&(r=20);var i=new meshData;i.pos=[],i.trisindex=[],i.normal=[],i.uv=[];for(var o=new t.math.vector3(0,1,0),n=0;n<4;n++){var s=(n<2?.5:-.5)*e;0==n?o=new t.math.vector3(0,1,0):3==n&&(o=new t.math.vector3(0,-1,0));for(p=0;p<r;p++){var l=p/r*Math.PI*2,h=Math.sin(l),c=Math.cos(l);1!=n&&2!=n||(o=new t.math.vector3(h,0,c)),i.pos.push(new t.math.vector3(h*a,s,c*a));var u=t.math.pool.clone_vector3(o);i.normal.push(u),0==n||3==n?i.uv.push(new t.math.vector2(h/2+.5,c/2+.5)):i.uv.push(new t.math.vector2(p/r,s<0?0:1))}}var d=i.pos.length;i.pos.push(new t.math.vector3(0,.5*e,0)),i.normal.push(new t.math.vector3(0,1,0)),i.uv.push(new t.math.vector2(.5,.5));var m=i.pos.length;i.pos.push(new t.math.vector3(0,-.5*e,0)),i.normal.push(new t.math.vector3(0,-1,0)),i.uv.push(new t.math.vector2(.5,.5));for(var p=0;p<r;p++){i.trisindex.push(d),i.trisindex.push(p==r-1?0*r+0:0*r+p+1),i.trisindex.push(0*r+p+0),i.trisindex.push(m),i.trisindex.push(3*r+p+0),i.trisindex.push(p==r-1?3*r+0:3*r+p+1);var f=1*r+p,v=p==r-1?1*r+0:1*r+p+1,g=2*r+p,y=p==r-1?2*r+0:2*r+p+1;i.trisindex.push(f),i.trisindex.push(v),i.trisindex.push(g),i.trisindex.push(v),i.trisindex.push(y),i.trisindex.push(g)}return i},meshData.genPyramid=function(e,a){var r=new meshData;r.pos=[],r.trisindex=[],r.normal=[],r.uv=[];var i=new t.math.vector3,o=new t.math.vector3,n=new t.math.vector3,s=new t.math.vector3,l=new t.math.vector3(0,-1,0),h=new t.math.vector2(.5,.5),c=new t.math.vector2(0,0),u=new t.math.vector2(0,1),d=new t.math.vector2(1,0),m=new t.math.vector2(1,1),p=0;return r.pos.push(new t.math.vector3(-a,.5*-e,-a)),r.pos.push(new t.math.vector3(0,.5*e,0)),r.pos.push(new t.math.vector3(a,.5*-e,-a)),r.normal.push(i),r.normal.push(i),r.normal.push(i),r.uv.push(c),r.uv.push(h),r.uv.push(u),r.trisindex.push(p),r.trisindex.push(p+2),r.trisindex.push(p+1),p+=3,r.pos.push(new t.math.vector3(a,.5*-e,-a)),r.pos.push(new t.math.vector3(0,.5*e,0)),r.pos.push(new t.math.vector3(a,.5*-e,a)),r.normal.push(o),r.normal.push(o),r.normal.push(o),r.uv.push(u),r.uv.push(h),r.uv.push(m),r.trisindex.push(p),r.trisindex.push(p+2),r.trisindex.push(p+1),p+=3,r.pos.push(new t.math.vector3(a,.5*-e,a)),r.pos.push(new t.math.vector3(0,.5*e,0)),r.pos.push(new t.math.vector3(-a,.5*-e,a)),r.normal.push(n),r.normal.push(n),r.normal.push(n),r.uv.push(m),r.uv.push(h),r.uv.push(d),r.trisindex.push(p),r.trisindex.push(p+2),r.trisindex.push(p+1),p+=3,r.pos.push(new t.math.vector3(-a,.5*-e,a)),r.pos.push(new t.math.vector3(0,.5*e,0)),r.pos.push(new t.math.vector3(-a,.5*-e,-a)),r.normal.push(s),r.normal.push(s),r.normal.push(s),r.uv.push(d),r.uv.push(h),r.uv.push(c),r.trisindex.push(p),r.trisindex.push(p+2),r.trisindex.push(p+1),p+=3,r.pos.push(new t.math.vector3(-a,.5*-e,-a)),r.pos.push(new t.math.vector3(a,.5*-e,-a)),r.pos.push(new t.math.vector3(a,.5*-e,a)),r.pos.push(new t.math.vector3(-a,.5*-e,a)),r.normal.push(l),r.normal.push(l),r.normal.push(l),r.normal.push(l),r.uv.push(c),r.uv.push(d),r.uv.push(m),r.uv.push(u),r.trisindex.push(p),r.trisindex.push(p+2),r.trisindex.push(p+1),r.trisindex.push(p+3),r.trisindex.push(p+2),r.trisindex.push(p),p+=4,r},meshData.genSphereCCW=function(e,a,r){void 0===e&&(e=1),void 0===a&&(a=24),void 0===r&&(r=12);var i=new meshData;i.pos=[],i.trisindex=[],i.normal=[],i.tangent=[],i.uv=[],a=Math.max(3,Math.floor(a)),r=Math.max(2,Math.floor(r));var o,n,s=0,l=[],h=new t.math.vector3,c=new t.math.vector3;for(n=0;n<=r;n++){var u=[],d=n/r;for(o=0;o<=a;o++){var m=o/a;h.x=-e*Math.cos(m*Math.PI*2)*Math.sin(d*Math.PI),h.y=e*Math.cos(d*Math.PI),h.z=e*Math.sin(m*Math.PI*2)*Math.sin(d*Math.PI),i.pos.push(t.math.pool.clone_vector3(h)),c=t.math.pool.clone_vector3(h);var p=Math.sqrt(c.x*c.x+c.y*c.y+c.z*c.z);p>Number.MIN_VALUE?(c.x=c.x/p,c.y=c.y/p,c.z=c.z/p):(c.x=0,c.y=0,c.z=0),i.normal.push(c);var f=new t.math.vector2(1-m,d);i.uv.push(f),u.push(s++)}l.push(u)}for(n=0;n<r;n++)for(o=0;o<a;o++){var v=l[n][o+1],g=l[n][o],y=l[n+1][o],_=l[n+1][o+1];0!==n&&i.trisindex.push(v,_,g),n!==r-1&&i.trisindex.push(g,_,y)}return i},meshData.genBoxCCW=function(e){var a=.5*e,r=new meshData;return r.pos=[],r.trisindex=[],r.normal=[],r.tangent=[],r.uv=[],meshData.addQuadVec3ByValue(r.normal,new t.math.vector3(0,-1,0)),meshData.addQuadPos(r,[new t.math.vector3(-a,-a,-a),new t.math.vector3(-a,-a,a),new t.math.vector3(a,-a,-a),new t.math.vector3(a,-a,a)]),meshData.addQuadVec2(r.uv,[new t.math.vector2(0,0),new t.math.vector2(0,1),new t.math.vector2(1,0),new t.math.vector2(1,1)]),meshData.addQuadVec3ByValue(r.tangent,new t.math.vector3(-1,0,0)),meshData.addQuadVec3ByValue(r.normal,new t.math.vector3(0,1,0)),meshData.addQuadPos(r,[new t.math.vector3(-a,a,a),new t.math.vector3(-a,a,-a),new t.math.vector3(a,a,a),new t.math.vector3(a,a,-a)]),meshData.addQuadVec2(r.uv,[new t.math.vector2(0,0),new t.math.vector2(0,1),new t.math.vector2(1,0),new t.math.vector2(1,1)]),meshData.addQuadVec3ByValue(r.tangent,new t.math.vector3(1,0,0)),meshData.addQuadVec3ByValue(r.normal,new t.math.vector3(0,0,1)),meshData.addQuadPos(r,[new t.math.vector3(-a,-a,a),new t.math.vector3(-a,a,a),new t.math.vector3(a,-a,a),new t.math.vector3(a,a,a)]),meshData.addQuadVec2(r.uv,[new t.math.vector2(1,1),new t.math.vector2(1,0),new t.math.vector2(0,1),new t.math.vector2(0,0)]),meshData.addQuadVec3ByValue(r.tangent,new t.math.vector3(-1,0,0)),meshData.addQuadVec3ByValue(r.normal,new t.math.vector3(0,0,-1)),meshData.addQuadPos(r,[new t.math.vector3(-a,a,-a),new t.math.vector3(-a,-a,-a),new t.math.vector3(a,a,-a),new t.math.vector3(a,-a,-a)]),meshData.addQuadVec2(r.uv,[new t.math.vector2(0,0),new t.math.vector2(0,1),new t.math.vector2(1,0),new t.math.vector2(1,1)]),meshData.addQuadVec3ByValue(r.tangent,new t.math.vector3(1,0,0)),meshData.addQuadVec3ByValue(r.normal,new t.math.vector3(1,0,0)),meshData.addQuadPos(r,[new t.math.vector3(a,-a,-a),new t.math.vector3(a,-a,a),new t.math.vector3(a,a,-a),new t.math.vector3(a,a,a)]),meshData.addQuadVec2(r.uv,[new t.math.vector2(0,1),new t.math.vector2(1,1),new t.math.vector2(0,0),new t.math.vector2(1,0)]),meshData.addQuadVec3ByValue(r.tangent,new t.math.vector3(0,0,1)),meshData.addQuadVec3ByValue(r.normal,new t.math.vector3(-1,0,0)),meshData.addQuadPos(r,[new t.math.vector3(-a,-a,a),new t.math.vector3(-a,-a,-a),new t.math.vector3(-a,a,a),new t.math.vector3(-a,a,-a)]),meshData.addQuadVec2(r.uv,[new t.math.vector2(0,1),new t.math.vector2(1,1),new t.math.vector2(0,0),new t.math.vector2(1,0)]),meshData.addQuadVec3ByValue(r.tangent,new t.math.vector3(0,0,-1)),r},meshData.genBoxByArray=function(e){var a=new meshData;return a.pos=[],a.trisindex=[],a.normal=[],a.tangent=[],a.uv=[],meshData.addQuadVec3ByValue(a.normal,new t.math.vector3(0,-1,0)),meshData.addQuadPos(a,[e[0],e[1],e[2],e[3]]),meshData.addQuadVec3ByValue(a.tangent,new t.math.vector3(-1,0,0)),meshData.addQuadVec3ByValue(a.normal,new t.math.vector3(0,1,0)),meshData.addQuadPos(a,[e[4],e[5],e[6],e[7]]),meshData.addQuadVec3ByValue(a.tangent,new t.math.vector3(1,0,0)),meshData.addQuadVec3ByValue(a.normal,new t.math.vector3(0,0,1)),meshData.addQuadPos(a,[e[1],e[3],e[5],e[7]]),meshData.addQuadVec3ByValue(a.tangent,new t.math.vector3(1,0,0)),meshData.addQuadVec3ByValue(a.normal,new t.math.vector3(0,0,-1)),meshData.addQuadPos(a,[e[0],e[2],e[4],e[6]]),meshData.addQuadVec3ByValue(a.tangent,new t.math.vector3(-1,0,0)),meshData.addQuadVec3ByValue(a.normal,new t.math.vector3(1,0,0)),meshData.addQuadPos(a,[e[6],e[2],e[7],e[3]]),meshData.addQuadVec3ByValue(a.tangent,new t.math.vector3(0,0,-1)),meshData.addQuadVec3ByValue(a.normal,new t.math.vector3(-1,0,0)),meshData.addQuadPos(a,[e[0],e[4],e[1],e[5]]),meshData.addQuadVec3ByValue(a.tangent,new t.math.vector3(0,0,1)),a},meshData.genBoxByArray_Quad=function(e){var a=new meshData;return a.pos=[],a.trisindex=[],a.normal=[],a.tangent=[],a.uv=[],meshData.addQuadVec3ByValue(a.normal,new t.math.vector3(0,-1,0)),meshData.addQuadPos_Quad(a,[e[0],e[1],e[2],e[3]]),meshData.addQuadVec3ByValue(a.tangent,new t.math.vector3(-1,0,0)),meshData.addQuadVec3ByValue(a.normal,new t.math.vector3(0,1,0)),meshData.addQuadPos_Quad(a,[e[4],e[5],e[6],e[7]]),meshData.addQuadVec3ByValue(a.tangent,new t.math.vector3(1,0,0)),meshData.addQuadVec3ByValue(a.normal,new t.math.vector3(0,0,1)),meshData.addQuadPos_Quad(a,[e[1],e[3],e[5],e[7]]),meshData.addQuadVec3ByValue(a.tangent,new t.math.vector3(1,0,0)),meshData.addQuadVec3ByValue(a.normal,new t.math.vector3(0,0,-1)),meshData.addQuadPos_Quad(a,[e[0],e[2],e[4],e[6]]),meshData.addQuadVec3ByValue(a.tangent,new t.math.vector3(-1,0,0)),meshData.addQuadVec3ByValue(a.normal,new t.math.vector3(1,0,0)),meshData.addQuadPos_Quad(a,[e[6],e[2],e[7],e[3]]),meshData.addQuadVec3ByValue(a.tangent,new t.math.vector3(0,0,-1)),meshData.addQuadVec3ByValue(a.normal,new t.math.vector3(-1,0,0)),meshData.addQuadPos_Quad(a,[e[0],e[4],e[1],e[5]]),meshData.addQuadVec3ByValue(a.tangent,new t.math.vector3(0,0,1)),a},meshData.genCircleLineCCW=function(e,a,r){void 0===a&&(a=64),void 0===r&&(r=.05);var i=new meshData;i.pos=[],i.trisindex=[],i.normal=[],i.uv=[];for(var o=0;o<a;o++){var n=2*Math.PI*o/a,s=Math.sin(n)*e,l=Math.cos(n)*e,h=2*Math.PI*(o+1)/a,c=Math.sin(h)*e,u=Math.cos(h)*e;meshData.addQuadPos(i,[new t.math.vector3(c,r,u),new t.math.vector3(s,r,l),new t.math.vector3(c,-r,u),new t.math.vector3(s,-r,l)])}return i},meshData.prototype.caclByteLength=function(){var t=0;return void 0!=this.pos&&(t+=12),void 0!=this.color&&(t+=16),void 0!=this.normal&&(t+=12),void 0!=this.tangent&&(t+=12),void 0!=this.uv&&(t+=8),void 0!=this.uv2&&(t+=8),void 0!=this.blendIndex&&(t+=16),void 0!=this.blendWeight&&(t+=16),void 0!=this.colorex&&(t+=16),void 0!=this.trisindex&&(t+=12),t*=this.pos.length},meshData.calcByteSize=function(t){var a=0;return t&e.VertexFormatMask.Position&&(a+=12),t&e.VertexFormatMask.Normal&&(a+=12),t&e.VertexFormatMask.Tangent&&(a+=12),t&e.VertexFormatMask.Color&&(a+=16),t&e.VertexFormatMask.UV0&&(a+=8),t&e.VertexFormatMask.UV1&&(a+=8),t&e.VertexFormatMask.BlendIndex4&&(a+=16),t&e.VertexFormatMask.BlendWeight4&&(a+=16),t&e.VertexFormatMask.ColorEX&&(a+=16),a},meshData.prototype.genVertexDataArray=function(t){for(var a=this.pos.length,r=meshData.calcByteSize(t)/4,i=new Float32Array(r*a),o=0;o<a;o++){var n=0;i[o*r+n]=this.pos[o].x,i[o*r+ ++n]=this.pos[o].y,i[o*r+ ++n]=this.pos[o].z,n++,t&e.VertexFormatMask.Normal&&(void 0==this.normal||0==this.normal.length?(i[o*r+n]=0,i[o*r+ ++n]=0,i[o*r+ ++n]=0,n++):(i[o*r+n]=this.normal[o].x,i[o*r+ ++n]=this.normal[o].y,i[o*r+ ++n]=this.normal[o].z,n++)),t&e.VertexFormatMask.Tangent&&(void 0==this.tangent||0==this.tangent.length?(i[o*r+n]=0,i[o*r+ ++n]=0,i[o*r+ ++n]=0,n++):(i[o*r+n]=this.tangent[o].x,i[o*r+ ++n]=this.tangent[o].y,i[o*r+ ++n]=this.tangent[o].z,n++)),t&e.VertexFormatMask.Color&&(void 0==this.color||0==this.color.length?(i[o*r+n]=1,i[o*r+ ++n]=1,i[o*r+ ++n]=1,i[o*r+ ++n]=1,n++):(i[o*r+n]=this.color[o].r,i[o*r+ ++n]=this.color[o].g,i[o*r+ ++n]=this.color[o].b,i[o*r+ ++n]=this.color[o].a,n++)),t&e.VertexFormatMask.UV0&&(void 0==this.uv||0==this.uv.length?(i[o*r+n]=0,i[o*r+ ++n]=0,n++):(i[o*r+n]=this.uv[o].x,i[o*r+ ++n]=this.uv[o].y,n++)),t&e.VertexFormatMask.UV1&&(void 0==this.uv2||0==this.uv2.length?(i[o*r+n]=0,i[o*r+ ++n]=0,n++):(i[o*r+n]=this.uv2[o].x,i[o*r+ ++n]=this.uv2[o].y,n++)),t&e.VertexFormatMask.BlendIndex4&&(void 0==this.blendIndex||0==this.blendIndex.length?(i[o*r+n]=0,i[o*r+ ++n]=0,i[o*r+ ++n]=0,i[o*r+ ++n]=0,n++):(i[o*r+n]=this.blendIndex[o].v0,i[o*r+ ++n]=this.blendIndex[o].v1,i[o*r+ ++n]=this.blendIndex[o].v2,i[o*r+ ++n]=this.blendIndex[o].v3,n++)),t&e.VertexFormatMask.BlendWeight4&&(void 0==this.blendWeight||0==this.blendWeight.length?(i[o*r+n]=1,i[o*r+ ++n]=0,i[o*r+ ++n]=0,i[o*r+ ++n]=0,n++):(i[o*r+n]=this.blendWeight[o].v0,i[o*r+ ++n]=this.blendWeight[o].v1,i[o*r+ ++n]=this.blendWeight[o].v2,i[o*r+ ++n]=this.blendWeight[o].v3,n++)),t&e.VertexFormatMask.ColorEX&&(void 0==this.colorex||0==this.colorex.length?(i[o*r+n]=1,i[o*r+ ++n]=1,i[o*r+ ++n]=1,i[o*r+ ++n]=1,n++):(i[o*r+n]=this.colorex[o].r,i[o*r+ ++n]=this.colorex[o].g,i[o*r+ ++n]=this.colorex[o].b,i[o*r+ ++n]=this.colorex[o].a,n++))}return i},meshData.prototype.genIndexDataArray=function(){return new Uint16Array(this.trisindex)},meshData.prototype.genIndexDataArrayTri2Line=function(){for(var t=[],e=0;e<(this.trisindex.length/3|0);e++)t.push(this.trisindex[3*e+0]),t.push(this.trisindex[3*e+1]),t.push(this.trisindex[3*e+1]),t.push(this.trisindex[3*e+2]),t.push(this.trisindex[3*e+2]),t.push(this.trisindex[3*e+0]);return new Uint16Array(t)},meshData.prototype.genIndexDataArrayQuad2Line=function(){for(var t=[],e=0;e<(this.trisindex.length/4|0);e++)t.push(this.trisindex[4*e+0]),t.push(this.trisindex[4*e+1]),t.push(this.trisindex[4*e+1]),t.push(this.trisindex[4*e+2]),t.push(this.trisindex[4*e+2]),t.push(this.trisindex[4*e+3]);return new Uint16Array(t)},meshData}();e.meshData=a}(t.render||(t.render={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(t){var e=function(){function staticMeshRenderer(){this.eboIndex=0,this.drawMode=t.DrawModeEnum.EboTri,this.drawbegin=0,this.drawcount=-1}return staticMeshRenderer.prototype.draw=function(e){this.material.use(e),this.mesh.bind(e,this.material.program,this.eboIndex),this.drawMode==t.DrawModeEnum.VboTri?this.mesh.drawArrayTris(e,this.drawbegin,this.drawcount):this.drawMode==t.DrawModeEnum.VboLine?this.mesh.drawArrayLines(e,this.drawbegin,this.drawcount):this.drawMode==t.DrawModeEnum.EboTri?this.mesh.drawElementTris(e,this.drawbegin,this.drawcount):this.drawMode==t.DrawModeEnum.EboLine&&this.mesh.drawElementLines(e,this.drawbegin,this.drawcount)},staticMeshRenderer}();t.staticMeshRenderer=e;var a=function(){function batchRenderer(){this.vboCount=0,this.eboCount=0}return batchRenderer.prototype.initBuffer=function(e,a,r){this.mesh=new t.glMesh,this.mesh.initBuffer(e,a,128,t.MeshTypeEnum.Dynamic),this.dataForVbo=new Float32Array(128),this.drawMode=r,r!=t.DrawModeEnum.EboLine&&r!=t.DrawModeEnum.EboTri||(this.mesh.addIndex(e,128),this.dataForEbo=new Uint16Array(128))},batchRenderer.prototype.begin=function(t,e){this.vboCount>0&&this.end(t),this.curmaterial=e},batchRenderer.prototype.push=function(e,a,r){if((this.vboCount+a.length>2048||null!=r&&this.eboCount+r.length>2048)&&this.end(e),this.vboCount+a.length>this.dataForVbo.length){for(var i=new Float32Array(2*this.dataForVbo.length),o=0;o<this.dataForVbo.length;o++)i[o]=this.dataForVbo[o];this.dataForVbo=i,this.mesh.resetVboSize(e,this.dataForVbo.length)}for(o=0;o<a.length;o++)this.dataForVbo[this.vboCount+o]=a[o];if(this.vboCount+=a.length,this.drawMode!=t.DrawModeEnum.VboLine&&this.drawMode!=t.DrawModeEnum.VboTri&&null!=r){if(this.eboCount+r.length>this.dataForEbo.length){for(var i=new Uint16Array(2*this.dataForEbo.length),o=0;o<this.dataForEbo.length;o++)i[o]=this.dataForEbo[o];this.dataForEbo=i,this.mesh.resetEboSize(e,0,this.dataForEbo.length)}for(o=0;o<r.length;o++)this.dataForEbo[this.eboCount+o]=r[o];this.eboCount+=r.length}},batchRenderer.prototype.end=function(e){if(0!=this.vboCount){this.mesh.uploadVertexSubData(e,this.dataForVbo.slice(0,this.vboCount),0),this.eboCount>0&&this.mesh.uploadIndexSubData(e,0,this.dataForEbo.slice(0,this.eboCount),0);var a=this.vboCount/(this.mesh.vertexByteSize/4)|0;this.curmaterial.use(e),this.mesh.bind(e,this.curmaterial.program,this.drawMode==t.DrawModeEnum.EboLine||this.drawMode==t.DrawModeEnum.EboTri?0:-1),this.drawMode==t.DrawModeEnum.EboLine?this.mesh.drawElementLines(e,0,this.eboCount):this.drawMode==t.DrawModeEnum.EboTri?this.mesh.drawElementTris(e,0,this.eboCount):this.drawMode==t.DrawModeEnum.VboLine?this.mesh.drawArrayLines(e,0,a):this.drawMode==t.DrawModeEnum.VboTri&&this.mesh.drawArrayTris(e,0,a),this.vboCount=0,this.eboCount=0}},batchRenderer}();t.batchRenderer=a}(t.render||(t.render={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a=function(){function glWindow(){this.clearop_Color=!1,this.backColor=new t.math.color(1,0,1,1),this.clearop_Depth=!1,this.clearop_Stencil=!1,this.viewport=new t.math.rect(0,0,1,1)}return glWindow.prototype.use=function(e){null!=this.renderTarget?this.renderTarget.use(e):t.render.glRenderTarget.useNull(e),null!=this.backColor&&e.clearColor(this.backColor.r,this.backColor.g,this.backColor.b,this.backColor.a);var a=0;this.clearop_Color&&(a|=e.COLOR_BUFFER_BIT),this.clearop_Depth&&(a|=e.DEPTH_BUFFER_BIT),this.clearop_Stencil&&(a|=e.STENCIL_BUFFER_BIT),e.clear(a),null!=this.renderTarget?e.viewport(this.renderTarget.width*this.viewport.x,this.renderTarget.height*this.viewport.y,this.renderTarget.width*this.viewport.w,this.renderTarget.height*this.viewport.h):e.viewport(e.canvas.width*this.viewport.x,e.canvas.height*this.viewport.y,e.canvas.width*this.viewport.w,e.canvas.height*this.viewport.h)},glWindow}();e.glWindow=a}(t.render||(t.render={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(t){var e;!function(t){t[t.Texture=0]="Texture",t[t.Float=1]="Float",t[t.Floatv=2]="Floatv",t[t.Float4=3]="Float4",t[t.Float4v=4]="Float4v",t[t.Float4x4=5]="Float4x4",t[t.Float4x4v=6]="Float4x4v"}(e=t.UniformTypeEnum||(t.UniformTypeEnum={}));var a=function(){return function uniform(){}}();t.uniform=a;var r;!function(t){t[t.VS=0]="VS",t[t.FS=1]="FS"}(r=t.ShaderTypeEnum||(t.ShaderTypeEnum={}));var i=function(){function glShader(t,e,a,r){this.mapUniform={},this.name=t,this.type=e,this.shader=a,this._scanUniform(r)}return glShader.prototype._scanUniform=function(t){var a=t.split(";");for(var r in a){var i=a[r].split("\n");for(var o in i){var n=i[o],s=n.match(new RegExp("([_a-zA-Z0-9]+)|([/=;]+)","g"));if(null!=s&&s.length>=3&&"uniform"==s[0]){var l=s[1],h=s[2];"highp"!=l&&"lowp"!=l&&"mediump"!=l||(l=s[2],h=s[3]);var c={name:h,type:e.Float};if(this.mapUniform[h]=c,"sampler2D"==l)c.type=e.Texture;else if("float"==l&&n.indexOf("[")>=0&&n.indexOf("]")>=0)c.type=e.Floatv;else if("float"==l)c.type=e.Float;else if("vec4"==l&&n.indexOf("[")>=0&&n.indexOf("]")>=0)c.type=e.Float4v;else if("vec4"==l)c.type=e.Float4;else if("mat4"==l&&n.indexOf("[")>=0&&n.indexOf("]")>=0)c.type=e.Float4x4v;else{if("mat4"!=l)throw new Error("uniform type:"+l+" not defined.");c.type=e.Float4x4}}}}},glShader}();t.glShader=i;var o=function(){function glProgram(t,e,a){this.posPos=-1,this.posNormal=-1,this.posTangent=-1,this.posColor=-1,this.posUV0=-1,this.posUV2=-1,this.posBlendIndex4=-1,this.posBlendWeight4=-1,this.posColorEx=-1,this.mapUniform={},this.vs=t,this.fs=e,this.program=a}return glProgram.prototype.initAttribute=function(t){this.posPos=t.getAttribLocation(this.program,"_glesVertex"),this.posColor=t.getAttribLocation(this.program,"_glesColor"),this.posUV0=t.getAttribLocation(this.program,"_glesMultiTexCoord0"),this.posUV2=t.getAttribLocation(this.program,"_glesMultiTexCoord1"),this.posNormal=t.getAttribLocation(this.program,"_glesNormal"),this.posTangent=t.getAttribLocation(this.program,"_glesTangent"),this.posBlendIndex4=t.getAttribLocation(this.program,"_glesBlendIndex4"),this.posBlendWeight4=t.getAttribLocation(this.program,"_glesBlendWeight4"),this.posColorEx=t.getAttribLocation(this.program,"_glesColorEx")},glProgram.prototype.use=function(t){t.useProgram(this.program)},glProgram}();t.glProgram=o;var n=function(){function shaderPool(){this.mapVS={},this.mapFS={},this.mapProgram={}}return shaderPool.prototype.disposeVS=function(t,e){t.deleteShader(this.mapVS[e].shader)},shaderPool.prototype.disposeFS=function(t,e){t.deleteShader(this.mapFS[e].shader)},shaderPool.prototype.disposeProgram=function(t,e){t.deleteProgram(this.mapProgram[e].program)},shaderPool.prototype.disposeAll=function(t){for(var e in this.mapVS)this.disposeVS(t,e);for(var e in this.mapFS)this.disposeFS(t,e);for(var e in this.mapProgram)this.disposeProgram(t,e);this.mapVS={},this.mapFS={},this.mapProgram={}},shaderPool.prototype.compileVS=function(t,e,a){var o=t.createShader(t.VERTEX_SHADER);if(t.shaderSource(o,a),t.compileShader(o),0==t.getShaderParameter(o,t.COMPILE_STATUS))return confirm("a vs:"+e+" error!!!"+t.getShaderInfoLog(o)+"\ndid you want see the code?")&&(t.deleteShader(o),alert(a)),null;var n=new i(e,r.VS,o,a);return this.mapVS[e]=n,n},shaderPool.prototype.compileFS=function(t,e,a){var o=t.createShader(t.FRAGMENT_SHADER);if(t.shaderSource(o,a),t.compileShader(o),0==t.getShaderParameter(o,t.COMPILE_STATUS))return confirm("a fs:"+e+" error!!!"+t.getShaderInfoLog(o)+"\ndid you want see the code?")&&(t.deleteShader(o),alert(a)),null;var n=new i(e,r.FS,o,a);return this.mapFS[e]=n,n},shaderPool.prototype.linkProgram=function(t,e,a){var r=t.createProgram();if(t.attachShader(r,this.mapVS[e].shader),t.attachShader(r,this.mapFS[a].shader),t.linkProgram(r),0==t.getProgramParameter(r,t.LINK_STATUS))return alert("vs:"+e+"   fs:"+a+"a webgl program error:"+t.getProgramInfoLog(r)),t.deleteProgram(r),null;var i=e+"_"+a,n=new o(this.mapVS[e],this.mapFS[a],r);for(var s in this.mapVS[e].mapUniform){l=this.mapVS[e].mapUniform[s];n.mapUniform[s]={name:l.name,type:l.type,location:null}}for(var s in this.mapFS[a].mapUniform){var l=this.mapFS[a].mapUniform[s];n.mapUniform[s]={name:l.name,type:l.type,location:null}}for(var s in n.mapUniform)n.mapUniform[s].location=t.getUniformLocation(r,s);return n.initAttribute(t),this.mapProgram[i]=n,n},shaderPool}();t.shaderPool=n}(t.render||(t.render={}))}(gd3d||(gd3d={}));var gd3d;!function(t){!function(e){var a;!function(t){t[t.RGBA=1]="RGBA",t[t.RGB=2]="RGB",t[t.Gray=3]="Gray",t[t.PVRTC4_RGB=4]="PVRTC4_RGB",t[t.PVRTC4_RGBA=4]="PVRTC4_RGBA",t[t.PVRTC2_RGB=4]="PVRTC2_RGB",t[t.PVRTC2_RGBA=4]="PVRTC2_RGBA"}(a=e.TextureFormatEnum||(e.TextureFormatEnum={}));var r=function(){function textureReader(t,e,a,r,i){void 0===i&&(i=!0),this.gray=i,this.width=a,this.height=r;var o=t.createFramebuffer(),n=t.getParameter(t.FRAMEBUFFER_BINDING);t.bindFramebuffer(t.FRAMEBUFFER,o),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e,0);var s=new Uint8Array(this.width*this.height*4);if(s[0]=2,t.readPixels(0,0,this.width,this.height,t.RGBA,t.UNSIGNED_BYTE,s),t.deleteFramebuffer(o),t.bindFramebuffer(t.FRAMEBUFFER,n),i){this.data=new Uint8Array(this.width*this.height);for(var l=0;l<a*r;l++)this.data[l]=s[4*l]}else this.data=s}return textureReader.prototype.getPixel=function(e,a){var r=e*this.width|0,i=a*this.height|0;if(r<0||r>=this.width||i<0||i>=this.height)return 0;if(this.gray)return this.data[i*this.width+r];var o=4*(i*this.width+r);return new t.math.color(this.data[o],this.data[o+1],this.data[o+2],this.data[o+3])},textureReader}();e.textureReader=r;var i=function(){function glRenderTarget(t,e,a,r,i){void 0===r&&(r=!1),void 0===i&&(i=!1),this.width=e,this.height=a,this.fbo=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,this.fbo),(r||i)&&(this.renderbuffer=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,this.renderbuffer),r&&i?(t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_STENCIL,e,a),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.RENDERBUFFER,this.renderbuffer)):r?(t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,e,a),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.renderbuffer)):(t.renderbufferStorage(t.RENDERBUFFER,t.STENCIL_INDEX8,e,a),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.STENCIL_ATTACHMENT,t.RENDERBUFFER,this.renderbuffer))),this.texture=t.createTexture(),this.fbo.width=e,this.fbo.height=a,t.bindTexture(t.TEXTURE_2D,this.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e,a,0,t.RGBA,t.UNSIGNED_BYTE,null),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.texture,0)}return glRenderTarget.prototype.use=function(t){t.bindFramebuffer(t.FRAMEBUFFER,this.fbo),t.bindRenderbuffer(t.RENDERBUFFER,this.renderbuffer),t.bindTexture(t.TEXTURE_2D,this.texture)},glRenderTarget.useNull=function(t){t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null)},glRenderTarget.prototype.dispose=function(t){null!=this.texture&&(t.deleteFramebuffer(this.renderbuffer),this.renderbuffer=null,t.deleteTexture(this.texture),this.texture=null)},glRenderTarget.prototype.caclByteLength=function(){return this.width*this.height*4},glRenderTarget.prototype.isFrameBuffer=function(){return!0},glRenderTarget}();e.glRenderTarget=i;var o=function(){function glTexture2D(t,e,r,i){void 0===e&&(e=a.RGBA),void 0===r&&(r=!1),void 0===i&&(i=!0),this.loaded=!1,this.width=0,this.height=0,this.mipmap=!1,this.webgl=t,this.format=e,this.texture=t.createTexture();this.ext=this.getExt("WEBGL_compressed_texture_pvrtc")}return glTexture2D.prototype.getExt=function(t){for(var e=["","MOZ_","OP_","WEBKIT_"],a=0;a<e.length;++a){var r=e[a]+t,i=this.webgl.getExtension(r);if(i)return i}return null},glTexture2D.prototype.uploadImage=function(t,e,r,i,o,n,s){void 0===i&&(i=!0),void 0===o&&(o=!1),void 0===n&&(n=!1),void 0===s&&(s=!1),this.width=t.width,this.height=t.height,this.mipmap=e,this.loaded=!0,this.webgl.pixelStorei(this.webgl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i?1:0),this.webgl.pixelStorei(this.webgl.UNPACK_FLIP_Y_WEBGL,0),this.webgl.bindTexture(this.webgl.TEXTURE_2D,this.texture);var l=this.webgl.RGBA;this.format==a.RGB?l=this.webgl.RGB:this.format==a.Gray&&(l=this.webgl.LUMINANCE),this.webgl.texImage2D(this.webgl.TEXTURE_2D,0,l,l,this.webgl.UNSIGNED_BYTE,t),e?(this.webgl.generateMipmap(this.webgl.TEXTURE_2D),r?(this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_MAG_FILTER,this.webgl.LINEAR),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_MIN_FILTER,this.webgl.LINEAR_MIPMAP_LINEAR)):(this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_MAG_FILTER,this.webgl.NEAREST),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_MIN_FILTER,this.webgl.NEAREST_MIPMAP_NEAREST))):r?(this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_MAG_FILTER,this.webgl.LINEAR),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_MIN_FILTER,this.webgl.LINEAR)):(this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_MAG_FILTER,this.webgl.NEAREST),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_MIN_FILTER,this.webgl.NEAREST)),o?n&&s?(this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_S,this.webgl.MIRRORED_REPEAT),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_T,this.webgl.MIRRORED_REPEAT)):n?(this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_S,this.webgl.MIRRORED_REPEAT),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_T,this.webgl.REPEAT)):s?(this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_S,this.webgl.REPEAT),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_T,this.webgl.MIRRORED_REPEAT)):(this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_S,this.webgl.REPEAT),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_T,this.webgl.REPEAT)):(this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_S,this.webgl.CLAMP_TO_EDGE),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_T,this.webgl.CLAMP_TO_EDGE))},glTexture2D.prototype.uploadByteArray=function(t,e,r,i,o,n,s,l){void 0===n&&(n=!1),void 0===s&&(s=!1),void 0===l&&(l=!1),this.width=r,this.height=i,this.mipmap=t,this.loaded=!0,this.webgl.pixelStorei(this.webgl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1),this.webgl.pixelStorei(this.webgl.UNPACK_FLIP_Y_WEBGL,0),this.webgl.bindTexture(this.webgl.TEXTURE_2D,this.texture);var h=this.webgl.RGBA;this.format==a.RGB?h=this.webgl.RGB:this.format==a.Gray&&(h=this.webgl.LUMINANCE),this.webgl.texImage2D(this.webgl.TEXTURE_2D,0,h,r,i,0,h,this.webgl.UNSIGNED_BYTE,o),t?(this.webgl.generateMipmap(this.webgl.TEXTURE_2D),e?(this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_MAG_FILTER,this.webgl.LINEAR),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_MIN_FILTER,this.webgl.LINEAR_MIPMAP_LINEAR)):(this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_MAG_FILTER,this.webgl.NEAREST),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_MIN_FILTER,this.webgl.NEAREST_MIPMAP_NEAREST))):e?(this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_MAG_FILTER,this.webgl.LINEAR),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_MIN_FILTER,this.webgl.LINEAR)):(this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_MAG_FILTER,this.webgl.NEAREST),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_MIN_FILTER,this.webgl.NEAREST)),n?s&&l?(this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_S,this.webgl.MIRRORED_REPEAT),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_T,this.webgl.MIRRORED_REPEAT)):s?(this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_S,this.webgl.MIRRORED_REPEAT),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_T,this.webgl.REPEAT)):l?(this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_S,this.webgl.REPEAT),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_T,this.webgl.MIRRORED_REPEAT)):(this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_S,this.webgl.REPEAT),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_T,this.webgl.REPEAT)):(this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_S,this.webgl.CLAMP_TO_EDGE),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_T,this.webgl.CLAMP_TO_EDGE))},glTexture2D.prototype.caclByteLength=function(){var t=1;this.format==a.RGBA?t=4:this.format==a.RGB&&(t=3);var e=this.width*this.height*t;return this.mipmap&&(e=e*(1-Math.pow(.25,10))/.75),e},glTexture2D.prototype.getReader=function(t){if(void 0===t&&(t=!1),null!=this.reader){if(this.reader.gray!=t)throw new Error("get param diff with this.reader");return this.reader}if(this.format!=a.RGBA)throw new Error("only rgba texture can read");return null==this.texture?null:(null==this.reader&&(this.reader=new r(this.webgl,this.texture,this.width,this.height,t)),this.reader)},glTexture2D.prototype.dispose=function(t){null!=this.texture&&(t.deleteTexture(this.texture),this.texture=null)},glTexture2D.prototype.isFrameBuffer=function(){return!1},glTexture2D.formGrayArray=function(t,e,r,i){for(var o=new glTexture2D(t,a.RGBA,!1,!0),n=new Uint8Array(4*e.length),s=0;s<r;s++)for(var l=0;l<r;l++){var h=512*s+l,c=s*r+l;n[4*h]=255*e[c],n[4*h+1]=255*e[c],n[4*h+2]=255*e[c],n[4*h+3]=255}return o.uploadByteArray(!1,!0,512,512,n),o},glTexture2D.staticTexture=function(t,e){var r=glTexture2D.mapTexture[e];if(void 0!=r)return r;r=new glTexture2D(t,a.RGBA,!1,!0);var i=new Uint8Array(4),o=1,n=1;if(i[0]=128,i[1]=0,i[2]=128,i[3]=255,"gray"==e)i[0]=128,i[1]=128,i[2]=128,i[3]=255;else if("white"==e)i[0]=255,i[1]=255,i[2]=255,i[3]=255;else if("black"==e)i[0]=0,i[1]=0,i[2]=0,i[3]=255;else if("grid"==e){o=256,n=256,i=new Uint8Array(o*o*4);for(var s=0;s<n;s++)for(var l=0;l<o;l++){var h=4*(s*o+l);(l-.5*o)*(s-.5*n)>0?(i[h]=0,i[h+1]=0,i[h+2]=0,i[h+3]=255):(i[h]=255,i[h+1]=255,i[h+2]=255,i[h+3]=255)}}return r.uploadByteArray(!1,!0,o,n,i),glTexture2D.mapTexture[e]=r,r},glTexture2D}();o.mapTexture={},e.glTexture2D=o;var n=function(){function WriteableTexture2D(t,e,r,i,o,n,s,l,h){void 0===e&&(e=a.RGBA),void 0===n&&(n=!0),void 0===s&&(s=!1),void 0===l&&(l=!1),void 0===h&&(h=!1),this.premultiply=!0,this.repeat=!1,this.mirroredU=!1,this.mirroredV=!1,this.width=0,this.height=0,this.webgl=t,this.texture=t.createTexture(),this.webgl.pixelStorei(this.webgl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,n?1:0),this.webgl.pixelStorei(this.webgl.UNPACK_FLIP_Y_WEBGL,0),this.webgl.bindTexture(this.webgl.TEXTURE_2D,this.texture),this.format=e,this.formatGL=this.webgl.RGBA,e==a.RGB?this.formatGL=this.webgl.RGB:e==a.Gray&&(this.formatGL=this.webgl.LUMINANCE);this.webgl.texImage2D(this.webgl.TEXTURE_2D,0,this.formatGL,r,i,0,this.formatGL,this.webgl.UNSIGNED_BYTE,null),o?(this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_MAG_FILTER,this.webgl.LINEAR),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_MIN_FILTER,this.webgl.LINEAR)):(this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_MAG_FILTER,this.webgl.NEAREST),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_MIN_FILTER,this.webgl.NEAREST)),s?l&&h?(this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_S,this.webgl.MIRRORED_REPEAT),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_T,this.webgl.MIRRORED_REPEAT)):l?(this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_S,this.webgl.MIRRORED_REPEAT),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_T,this.webgl.REPEAT)):h?(this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_S,this.webgl.REPEAT),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_T,this.webgl.MIRRORED_REPEAT)):(this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_S,this.webgl.REPEAT),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_T,this.webgl.REPEAT)):(this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_S,this.webgl.CLAMP_TO_EDGE),this.webgl.texParameteri(this.webgl.TEXTURE_2D,this.webgl.TEXTURE_WRAP_T,this.webgl.CLAMP_TO_EDGE))}return WriteableTexture2D.prototype.updateRect=function(t,e,a,r,i){this.webgl.bindTexture(this.webgl.TEXTURE_2D,this.texture),this.webgl.texSubImage2D(this.webgl.TEXTURE_2D,0,e,a,r,i,this.formatGL,this.webgl.UNSIGNED_BYTE,t)},WriteableTexture2D.prototype.updateRectImg=function(t,e,a){this.webgl.bindTexture(this.webgl.TEXTURE_2D,this.texture),this.webgl.texSubImage2D(this.webgl.TEXTURE_2D,0,e,a,this.formatGL,this.webgl.UNSIGNED_BYTE,t)},WriteableTexture2D.prototype.isFrameBuffer=function(){return!1},WriteableTexture2D.prototype.dispose=function(t){null!=this.texture&&(t.deleteTexture(this.texture),this.texture=null)},WriteableTexture2D.prototype.caclByteLength=function(){var t=1;return this.format==a.RGBA?t=4:this.format==a.RGB&&(t=3),this.width*this.height*t},WriteableTexture2D}();e.WriteableTexture2D=n}(t.render||(t.render={}))}(gd3d||(gd3d={}));